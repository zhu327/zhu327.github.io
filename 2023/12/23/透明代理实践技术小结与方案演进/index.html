<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      透明代理实践：技术小结与方案演进 &middot; 跬步
    
  </title>

  
  <link rel="stylesheet" href="https://zhu327.github.io/css/poole.css">
  <link rel="stylesheet" href="https://zhu327.github.io/css/syntax.css">
  <link rel="stylesheet" href="https://zhu327.github.io/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://zhu327.github.io/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="https://zhu327.github.io/assets/favicon.ico">

  
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://zhu327.github.io/feed.xml">
</head>


  <body class="theme-base-0d">

    
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>My notes and thoughts.</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="https://zhu327.github.io/">Home</a>
    <a class="sidebar-nav-item " href="https://zhu327.github.io/post">Posts</a>
    <a class="sidebar-nav-item " href="https://zhu327.github.io/tags">Tags</a>

    
        <a class="sidebar-nav-item " href="https://zhu327.github.io/about/">About</a>

    <a class="sidebar-nav-item" href="https://github.com/zhu327" target="_blank">GitHub</a>
  </nav>

  <div class="sidebar-item">
    <p>&copy; 2024. All rights reserved.</p>
  </div>
</div>


    
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="https://zhu327.github.io/" title="Home">跬步</a>
            <small>On Coding</small>
          </h3>
        </div>
      </div>

      <div class="container content">


<div class="post">
  <h1 class="post-title">透明代理实践：技术小结与方案演进</h1>
  <span class="post-date">Dec 23 2023</span>
  <h3 id="1-路由拓扑">1. 路由拓扑</h3>

<p>在家中，我们采用了中国移动提供的千兆宽带服务，通过移动自带的光猫进行拨号连接。紧随其后是一台搭载OpenWRT系统的路由器，负责管理Wi-Fi以及局域网的网络地址转换（NAT）。由于光猫已占用了192.168.1.1网段，我们将路由器配置为192.168.2.1，以便更好地管理IPv4流量。在IPv4网络中，数据流经过光猫和路由器的双层NAT进行处理。</p>

<p>对于IPv6网络，由于路由器无法直接获取地址前缀，我们配置了IPv6 DHCP Relay功能，确保局域网内的每个设备都能够获取IPv6地址。</p>

<p>以下是我们在OpenWRT路由器上的相关配置：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># cat /etc/config/network
</span><span class="c1"></span>config interface <span class="s1">&#39;lan&#39;</span>
	option <span class="nb">type</span> <span class="s1">&#39;bridge&#39;</span>
	option ifname <span class="s1">&#39;eth0 ra0 ra1 rai0 rai1&#39;</span>
	option proto <span class="s1">&#39;static&#39;</span>
	option netmask <span class="s1">&#39;255.255.255.0&#39;</span>
	option ipaddr <span class="s1">&#39;192.168.2.1&#39;</span>
	option macaddr <span class="s1">&#39;C8:BF:4C:87:EE:68&#39;</span></code></pre></div>
<p>在这里，我们通过将LAN口的MAC地址固定设置，以避免LAN IPv6地址的变化。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># cat /etc/config/dhcp
</span><span class="c1"></span>config dhcp <span class="s1">&#39;lan&#39;</span>
	option interface <span class="s1">&#39;lan&#39;</span>
	option start <span class="s1">&#39;100&#39;</span>
	option limit <span class="s1">&#39;150&#39;</span>
	option leasetime <span class="s1">&#39;12h&#39;</span>
	option ra_slaac <span class="s1">&#39;1&#39;</span>
	list ra_flags <span class="s1">&#39;managed-config&#39;</span>
	list ra_flags <span class="s1">&#39;other-config&#39;</span>
	option ra <span class="s1">&#39;relay&#39;</span>
	option ndp <span class="s1">&#39;relay&#39;</span>
	option dhcpv6 <span class="s1">&#39;relay&#39;</span>
	option force <span class="s1">&#39;1&#39;</span>
	list dns <span class="s1">&#39;fe80::cabf:4cff:fe87:ee68&#39;</span>

config dhcp <span class="s1">&#39;wan&#39;</span>
	option interface <span class="s1">&#39;wan&#39;</span>
	option ignore <span class="s1">&#39;1&#39;</span>
	option dhcpv6 <span class="s1">&#39;relay&#39;</span>
	option ra <span class="s1">&#39;relay&#39;</span>
	option ndp <span class="s1">&#39;relay&#39;</span>
	option master <span class="s1">&#39;1&#39;</span></code></pre></div>
<p>此处，我们配置了IPv6 DHCP Relay功能，直接从光猫获取IPv6地址，并指定LAN口IPv6地址作为IPv6 DNS通告，以确保局域网内的设备的DNS配置无论是IPv4还是IPv6地址都是OpenWRT路由器。</p>

<p></p>

<h3 id="2-dns分流透明代理">2. DNS分流透明代理</h3>

<p>为了满足一些特殊需求，我们需要对特定域名进行代理，以确保局域网内的每个设备都能轻松无配置地享受代理服务。为此，我们在OpenWRT路由器上配置了透明代理。</p>

<p>为了实现只有特定域名走代理的目的，我们首先需要在DNS层面进行分流。下面是一个更为紧凑的DNS分流示意图：</p>

<p><img src="https://github.com/zhu327/zhu327.github.io/assets/873883/594bdd94-3593-4278-8fa8-b8f7067b345e" alt="Image1" width="700px" /></p>

<ul>
<li>Dnsmasq负责DNS分流，将命中代理域名列表的域名分流到SmartDNS，并将查询的IP放入ipset中。对于直连的域名，直接通过光猫进行DNS查询。</li>
<li>SmartDNS负责代理域名的DNS查询，通过TCP DNS查询走透明代理到远端的代理服务器上，查询代理服务器上最佳的IP地址。</li>
<li>ipt2socks是一个将透明代理转换为Socks5代理的小工具，通过这个工具可以降低路由器负载。真正的代理程序运行在局域网内的NAS上。</li>
</ul>

<p>Dnsmasq分流配置示例：</p>

<pre><code>server=/example.com/127.0.0.1#5335
ipset=/example.com/vpn
</code></pre>

<p>这样，命中分流列表的域名会被发送到SmartDNS，同时查询到的IP地址会被放入ipset vpn中。</p>

<p>SmartDNS配置示例：</p>

<pre><code>bind :5335 -no-dualstack-selection -no-speed-check -force-aaaa-soa

server-tcp 8.8.8.8
server-tcp 1.1.1.1
</code></pre>

<p>SmartDNS将UDP DNS查询转换为TCP DNS查询，通过iptables路由到ipt2socks，最终在远端的代理服务器上查询。SmartDNS还强制执行SOA IPv6的DNS查询，以防止代理流量通过IPv6直接走到光猫而绕过路由器NAT。</p>

<p>TCP分流示意图：</p>

<p><img src="https://github.com/zhu327/zhu327.github.io/assets/873883/91c390ba-c1a6-42a2-b8de-3d3e38b74f83" alt="Image2" width="700px" /></p>

<p>当目标IP命中ipset vpn流量时，重定向到ipt2socks进行代理。直连的流量则直接通过系统出口。</p>

<p>iptables配置示例：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 创建ipset
</span><span class="c1"></span>ipset create vpn hash:ip

iptables -t nat -N V2RAY <span class="c1"># 新建一个名为 V2RAY 的链
</span><span class="c1"></span>iptables -t nat -A V2RAY -p tcp -m <span class="nb">set</span> --match-set vpn dst -j REDIRECT --to-ports <span class="m">12345</span> <span class="c1"># 命中ipset vpn的流量重定向到ipt2socks
</span><span class="c1"></span>iptables -t nat -A PREROUTING -p tcp -j V2RAY <span class="c1"># 对局域网其他设备进行透明代理
</span><span class="c1"></span>iptables -t nat -A OUTPUT -p tcp -j V2RAY # 对本机进行透明代理</code></pre></div>
<p>ipt2socks启动命令：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">/usr/bin/ipt2socks -R -4 -j <span class="m">2</span> -s <span class="m">192</span>.168.2.141 -p <span class="m">1080</span> -l <span class="m">12345</span></code></pre></div>
<p>这一方案的具体实现通过OpenWRT的Passwall插件，使得配置变得非常便捷。尽管这个方案在日常使用中表现良好，但也存在3个主要问题：</p>

<ol>
<li><strong>分流的DNS需要通过远端代理查询</strong>，虽然我们利用DNS缓存来减轻影响，但仍可能影响首次响应速度。</li>
<li><strong>对于一些走CDN的网站，是否将其IP加入ipset不太确定</strong>，这可能导致一些网站无法正常访问。</li>
<li><strong>ipset变大以后影响iptables匹配效率</strong></li>
</ol>

<h3 id="3-fake-ip透明代理">3. Fake IP透明代理</h3>

<p>最近我了解到一种称为Fake IP的代理方案，将其应用到我的现有解决方案中，成功解决了旧方案存在的三个问题。新方案更为简洁高效，无需依赖SmartDNS和Passwall插件，直接手动搭建即可。</p>

<h4 id="dns查询示意图">DNS查询示意图：</h4>

<p><img src="https://github.com/zhu327/zhu327.github.io/assets/873883/a9a68e6b-ca83-4397-9742-83732b7c07f7" alt="Image3" width="700px" /></p>

<p>在DNS查询中，Dnsmasq通过分流后，命中代理域名的查询会被引导至v2ray的Fake DNS上，该Fake DNS返回一个固定网段的Fake IP。不再需要设置ipset，方案更为简化。</p>

<h4 id="tcp流量示意图">TCP流量示意图：</h4>

<p><img src="https://github.com/zhu327/zhu327.github.io/assets/873883/2c05cec4-741a-43dd-b709-3f77d5e9ce7e" alt="Image4" width="700px" /></p>

<p>在TCP流量方面，命中固定网段的iptables规则后，流量将被重定向至ipt2socks。ipt2socks将透明代理转换为Socks5代理，并将流量发送至v2ray。v2ray检测到目标IP为Fake IP后，填充成域名并发送至远端代理服务器，实现代理域名的解析。</p>

<h4 id="v2ray配置参考">v2ray配置参考：</h4>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;log&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;loglevel&#34;</span><span class="p">:</span> <span class="s2">&#34;warning&#34;</span>
  <span class="p">},</span>
  <span class="nt">&#34;fakedns&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;ipPool&#34;</span><span class="p">:</span> <span class="s2">&#34;198.18.0.0/15&#34;</span><span class="p">,</span>
    <span class="nt">&#34;poolSize&#34;</span><span class="p">:</span> <span class="mi">65535</span>
  <span class="p">},</span>
  <span class="nt">&#34;dns&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;servers&#34;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">&#34;fakedns&#34;</span>
    <span class="p">],</span>
    <span class="nt">&#34;queryStrategy&#34;</span><span class="p">:</span> <span class="s2">&#34;USE_IP4&#34;</span>
  <span class="p">},</span>
  <span class="nt">&#34;inbounds&#34;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&#34;port&#34;</span><span class="p">:</span> <span class="mi">5335</span><span class="p">,</span>
      <span class="nt">&#34;tag&#34;</span><span class="p">:</span> <span class="s2">&#34;dns-in&#34;</span><span class="p">,</span>
      <span class="nt">&#34;protocol&#34;</span><span class="p">:</span> <span class="s2">&#34;dokodemo-door&#34;</span><span class="p">,</span>
      <span class="nt">&#34;settings&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;address&#34;</span><span class="p">:</span> <span class="s2">&#34;119.29.29.29&#34;</span><span class="p">,</span>
        <span class="nt">&#34;port&#34;</span><span class="p">:</span> <span class="mi">53</span><span class="p">,</span>
        <span class="nt">&#34;network&#34;</span><span class="p">:</span> <span class="s2">&#34;udp&#34;</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="nt">&#34;port&#34;</span><span class="p">:</span> <span class="mi">1080</span><span class="p">,</span>
      <span class="nt">&#34;protocol&#34;</span><span class="p">:</span> <span class="s2">&#34;socks&#34;</span><span class="p">,</span>
      <span class="nt">&#34;settings&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;auth&#34;</span><span class="p">:</span> <span class="s2">&#34;noauth&#34;</span><span class="p">,</span>
        <span class="nt">&#34;udp&#34;</span><span class="p">:</span> <span class="kc">true</span>
      <span class="p">},</span>
      <span class="nt">&#34;sniffing&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;enabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nt">&#34;destOverride&#34;</span><span class="p">:</span> <span class="p">[</span>
          <span class="s2">&#34;fakedns&#34;</span>
        <span class="p">],</span>
        <span class="nt">&#34;metadataOnly&#34;</span><span class="p">:</span> <span class="kc">false</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">],</span>
  <span class="nt">&#34;outbounds&#34;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&#34;protocol&#34;</span><span class="p">:</span> <span class="s2">&#34;vless&#34;</span><span class="p">,</span>
      <span class="err">#</span> <span class="err">出口协议</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="nt">&#34;protocol&#34;</span><span class="p">:</span> <span class="s2">&#34;dns&#34;</span><span class="p">,</span>
      <span class="nt">&#34;tag&#34;</span><span class="p">:</span> <span class="s2">&#34;dns-out&#34;</span>
    <span class="p">}</span>
  <span class="p">],</span>
  <span class="nt">&#34;routing&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;rules&#34;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;field&#34;</span><span class="p">,</span>
        <span class="nt">&#34;inboundTag&#34;</span><span class="p">:</span> <span class="p">[</span>
          <span class="s2">&#34;dns-in&#34;</span>
        <span class="p">],</span>
        <span class="nt">&#34;outboundTag&#34;</span><span class="p">:</span> <span class="s2">&#34;dns-out&#34;</span>
      <span class="p">}</span>
    <span class="p">],</span>
    <span class="nt">&#34;strategy&#34;</span><span class="p">:</span> <span class="s2">&#34;rules&#34;</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></div>
<h4 id="iptables规则示例">iptables规则示例：</h4>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">iptables -t nat -N V2RAY
iptables -t nat -A V2RAY -d <span class="m">198</span>.18.0.0/15 -p tcp -j REDIRECT --to-ports <span class="m">12345</span>
iptables -t nat -A PREROUTING -p tcp -j V2RAY
iptables -t nat -A OUTPUT -p tcp -j V2RAY</code></pre></div>
<p>这一新方案通过Fake IP的代理机制成功解决了旧方案存在的问题，更加简洁高效。其中，v2ray的配置和iptables规则的设置使得整个方案在实践中更为可行和稳定。</p>

<h3 id="4-总结">4. 总结</h3>

<p>通过实践与不断的尝试，我们成功实现了一套高效、简洁的透明代理方案，让家中网络更具灵活性和隐私保护。通过采用Fake IP透明代理，我们解决了旧方案中存在的DNS查询速度、CDN网站不确定性等问题。新方案无需依赖繁杂的插件，通过手动配置即可轻松搭建。</p>

<p>这一方案的精髓在于利用v2ray的Fake DNS功能，将特定域名的DNS查询引导至Fake IP，进而实现透明代理。同时，通过iptables的规则设置，我们成功将流量重定向至代理，实现了透明代理的高效运作。这不仅提高了网络使用体验，同时也加强了网络隐私和安全。</p>

<p>这篇文章详细介绍了家庭网络的拓扑结构、IPv4与IPv6的配置以及三个阶段的透明代理方案演进。通过本文的分享，希望读者在搭建自己的透明代理方案时能够有所借鉴，更好地定制适合自己需求的网络环境。网络技术的不断发展，也让我们对未来的网络体验充满期待。</p>

<p>在科技的道路上，我们将不断追求创新，不断完善，让科技更好地服务于我们的生活。希望这篇文章对您有所启发，为您的网络探索之路提供一些有益的参考。</p>


</div>



<script src="https://utteranc.es/client.js"
  repo="zhu327/zhu327.github.io"
  issue-term="title"
  theme="github-light"
  crossorigin="anonymous"
  async>
</script>


      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>

