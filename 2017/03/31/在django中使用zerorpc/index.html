<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      在Django中使用zerorpc &middot; 跬步
    
  </title>

  
  <link rel="stylesheet" href="https://zhu327.github.io/css/poole.css">
  <link rel="stylesheet" href="https://zhu327.github.io/css/syntax.css">
  <link rel="stylesheet" href="https://zhu327.github.io/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://zhu327.github.io/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="https://zhu327.github.io/assets/favicon.ico">

  
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://zhu327.github.io/feed.xml">
</head>


  <body class="theme-base-0d">

    
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>My notes and thoughts.</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="https://zhu327.github.io/">Home</a>
    <a class="sidebar-nav-item " href="https://zhu327.github.io/post">Posts</a>
    <a class="sidebar-nav-item " href="https://zhu327.github.io/tags">Tags</a>

    
        <a class="sidebar-nav-item " href="https://zhu327.github.io/about/">About</a>

    <a class="sidebar-nav-item" href="https://github.com/zhu327" target="_blank">GitHub</a>
  </nav>

  <div class="sidebar-item">
    <p>&copy; 2020. All rights reserved.</p>
  </div>
</div>


    
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="https://zhu327.github.io/" title="Home">跬步</a>
            <small>On Coding</small>
          </h3>
        </div>
      </div>

      <div class="container content">


<div class="post">
  <h1 class="post-title">在Django中使用zerorpc</h1>
  <span class="post-date">Mar 31 2017</span>
  <h3 id="前言">前言</h3>

<p>随着系统架构从集中式单点服务器到分布式微服务方向的迁移,RPC是一个不可回避的话题.如何在系统中引入对开发者友好,性能可靠的RPC服务是一个值得深思的问题.</p>

<p>在调研了Thrift,gRPC,zerorpc等方案后,基于以下2点最后选择了zerorpc:</p>

<ul>
<li>Thrift,gRPC学习成本高,开发者需要重新定义返回结构增加了工作量</li>
<li>zerorpc完美契合Python,能快速开发,并且支持Node.js,适用于当前技术栈</li>
</ul>

<h3 id="问题">问题</h3>

<p>虽然zerorpc可以直接嵌入当前系统框架中,但是还是有一些问题需要去考虑解决</p>

<ul>
<li><p>rpc 接口如何定义</p></li>

<li><p>rpc 服务如何启动</p></li>

<li><p>高并发情况下客户端的可靠性</p></li>
</ul>

<p></p>

<h3 id="服务端">服务端</h3>

<p>在当前的系统中大量使用Celery,djang-celery定义Task的方式是在每个install app中定义<code>tasks.py</code>文件,然后通过<code>@task</code>装饰器来生成Task.所以这里为了方便定义rpc interface设计一套类似于Celery的规范.需要输出rpc interface的app下面创建<code>rpcs.py</code>文件</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># rpcs.py</span>
<span class="c1"># coding: utf-8</span>

<span class="kn">from</span> <span class="nn">eebo.core.utils.zrpc</span> <span class="kn">import</span> <span class="n">rpc</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Ticket</span>
<span class="kn">from</span> <span class="nn">.serializers</span> <span class="kn">import</span> <span class="n">TicketSerializer</span>


<span class="nd">@rpc.register</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">get_ticket</span><span class="p">():</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">Ticket</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">TicketSerializer</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">data</span>


<span class="nd">@rpc.register</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;ticket_list&#39;</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_tickets</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">qs</span> <span class="o">=</span> <span class="n">Ticket</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="nb">all</span><span class="p">()[:</span><span class="n">n</span><span class="p">]</span>
    <span class="n">s</span>  <span class="o">=</span> <span class="n">TicketSerializer</span><span class="p">(</span><span class="n">qs</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></code></pre></div>
<p><code>rpc.register</code>装饰器用来注册函数到rpc服务上,可选参数:</p>

<ul>
<li>name: 客户调用方法名称, 没有写的情况下就是func name如get_ticket</li>
<li>stream: 默认False, 如果为True, 则使用zerorpc的流式响应传输, 数据量比较大的情况时使用, 返回可迭代对象</li>
</ul>

<p>我们来看看<code>eebo.core.utils.zrpc</code>如何来实现这个注册过程:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># coding: utf-8</span>

<span class="kn">import</span> <span class="nn">zerorpc</span>


<span class="k">class</span> <span class="nc">RPC</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">_wrapper</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span> <span class="ow">or</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">zerorpc</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span> <span class="k">if</span> <span class="n">stream</span>
                    <span class="k">else</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">func</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">func</span>

        <span class="k">return</span> <span class="n">_wrapper</span>


<span class="n">rpc</span> <span class="o">=</span> <span class="n">RPC</span><span class="p">()</span></code></pre></div>
<p>通过一个类方法来往类上面绑定方法,需要注意的是<code>name</code>的定义必须是全局唯一的.</p>

<p>现在我们有了定义rpc interface的方法,下面来看看如何启动rpc server.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># runrpc.py</span>
<span class="c1"># coding: utf-8</span>

<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">imp</span> <span class="kn">as</span> <span class="nn">_imp</span>
<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.core.management.base</span> <span class="kn">import</span> <span class="n">BaseCommand</span><span class="p">,</span> <span class="n">CommandError</span>

<span class="kn">from</span> <span class="nn">eebo.core.utils.zrpc</span> <span class="kn">import</span> <span class="n">rpc</span><span class="p">,</span> <span class="n">ServerExecMiddleware</span>

<span class="n">naiveip_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="nb">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&#34;&#34;&#34;^(?:
</span><span class="s2">(?P&lt;addr&gt;
</span><span class="s2">    (?P&lt;ipv4&gt;\d{1,3}(?:\.\d{1,3}){3}) |         # IPv4 address
</span><span class="s2">    (?P&lt;ipv6&gt;\[[a-fA-F0-9:]+\]) |               # IPv6 address
</span><span class="s2">    (?P&lt;fqdn&gt;[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*) # FQDN
</span><span class="s2">):)?(?P&lt;port&gt;\d+)$&#34;&#34;&#34;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Command</span><span class="p">(</span><span class="n">BaseCommand</span><span class="p">):</span>
    <span class="n">help</span> <span class="o">=</span> <span class="s2">&#34;Starts a lightweight RPC server for development.&#34;</span>

    <span class="n">default_addr</span> <span class="o">=</span> <span class="s1">&#39;127.0.0.1&#39;</span>
    <span class="n">default_port</span> <span class="o">=</span> <span class="s1">&#39;4242&#39;</span>

    <span class="k">def</span> <span class="nf">add_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">):</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;addrport&#39;</span><span class="p">,</span>
                            <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Optional port number, or ipaddr:port&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">use_ipv6</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;addrport&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_port</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">naiveip_re</span><span class="p">,</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;addrport&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CommandError</span><span class="p">(</span><span class="s1">&#39;&#34;</span><span class="si">%s</span><span class="s1">&#34; is not a valid port number &#39;</span>
                                   <span class="s1">&#39;or address:port pair.&#39;</span> <span class="o">%</span>
                                   <span class="n">options</span><span class="p">[</span><span class="s1">&#39;addrport&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">_ipv4</span><span class="p">,</span> <span class="n">_ipv6</span><span class="p">,</span> <span class="n">_fqdn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">CommandError</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%r</span><span class="s2"> is not a valid port number.&#34;</span> <span class="o">%</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">_ipv6</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">use_ipv6</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_raw_ipv6</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_ipv6</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">_fqdn</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">CommandError</span><span class="p">(</span><span class="s1">&#39;&#34;</span><span class="si">%s</span><span class="s1">&#34; is not a valid IPv6 address.&#39;</span> <span class="o">%</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_addr_ipv6</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_ipv6</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_addr</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raw_ipv6</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_ipv6</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">**</span><span class="n">options</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="s2">&#34;&#34;&#34;Run the server, using the autoreloader if needed.&#34;&#34;&#34;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">autodiscover_rpc</span><span class="p">()</span>

        <span class="n">server</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_server</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">server</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="n">server</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">autodiscover_rpc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;rpcs&#39;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">pkg</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">INSTALLED_APPS</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pkg_path</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">pkg</span><span class="p">)</span><span class="o">.</span><span class="n">__path__</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">_imp</span><span class="o">.</span><span class="n">find_module</span><span class="p">(</span><span class="n">related_name</span><span class="p">,</span> <span class="n">pkg_path</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="s1">&#39;{0}.{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">related_name</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">get_server</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="s2">&#34;&#34;&#34;Return the default zerorpc server for the runner.&#34;&#34;&#34;</span>
        <span class="kn">import</span> <span class="nn">zerorpc</span>
        <span class="n">server</span> <span class="o">=</span> <span class="n">zerorpc</span><span class="o">.</span><span class="n">Server</span><span class="p">(</span><span class="n">rpc</span><span class="p">,</span> <span class="n">heartbeat</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
        <span class="n">server</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&#34;tcp://{0}:{1}&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
        <span class="c1"># close django old connections</span>
        <span class="n">zerorpc</span><span class="o">.</span><span class="n">Context</span><span class="o">.</span><span class="n">get_instance</span><span class="p">()</span><span class="o">.</span><span class="n">register_middleware</span><span class="p">(</span><span class="n">ServerExecMiddleware</span><span class="p">())</span>

        <span class="c1"># for sentry</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">raven.contrib.zerorpc</span> <span class="kn">import</span> <span class="n">SentryMiddleware</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s1">&#39;RAVEN_CONFIG&#39;</span><span class="p">):</span>
                <span class="n">sentry</span> <span class="o">=</span> <span class="n">SentryMiddleware</span><span class="p">(</span><span class="n">hide_zerorpc_frames</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                          <span class="n">dsn</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">RAVEN_CONFIG</span><span class="p">[</span><span class="s1">&#39;dsn&#39;</span><span class="p">])</span>
                <span class="n">zerorpc</span><span class="o">.</span><span class="n">Context</span><span class="o">.</span><span class="n">get_instance</span><span class="p">()</span><span class="o">.</span><span class="n">register_middleware</span><span class="p">(</span><span class="n">sentry</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">return</span> <span class="n">server</span></code></pre></div>
<p><code>runrpc.py</code>是一个Django management commands 文件需要放到某个install app目录的<code>management/commands</code>下面,启动服务器:</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">python manage.py runrpc <span class="m">0</span>.0.0.0:4242</code></pre></div>
<ul>
<li><code>autodiscover_rpc</code> 自动发现rpc interface注册函数</li>
<li><code>get_server</code> 生成zerorpc server对象</li>
</ul>

<p>在<code>get_server</code>中对zerorpc注册了2个中间件,<code>SentryMiddleware</code>用于捕获rpc interface抛出的异常发送到sentry,<code>ServerExecMiddleware</code>用于处理Django db connection,看看代码:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># zrpc.py</span>
<span class="c1"># coding: utf-8</span>

<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">close_old_connections</span>

<span class="k">class</span> <span class="nc">ServerExecMiddleware</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">server_before_exec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_event</span><span class="p">):</span>
        <span class="n">close_old_connections</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">server_after_exec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_event</span><span class="p">,</span> <span class="n">reply_event</span><span class="p">):</span>
        <span class="n">close_old_connections</span><span class="p">()</span></code></pre></div>
<p>在每个rpc interface被调用前与调用后都调用<code>close_old_connections</code>关闭db connection,这里是为了实现<code>django.db</code>中对请求处理前与处理后注册信号:</p>

<p><code>django.db.__init__.py</code></p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">signals</span><span class="o">.</span><span class="n">request_started</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">close_old_connections</span><span class="p">)</span>
<span class="n">signals</span><span class="o">.</span><span class="n">request_finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">close_old_connections</span><span class="p">)</span></code></pre></div>
<p>目的是保证在rpc interface中使用ORM时,connection没有超时断开.</p>

<h3 id="客户端">客户端</h3>

<p>由于rpc的调用是阻塞的,不能全局只创建一个client.但是也不能每个请求都创建client,所以这里参考<code>redis-py</code>的client实现,定义一个支持连接池的zerorpc client.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># zrpc.py</span>
<span class="c1"># coding: utf-8</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">zerorpc</span>

<span class="kn">from</span> <span class="nn">redis.connection</span> <span class="kn">import</span> <span class="n">BlockingConnectionPool</span>
<span class="kn">from</span> <span class="nn">gevent.queue</span> <span class="kn">import</span> <span class="n">LifoQueue</span>

<span class="k">class</span> <span class="nc">Connection</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connect_to</span><span class="p">,</span> <span class="n">heartbeat</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">zerorpc</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span><span class="n">heartbeat</span><span class="o">=</span><span class="n">heartbeat</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">connect_to</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">RPCClient</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connect_to</span><span class="p">,</span> <span class="n">heartbeat</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection_pool</span> <span class="o">=</span> <span class="n">BlockingConnectionPool</span><span class="p">(</span><span class="n">connection_class</span><span class="o">=</span><span class="n">Connection</span><span class="p">,</span>
            <span class="n">queue_class</span><span class="o">=</span><span class="n">LifoQueue</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">heartbeat</span><span class="p">,</span> <span class="n">connect_to</span><span class="o">=</span><span class="n">connect_to</span><span class="p">,</span> <span class="n">heartbeat</span><span class="o">=</span><span class="n">heartbeat</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection_pool</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="bp">self</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection_pool</span><span class="o">.</span><span class="n">get_connection</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">client</span><span class="p">,</span> <span class="n">name</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connection_pool</span><span class="o">.</span><span class="n">release</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span></code></pre></div>
<p>这里直接复用了<code>redis-py</code>定义的连接池,当前系统使用gunicorn + gevent的方式启动Django服务,所以<code>queue_class</code>使用了gevent的<code>LifoQueue</code>.</p>

<p>在使用过程中还发现了这个问题:</p>

<blockquote>
<p><a href="https://github.com/0rpc/zerorpc-python/issues/123">https://github.com/0rpc/zerorpc-python/issues/123</a></p>
</blockquote>

<p>需要打个补丁解决:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">zmq.green</span> <span class="kn">as</span> <span class="nn">zmq</span>

<span class="c1"># patch zmq garbage-collection Thread to use green Context:</span>
<span class="kn">from</span> <span class="nn">zmq.utils.garbage</span> <span class="kn">import</span> <span class="n">gc</span>
<span class="n">gc</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span></code></pre></div>
<h3 id="总结">总结</h3>

<p>技术的选型需要契合项目实际情况,不要盲目上新技术引入不必要的成本.为了推广方案,必须全局的考虑方案是否易使用,是否易部署.</p>

<p>完整代码:</p>

<blockquote>
<p><a href="https://gist.github.com/zhu327/5b6c06eccc5758d4e642ee899a518687">https://gist.github.com/zhu327/5b6c06eccc5758d4e642ee899a518687</a></p>
</blockquote>


</div>



<script src="https://utteranc.es/client.js"
  repo="zhu327/zhu327.github.io"
  issue-term="og:title"
  theme="github-light"
  crossorigin="anonymous"
  async>
</script>


      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>

