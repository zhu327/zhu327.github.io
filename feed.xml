<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
      <title>跬步 On Coding </title>
      <generator uri="https://gohugo.io">Hugo</generator>
    <link>https://zhu327.github.io/</link>
    <language>zh-cn</language>
    
    
    <updated>Sun, 30 Nov 2025 10:00:00 &#43;0800</updated>
    
    <item>
      <title>AI Agent 工程化实践：从 Prompt 到 Context 的思维转变</title>
      <link>https://zhu327.github.io/2025/11/30/ai-agent-%E5%B7%A5%E7%A8%8B%E5%8C%96%E5%AE%9E%E8%B7%B5%E4%BB%8E-prompt-%E5%88%B0-context-%E7%9A%84%E6%80%9D%E7%BB%B4%E8%BD%AC%E5%8F%98/</link>
      <pubDate>Sun, 30 Nov 2025 10:00:00 &#43;0800</pubDate>
      
      <guid>https://zhu327.github.io/2025/11/30/ai-agent-%E5%B7%A5%E7%A8%8B%E5%8C%96%E5%AE%9E%E8%B7%B5%E4%BB%8E-prompt-%E5%88%B0-context-%E7%9A%84%E6%80%9D%E7%BB%B4%E8%BD%AC%E5%8F%98/</guid>
      <description>&lt;p&gt;最近在新公司这边，大部分精力都耗在了 AI Agent 的落地应用上。大家都在谈 Agent，网上的 Demo 也是满天飞，但当你真正把这玩意儿往生产环境搬的时候，会发现完全是两码事。&lt;/p&gt;

&lt;p&gt;简单的说，AI Agent 的核心逻辑其实并不复杂，本质上就是一个基于 ReAct（Reasoning and Acting）范式的工程结构，程序在一个死循环里不断地调用 LLM 的 API，让它根据当前的观测去决策下一步是思考还是行动。&lt;/p&gt;

&lt;p&gt;起初我也觉得这就跟写个脚本差不多，但在实际调试过程中，我发现让 Agent “跑通”不难，但要让它“跑好”、“省钱”且“不犯蠢”，这里面全是工程细节。我也复盘了一下这段时间的踩坑经历，总结了一些在工程实践中的“巧思”。&lt;/p&gt;

&lt;p&gt;&lt;/p&gt;

&lt;h3 id=&#34;遇到的瓶颈&#34;&gt;遇到的瓶颈&lt;/h3&gt;

&lt;p&gt;在项目初期，我碰到的最大痛点就是 &lt;strong&gt;Token 的消耗&lt;/strong&gt; 和 &lt;strong&gt;上下文窗口（Context Window）的限制&lt;/strong&gt;。&lt;/p&gt;

&lt;p&gt;Agent 运行起来后，为了保证它能记住之前的操作，我们往往会把历史对话一股脑地塞进 Prompt 里。但随着交互轮数的增加，上下文会迅速膨胀。这不仅烧钱（Token 费很贵），更要命的是，当无关信息太多时，LLM 的注意力会被稀释，导致它开始“幻觉”或者逻辑混乱，也就是我们常说的“变笨了”。&lt;/p&gt;

&lt;p&gt;为了解决这个问题，我开始从工程角度去干预 Agent 的记忆机制，我发现单纯的 Prompt Engineering 已经不够用了，我们需要进阶到 &lt;strong&gt;Context Engineering（上下文工程）&lt;/strong&gt;。&lt;/p&gt;

&lt;h3 id=&#34;几个工程化的巧思&#34;&gt;几个工程化的巧思&lt;/h3&gt;

&lt;p&gt;针对上下文过载和执行效率低的问题，我在工程实践中尝试了以下几个优化策略，效果还不错：&lt;/p&gt;

&lt;h4 id=&#34;1-动态整理与压缩上下文&#34;&gt;1. 动态整理与压缩上下文&lt;/h4&gt;

&lt;p&gt;这招主要是应对“记不住”的问题。当对话轮数逼近模型的 Context 上限时，如果直接截断最早的记录，Agent 可能会丢失关键的任务背景。&lt;/p&gt;

&lt;p&gt;我的做法是，在检测到 Token 数快到阈值时，触发一个后台任务，让 LLM 自己对之前的多轮对话做一个动态整理（Summary）。&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;输入&lt;/strong&gt;：过去 N 轮的详细对话。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;输出&lt;/strong&gt;：提取出“用户的核心诉求”、“已完成的关键步骤”和“当前获得的中间结果”。&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;用这段高密度的摘要替换掉那 N 轮冗长的对话。这样既大幅减少了 Token 量，又确保了历史关键信息得以保存，让 Agent 始终记得“我是谁，我在哪，我要干什么”。&lt;/p&gt;

&lt;h4 id=&#34;2-checkpoint-回溯与有效信息保留&#34;&gt;2. Checkpoint 回溯与有效信息保留&lt;/h4&gt;

&lt;p&gt;Agent 在尝试调用工具时，并不总是成功的。有时候它参数传错了，有时候 API 报错了。在标准的 ReAct 循环里，这些报错信息（Error Logs）会被完整地记录在上下文里。&lt;/p&gt;

&lt;p&gt;这就导致一个问题：如果 Agent 试错了好几次才成功，那上下文里会充斥着大量的垃圾报错信息。这些信息对于后续的决策不仅无用，反而可能误导模型。&lt;/p&gt;

&lt;p&gt;这里我引入了一个类似游戏存档的 &lt;strong&gt;Checkpoint（检查点）&lt;/strong&gt; 机制。&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;在执行关键动作前，系统会自动保存当前的上下文快照。&lt;/li&gt;
&lt;li&gt;当检测到 Agent 陷入死循环或产生大量无效交互时，系统会强制回滚到上一个 Checkpoint。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;关键点&lt;/strong&gt;：回溯不是简单的“读档重来”，我们会通过规则提取出刚才试错过程中产生的“有效信息”（比如“某个参数验证失败”的结论），将其注入到回溯后的上下文中。&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;这样既清洗了上下文中的噪音，又保留了试错的价值，避免 Agent 在同一个坑里跌倒两次。&lt;/p&gt;

&lt;h4 id=&#34;3-sub-agent-解决上下文隔离&#34;&gt;3. Sub Agent 解决上下文隔离&lt;/h4&gt;

&lt;p&gt;在某些场景下，Agent 需要执行非常复杂的子任务，比如写一段 Python 代码并执行，或者进行复杂的数据清洗。&lt;/p&gt;

&lt;p&gt;如果把这些子任务的所有中间步骤都塞进主线程的上下文（Main Context），瞬间就会把 Token 撑爆。我的解决思路是引入 &lt;strong&gt;Sub Agent（子智能体）&lt;/strong&gt;：&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;把复杂任务分发给一个独立的 Sub Agent。&lt;/li&gt;
&lt;li&gt;Sub Agent 拥有独立的上下文空间，它可以在里面进行多轮的思考、调试、修正。&lt;/li&gt;
&lt;li&gt;当 Sub Agent 任务完成后，只提取“最终结果”返回给主 Agent。&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;通过这种方式，我们实现了上下文的物理隔离，主 Agent 的视野始终保持清爽，只关注宏观流程，而细节则由 Sub Agent 屏蔽。&lt;/p&gt;

&lt;h4 id=&#34;4-面向-人-设计工具-而非面向-api&#34;&gt;4. 面向“人”设计工具，而非面向 API&lt;/h4&gt;

&lt;p&gt;这一点是我觉得思维层次提升最大的地方。&lt;/p&gt;

&lt;p&gt;最初给 Agent 设计工具时，我习惯直接把后端的原子 API 扔给它，比如 &lt;code&gt;login()&lt;/code&gt;, &lt;code&gt;get_token()&lt;/code&gt;, &lt;code&gt;get_user_info()&lt;/code&gt;。结果就是 Agent 完成一个简单的查用户信息，需要来回跑三趟。&lt;/p&gt;

&lt;p&gt;后来我意识到，Agent 使用工具的逻辑应该更像“人”使用 app。工具的设计粒度应该更粗。我们将多个原子 API 组合封装成一个面向业务场景的高阶工具。这样一次调用就能搞定，减少了 Agent 的交互流程，容错率也大大提升。&lt;/p&gt;

&lt;h3 id=&#34;总结-从-prompt-到-context&#34;&gt;总结：从 Prompt 到 Context&lt;/h3&gt;

&lt;p&gt;回顾这些优化点，我们可以发现，提升 Agent 能力的关键，不仅仅在于你 Prompt 写得有多花哨，更在于你如何管理它所能看到的“世界”。&lt;/p&gt;

&lt;p&gt;让我们来总结下这里的思维层次：&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;第一层（Prompt Engineering）&lt;/strong&gt;：专注于怎么把 Prompt 词写好，试图用一段话把所有要求都告诉 AI。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;第二层（RAG / Memory）&lt;/strong&gt;：开始给 AI 外挂数据库，解决知识库的问题。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;第三层（Context Engineering）&lt;/strong&gt;：把上下文看作一种稀缺的计算资源，通过动态压缩、Checkpoint 回溯、Sub Agent 隔离等工程手段，动态地管理 AI 的注意力。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;第四层（Architecture Design）&lt;/strong&gt;：从单点优化走向系统设计，构建一套具备自我纠错、状态管理、分层协作的智能体运行时环境。&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;以前做传统开发，我们优化的是 CPU 和内存；现在做 AI 开发，我们优化的其实是 Context Window 和 Token 效率。&lt;/p&gt;

&lt;p&gt;在这个技术日新月异的时代，作为程序员，我们不仅要会写代码，更要学会如何设计系统来弥补模型的短板。这些关于 Context 的巧思，其实就是把复杂的非结构化问题，通过工程手段变得有序化的过程。&lt;/p&gt;

&lt;p&gt;希望这些瞎絮叨的经验能对正在折腾 Agent 的你有那么一点点启发。2025 年了，保持学习，保持思考，依然是应对变化的唯一解法。&lt;/p&gt;</description>
    </item>
    
    <item>
      <title>系统性思维的陷阱：从“完美方案”到“有效落地”</title>
      <link>https://zhu327.github.io/2025/11/21/%E7%B3%BB%E7%BB%9F%E6%80%A7%E6%80%9D%E7%BB%B4%E7%9A%84%E9%99%B7%E9%98%B1%E4%BB%8E%E5%AE%8C%E7%BE%8E%E6%96%B9%E6%A1%88%E5%88%B0%E6%9C%89%E6%95%88%E8%90%BD%E5%9C%B0/</link>
      <pubDate>Fri, 21 Nov 2025 10:00:52 &#43;0800</pubDate>
      
      <guid>https://zhu327.github.io/2025/11/21/%E7%B3%BB%E7%BB%9F%E6%80%A7%E6%80%9D%E7%BB%B4%E7%9A%84%E9%99%B7%E9%98%B1%E4%BB%8E%E5%AE%8C%E7%BE%8E%E6%96%B9%E6%A1%88%E5%88%B0%E6%9C%89%E6%95%88%E8%90%BD%E5%9C%B0/</guid>
      <description>&lt;p&gt;我做程序员已经 10 多年了。&lt;/p&gt;

&lt;p&gt;回想刚入行那会儿，我的思维模式很简单：产品经理提什么，我就做什么。那时候追求的是“短平快”，像个执行指令的机器，代码写得快就是牛。&lt;/p&gt;

&lt;p&gt;后来加入了腾讯，随着职级的提升，负责的系统越来越复杂，我开始意识到：写代码只是冰山一角，&lt;strong&gt;做方案才是真正的考验。&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;所谓的“系统性思维”，一度让我受益匪浅，但最近我发现，如果一旦陷入对“完美”的执念，系统性思维反而会成为阻碍项目落地的最大陷阱。今天想和大家聊聊，如何在架构设计、风险控制和实际落地之间找到那个微妙的平衡点。&lt;/p&gt;

&lt;p&gt;&lt;/p&gt;

&lt;h3 id=&#34;方案的本质-平衡客观条件的艺术&#34;&gt;方案的本质：平衡客观条件的艺术&lt;/h3&gt;

&lt;p&gt;什么是做方案？以前我觉得是画一张最漂亮的架构图，用最牛的组件。现在我理解，&lt;strong&gt;做方案其实是把各种“客观条件”作为输入，寻找最优解的过程。&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;这些客观条件包括：&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;硬件资源&lt;/strong&gt;：手头有多少服务器？&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;依赖组件&lt;/strong&gt;：公司基建支持什么？（比如你想用 ClickHouse，但公司运维没经验，出了问题没人兜底，那这就不是一个好选项，不如看看现有组件能不能替代。）&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;人力成本&lt;/strong&gt;：团队几个人？水平如何？&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;时间窗口&lt;/strong&gt;：业务等得起多久？&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;我见过很多“完美”的方案，逻辑自洽，架构优雅，但落地需要半年。而另一个方案虽然略显粗糙，但只需要 1 个月，且预留了后续演进的空间。在商业世界里，后者往往才是胜者。&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;架构不是设计出来的，是演进出来的。&lt;/strong&gt; 我们需要做的是调整各种客观条件的优先级，在风险可控的前提下，通过多方评审（集思广益，消除盲区），找到那个平衡点。&lt;/p&gt;

&lt;h3 id=&#34;实战案例-只解决-80-的问题&#34;&gt;实战案例：只解决 80% 的问题&lt;/h3&gt;

&lt;p&gt;分享一个我在腾讯做权限中心时的真实案例。&lt;/p&gt;

&lt;p&gt;当时我们面临一个痛点：有一个中心化的管理员，每天大量时间都在处理审批单，他一直在吐槽，希望把这些审批自动路由到对应的业务负责人，别全堆在他头上。&lt;/p&gt;

&lt;p&gt;我第一反应是：&lt;strong&gt;做不到。&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;从技术角度看，审批范围是一个复杂的表达式。要根据用户申请的数据去匹配这个表达式，没法直接做数据库索引。如果要实现，就得全表扫描进行遍历匹配，性能扛不住。而且，很多申请范围很模糊，根本匹配不到具体负责人，最后还是得兜底回落到管理员那里。&lt;/p&gt;

&lt;p&gt;于是这个需求被我挡回去了。后来问题太严重，捅到了上面。在复盘会上，我的 Leader 问了一句话，让我瞬间顿悟：&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;“能不能在只解决 80% 问题的前提下，来做这个方案？”&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;我突然意识到，我陷入了“完美主义”的陷阱。我一直在纠结那 20% 匹配不到的情况，却忽略了如果能自动化处理掉 80% 的单子，管理员的工作量就能大大减轻。&lt;/p&gt;

&lt;p&gt;于是我重新设计了方案：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;引入前置索引&lt;/strong&gt;：提取表达式中的关键特征做索引。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;允许降级&lt;/strong&gt;：能走索引匹配的先走索引，匹配不到的（那复杂的 20%），直接回退给中心管理员。&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;事实证明，方案落地后，管理员的压力骤减。这就告诉我：&lt;strong&gt;有时候真的没有完美的方案，只有平衡现状的方案。&lt;/strong&gt;&lt;/p&gt;

&lt;h3 id=&#34;开源代码的-神话-与重构&#34;&gt;开源代码的“神话”与重构&lt;/h3&gt;

&lt;p&gt;在阅读优秀开源项目代码时，我常有这种时刻：“哇塞，这代码写得太神了，连这种极端场景都想到了，作者是开了天眼吗？”&lt;/p&gt;

&lt;p&gt;随着我自己经验的增长，我发现所谓的“神人”并没有那么玄乎。&lt;/p&gt;

&lt;p&gt;他能考虑到那个场景，很可能只是因为他&lt;strong&gt;踩过那个坑&lt;/strong&gt;。&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;版本 1.0 可能是个草台班子。&lt;/li&gt;
&lt;li&gt;版本 2.0 修复了几个致命 Bug（踩坑）。&lt;/li&gt;
&lt;li&gt;版本 3.0 因为补丁打多了，代码太烂，被迫重构，把之前的坑变成了新的设计约束。&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;我在腾讯的 6 年里，权限中心整体重构过 3 次，API 网关也重构过 3 次。每一次重构，都是因为旧的方案无法适应新的客观条件。&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;踩坑并不是坏事，失败也是财富。&lt;/strong&gt; 那些让你绞尽脑汁都想不到的 Edge Case，往往是别人血淋淋的经验积累。我们在做方案时，不要怕现在的方案未来会被推翻，&lt;strong&gt;只要预留了演进空间，现在的“不完美”就是未来能力的基石。&lt;/strong&gt;&lt;/p&gt;

&lt;h3 id=&#34;警惕-过度系统化-的僵局&#34;&gt;警惕“过度系统化”的僵局&lt;/h3&gt;

&lt;p&gt;我现在所在的公司，领导层是运维出身。运维思维和研发思维有一个本质的区别：&lt;strong&gt;运维天然厌恶风险（Risk Averse），而研发需要管理风险。&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;这就导致了一个尴尬的局面：
我提出了方案 A 来解决问题 A，但在评审会上，领导会挑战：“你这个方案没有解决问题 B 怎么办？有没有风险？”&lt;/p&gt;

&lt;p&gt;于是，技术评审会变成了“挑刺大会”。&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;为了应对领导的挑刺，我们被迫把方案搞得越来越复杂，试图覆盖所有角落。&lt;/li&gt;
&lt;li&gt;方案一复杂，落地难度就指数级上升。&lt;/li&gt;
&lt;li&gt;最终结果是：动作变形，无法落地，不了了之。&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;组内甚至有同事因为方案迟迟推不动，最后无奈活水走人。&lt;/p&gt;

&lt;p&gt;这种&lt;strong&gt;过度系统化&lt;/strong&gt;的思考方式，实际上是一种&lt;strong&gt;停滞&lt;/strong&gt;。领导当然需要系统性思考，但如果一直纠结于“一步到位”的完美方案，就会导致方案根本不具备可行性。&lt;/p&gt;

&lt;h3 id=&#34;我的应对策略-最小化闭环&#34;&gt;我的应对策略：最小化闭环&lt;/h3&gt;

&lt;p&gt;面对这种环境，如果硬刚，很容易陷入内耗。我的应对方法是：&lt;strong&gt;MVP（Minimum Viable Product）策略 + 工具提效。&lt;/strong&gt;&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;把方案切得足够小&lt;/strong&gt;：不要试图画一张大饼，而是聚焦当前最核心的痛点。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;快速跑通 PoC（概念验证）&lt;/strong&gt;：与其在会议室争论风险，不如直接把代码跑起来，让领导看到可视化的成果。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;利用 AI 提效&lt;/strong&gt;：为了不让自己太累，我现在大量使用 AI 编程工具。它可以帮我快速生成原型代码，大大缩短从“想法”到“演示”的时间。&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;虽然这样做确实会累一点（因为要先斩后奏，自己承担一部分验证成本），但在“不做不错”和“艰难推进”之间，我选择后者。&lt;/p&gt;

&lt;h3 id=&#34;写在最后&#34;&gt;写在最后&lt;/h3&gt;

&lt;p&gt;系统性思维是好东西，它让我们思考得更全面。但我们不能让系统性思维成为&lt;strong&gt;阻碍系统发展&lt;/strong&gt;的借口。&lt;/p&gt;

&lt;p&gt;做方案，本质上是在&lt;strong&gt;不确定性中寻找确定性&lt;/strong&gt;。&lt;/p&gt;

&lt;p&gt;既要有思维高度，也要有“先解决当下问题”的务实态度。不要害怕方案不完美，&lt;strong&gt;只要控制好风险，让系统转起来，剩下的，交给时间去演进。&lt;/strong&gt;&lt;/p&gt;</description>
    </item>
    
    <item>
      <title>pingsix-ingress-controller启动</title>
      <link>https://zhu327.github.io/2025/10/20/pingsix-ingress-controller%E5%90%AF%E5%8A%A8/</link>
      <pubDate>Mon, 20 Oct 2025 10:00:52 &#43;0800</pubDate>
      
      <guid>https://zhu327.github.io/2025/10/20/pingsix-ingress-controller%E5%90%AF%E5%8A%A8/</guid>
      <description>&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/zhu327/pingsix&#34;&gt;https://github.com/zhu327/pingsix&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;PingSIX 自从上次重构之后, 我一直在考虑如何扩展这个项目的功能与使用场景, 有2个方向可以考虑:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;支持proxy-wasm插件&lt;/li&gt;
&lt;li&gt;实现pingsix-ingress-controller&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;在调研了proxy-wasm的相关功能后, 结论是由于pingora面向的场景是CDN的反向代理, 所以没有考虑过方便的修改请求体与响应体, 这就造成很难基于pingora来实现proxy-wasm的ABI, 如果我要自己定义一个wasm的接口协议, 没法复用社区现有的proxy-wasm插件, 那就没必要了, 不如直接写Rust的插件. 相关参考内容:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/cloudflare/pingora/issues/17&#34;&gt;proxy-wasm support&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://segmentfault.com/a/1190000045232953&#34;&gt;pingora 能做什么和不能做什么&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;在放弃了proxy-wasm的支持后, 我开始调研如何实现pingsix-ingress-controller, 由于pingsix的的资源定义是参考apisix来实现的, 所以就直接参考&lt;a href=&#34;https://github.com/apache/apisix-ingress-controller&#34;&gt;apisix-ingress-controller&lt;/a&gt;来实现我们自己的&lt;a href=&#34;https://github.com/zhu327/pingsix-ingress-controller&#34;&gt;pingsix-ingress-controller&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;/p&gt;

&lt;h3 id=&#34;1-apisix-ingress-controller架构&#34;&gt;1. apisix-ingress-controller架构&lt;/h3&gt;

&lt;p&gt;&lt;img src=&#34;https://github.com/user-attachments/assets/1ecf116a-378f-4357-a597-5bafb56991fd&#34; alt=&#34;Image1&#34; width=&#34;700px&#34; /&gt;&lt;/p&gt;

&lt;h4 id=&#34;1-k8s-resources-watch-layer-资源监听层&#34;&gt;1. K8s Resources Watch Layer (资源监听层)&lt;/h4&gt;

&lt;ul&gt;
&lt;li&gt;各种Controller通过Kubernetes的Watch机制监听对应的资源变化&lt;/li&gt;
&lt;li&gt;支持的资源类型包括：

&lt;ul&gt;
&lt;li&gt;Gateway API: HTTPRoute, Gateway, GRPCRoute, TCPRoute, UDPRoute, TLSRoute&lt;/li&gt;
&lt;li&gt;Kubernetes原生: Ingress, IngressClass&lt;/li&gt;
&lt;li&gt;APISIX CRD: ApisixRoute, ApisixGlobalRule, ApisixTls, ApisixConsumer, ApisixUpstream&lt;/li&gt;
&lt;li&gt;自定义: Consumer, GatewayProxy&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&#34;2-provider-layer-提供者层&#34;&gt;2. Provider Layer (提供者层)&lt;/h4&gt;

&lt;ul&gt;
&lt;li&gt;Provider接收Controller的Update/Delete请求&lt;/li&gt;
&lt;li&gt;TranslateContext收集所有依赖资源（Services, Secrets, EndpointSlices等）&lt;/li&gt;
&lt;li&gt;为Translator提供完整的上下文信息&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&#34;3-translator-layer-翻译层&#34;&gt;3. Translator Layer (翻译层)&lt;/h4&gt;

&lt;ul&gt;
&lt;li&gt;将K8s资源翻译成ADC资源描述&lt;/li&gt;
&lt;li&gt;每种资源类型都有对应的Translator方法&lt;/li&gt;
&lt;li&gt;输出TranslateResult，包含：

&lt;ul&gt;
&lt;li&gt;Services (路由规则)&lt;/li&gt;
&lt;li&gt;SSL/TLS (证书)&lt;/li&gt;
&lt;li&gt;Consumers (消费者)&lt;/li&gt;
&lt;li&gt;GlobalRules (全局规则)&lt;/li&gt;
&lt;li&gt;PluginMetadata (插件元数据)&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&#34;4-adc-client-layer-adc客户端层&#34;&gt;4. ADC Client Layer (ADC客户端层)&lt;/h4&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;ConfigManager&lt;/strong&gt;: 管理多个GatewayProxy的配置&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Store/MemDB&lt;/strong&gt;: 内存数据库，存储ADC资源状态&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;StoreDelta&lt;/strong&gt;: 对比新旧配置，计算差异&lt;/li&gt;
&lt;li&gt;将变更任务传递给Executor执行&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&#34;5-adc-executor-interface-执行器接口&#34;&gt;5. ADC Executor Interface (执行器接口)&lt;/h4&gt;

&lt;p&gt;ADC Executor提供统一的Execute接口，支持三种实现：&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;HTTPADCExecutor&lt;/strong&gt;: 通过HTTP调用ADC Server（推荐方式）&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;DefaultADCExecutor&lt;/strong&gt;: 通过命令行调用adc命令&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&#34;6-adc-http-server-adc-http服务器&#34;&gt;6. ADC HTTP Server (ADC HTTP服务器)&lt;/h4&gt;

&lt;p&gt;ADC HTTP Server的核心流程：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;接收&lt;code&gt;/sync&lt;/code&gt;端点的PUT请求&lt;/li&gt;
&lt;li&gt;解析ADCServerRequest（包含opts和config）&lt;/li&gt;
&lt;li&gt;根据label-selector从APISIX拉取现有资源&lt;/li&gt;
&lt;li&gt;将ADC资源描述转换为APISIX资源格式&lt;/li&gt;
&lt;li&gt;对比已拉取的资源，计算差异（Diff）&lt;/li&gt;
&lt;li&gt;调用APISIX Admin API执行创建/更新/删除操作&lt;/li&gt;
&lt;li&gt;返回SyncResult（包含成功/失败状态）&lt;/li&gt;
&lt;/ol&gt;

&lt;h4 id=&#34;7-apisix-data-plane-apisix数据平面&#34;&gt;7. APISIX Data Plane (APISIX数据平面)&lt;/h4&gt;

&lt;p&gt;最终在APISIX中创建/更新/删除的资源：&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Routes (路由)&lt;/li&gt;
&lt;li&gt;Services (服务)&lt;/li&gt;
&lt;li&gt;Upstreams (上游)&lt;/li&gt;
&lt;li&gt;SSL/TLS (证书)&lt;/li&gt;
&lt;li&gt;Consumers (消费者)&lt;/li&gt;
&lt;li&gt;Global Rules (全局规则)&lt;/li&gt;
&lt;li&gt;Plugin Metadata (插件元数据)&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&#34;8-核心特性&#34;&gt;8. 核心特性&lt;/h4&gt;

&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;多GatewayProxy支持&lt;/strong&gt;: 通过ConfigManager管理多个APISIX实例的配置&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Label Selector&lt;/strong&gt;: 支持通过标签选择器过滤资源&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;增量同步&lt;/strong&gt;: 通过MemDB对比差异，只同步变更的资源&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;错误处理&lt;/strong&gt;: 完善的错误收集和状态更新机制&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;灵活的执行方式&lt;/strong&gt;: 支持HTTP、命令行多种执行模式&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;资源隔离&lt;/strong&gt;: 通过label实现不同资源的隔离和管理&lt;/li&gt;
&lt;/ol&gt;

&lt;h3 id=&#34;2-apisix-ingress-controller的经验&#34;&gt;2. apisix-ingress-controller的经验&lt;/h3&gt;

&lt;p&gt;虽然以前也写过一些operator的代码, 但是在学习apisix-ingress-controller代码的过程中, 我还是学到了一些新的东西, 在controller watch一类资源的时候, 我们可以watch所有关联的资源类型, 一旦这些关联的资源类型有变更, 就可以进入统一的变更流程, 这样就减少了我们写controller的逻辑复杂度, 所有的关联资源的变更都会触发主资源的更新.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-golang&#34; data-lang=&#34;golang&#34;&gt;&lt;span class=&#34;c1&#34;&gt;// SetupWithManager sets up the controller with the Manager.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;IngressReconciler&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;SetupWithManager&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;mgr&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;ctrl&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Manager&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;error&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;genericEvent&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;make&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;chan&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;event&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;GenericEvent&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;100&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;

	&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;ctrl&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;NewControllerManagedBy&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;mgr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;).&lt;/span&gt;
		&lt;span class=&#34;nx&#34;&gt;For&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;networkingv1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Ingress&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{},&lt;/span&gt;
			&lt;span class=&#34;nx&#34;&gt;builder&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;WithPredicates&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
				&lt;span class=&#34;nx&#34;&gt;MatchesIngressClassPredicate&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Client&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Log&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;
			&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;
		&lt;span class=&#34;p&#34;&gt;).&lt;/span&gt;
		&lt;span class=&#34;nx&#34;&gt;WithEventFilter&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
			&lt;span class=&#34;nx&#34;&gt;predicate&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Or&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
				&lt;span class=&#34;nx&#34;&gt;predicate&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;GenerationChangedPredicate&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{},&lt;/span&gt;
				&lt;span class=&#34;nx&#34;&gt;predicate&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;AnnotationChangedPredicate&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{},&lt;/span&gt;
				&lt;span class=&#34;nx&#34;&gt;predicate&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;NewPredicateFuncs&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;TypePredicate&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;corev1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Secret&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]()),&lt;/span&gt;
			&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;
		&lt;span class=&#34;p&#34;&gt;).&lt;/span&gt;
		&lt;span class=&#34;nx&#34;&gt;Watches&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
			&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;networkingv1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;IngressClass&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{},&lt;/span&gt;
			&lt;span class=&#34;nx&#34;&gt;handler&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;EnqueueRequestsFromMapFunc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;listIngressForIngressClass&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;
			&lt;span class=&#34;nx&#34;&gt;builder&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;WithPredicates&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
				&lt;span class=&#34;nx&#34;&gt;predicate&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;NewPredicateFuncs&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;matchesIngressController&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;
			&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;
		&lt;span class=&#34;p&#34;&gt;).&lt;/span&gt;
		&lt;span class=&#34;nx&#34;&gt;Watches&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
			&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;discoveryv1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;EndpointSlice&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{},&lt;/span&gt;
			&lt;span class=&#34;nx&#34;&gt;handler&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;EnqueueRequestsFromMapFunc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;listIngressesByService&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;
		&lt;span class=&#34;p&#34;&gt;).&lt;/span&gt;
		&lt;span class=&#34;nx&#34;&gt;Watches&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
			&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;corev1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Secret&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{},&lt;/span&gt;
			&lt;span class=&#34;nx&#34;&gt;handler&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;EnqueueRequestsFromMapFunc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;listIngressesBySecret&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;
		&lt;span class=&#34;p&#34;&gt;).&lt;/span&gt;
		&lt;span class=&#34;nx&#34;&gt;Watches&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;v1alpha1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;BackendTrafficPolicy&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{},&lt;/span&gt;
			&lt;span class=&#34;nx&#34;&gt;handler&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;EnqueueRequestsFromMapFunc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;listIngressForBackendTrafficPolicy&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;
			&lt;span class=&#34;nx&#34;&gt;builder&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;WithPredicates&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
				&lt;span class=&#34;nx&#34;&gt;BackendTrafficPolicyPredicateFunc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;genericEvent&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;
			&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;
		&lt;span class=&#34;p&#34;&gt;).&lt;/span&gt;
		&lt;span class=&#34;nx&#34;&gt;Watches&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;v1alpha1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;HTTPRoutePolicy&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{},&lt;/span&gt;
			&lt;span class=&#34;nx&#34;&gt;handler&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;EnqueueRequestsFromMapFunc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;listIngressesByHTTPRoutePolicy&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;
			&lt;span class=&#34;nx&#34;&gt;builder&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;WithPredicates&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;httpRoutePolicyPredicateFuncs&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;genericEvent&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)),&lt;/span&gt;
		&lt;span class=&#34;p&#34;&gt;).&lt;/span&gt;
		&lt;span class=&#34;nx&#34;&gt;Watches&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;v1alpha1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;GatewayProxy&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{},&lt;/span&gt;
			&lt;span class=&#34;nx&#34;&gt;handler&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;EnqueueRequestsFromMapFunc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;listIngressesForGatewayProxy&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;
		&lt;span class=&#34;p&#34;&gt;).&lt;/span&gt;
		&lt;span class=&#34;nx&#34;&gt;WatchesRawSource&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
			&lt;span class=&#34;nx&#34;&gt;source&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Channel&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
				&lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;genericEvent&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
				&lt;span class=&#34;nx&#34;&gt;handler&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;EnqueueRequestsFromMapFunc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;listIngressForGenericEvent&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;
			&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;
		&lt;span class=&#34;p&#34;&gt;).&lt;/span&gt;
		&lt;span class=&#34;nx&#34;&gt;Complete&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;IngressReconciler Watch 事件详解&lt;/p&gt;

&lt;p&gt;根据代码分析，&lt;code&gt;IngressReconciler&lt;/code&gt; 在 &lt;code&gt;SetupWithManager&lt;/code&gt; 方法中配置了多个 watch 事件。让我为您详细解释每个事件的作用和逻辑：&lt;/p&gt;

&lt;h4 id=&#34;1-主资源-watch-ingress-第70-81行&#34;&gt;1. &lt;strong&gt;主资源 Watch - Ingress&lt;/strong&gt; (第70-81行)&lt;/h4&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;nx&#34;&gt;For&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;networkingv1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Ingress&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{},&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;builder&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;WithPredicates&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;MatchesIngressClassPredicate&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Client&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Log&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;作用&lt;/strong&gt;：监听 Ingress 资源本身的变化&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Predicates（过滤条件）&lt;/strong&gt;：&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;MatchesIngressClassPredicate&lt;/code&gt;: 只处理由当前控制器管理的 IngressClass 的 Ingress&lt;/li&gt;
&lt;li&gt;&lt;code&gt;GenerationChangedPredicate&lt;/code&gt;: 资源的 Generation 发生变化（spec 修改）&lt;/li&gt;
&lt;li&gt;&lt;code&gt;AnnotationChangedPredicate&lt;/code&gt;: 注解发生变化&lt;/li&gt;
&lt;li&gt;&lt;code&gt;TypePredicate[*corev1.Secret]()&lt;/code&gt;: 用于 Secret 类型判断&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;逻辑&lt;/strong&gt;：这是主要的监听对象，当 Ingress 的规格或注解变化时触发 Reconcile&lt;/p&gt;

&lt;h4 id=&#34;2-ingressclass-watch-第82-88行&#34;&gt;2. &lt;strong&gt;IngressClass Watch&lt;/strong&gt; (第82-88行)&lt;/h4&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;nx&#34;&gt;Watches&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
    &lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;networkingv1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;IngressClass&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{},&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;handler&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;EnqueueRequestsFromMapFunc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;listIngressForIngressClass&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;builder&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;WithPredicates&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
        &lt;span class=&#34;nx&#34;&gt;predicate&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;NewPredicateFuncs&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;matchesIngressController&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;
    &lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;作用&lt;/strong&gt;：监听 IngressClass 资源的变化&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;触发条件&lt;/strong&gt;：&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;matchesIngressController&lt;/code&gt;: 只监听由当前控制器管理的 IngressClass（通过 &lt;code&gt;spec.controller&lt;/code&gt; 字段匹配）&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;逻辑&lt;/strong&gt; (&lt;code&gt;listIngressForIngressClass&lt;/code&gt;)：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;检查 IngressClass 是否是默认类（通过注解 &lt;code&gt;ingressclass.kubernetes.io/is-default-class&lt;/code&gt;）&lt;/li&gt;
&lt;li&gt;如果是默认类：列出所有未指定 IngressClassName 或指定为该类的 Ingress&lt;/li&gt;
&lt;li&gt;如果不是默认类：通过索引查找使用该 IngressClass 的所有 Ingress&lt;/li&gt;
&lt;li&gt;返回需要 reconcile 的 Ingress 列表&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;&lt;strong&gt;使用场景&lt;/strong&gt;：当 IngressClass 的配置变化时，需要重新处理所有使用该类的 Ingress&lt;/p&gt;

&lt;h4 id=&#34;3-endpointslice-watch-第89-92行&#34;&gt;3. &lt;strong&gt;EndpointSlice Watch&lt;/strong&gt; (第89-92行)&lt;/h4&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;nx&#34;&gt;Watches&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
    &lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;discoveryv1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;EndpointSlice&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{},&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;handler&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;EnqueueRequestsFromMapFunc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;listIngressesByService&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;作用&lt;/strong&gt;：监听后端服务的 Endpoint 变化&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;逻辑&lt;/strong&gt; (&lt;code&gt;listIngressesByService&lt;/code&gt;)：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;从 EndpointSlice 的 label 中提取 Service 名称（&lt;code&gt;discovery.k8s.io/service-name&lt;/code&gt;）&lt;/li&gt;
&lt;li&gt;通过索引 &lt;code&gt;ServiceIndexRef&lt;/code&gt; 查找引用该 Service 的所有 Ingress&lt;/li&gt;
&lt;li&gt;过滤出由当前控制器管理的 Ingress&lt;/li&gt;
&lt;li&gt;返回需要 reconcile 的 Ingress 列表&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;&lt;strong&gt;使用场景&lt;/strong&gt;：当后端 Pod 的 IP 地址变化（扩缩容、重启等）时，需要更新 APISIX 的 upstream 配置&lt;/p&gt;

&lt;h4 id=&#34;4-secret-watch-第93-96行&#34;&gt;4. &lt;strong&gt;Secret Watch&lt;/strong&gt; (第93-96行)&lt;/h4&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;nx&#34;&gt;Watches&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
    &lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;corev1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Secret&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{},&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;handler&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;EnqueueRequestsFromMapFunc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;listIngressesBySecret&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;作用&lt;/strong&gt;：监听 TLS 证书 Secret 的变化&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;逻辑&lt;/strong&gt; (&lt;code&gt;listIngressesBySecret&lt;/code&gt;)：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;通过索引 &lt;code&gt;SecretIndexRef&lt;/code&gt; 查找直接引用该 Secret 的 Ingress（TLS 配置）&lt;/li&gt;
&lt;li&gt;查找引用该 Secret 的 GatewayProxy（用于 provider 认证）&lt;/li&gt;
&lt;li&gt;如果 GatewayProxy 引用了该 Secret，找到使用该 GatewayProxy 的 IngressClass&lt;/li&gt;
&lt;li&gt;再找到使用这些 IngressClass 的所有 Ingress&lt;/li&gt;
&lt;li&gt;去重后返回所有需要 reconcile 的 Ingress&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;&lt;strong&gt;使用场景&lt;/strong&gt;：&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;TLS 证书更新或轮换&lt;/li&gt;
&lt;li&gt;GatewayProxy 的 AdminKey Secret 变化&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&#34;5-backendtrafficpolicy-watch-第97-102行&#34;&gt;5. &lt;strong&gt;BackendTrafficPolicy Watch&lt;/strong&gt; (第97-102行)&lt;/h4&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;nx&#34;&gt;Watches&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;v1alpha1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;BackendTrafficPolicy&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{},&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;handler&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;EnqueueRequestsFromMapFunc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;listIngressForBackendTrafficPolicy&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;builder&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;WithPredicates&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
        &lt;span class=&#34;nx&#34;&gt;BackendTrafficPolicyPredicateFunc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;genericEvent&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;
    &lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;作用&lt;/strong&gt;：监听后端流量策略的变化&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Predicates 逻辑&lt;/strong&gt;：&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Create&lt;/strong&gt;: 返回 true，新建时触发&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Delete&lt;/strong&gt;: 返回 true，删除时触发&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Update&lt;/strong&gt;: 检测 &lt;code&gt;targetRefs&lt;/code&gt; 的变化

&lt;ul&gt;
&lt;li&gt;找出被移除的 targetRefs&lt;/li&gt;
&lt;li&gt;将包含被移除 targetRefs 的旧对象发送到 genericEvent channel&lt;/li&gt;
&lt;li&gt;这样可以清理不再被引用的资源&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;逻辑&lt;/strong&gt; (&lt;code&gt;listIngressForBackendTrafficPolicy&lt;/code&gt;)：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;遍历 Policy 的所有 &lt;code&gt;targetRefs&lt;/code&gt;（引用的 Service）&lt;/li&gt;
&lt;li&gt;通过索引查找使用这些 Service 的 Ingress&lt;/li&gt;
&lt;li&gt;去重后返回需要 reconcile 的 Ingress 列表&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;&lt;strong&gt;使用场景&lt;/strong&gt;：配置后端流量策略（如负载均衡算法、健康检查等）&lt;/p&gt;

&lt;h4 id=&#34;6-httproutepolicy-watch-第103-106行&#34;&gt;6. &lt;strong&gt;HTTPRoutePolicy Watch&lt;/strong&gt; (第103-106行)&lt;/h4&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;nx&#34;&gt;Watches&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;v1alpha1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;HTTPRoutePolicy&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{},&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;handler&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;EnqueueRequestsFromMapFunc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;listIngressesByHTTPRoutePolicy&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;builder&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;WithPredicates&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;httpRoutePolicyPredicateFuncs&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;genericEvent&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)),&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;作用&lt;/strong&gt;：监听 HTTP 路由策略的变化&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Predicates 逻辑&lt;/strong&gt;：&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Create/Delete&lt;/strong&gt;: 返回 true&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Update&lt;/strong&gt;: 检测 &lt;code&gt;targetRefs&lt;/code&gt; 的变化

&lt;ul&gt;
&lt;li&gt;找出被移除的 targetRefs&lt;/li&gt;
&lt;li&gt;将包含被移除 targetRefs 的旧对象发送到 genericEvent channel&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;逻辑&lt;/strong&gt; (&lt;code&gt;listIngressesByHTTPRoutePolicy&lt;/code&gt;)：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;遍历 Policy 的所有 &lt;code&gt;targetRefs&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;过滤出 Kind 为 &lt;code&gt;Ingress&lt;/code&gt; 的引用&lt;/li&gt;
&lt;li&gt;获取这些 Ingress 对象&lt;/li&gt;
&lt;li&gt;返回需要 reconcile 的 Ingress 列表&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;&lt;strong&gt;使用场景&lt;/strong&gt;：配置 HTTP 路由级别的策略（如重写、重定向、超时等）&lt;/p&gt;

&lt;h4 id=&#34;7-gatewayproxy-watch-第107-109行&#34;&gt;7. &lt;strong&gt;GatewayProxy Watch&lt;/strong&gt; (第107-109行)&lt;/h4&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;nx&#34;&gt;Watches&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;v1alpha1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;GatewayProxy&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{},&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;handler&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;EnqueueRequestsFromMapFunc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;listIngressesForGatewayProxy&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;作用&lt;/strong&gt;：监听 GatewayProxy 配置的变化&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;逻辑&lt;/strong&gt; (&lt;code&gt;listIngressesForGatewayProxy&lt;/code&gt; -&amp;gt; &lt;code&gt;listIngressClassRequestsForGatewayProxy&lt;/code&gt;)：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;通过索引 &lt;code&gt;IngressClassParametersRef&lt;/code&gt; 查找引用该 GatewayProxy 的 IngressClass&lt;/li&gt;
&lt;li&gt;对每个 IngressClass，调用 &lt;code&gt;listIngressForIngressClass&lt;/code&gt; 获取相关 Ingress&lt;/li&gt;
&lt;li&gt;去重后返回所有需要 reconcile 的 Ingress&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;&lt;strong&gt;使用场景&lt;/strong&gt;：&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;GatewayProxy 的 APISIX 地址变化&lt;/li&gt;
&lt;li&gt;发布服务配置变化&lt;/li&gt;
&lt;li&gt;Provider 配置变化&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&#34;8-generic-event-channel-第110-116行&#34;&gt;8. &lt;strong&gt;Generic Event Channel&lt;/strong&gt; (第110-116行)&lt;/h4&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;nx&#34;&gt;WatchesRawSource&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;source&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Channel&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
        &lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;genericEvent&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
        &lt;span class=&#34;nx&#34;&gt;handler&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;EnqueueRequestsFromMapFunc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;listIngressForGenericEvent&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;
    &lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;作用&lt;/strong&gt;：处理通过 channel 发送的自定义事件&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;逻辑&lt;/strong&gt; (&lt;code&gt;listIngressForGenericEvent&lt;/code&gt;)：&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;根据对象类型路由到相应的处理函数：

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;BackendTrafficPolicy&lt;/code&gt; -&amp;gt; &lt;code&gt;listIngressForBackendTrafficPolicy&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;HTTPRoutePolicy&lt;/code&gt; -&amp;gt; &lt;code&gt;listIngressesByHTTPRoutePolicy&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;使用场景&lt;/strong&gt;：&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;处理 Policy 的 targetRefs 被移除时的清理工作&lt;/li&gt;
&lt;li&gt;确保当资源不再被引用时，能正确更新相关配置&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&#34;整体工作流程&#34;&gt;整体工作流程&lt;/h4&gt;

&lt;pre&gt;&lt;code&gt;1. 事件触发 → 2. Predicate 过滤 → 3. MapFunc 映射 → 4. Reconcile 队列 → 5. Reconcile 执行
&lt;/code&gt;&lt;/pre&gt;

&lt;h4 id=&#34;reconcile-主要步骤&#34;&gt;Reconcile 主要步骤：&lt;/h4&gt;

&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;获取 Ingress 对象&lt;/strong&gt;：如果不存在则执行删除逻辑&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;查找 IngressClass&lt;/strong&gt;：确定配置来源&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;处理 IngressClass Parameters&lt;/strong&gt;：加载 GatewayProxy 配置&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;处理 TLS&lt;/strong&gt;：加载证书 Secret&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;处理 Backends&lt;/strong&gt;：加载 Service 和 EndpointSlice&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;处理 HTTPRoutePolicy&lt;/strong&gt;：应用路由策略&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;处理 BackendTrafficPolicy&lt;/strong&gt;：应用后端流量策略&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;更新 APISIX 配置&lt;/strong&gt;：通过 Provider 同步到 APISIX&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;更新状态&lt;/strong&gt;：更新 Ingress 和相关资源的状态&lt;/li&gt;
&lt;/ol&gt;

&lt;h4 id=&#34;关键设计特点&#34;&gt;关键设计特点&lt;/h4&gt;

&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;索引优化&lt;/strong&gt;：使用 Field Indexer 快速查找资源关系&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;级联更新&lt;/strong&gt;：依赖资源变化时自动触发主资源更新&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;去重机制&lt;/strong&gt;：避免重复处理同一个 Ingress&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;事件通道&lt;/strong&gt;：使用 genericEvent channel 处理复杂的清理场景&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;条件过滤&lt;/strong&gt;：通过 Predicate 减少不必要的 Reconcile&lt;/li&gt;
&lt;/ol&gt;

&lt;h4 id=&#34;indexer性能优化&#34;&gt;indexer性能优化&lt;/h4&gt;

&lt;p&gt;可以看到在上面的watch逻辑中有很多的list操作, 比如listIngressForBackendTrafficPolicy, 这个时候就需要事先在k8s client的indexer中建立索引来优化查询速度, 避免list全扫数据:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;setupIngressIndexer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;mgr&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;ctrl&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Manager&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;error&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
	&lt;span class=&#34;c1&#34;&gt;// create IngressClass index
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;	&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;mgr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;GetFieldIndexer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;().&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;IndexField&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
		&lt;span class=&#34;nx&#34;&gt;context&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Background&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt;
		&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;networkingv1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Ingress&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{},&lt;/span&gt;
		&lt;span class=&#34;nx&#34;&gt;IngressClassRef&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
		&lt;span class=&#34;nx&#34;&gt;IngressClassRefIndexFunc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
	&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;!=&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;nil&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
		&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt;
	&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;

	&lt;span class=&#34;c1&#34;&gt;// create Service index for quick lookup of Ingresses using specific services
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;	&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;mgr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;GetFieldIndexer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;().&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;IndexField&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
		&lt;span class=&#34;nx&#34;&gt;context&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Background&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt;
		&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;networkingv1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Ingress&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{},&lt;/span&gt;
		&lt;span class=&#34;nx&#34;&gt;ServiceIndexRef&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
		&lt;span class=&#34;nx&#34;&gt;IngressServiceIndexFunc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
	&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;!=&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;nil&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
		&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt;
	&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;

	&lt;span class=&#34;c1&#34;&gt;// create secret index for TLS
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;	&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;mgr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;GetFieldIndexer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;().&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;IndexField&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
		&lt;span class=&#34;nx&#34;&gt;context&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Background&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt;
		&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;networkingv1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Ingress&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{},&lt;/span&gt;
		&lt;span class=&#34;nx&#34;&gt;SecretIndexRef&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
		&lt;span class=&#34;nx&#34;&gt;IngressSecretIndexFunc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
	&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;!=&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;nil&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
		&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt;
	&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;

	&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;mgr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;GetFieldIndexer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;().&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;IndexField&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
		&lt;span class=&#34;nx&#34;&gt;context&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Background&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt;
		&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;networkingv1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Ingress&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{},&lt;/span&gt;
		&lt;span class=&#34;nx&#34;&gt;TLSHostIndexRef&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
		&lt;span class=&#34;nx&#34;&gt;IngressTLSHostIndexFunc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
	&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;!=&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;nil&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
		&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt;
	&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;

	&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;nil&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h5 id=&#34;索引概览表&#34;&gt;📊 &lt;strong&gt;索引概览表&lt;/strong&gt;&lt;/h5&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;索引名称&lt;/th&gt;
&lt;th&gt;索引字段&lt;/th&gt;
&lt;th&gt;索引函数&lt;/th&gt;
&lt;th&gt;主要用途&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;

&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;IngressClassRef&lt;/td&gt;
&lt;td&gt;&lt;code&gt;ingressClassRef&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;IngressClassRefIndexFunc&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;根据 IngressClass 查找 Ingress&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;ServiceIndexRef&lt;/td&gt;
&lt;td&gt;&lt;code&gt;serviceRefs&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;IngressServiceIndexFunc&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;根据后端 Service 查找 Ingress&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;SecretIndexRef&lt;/td&gt;
&lt;td&gt;&lt;code&gt;secretRefs&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;IngressSecretIndexFunc&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;根据 TLS Secret 查找 Ingress&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;TLSHostIndexRef&lt;/td&gt;
&lt;td&gt;&lt;code&gt;tlsHostRefs&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;IngressTLSHostIndexFunc&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;根据 TLS 主机名查找 Ingress&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;Ingress 的 4 个索引形成了一个完整的查询体系：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;IngressClassRef&lt;/strong&gt;：管理层面 - 按控制器分组&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ServiceIndexRef&lt;/strong&gt;：数据平面 - 后端服务关联&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;SecretIndexRef&lt;/strong&gt;：安全层面 - TLS 证书管理&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;TLSHostIndexRef&lt;/strong&gt;：域名层面 - SSL 配置管理&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;这些索引确保了当任何依赖资源变化时，控制器都能&lt;strong&gt;快速、准确&lt;/strong&gt;地找到需要更新的 Ingress，实现&lt;strong&gt;高效的级联更新&lt;/strong&gt;和&lt;strong&gt;实时配置同步&lt;/strong&gt;。&lt;/p&gt;

&lt;h3 id=&#34;3-pingsix-ingress-controller架构决策&#34;&gt;3. pingsix-ingress-controller架构决策&lt;/h3&gt;

&lt;p&gt;从apisix-ingress-controller的架构中, 我们知道apisix抽象了一种ADC(API Declarative CLI)的资源类型用来在ingress与apisix资源之间作为中间的桥梁, 如果直接使用apisix-ingress-controller来对接pingsix的话, 就需要pingsix完整的实现apisix的admin api, 并且还需要在使用时启动etcd.&lt;/p&gt;

&lt;p&gt;在我的印象中曾经看到过apisix-ingress-controller实现过一个不需要etcd的方案:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://apisix.apache.org/blog/2023/10/18/ingress-apisix/&#34;&gt;Embrace the Lightweight APISIX Ingress Controller Without etcd Dependency&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;然后我在apisix-ingress-controller 1.8.x 版本的代码下找到了这个这个实现方式, 只是当前的 2.0.x 版本在引入了ADC相关的功能后去掉了&lt;a href=&#34;https://github.com/api7/etcd-adapter&#34;&gt;etcd-adapter&lt;/a&gt;, 那我在考虑实现我的pingsix-ingress-controller时, 为了避免直接改动pingsix的代码, 并且也不希望在ingress启动时依赖etcd, 所以决定重新引入etcd-adapter, 然后为了后续pingsix-ingress-controller能同步apisix-ingress-controller的上游更新, 我决定在现有的ADC Executor的接口的基础上, 实现pingsix的Executor, 这样就可以在避免直接修改apisix的逻辑代码, 使用一种adapter的方式来实现我们自己的pingsix-ingress-controller.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://github.com/user-attachments/assets/a10a7162-ea7d-4407-b7a6-b5481823592b&#34; alt=&#34;Image2&#34; width=&#34;700px&#34; /&gt;&lt;/p&gt;

&lt;p&gt;可以看到我们实现的这个Executor, 其实就是重复了一遍ADC http serve的逻辑, 但是最终资源的数据是写入到etcd-adapter中的, 我们实现了一个apisix-ingress-controller最底层的抽象, 通过这种低成本的改造我们后续还可以继续同步apisix-ingress-controller的变更, 并不会造成代码冲突.&lt;/p&gt;

&lt;h3 id=&#34;总结&#34;&gt;总结&lt;/h3&gt;

&lt;p&gt;在实现&lt;a href=&#34;https://github.com/zhu327/pingsix-ingress-controller&#34;&gt;pingsix-ingress-controller&lt;/a&gt;的过程中, 我完整的阅读了apisix-ingress-controller的代码, 收获了一些写operator的技巧, 然后在分析现有apisix-ingress-controller的代码架构时, 决定通过扩展ADC Executor的实现来实践了面向对象的开闭原则, 对于后续的代码更新合并开了一个好头.&lt;/p&gt;</description>
    </item>
    
    <item>
      <title>编写可维护的代码 -- 面向AI编程</title>
      <link>https://zhu327.github.io/2025/10/16/%E7%BC%96%E5%86%99%E5%8F%AF%E7%BB%B4%E6%8A%A4%E7%9A%84%E4%BB%A3%E7%A0%81----%E9%9D%A2%E5%90%91ai%E7%BC%96%E7%A8%8B/</link>
      <pubDate>Thu, 16 Oct 2025 10:00:52 &#43;0800</pubDate>
      
      <guid>https://zhu327.github.io/2025/10/16/%E7%BC%96%E5%86%99%E5%8F%AF%E7%BB%B4%E6%8A%A4%E7%9A%84%E4%BB%A3%E7%A0%81----%E9%9D%A2%E5%90%91ai%E7%BC%96%E7%A8%8B/</guid>
      <description>&lt;p&gt;这是最近在小组内做的一次技术分享的文字稿，总体来说我觉得没有表达出特别硬核的内容，我本身也希望说这次分享不用讲的太硬核，在分享的开头还设计了互动环节，分享的过程中也尝试加入一些问答来互动，奈何现公司的技术氛围确实比较沉闷，似乎同事都比较I，好在最后的问答环节有几个比较好的问题，总体来说还算是一次成功的分享吧，希望自己能输出更多的好内容。&lt;/p&gt;

&lt;h4 id=&#34;p1-我们写的代码是写给谁看的&#34;&gt;&lt;strong&gt;P1: 我们写的代码是写给谁看的?&lt;/strong&gt;&lt;/h4&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;(🎤 互动环节):&lt;/strong&gt; “大家有没有过接手一个项目时，看到的第一感觉是：我该从哪下手？结果花了三天才搞明白一个功能的逻辑。有过类似经历的兄弟举个手我看看？”&lt;/li&gt;
&lt;li&gt;小说家写小说给读者，建筑师盖房子给业主&amp;hellip; 那我们程序员写代码，最终是写给未来的自己，和接手我们代码的同事看的。&lt;/li&gt;
&lt;li&gt;代码的可维护性，决定了我们是在“创造价值”还是在“创造负债”。&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&#34;p2-举几个代码坏味道的例子&#34;&gt;&lt;strong&gt;P2: 举几个代码坏味道的例子?&lt;/strong&gt;&lt;/h4&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;(🎤 互动环节):&lt;/strong&gt; “看过《重构》的同学应该都知道代码坏味道。来，大家一起吐槽一下，你在项目里见过最痛苦的代码坏味道是什么？” (引导大家说出几个)&lt;/li&gt;
&lt;li&gt;其实按照我朴素的理解，能让我快速理清逻辑的就是好代码，理解起来很费劲的，那肯定就充满坏味道。&lt;/li&gt;
&lt;li&gt;正如我在入职后接手的&lt;code&gt;kitam&lt;/code&gt;项目，它就充满了这些味道：

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;代码逻辑不内聚&lt;/strong&gt;：功能实现像天女散花。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;分层过多且混乱&lt;/strong&gt;：一个请求要穿越重重关卡。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;外部依赖离散&lt;/strong&gt;：数据库、缓存的调用没有统一规范。&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;/p&gt;

&lt;h4 id=&#34;p3-今天分享的主题&#34;&gt;&lt;strong&gt;P3: 今天分享的主题&lt;/strong&gt;&lt;/h4&gt;

&lt;ul&gt;
&lt;li&gt;今天分享的主题是 编写可维护的代码，以及我们可探讨下面向AI编程。&lt;/li&gt;
&lt;li&gt;面对代码的坏味道和混乱，我们有什么良药？—— 答案是：一个好的架构。今天我将分享我们&lt;code&gt;kfinops&lt;/code&gt;项目中使用的架构：整洁架构 (Clean Architecture)。&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&#34;p4-我们的敌人是谁-是-耦合-这头怪兽&#34;&gt;&lt;strong&gt;P4: 我们的敌人是谁？——是“耦合”这头怪兽！&lt;/strong&gt;&lt;/h4&gt;

&lt;p&gt;&lt;img src=&#34;https://github.com/user-attachments/assets/67458592-6307-44ed-a991-a6def7f53bf8&#34; alt=&#34;Image3&#34; width=&#34;700px&#34; /&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;(🖼️ 视觉元素占位符: 此处放置一张生动的图片，比如一个身上贴满“耦合”标签的小怪兽 🐲)&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;在深入架构之前，我们先要认清我们真正的敌人：&lt;strong&gt;耦合 (Coupling)&lt;/strong&gt;。&lt;/li&gt;
&lt;li&gt;什么是耦合？当你修改代码的一个地方，却意外地导致另一个看似无关的地方也必须修改，甚至直接崩溃时，你就遇到了耦合。&lt;/li&gt;
&lt;li&gt;整洁架构的核心目标只有一个：斩断不必要的耦合，为我们的代码建立“防火墙”，控制变更的“爆炸半径”。&lt;/li&gt;
&lt;li&gt;接下来，我会通过4个我们都经历过的惨痛问题，来展示整洁架构是如何一步步帮我们驯服这头怪兽的。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;(🖼️ 视觉元素占位符: 此处展示完整的整洁架构“洋葱图”，并快速解释四个环：Entities -&amp;gt; Use Cases -&amp;gt; Adapters -&amp;gt; Frameworks)&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&#34;https://github.com/user-attachments/assets/fb504fdb-4ba4-4dc8-8d01-c869da9be03d&#34; alt=&#34;Image3&#34; width=&#34;700px&#34; /&gt;&lt;/p&gt;

&lt;h4 id=&#34;p5-问题一-我只想改个业务规则-为什么还要动数据库和api的代码&#34;&gt;&lt;strong&gt;P5: 问题一：“我只想改个业务规则，为什么还要动数据库和API的代码？”&lt;/strong&gt;&lt;/h4&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;(🖼️ 视觉元素占位符: 洋葱图高亮最内层的 &amp;ldquo;Entities&amp;rdquo; 环)&lt;/strong&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;痛点场景：&lt;/strong&gt; 你想修改一个实体（比如 &lt;code&gt;User&lt;/code&gt;）的业务规则。但在很多项目中，这个实体被定义成了一个“万能Struct”：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;c1&#34;&gt;// user.go
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 它既是业务实体，又是GORM模型，还是HTTP响应体
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;type&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;User&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;struct&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;ID&lt;/span&gt;        &lt;span class=&#34;kt&#34;&gt;uint&lt;/span&gt;      &lt;span class=&#34;s&#34;&gt;`json:&amp;#34;id&amp;#34; gorm:&amp;#34;primaryKey&amp;#34;`&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;// &amp;lt;-- 高亮此行
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;nx&#34;&gt;Name&lt;/span&gt;      &lt;span class=&#34;kt&#34;&gt;string&lt;/span&gt;    &lt;span class=&#34;s&#34;&gt;`json:&amp;#34;name&amp;#34; gorm:&amp;#34;size:255&amp;#34;`&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;Points&lt;/span&gt;    &lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;       &lt;span class=&#34;s&#34;&gt;`json:&amp;#34;points&amp;#34;`&lt;/span&gt;
    &lt;span class=&#34;c1&#34;&gt;// ...
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;现在，产品说：为了兼容新App，&lt;code&gt;ID&lt;/code&gt; 字段对外要改成 &lt;code&gt;user_id&lt;/code&gt;。&lt;/li&gt;
&lt;li&gt;你只能修改：&lt;code&gt;ID uint \&lt;/code&gt;json:&amp;ldquo;user_id&amp;rdquo; gorm:&amp;ldquo;primaryKey&amp;rdquo;``。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;问题来了：&lt;/strong&gt; 你只是在修改一个前端展示字段的名称，却迫使你修改了一个核心业务实体（User）的文件。&lt;strong&gt;这就是业务逻辑和展示细节的耦合。&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;解药：一个纯净的【领域层 Domain Layer】&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;它的唯一职责&lt;/strong&gt;：建立一个“无菌室”，只存放最核心、最纯粹的业务实体和业务规则。&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;&lt;code&gt;kfinops&lt;/code&gt; 的实践:&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;c1&#34;&gt;// internal/domain/subdomain.go
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 只有业务属性，没有json，gorm等任何技术标签
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;type&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;SubDomain&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;struct&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;ID&lt;/span&gt;         &lt;span class=&#34;kt&#34;&gt;string&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;// 纯粹的业务ID
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;nx&#34;&gt;FullDomain&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;string&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;Status&lt;/span&gt;     &lt;span class=&#34;nx&#34;&gt;SubDomainStatus&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;效果：&lt;/strong&gt; 业务核心完全稳定。前端/数据库的任何变化，都不会触碰到这个文件。&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&#34;p6-问题二-创建子域名-这个功能-代码到底在哪&#34;&gt;&lt;strong&gt;P6: 问题二：“‘创建子域名’这个功能，代码到底在哪？”&lt;/strong&gt;&lt;/h4&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;(🖼️ 视觉元素占位符: 洋葱图高亮第二层的 &amp;ldquo;Use Cases&amp;rdquo; 环)&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;(🎤 互动环节):&lt;/strong&gt; “举个手，谁遇到过想看懂一个功能，结果在IDE里跳了十几个文件的情况？”&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;痛点场景：&lt;/strong&gt; 业务流程像天女散花，心智负担极大，你根本找不到一个地方能看清这个功能的“剧本”。&lt;strong&gt;这就是业务流程的逻辑离散。&lt;/strong&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;解药：一个清晰的【用例层 Use Case Layer】&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;它的唯一职责&lt;/strong&gt;：像一个“导演”，负责编排一个完整的业务故事。一个Use Case就代表系统的一个能力。&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;&lt;code&gt;kfinops&lt;/code&gt; 的实践:&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;c1&#34;&gt;// in internal/usecase/subdomain/service.go
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;type&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;SubDomainUseCase&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;struct&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;repo&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;repository&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;SubDomainRepository&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;// 依赖接口
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;uc&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;SubDomainUseCase&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;CreateSubDomain&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;...&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;error&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;c1&#34;&gt;// 1. 验证输入 (DTO)                &amp;lt;-- 高亮
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;c1&#34;&gt;// 2. 创建 Domain 实体             &amp;lt;-- 高亮
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;c1&#34;&gt;// 3. 调用 Domain 实体业务方法      &amp;lt;-- 高亮
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;c1&#34;&gt;// 4. 通过【接口】进行持久化          &amp;lt;-- 高亮
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;uc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;repo&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Save&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;ctx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;domainEntity&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;效果：&lt;/strong&gt; 想理解一个功能，只需要看这一个文件。它清晰地讲述了“做什么（What）”，而不关心“怎么做（How）”。&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&#34;p7-问题三-数据库要从mysql换成mongodb-完了-项目要重写了&#34;&gt;&lt;strong&gt;P7: 问题三：“数据库要从MySQL换成MongoDB，完了，项目要重写了！”&lt;/strong&gt;&lt;/h4&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;(🖼️ 视觉元素占位符: 洋葱图高亮第三层的 &amp;ldquo;Adapters&amp;rdquo; 环，并画一个箭头表示依赖反转)&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;痛点场景：&lt;/strong&gt; 你的代码里到处都是 &lt;code&gt;gorm.DB.Where(...).Find(...)&lt;/code&gt;。你的业务逻辑“知道”你正在使用GORM和MySQL。&lt;strong&gt;这就是业务逻辑和数据存储技术的强耦合。&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;解药：【适配器层 Adapter】 + 【依赖倒置原则】&lt;/strong&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;它的唯一职责&lt;/strong&gt;：将技术细节“适配”成业务层能理解的“插件”。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;核心魔法——依赖倒置&lt;/strong&gt;：

&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;Use Case（使用者）&lt;/strong&gt; 在自己包里定义接口。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Adapter（实现者）&lt;/strong&gt; 去实现这个接口。&lt;/li&gt;
&lt;/ol&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;效果：&lt;/strong&gt; 技术实现变成了可插拔的“零件”。更换数据库？只需要写一个新的Repository实现，然后在DI配置里换掉即可，&lt;strong&gt;Use Case层的代码一行都不用改！&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&#34;p8-问题四-这代码根本没法写单元测试&#34;&gt;&lt;strong&gt;P8: 问题四：“这代码根本没法写单元测试！”&lt;/strong&gt;&lt;/h4&gt;

&lt;p&gt;&lt;img src=&#34;https://github.com/user-attachments/assets/7271b7b0-f51e-40ce-8fe0-dfad4850ed7e&#34; alt=&#34;Image3&#34; width=&#34;700px&#34; /&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;(🖼️ 视觉元素占位符: 一张图片，左边是混乱的毛线球代表紧耦合，右边是整齐的乐高积木代表可测试)&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;(🎤 互动环节):&lt;/strong&gt; “诚实地举手，谁因为代码太难测试而放弃写单元测试的？”&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;痛点场景：&lt;/strong&gt; 业务逻辑里 &lt;code&gt;new&lt;/code&gt; 了一个数据库连接，导致单元测试必须依赖真实环境。&lt;strong&gt;这是【可测试性灾难】。&lt;/strong&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;解药：【接口】 + 【依赖注入 Dependency Injection】&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;它的唯一职责&lt;/strong&gt;：将组件之间的依赖关系从“硬编码”变为“外部配置”。&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;效果：在单元测试中，我们可以轻松地“骗”过 Use Case：&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;c1&#34;&gt;// 我们可以轻易地用一个 &amp;#34;假的&amp;#34; mockRepo 替换掉 &amp;#34;真的&amp;#34; GormRepo
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;mockRepo&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;MockSubDomainRepository&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;// 告诉 mockRepo: &amp;#34;当有人调用Save方法时，假装成功&amp;#34;
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;mockRepo&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;On&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;Save&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;mock&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Anything&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;mock&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Anything&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;).&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Return&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kc&#34;&gt;nil&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;// &amp;lt;-- 高亮
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;nx&#34;&gt;useCase&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;NewSubDomainUseCase&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;mockRepo&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;// 依赖被注入了！ &amp;lt;-- 高亮
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;useCase&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;CreateSubDomain&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;...&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;

&lt;span class=&#34;nx&#34;&gt;assert&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;NoError&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;//&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;测试通过&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;！&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;全程没有碰过数据库&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;！&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;这让编写快速、可靠的单元测试成为可能，极大地保证了代码质量。&lt;/strong&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&#34;p9-可维护性的延伸-构建强大的可观测性&#34;&gt;&lt;strong&gt;P9: 可维护性的延伸：构建强大的可观测性&lt;/strong&gt;&lt;/h4&gt;

&lt;p&gt;&lt;img src=&#34;https://github.com/user-attachments/assets/297e1818-ea6e-4a33-8747-5ad78e004e40&#34; alt=&#34;Image3&#34; width=&#34;700px&#34; /&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;作为SRE团队，我们不仅要写出可维护的代码，更要确保系统在生产环境中是‘可理解’、‘可诊断’的。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;可观测性三大支柱：&lt;/strong&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;🪵 日志 (Logging) - 定位“哪里”出错了&lt;/strong&gt;: 接入KAE，结构化日志，包含&lt;code&gt;request_id&lt;/code&gt;。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;📊 指标 (Metrics) - 了解“怎么样”了&lt;/strong&gt;: Prometheus + Grafana Dashboard。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;🔗 追踪 (Tracing) - 分析“为什么”慢了&lt;/strong&gt;: OpenTelemetry 分布式追踪。&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;小结：整洁的架构让代码在“静态时”易于理解；完善的可观测性体系则让系统在“运行时”易于诊断。&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&#34;p10-面向ai编程-架构即契约-约束即指导&#34;&gt;&lt;strong&gt;P10: 面向AI编程：架构即契约，约束即指导&lt;/strong&gt;&lt;/h4&gt;

&lt;p&gt;&lt;img src=&#34;https://github.com/user-attachments/assets/640a4f7e-5ef3-4ec6-806e-5e72fd31cb26&#34; alt=&#34;Image3&#34; width=&#34;700px&#34; /&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;(🖼️ 视觉元素占位符: 一个对比图)&lt;/strong&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;左边 (无架构):&lt;/strong&gt; 人类 🤯 → prompt → AI 🤖 → 一堆散乱代码 💩&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;右边 (有架构):&lt;/strong&gt; 人类 😎 → 短prompt → AI 🤖 → 精准、分层的代码 ✅&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;一个好的架构，就是整个项目的“代码契约 (Code Contract)”&lt;/strong&gt;，它为AI提供了一个清晰、明确的上下文环境。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;有了这份“契约”，约束就变成了对AI最有效的指导：&lt;/strong&gt;

&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;架构定义了“剧本 (Playbook)”&lt;/strong&gt;: AI会像一个熟悉项目的老手一样，在正确的地方写代码。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;约束提供了“护栏 (Guardrails)”&lt;/strong&gt;: AI不会在usecase层直接写SQL。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;“契约”简化了我们的“指令 (Prompt)”&lt;/strong&gt;: 从“一步步告诉AI怎么做”，变成了“&lt;strong&gt;为 &lt;code&gt;CreateUser&lt;/code&gt; 用例实现API&lt;/strong&gt;”这样简单的指令。&lt;/li&gt;
&lt;/ol&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;结论：架构即提示 (Architecture as the Prompt)。&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&#34;p11-总结与行动指南&#34;&gt;&lt;strong&gt;P11: 总结与行动指南&lt;/strong&gt;&lt;/h4&gt;

&lt;ul&gt;
&lt;li&gt;编写可维护代码的核心是“降低理解成本”和“控制变更影响”。&lt;/li&gt;
&lt;li&gt;整洁架构是一份强大的“代码契约”，通过强制规则保证了项目的一致性。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;(🚀 行动号召):&lt;/strong&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;团队可以马上尝试的实践&lt;/strong&gt;: 在下一个新功能里，先和同事花10分钟讨论一下它的 Use Case 是什么。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;推荐大家试用&lt;/strong&gt;: 克隆我们的 &lt;code&gt;kfinops&lt;/code&gt; 项目或&lt;code&gt;go-clean-arch&lt;/code&gt;模板，亲手运行一下，感受分层的清晰。&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;面向AI编程不是一句口号，而是一种新的工作范式。&lt;/strong&gt; 你的架构越清晰、约束越明确，AI就越能成为你的得力助手。&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&#34;p12-q-a&#34;&gt;&lt;strong&gt;P12: Q&amp;amp;A&lt;/strong&gt;&lt;/h4&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;谢谢大家！&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;项目模板参考: &lt;a href=&#34;https://github.com/zhu327/go-clean-arch&#34;&gt;https://github.com/zhu327/go-clean-arch&lt;/a&gt;&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;大家有什么问题吗？或者对我们团队未来的代码规范有什么建议？&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;</description>
    </item>
    
    <item>
      <title>Vibe Coding有感: 从PingSIX重构说起</title>
      <link>https://zhu327.github.io/2025/09/02/vibe-coding%E6%9C%89%E6%84%9F-%E4%BB%8Epingsix%E9%87%8D%E6%9E%84%E8%AF%B4%E8%B5%B7/</link>
      <pubDate>Tue, 02 Sep 2025 14:55:52 &#43;0800</pubDate>
      
      <guid>https://zhu327.github.io/2025/09/02/vibe-coding%E6%9C%89%E6%84%9F-%E4%BB%8Epingsix%E9%87%8D%E6%9E%84%E8%AF%B4%E8%B5%B7/</guid>
      <description>&lt;p&gt;说到“Vibe Coding”，这个词最近在开发者圈子里越来越流行。在过去，我的实践很大程度上还停留在比较初级的阶段：把需求和代码片段在 ChatGPT、Google AI Studio 或是 Grok 之间来回地复制粘贴。来到新公司后，虽然开通了 GitHub Copilot，体验有所提升，但感觉它更多时候还是一个“超级智能补全”工具。直到今年7月份，公司给配上了 Cursor，我的编程体验才真正开启了一场变革，正式进入了 Vibe Coding 的奇妙旅程。&lt;/p&gt;

&lt;p&gt;恰好，距离我上次更新个人项目 &lt;a href=&#34;https://github.com/zhu327/pingsix&#34;&gt;PingSIX&lt;/a&gt; 已经有一段时间了。PingSIX 是一个我基于 Cloudflare 高性能框架 Pingora 开发的 API 网关。两周前，Pingora 发布了 0.6.0 版本，这给了我一个绝佳的契机。我决定利用这个机会，彻底实践一次全程使用 Cursor 的 Vibe Coding，对 PingSIX 进行一次大重构。&lt;/p&gt;

&lt;p&gt;这次重构断断续续花了一周时间，最终新增了 6636 行代码，删除了 3578 行。这不仅仅是数字上的变化，整个项目在架构、可维护性、可读性、安全性及性能上，都达到了一个我自己非常满意的状态。&lt;/p&gt;

&lt;p&gt;&lt;/p&gt;

&lt;h3 id=&#34;我的-vibe-coding-工作流&#34;&gt;我的 Vibe Coding 工作流&lt;/h3&gt;

&lt;p&gt;在这次重构之旅中，我逐渐摸索出了一套与 AI 高效协作的工作流。这套流程的核心思想是：&lt;strong&gt;你，作为程序员，依然是掌舵者；而 AI，是你最强大的副驾驶。&lt;/strong&gt;&lt;/p&gt;

&lt;h4 id=&#34;1-选择对的-副驾-模型很重要&#34;&gt;1. 选择对的“副驾”：模型很重要&lt;/h4&gt;

&lt;p&gt;工欲善其事，必先利其器。我尝试了 Cursor 内置的多个模型，最终发现 &lt;strong&gt;claude-4-sonnet&lt;/strong&gt; 是我的首选。它表现最稳定，理解复杂上下文的能力很强，生成代码的质量也相当高，而且价格合适。其它模型或多或少会有些小问题，而 Sonnet 则提供了一种“无脑用”的稳定预期。&lt;/p&gt;

&lt;h4 id=&#34;2-精准的指令-上下文工程是关键&#34;&gt;2. 精准的指令：上下文工程是关键&lt;/h4&gt;

&lt;p&gt;把 AI 当成一个需要明确指令的初级程序员。在你让 Cursor 写代码前，&lt;strong&gt;必须先自己整理好需求&lt;/strong&gt;。需求描述得越详细、越清晰，AI 生成的代码质量就越高。我会把相关的代码文件、需要调用的函数定义，都通过 &lt;code&gt;@&lt;/code&gt; 符号添加到上下文中，为 AI 提供一个完整的“作战地图”。&lt;/p&gt;

&lt;h4 id=&#34;3-从战略到战术-让-ai-先当-架构师&#34;&gt;3. 从战略到战术：让 AI 先当“架构师”&lt;/h4&gt;

&lt;p&gt;如果你自己对某个功能也一头雾水，不知道该如何下手，那就先别急着让 AI 写代码。我会先打开 “Ask” 模式，把我的难题抛给它，让 LLM 帮我出谋划策。通过一遍遍的追问和迭代，更新我的需求，最终将 AI 提供的方案整理成一份详尽的文档，甚至细化到某个具体逻辑的实现步骤。有时，我还会让它&lt;strong&gt;先为我的设想编写单元测试&lt;/strong&gt;，然后再让 Agent 遵循这份“蓝图”去实现功能代码。&lt;/p&gt;

&lt;h4 id=&#34;4-你永远是代码的最终责任人&#34;&gt;4. 你永远是代码的最终责任人&lt;/h4&gt;

&lt;p&gt;要时刻记住，LLM 的回答具有不确定性。它是一个强大的工具，但不能替代你的专业判断。我的原则是：&lt;strong&gt;先由我来确定“怎么写”的顶层设计，再让 LLM 来完成“体力活”&lt;/strong&gt;。当代码生成后，&lt;strong&gt;Code Review 是必不可少的一环&lt;/strong&gt;。仔细审查每一行代码，确保它完全符合你的预期。如果不确定，那就让 LLM 继续为这段代码补充单元测试，用测试用例来验证逻辑的正确性。&lt;/p&gt;

&lt;h4 id=&#34;5-让-ai-成为你的-代码评审专家&#34;&gt;5. 让 AI 成为你的“代码评审专家”&lt;/h4&gt;

&lt;p&gt;除了写代码，AI 在 Code Review 方面也表现出色。有时我们自己很难发现项目中的潜在问题，这时就可以借助 LLM 的视角。我会用下面这个 Prompt 来请求一次全面的“代码体检”：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;你是一个Rust编程大师, API网关领域的专家, 请你从代码总体的架构, 可读性, 可维护性, 安全性, 性能方面全面的review我的项目代码, 给出你的分析报告, 并对有哪些代码需要修改给出具体的修改建议。
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;从局部优化到全局审视-当ai助手遇到架构难题&#34;&gt;从局部优化到全局审视：当AI助手遇到架构难题&lt;/h3&gt;

&lt;p&gt;在使用上述 Prompt 的过程中，我发现了一个 Cursor 的局限性。它的文件索引方式似乎是基于代码片段的向量化，这导致它在进行 Review 时，非常擅长发现局部的、函数级别的问题，但&lt;strong&gt;很难从项目整体的架构、分层和依赖关系上给出宏观的分析&lt;/strong&gt;。&lt;/p&gt;

&lt;p&gt;为了解决这个问题，我引入了两个外部工具，形成了一套组合拳：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;&lt;a href=&#34;https://gitingest.com&#34;&gt;gitingest.com&lt;/a&gt;&lt;/strong&gt;: 这个小工具能把整个项目的代码，按照文件结构，完整地生成一个 Markdown 文本。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;&lt;a href=&#34;https://aistudio.google.com&#34;&gt;aistudio.google.com&lt;/a&gt;&lt;/strong&gt;: 我使用的是 Gemini 2.5 Pro 模型，它支持百万级别的 Token 上下文，足以一次性“吞下”我的整个项目代码。&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;我的工作流变成了：使用 &lt;code&gt;gitingest&lt;/code&gt; 打包项目 -&amp;gt; 将生成的 Markdown 完整地粘贴到 Google AI Studio -&amp;gt; 使用上面那个专家 Prompt 让 Gemini 进行全局审查。&lt;/p&gt;

&lt;p&gt;经过这个流程，我得到了一份详尽的“体检报告”，其深度和广度甚至超出了我的预期。下面是最近一次 Gemini Review 报告的一部分摘录：&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;好的，作为一名在 Rust 编程和 API 网关领域都有深入研究的专家，我非常荣幸能为您审查 PingSIX 这个项目。&lt;/p&gt;

&lt;p&gt;首先，请允许我表达我的赞赏：&lt;strong&gt;这是一个非常出色、设计精良的项目&lt;/strong&gt;。它不仅基于 Cloudflare Pingora 这一高性能框架，还在架构设计、代码实现和功能完整性上达到了很高的水準。许多设计决策，例如配置热加载的实现方式、插件系统的设计以及对安全性的关注，都体现了作者深厚的技术功底和对 API 网关领域的深刻理解。&lt;/p&gt;

&lt;p&gt;以下是我的综合分析报告，涵盖了总体架构、可读性、可维护性、安全性、性能以及具体的修改建议。&lt;/p&gt;

&lt;hr /&gt;

&lt;h4 id=&#34;1-总体架构-overall-architecture&#34;&gt;1. 总体架构 (Overall Architecture)&lt;/h4&gt;

&lt;p&gt;&lt;strong&gt;分析:&lt;/strong&gt;
项目的整体架构是现代、模块化且高度可扩展的，非常符合云原生 API 网关的设计理念。&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;坚实的基础&lt;/strong&gt;: 项目选择基于 Cloudflare 的 Pingora 框架，这是一个明智的决定。Pingora 提供了经过生产环境严酷考验的高性能、多线程的异步 I/O 核心，让项目可以专注于网关业务逻辑的实现，而不是底层网络细节。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;配置驱动&lt;/strong&gt;: &amp;hellip; 特别是 Etcd 的集成，通过 &lt;code&gt;arc-swap&lt;/code&gt; 和 &lt;code&gt;dashmap&lt;/code&gt; 实现的配置热加载机制，是高性能网关的黄金标准&amp;hellip;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;逻辑分层清晰&lt;/strong&gt;: 项目代码在 &lt;code&gt;src&lt;/code&gt; 目录下按功能清晰地划分了模块（&lt;code&gt;config&lt;/code&gt;, &lt;code&gt;proxy&lt;/code&gt;, &lt;code&gt;plugin&lt;/code&gt;, &lt;code&gt;admin&lt;/code&gt;, &lt;code&gt;core&lt;/code&gt; 等），职责分明。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;共享服务设计&lt;/strong&gt;: &lt;code&gt;SharedHealthCheckService&lt;/code&gt; 的设计是一个关键的性能优化&amp;hellip;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;评价:&lt;/strong&gt;
架构设计堪称典范，无论是性能、可扩展性还是可靠性方面都考虑得非常周到，达到了业界领先水平。&lt;/p&gt;

&lt;hr /&gt;

&lt;h4 id=&#34;2-代码可读性-readability&#34;&gt;2. 代码可读性 (Readability)&lt;/h4&gt;

&lt;p&gt;&lt;strong&gt;分析:&lt;/strong&gt;
*   &lt;strong&gt;命名规范&lt;/strong&gt;: &amp;hellip;
*   &lt;strong&gt;注释质量高&lt;/strong&gt;: &amp;hellip;更重要的是解释了“为什么这么做”（The Why）&amp;hellip;
*   &lt;strong&gt;错误处理&lt;/strong&gt;: &amp;hellip;&lt;code&gt;ProxyError&lt;/code&gt; 枚举类型非常完善&amp;hellip;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;评价:&lt;/strong&gt;
代码可读性极佳。&lt;/p&gt;

&lt;hr /&gt;

&lt;h4 id=&#34;3-可维护性-maintainability&#34;&gt;3. 可维护性 (Maintainability)&lt;/h4&gt;

&lt;p&gt;&lt;strong&gt;分析:&lt;/strong&gt;
*   &lt;strong&gt;高内聚，低耦合&lt;/strong&gt;: &amp;hellip;
*   &lt;strong&gt;强大的配置校验&lt;/strong&gt;: &amp;hellip;在 &lt;code&gt;src/config/mod.rs&lt;/code&gt; 中大量使用了 &lt;code&gt;validator&lt;/code&gt; crate&amp;hellip;
*   &lt;strong&gt;泛型编程的极致运用&lt;/strong&gt;: &lt;code&gt;src/admin/mod.rs&lt;/code&gt; 中的 &lt;code&gt;AdminResource&lt;/code&gt; Trait 和 &lt;code&gt;ResourceHandler&amp;lt;T&amp;gt;&lt;/code&gt; 泛型结构是可维护性的典范&amp;hellip;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;评价:&lt;/strong&gt;
项目的可维护性非常出色。&lt;/p&gt;

&lt;hr /&gt;

&lt;h4 id=&#34;4-安全性-security&#34;&gt;4. 安全性 (Security)&lt;/h4&gt;

&lt;p&gt;&lt;strong&gt;分析:&lt;/strong&gt;
*   &lt;strong&gt;容器安全&lt;/strong&gt;: &lt;code&gt;Dockerfile&lt;/code&gt; 遵循了最佳实践，使用了多阶段构建&amp;hellip;并且创建了一个低权限的非 root 用户&amp;hellip;
*   &lt;strong&gt;API 认证&lt;/strong&gt;: &amp;hellip;在比较密钥时使用了 &lt;code&gt;constant_time_eq&lt;/code&gt; 函数，有效防止了时序攻击（Timing Attack）。
*   &lt;strong&gt;TLS 配置&lt;/strong&gt;: &amp;hellip;代码强制将 TLS 的最低版本设置为 TLS 1.3&amp;hellip;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;评价:&lt;/strong&gt;
安全性设计考虑周全，遵循了行业内的安全最佳实践。&lt;/p&gt;

&lt;hr /&gt;

&lt;h4 id=&#34;5-性能-performance&#34;&gt;5. 性能 (Performance)&lt;/h4&gt;

&lt;p&gt;&lt;strong&gt;分析:&lt;/strong&gt;
*   &lt;strong&gt;无锁热加载&lt;/strong&gt;: 使用 &lt;code&gt;arc-swap&lt;/code&gt; 来实现路由表&amp;hellip;避免了读写锁带来的性能开销&amp;hellip;
*   &lt;strong&gt;高效的路由匹配&lt;/strong&gt;: &amp;hellip;通过&lt;strong&gt;反转主机名&lt;/strong&gt;来巧妙地利用 &lt;code&gt;matchit&lt;/code&gt; 的前缀匹配能力实现对通配符域名&amp;hellip;这是一个极其聪明和高效的实现。
*   &lt;strong&gt;预编译与缓存&lt;/strong&gt;: &amp;hellip;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;评价:&lt;/strong&gt;
性能设计和优化做到了极致&amp;hellip;&lt;code&gt;README.md&lt;/code&gt; 中提到的性能指标（100K+ RPS, &amp;lt;10ms P99 延迟）基于此架构是完全可信的。&lt;/p&gt;

&lt;hr /&gt;

&lt;h3 id=&#34;总结&#34;&gt;总结&lt;/h3&gt;

&lt;p&gt;PingSIX 是一个非常优秀的项目，其代码质量、架构设计和性能考量都达到了专业甚至顶尖的水平。它不仅是一个功能强大的 API 网关，更是一个极佳的 Rust 工程实践范例。
&amp;hellip;
希望这份详尽的审查报告对您有所帮助！&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;拿到这份宏观报告后，我就可以把其中具体的修改建议，一段段地贴回 Cursor，让它帮我完成代码的微调和优化。改完一轮，再打包给 Gemini 重新审查，如此循环，直到臻于完美。&lt;/p&gt;

&lt;h3 id=&#34;一点感想&#34;&gt;一点感想&lt;/h3&gt;

&lt;p&gt;LLM Agent 的强大无疑极大地提升了我的开发效率，但它也像一把双刃剑。这种前所未有的效率有时也会让上游的 PM 或 Leader 觉得：“反正你很快就能做出来，那我们就快速地改需求吧。” 结果可能导致我们做了很多功能，但真正沉淀和落地的却不多，这或许是“高效”时代下新的烦恼。&lt;/p&gt;

&lt;p&gt;面对层出不穷的新工具和新范式，我的建议是：&lt;strong&gt;先用起来再说&lt;/strong&gt;。用的多了，体会自然就深了。别人的经验可以参考，但更重要的是在实践中找到最适合自己的那套 Vibe。&lt;/p&gt;

&lt;p&gt;我不确定 LLM 最终会不会淘汰程序员这个职业，但我能确定的是，&lt;strong&gt;会 Vibe Coding 的程序员，一定会淘汰不会 Vibe Coding 的程序员&lt;/strong&gt;。所以，朋友们，都 Vibe起来吧！&lt;/p&gt;</description>
    </item>
    
    <item>
      <title>整洁架构落地实践</title>
      <link>https://zhu327.github.io/2025/08/04/%E6%95%B4%E6%B4%81%E6%9E%B6%E6%9E%84%E8%90%BD%E5%9C%B0%E5%AE%9E%E8%B7%B5/</link>
      <pubDate>Mon, 04 Aug 2025 14:55:52 &#43;0800</pubDate>
      
      <guid>https://zhu327.github.io/2025/08/04/%E6%95%B4%E6%B4%81%E6%9E%B6%E6%9E%84%E8%90%BD%E5%9C%B0%E5%AE%9E%E8%B7%B5/</guid>
      <description>&lt;p&gt;最近在新公司接手了一个历史悠久的项目，功能不多，代码量却不小。深入其中，才发现有太多太多的槽点，简直让人头大。每当要新增一个功能或者修复一个 Bug，都感觉像是在雷区里跳舞，步步惊心。&lt;/p&gt;

&lt;p&gt;总结下来，这个项目主要有这么几个“硬伤”：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;代码逻辑不内聚&lt;/strong&gt;：同一个功能的实现，像天女散花一样分散在好几个不同的文件里，想理清完整的逻辑链条，得在 IDE 里跳来跳去，极其耗费心智。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;分层过多且混乱&lt;/strong&gt;：一个简单的请求，要穿越重重关卡，经过好几个层级的调用才能抵达终点。有时你都分不清某一层到底是干嘛的，感觉纯粹是为了分层而分层。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;内部自研框架不好用&lt;/strong&gt;：项目依赖了一个内部的 &lt;code&gt;kgo&lt;/code&gt; 框架，但文档缺失，设计理念也比较陈旧，出了问题排查起来非常困难。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;外部依赖离散&lt;/strong&gt;：对数据库、缓存、外部 API 的调用封装得五花八门，没有统一的规范和入口，整个项目像一个杂乱的“百宝箱”。&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;恰好，Leader 对这个项目制定了新的方向与目标，之前这些遗留问题实实在在成了我们前进路上的绊脚石。因此，一次彻底的架构升级与重构势在必行。同时，部门内也正在推广项目规范化和最佳实践输出，这简直是天赐良机。&lt;/p&gt;

&lt;p&gt;很久以前我就读过《架构整洁之道》这本书，在之前的项目中也或多或少受到一些启发，但从未有机会从一个项目初始就完整地贯彻整洁架构的理念。这次，我决定抓住机会，来一场彻彻底底的整洁架构实践。在这个过程中，我感觉自己对整洁架构的理解，以及对 SOLID 原则的落地方式，都有了前所未有的深入体会。&lt;/p&gt;

&lt;p&gt;&lt;/p&gt;

&lt;p&gt;在实践的过程中，我将心得与经验沉淀下来，开源了一个即开即用的 Go 整洁架构项目模板，希望能给有同样需求的同学一些参考：
&lt;strong&gt;&lt;a href=&#34;https://github.com/zhu327/go-clean-arch&#34;&gt;https://github.com/zhu327/go-clean-arch&lt;/a&gt;&lt;/strong&gt;&lt;/p&gt;

&lt;h3 id=&#34;项目模板特性&#34;&gt;项目模板特性&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Clean Architecture&lt;/strong&gt;: 清晰地分离业务逻辑与基础设施。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Dependency Injection&lt;/strong&gt;: 使用 Google Wire 实现编译时依赖注入，避免反射。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Structured Logging&lt;/strong&gt;: 开箱即用的结构化日志。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Configuration Management&lt;/strong&gt;: 基于 Viper 的环境化配置管理。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Docker Support&lt;/strong&gt;: 包含 &lt;code&gt;Dockerfile&lt;/code&gt; 和 &lt;code&gt;docker-compose.yaml&lt;/code&gt;，便于部署。&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;架构设计&#34;&gt;架构设计&lt;/h3&gt;

&lt;p&gt;这个项目严格遵循整洁架构（Clean Architecture）的原则，确保代码库的可扩展性、可维护性和可测试性。&lt;/p&gt;

&lt;h4 id=&#34;各层描述&#34;&gt;各层描述&lt;/h4&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;🔵 Domain 层&lt;/strong&gt;: 包含核心的业务逻辑和实体。它是最独立的层，不依赖于任何其他层。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;🟣 Use Case 层&lt;/strong&gt;: 通过与 Domain 层交互来编排业务工作流。它定义了供 Adapter 层实现的接口。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;🟠 Adapter 层&lt;/strong&gt;: 作为与外部世界（如 UI、数据库、外部 API）沟通的桥梁。它实现了 Use Case 层定义的接口。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;🟢 External World&lt;/strong&gt;: 代表与应用程序交互的外部系统，如 Web 客户端、数据库或第三方服务。&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&#34;核心原则&#34;&gt;核心原则&lt;/h4&gt;

&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;依赖方向&lt;/strong&gt;: 所有依赖都必须指向内部。Domain 层位于中心，任何内层都不能依赖于外层。这是依赖倒置的核心。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;接口隔离&lt;/strong&gt;: 接口由消费者（Use Case 层）定义，由提供者（Adapter 层）实现。这使得业务逻辑与基础设施细节解耦。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;分层隔离&lt;/strong&gt;: 每一层只与它的相邻层交互，保持清晰的职责分离。&lt;/li&gt;
&lt;/ol&gt;

&lt;h4 id=&#34;项目结构&#34;&gt;项目结构&lt;/h4&gt;

&lt;pre&gt;&lt;code&gt;internal/
├── domain/          # Domain 层 (业务实体和规则)
├── usecase/         # Use Case 层 (业务逻辑, 接口, DTOs)
├── adapter/         # Adapter 层
│   ├── delivery/    # 交付机制 (例如, HTTP, gRPC handlers)
│   ├── repository/  # 仓库实现 (数据库访问)
│   └── gateway/     # 到外部服务的网关
└── di/              # 依赖注入配置 (Wire)
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;实践中的思考与-顿悟&#34;&gt;实践中的思考与“顿悟”&lt;/h3&gt;

&lt;p&gt;理论总是美好的，但实践才是检验真理的唯一标准。在重构过程中，我遇到了不少困惑，也收获了很多“原来如此”的顿悟时刻。&lt;/p&gt;

&lt;h4 id=&#34;1-每一层到底应该放什么&#34;&gt;1. 每一层到底应该放什么？&lt;/h4&gt;

&lt;p&gt;刚开始划分代码时，我经常会纠结一个结构体、一个文件到底该放在哪。经过反复的思考和试错，我总结出了一套相对清晰的指导方针。&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;&lt;code&gt;internal/domain/&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;✅ 应该包含&lt;/strong&gt;: 核心业务实体（代表业务对象的 Struct）、值对象、领域服务接口、与领域相关的枚举和常量。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;❌ 不应包含&lt;/strong&gt;: HTTP 请求/响应结构体、分页或 API 特定数据等应用级概念、任何基础设施细节（如 JSON 标签）。&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;&lt;code&gt;internal/usecase/&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;✅ 应该包含&lt;/strong&gt;: 具体业务用例的实现（如 &lt;code&gt;CreateUser&lt;/code&gt;, &lt;code&gt;LoginUser&lt;/code&gt;）、依赖项的接口定义（如 &lt;code&gt;UserRepository&lt;/code&gt;）、请求和响应的 DTO（数据传输对象）。&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;&lt;code&gt;internal/adapter/&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;✅ 应该包含&lt;/strong&gt;: 将请求转换为用例调用的 HTTP/gRPC 处理器、实现 Use Case 层接口的数据库仓库、外部服务的客户端（网关）。&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;通过这个项目我深刻地体会到，&lt;strong&gt;项目的根本目的是解决现实世界的问题&lt;/strong&gt;。我们需要对现实中的实体进行建模，这就是 &lt;code&gt;domain&lt;/code&gt; 层的使命。这个实体必须纯粹，不依赖任何外部技术，只包含自身的业务规则和逻辑。&lt;/p&gt;

&lt;p&gt;而 &lt;code&gt;usecase&lt;/code&gt; 层，则是针对领域模型的一次具体应用和落地。它需要依赖外部能力，比如查询一次数据库、调用一次 gRPC。这时，&lt;strong&gt;我们不应该直接在 &lt;code&gt;usecase&lt;/code&gt; 中去 new 一个 DB client&lt;/strong&gt;。而是应该在 &lt;code&gt;usecase&lt;/code&gt; 中定义业务所需的 &lt;code&gt;interface&lt;/code&gt;，然后由 &lt;code&gt;adapter&lt;/code&gt; 层的 &lt;code&gt;repository&lt;/code&gt; 或 &lt;code&gt;gateway&lt;/code&gt; 来实现这些接口。&lt;/p&gt;

&lt;p&gt;这样一来，&lt;code&gt;repository&lt;/code&gt; 就不再只是对 GORM 或 &lt;code&gt;sqlx&lt;/code&gt; 的简单封装，它变成了 &lt;code&gt;usecase&lt;/code&gt; 接口的具体“提供者”。它需要将从数据库查出的数据模型，转换为 &lt;code&gt;usecase&lt;/code&gt; 能理解的 &lt;code&gt;domain&lt;/code&gt; 模型。最后，通过依赖注入，实现了完美的依赖倒置。&lt;/p&gt;

&lt;h4 id=&#34;2-关于依赖注入-从排斥到接受&#34;&gt;2. 关于依赖注入：从排斥到接受&lt;/h4&gt;

&lt;p&gt;在以往的项目中，我基本没用过依赖注入，项目里充斥着各种 &lt;code&gt;init()&lt;/code&gt; 函数和全局变量，给测试和维护带来了无尽的痛苦。后来接触到依赖注入，有个老哥自己撸了一套基于反射的 DI 框架，读他的代码真的太难受了，完全不知道依赖到底是怎么注入进来的，魔法感十足，这导致我对依赖注入一度有先入为主的排斥。&lt;/p&gt;

&lt;p&gt;但在实践整洁架构的过程中，由于 &lt;code&gt;usecase&lt;/code&gt; 必须做依赖倒置，我不得不引入 DI 工具。最终选择了 Google 的 &lt;code&gt;wire&lt;/code&gt;。用过之后才发现，&lt;strong&gt;它其实并没有什么魔法&lt;/strong&gt;，只是通过扫描代码，自动生成了那些“手动挡”的初始化代码而已（&lt;code&gt;wire_gen.go&lt;/code&gt;）。相对于通过反射实现的“自动挡”，这种代码生成的方式让一切依赖关系都变得明确和可知，可读性好太多了。&lt;/p&gt;

&lt;h4 id=&#34;3-dto-的归属之争&#34;&gt;3. DTO 的归属之争&lt;/h4&gt;

&lt;p&gt;这是一个让我纠结了很久的问题。&lt;code&gt;usecase&lt;/code&gt; 理想情况下只应该依赖 &lt;code&gt;domain&lt;/code&gt; 定义的模型。然而在实际业务中，总会有一些不属于 &lt;code&gt;domain&lt;/code&gt; 核心模型的结构，比如 &lt;code&gt;CreateUserRequest&lt;/code&gt;、&lt;code&gt;UserListResponse&lt;/code&gt;。注意，这并非 &lt;code&gt;delivery&lt;/code&gt; 层用于解析 JSON 的结构体，而是 &lt;code&gt;usecase&lt;/code&gt; 自身执行业务逻辑所需要的数据结构。&lt;/p&gt;

&lt;p&gt;我曾经犹豫过，要不要把这些结构体也塞进 &lt;code&gt;domain&lt;/code&gt; 层？&lt;/p&gt;

&lt;p&gt;纠结过后，我得出的结论是：&lt;strong&gt;不能！一定要保持 &lt;code&gt;domain&lt;/code&gt; 层的纯粹性&lt;/strong&gt;。这些结构体实际上是和某个具体的 &lt;code&gt;usecase&lt;/code&gt; 强绑定的，它们应该属于 &lt;code&gt;usecase&lt;/code&gt; 层。所以，我在 &lt;code&gt;usecase&lt;/code&gt; 层下也创建了 &lt;code&gt;dto&lt;/code&gt; 目录，用来存放这些用例专属的请求/响应结构。&lt;/p&gt;

&lt;p&gt;这确实会导致 &lt;code&gt;delivery&lt;/code&gt; (HTTP) 层和 &lt;code&gt;usecase&lt;/code&gt; 层可能都有各自的 DTO，初看可能会有些冗余和困惑。但这样做的好处是职责更清晰，&lt;code&gt;usecase&lt;/code&gt; 不会因为 &lt;code&gt;delivery&lt;/code&gt; 层的变化（比如修改一个 JSON 字段名）而被迫修改。这是为了层与层之间的解耦，必须付出的代价。&lt;/p&gt;

&lt;h4 id=&#34;4-我终于悟了-在调用者包中定义接口&#34;&gt;4. 我终于悟了：“在调用者包中定义接口”&lt;/h4&gt;

&lt;p&gt;我之前读到过 Go 社区的一个广为流传的建议（出自 &lt;a href=&#34;https://colobu.com/gotips/018.html&#34;&gt;colobu.com/gotips/018.html&lt;/a&gt;）：&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;在使用者的包中定义接口，而不是提供者的包中定义。&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;说实话，在没有深入实践整洁架构之前，我对这条原则一直是一知半解。为什么接口要让“用的人”来定义，而不是“做的人”来定义呢？&lt;/p&gt;

&lt;p&gt;在这次重构之后，我“悟了”。&lt;strong&gt;这不就是对“依赖倒置原则”最精准、最通俗的诠释吗！&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;在我们的架构里：
-   &lt;code&gt;usecase&lt;/code&gt; 是接口的&lt;strong&gt;使用者&lt;/strong&gt;（消费者）。
-   &lt;code&gt;adapter&lt;/code&gt; 是接口的&lt;strong&gt;实现者&lt;/strong&gt;（提供者）。&lt;/p&gt;

&lt;p&gt;&lt;code&gt;usecase&lt;/code&gt; 说：“我需要一个能根据用户 ID 找到用户，并返回 &lt;code&gt;domain.User&lt;/code&gt; 的能力，我不管你是从 MySQL、Redis 还是从文件中获取，总之，你得满足我定义的这个 &lt;code&gt;UserRepository&lt;/code&gt; 接口。”&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;c1&#34;&gt;// in usecase/iface/repository.go
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;kn&#34;&gt;package&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;iface&lt;/span&gt;

&lt;span class=&#34;kn&#34;&gt;import&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;&amp;#34;your_project/internal/domain&amp;#34;&lt;/span&gt;

&lt;span class=&#34;kd&#34;&gt;type&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;UserRepository&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;interface&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;FindByID&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;ctx&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;context&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Context&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;id&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;uint&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;domain&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;User&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;error&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;然后，&lt;code&gt;adapter/repository&lt;/code&gt; 层去实现它。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;c1&#34;&gt;// in adapter/repository/user_gorm.go
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;kn&#34;&gt;package&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;repository&lt;/span&gt;

&lt;span class=&#34;c1&#34;&gt;// ...
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;userRepository&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;FindByID&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;ctx&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;context&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Context&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;id&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;uint&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;domain&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;User&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;error&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;c1&#34;&gt;// gorm query logic...
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;    &lt;span class=&#34;c1&#34;&gt;// convert gorm model to domain.User
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这样做的好处是巨大的：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;完美解耦&lt;/strong&gt;：&lt;code&gt;usecase&lt;/code&gt; 只关心它需要什么，不关心底层如何实现。更换数据库实现对 &lt;code&gt;usecase&lt;/code&gt; 毫无影响。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;易于测试&lt;/strong&gt;：在为 &lt;code&gt;usecase&lt;/code&gt; 写单元测试时，我们可以轻而易举地 mock 这个 &lt;code&gt;UserRepository&lt;/code&gt; 接口，而无需一个真实的数据库连接。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;符合最小知识原则&lt;/strong&gt;：如果让 &lt;code&gt;adapter&lt;/code&gt; 来定义接口，它可能会暴露很多 &lt;code&gt;usecase&lt;/code&gt; 根本不需要的方法，增加了使用者的心智负担。而由使用者定义，则可以确保接口的精简和必要。&lt;/li&gt;
&lt;/ol&gt;

&lt;h3 id=&#34;总结&#34;&gt;总结&lt;/h3&gt;

&lt;p&gt;从一个混乱的遗留项目开始，到最终落地一套清晰、可维护的整洁架构，这次重构之旅让我收获颇丰。整洁架构并不仅仅是一套死板的目录结构或分层规则，它更是一种引导我们写出高内聚、低耦合代码的思维方式。&lt;/p&gt;

&lt;p&gt;它迫使我们去思考：
-   什么是业务的核心？（Domain）
-   业务流程是怎样的？（UseCase）
-   技术细节如何与业务逻辑解耦？（Adapter &amp;amp; Dependency Inversion）&lt;/p&gt;

&lt;p&gt;通过这次实践，我对依赖倒置、接口隔离等 SOLID 原则有了远比书本上更深刻的理解。当你真正理解了“为什么”要这么做，而不是仅仅停留在“是什么”和“怎么做”的层面时，你会发现，写出整洁、健壮的代码，其实是一件充满乐趣的事情。&lt;/p&gt;

&lt;p&gt;希望这篇文章能为同样在重构道路上探索的你，提供一些有价值的参考与启发。&lt;/p&gt;</description>
    </item>
    
    <item>
      <title>打造一个属于自己的AI书签</title>
      <link>https://zhu327.github.io/2025/07/07/%E6%89%93%E9%80%A0%E4%B8%80%E4%B8%AA%E5%B1%9E%E4%BA%8E%E8%87%AA%E5%B7%B1%E7%9A%84ai%E4%B9%A6%E7%AD%BE/</link>
      <pubDate>Mon, 07 Jul 2025 14:55:52 &#43;0800</pubDate>
      
      <guid>https://zhu327.github.io/2025/07/07/%E6%89%93%E9%80%A0%E4%B8%80%E4%B8%AA%E5%B1%9E%E4%BA%8E%E8%87%AA%E5%B7%B1%E7%9A%84ai%E4%B9%A6%E7%AD%BE/</guid>
      <description>&lt;h3 id=&#34;前言&#34;&gt;前言&lt;/h3&gt;

&lt;p&gt;我一直是个重度的书签使用者，多年来都依赖 Pocket 来收藏和沉淀那些在网上看到的、值得一读的文章。然而，最近 Pocket 宣布其通知服务即将关闭，这对我来说像是一个信号，是时候去寻找一个更稳定、更可控的替代品了。&lt;/p&gt;

&lt;p&gt;我的探索之旅就这样开始了：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;Raindrop.io&lt;/strong&gt;：社区里很多人推荐，功能也确实强大。但不知道是不是网络原因，我这边访问起来总是感觉有点慢，而且用惯了 Pocket 的我，对它的界面和交互逻辑始终有些不太习惯。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;自建服务&lt;/strong&gt;：作为程序员，第一反应自然是自己动手。我找到了像 &lt;a href=&#34;https://github.com/sissbruecker/linkding&#34;&gt;linkding&lt;/a&gt; 这样的优秀开源项目。我尝试把它部署在 &lt;a href=&#34;https://fly.io/&#34;&gt;fly.io&lt;/a&gt; 的免费实例上，但 linkding 对资源的要求不低，最低配的 256M 内存实例直接就 OOM (Out of Memory) 了，升级配置又意味着成本。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;从零开始写一个？&lt;/strong&gt; 这个念头一闪而过。我甚至构思好了技术选型：参照 linkding 的功能，用我最近在学习的 &lt;strong&gt;Rust&lt;/strong&gt; 实现后端，部署在 &lt;strong&gt;Cloudflare Workers&lt;/strong&gt; 上，再配上 &lt;strong&gt;Cloudflare D1&lt;/strong&gt; 的 SQLite 数据库。这套方案 Serverless、成本极低，堪称完美。但转念一想，这工程量可不小，对于业余项目来说，我实在没有那么多时间投入进去。&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;就在我快要放弃，准备将就着用某个方案时，我想起了一篇以前收藏过的文章。&lt;/p&gt;

&lt;p&gt;&lt;/p&gt;

&lt;h3 id=&#34;1-灵感乍现-llm-x-github-书签&#34;&gt;1. 灵感乍现：LLM x GitHub 书签&lt;/h3&gt;

&lt;p&gt;那篇文章是 &lt;a href=&#34;https://nekonull.me/posts/llm_x_bookmark/&#34;&gt;LLM x 书签收藏：摘要 &amp;amp; 全文索引&lt;/a&gt;，作者提供了一个极具创意的思路：通过一个浏览器插件 &lt;a href=&#34;https://github.com/osmoscraft/osmosmemo&#34;&gt;osmos::memo&lt;/a&gt;，可以将书签直接保存到指定 GitHub 仓库的 &lt;code&gt;README.md&lt;/code&gt; 文件里。&lt;/p&gt;

&lt;p&gt;这个方案瞬间击中了我！它足够&lt;strong&gt;简单&lt;/strong&gt;，没有多余的功能，完美符合我的需求。数据就躺在自己的 GitHub 仓库里，再也不用担心服务关停。虽然原文后续介绍了如何利用 LLM 对书签进行摘要和索引，但我觉得还可以更进一步，改造成一个完全自动化、更符合我使用习惯的流程。&lt;/p&gt;

&lt;p&gt;说干就干，我立刻创建了一个新的仓库 &lt;a href=&#34;https://github.com/zhu327/bookmark&#34;&gt;bookmark&lt;/a&gt;，准备开始我的改造计划。&lt;/p&gt;

&lt;h3 id=&#34;2-存量数据的漫漫迁移路&#34;&gt;2. 存量数据的漫漫迁移路&lt;/h3&gt;

&lt;p&gt;要打造新家，首先得把老家的家当搬过去。第一步，就是处理从 Pocket 导出的几百条存量书签。&lt;/p&gt;

&lt;p&gt;我写了一个简单的 Python 脚本，将 Pocket 导出的 HTML 文件解析成 Markdown 格式，然后一股脑儿地塞进了 &lt;code&gt;README.md&lt;/code&gt;。但这只是万里长征的第一步。我的目标是让每个书签都有 &lt;strong&gt;AI 生成的摘要和分类&lt;/strong&gt;。&lt;/p&gt;

&lt;p&gt;我想到了最近很火的 Gemini，它的命令行工具 &lt;code&gt;gemini-cli&lt;/code&gt; 看起来很适合用来做批处理。于是，我开始了我的踩坑之旅：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;初次尝试（失败）&lt;/strong&gt;：我用 &lt;strong&gt;Playwright&lt;/strong&gt; 写了个脚本，模拟浏览器去访问我的 230 个书签链接，把每个页面的完整 HTML 都抓取下来。结果，所有内容加起来足足有 &lt;strong&gt;165MB&lt;/strong&gt;。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;分割文件 + Gemini CLI（失败）&lt;/strong&gt;：我把这 165MB 的内容按每个网页一个文件进行分割，然后尝试用 &lt;code&gt;gemini-cli&lt;/code&gt; 遍历所有文件，让它为每个 HTML 生成摘要和分类。结果，Gemini 的上下文窗口有限，而且 API 调用非常非常慢，一个下午过去，才处理了不到 80 个。果断放弃。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;打包上传 AI Studio（失败）&lt;/strong&gt;：我想，单个处理不行，那就打包处理。我用 Python 脚本把网页按每 20 个一组进行打包，但每个包的文件大小仍在 5MB ~ 14MB 之间。这个大小对于直接上传到 Google AI Studio 来说还是太大了，此路不通。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;精简内容 + 手动处理（成功！）&lt;/strong&gt;：看来问题出在原始 HTML 内容太庞杂了。我再次修改脚本，在分割文件的同时，引入 &lt;strong&gt;&lt;code&gt;html2text&lt;/code&gt;&lt;/strong&gt; 库，将臃肿的 HTML 转换成纯文本。这下效果立竿见影，每 20 个网页打包成的文件只有 &lt;strong&gt;400KB ~ 600KB&lt;/strong&gt;。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;AI 手工操作&lt;/strong&gt;：我将这 13 个（230/20 ≈ 13）处理过的文本文件，&lt;strong&gt;手动一个个上传&lt;/strong&gt;到 Google AI Studio。然后，通过精心设计的 Prompt，让 AI 为文件里的每一个链接都生成摘要，并整理成我想要的 Markdown 格式。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;最终分类&lt;/strong&gt;：我把 AI 生成的所有摘要内容汇总到一个 &lt;code&gt;summary.md&lt;/code&gt; 文件里。最后，再把这个汇总文件上传给 AI Studio，给它下达最终指令：“请根据这些内容的摘要，将所有链接按技术领域、生活、思考等类别进行分类整理。”&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;最终，我得到了完美的分类归档文件：&lt;a href=&#34;https://github.com/zhu327/bookmark/blob/main/category.md&#34;&gt;category.md&lt;/a&gt;。虽然过程曲折，但看到整齐划一的成果时，一切都值了。&lt;/p&gt;

&lt;h3 id=&#34;3-新增书签-交给-github-actions-吧&#34;&gt;3. 新增书签？交给 GitHub Actions 吧！&lt;/h3&gt;

&lt;p&gt;处理完存量数据，接下来就要考虑如何自动化地处理每一个新增的书签了。我的思路是，让万能的 &lt;strong&gt;GitHub Actions&lt;/strong&gt; 来扮演这个智能管家的角色。&lt;/p&gt;

&lt;p&gt;整个流程如下：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;触发&lt;/strong&gt;：每当我通过 &lt;code&gt;osmos::memo&lt;/code&gt; 插件向 &lt;code&gt;README.md&lt;/code&gt; 添加新链接并推送到 GitHub 时，就会自动触发 GitHub Actions 的 workflow。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;解析&lt;/strong&gt;：在 workflow 中运行的 Python 脚本 (&lt;code&gt;process_bookmarks.py&lt;/code&gt;) 会使用 &lt;code&gt;git diff&lt;/code&gt; 命令，精准地找出 &lt;code&gt;README.md&lt;/code&gt; 中新增加的那一行书签链接。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;抓取内容&lt;/strong&gt;：为了避免自己写爬虫遇到的各种反爬问题，我选择了一个非常棒的工具——&lt;a href=&#34;https://jina.ai/reader/&#34;&gt;jina reader&lt;/a&gt;。通过调用它的 API (&lt;code&gt;https://r.jina.ai/URL&lt;/code&gt;)，可以直接获取到目标链接页面的干净、规范的 Markdown 文本。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;生成摘要&lt;/strong&gt;：将获取到的 Markdown 文本发送给 LLM API，让它生成一段简洁的摘要。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;智能分类&lt;/strong&gt;：将链接的原始标题和 AI 生成的摘要再次组合，发送给 LLM API，让它判断这个链接应该属于哪个分类。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;写入归档&lt;/strong&gt;：最后，脚本会按照 &lt;code&gt;[标题](链接) - 摘要&lt;/code&gt; 的格式，将这条全新的、处理好的书签信息，追加到 &lt;code&gt;category.md&lt;/code&gt; 文件对应的分类下。&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;就这样，一套完全自动化的 AI 书签整理流程就诞生了。我只需要在浏览器上点一下收藏，剩下的抓取、摘要、分类、归档工作，都由我的 AI 管家在云端默默完成。&lt;/p&gt;

&lt;h3 id=&#34;4-拥有你自己的-ai-书签&#34;&gt;4. 拥有你自己的 AI 书签&lt;/h3&gt;

&lt;p&gt;这套方案我已经开源在 GitHub 上：&lt;a href=&#34;https://github.com/zhu327/bookmark&#34;&gt;https://github.com/zhu327/bookmark&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;目前我使用的 LLM API 是由硅基流动提供的免费模型 &lt;strong&gt;deepseek-ai/DeepSeek-R1-0528-Qwen3-8B&lt;/strong&gt;，效果相当不错。如果你也对这个方案感兴趣，可以非常简单地拥有自己的 AI 书签：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;Fork&lt;/strong&gt; 这个仓库。&lt;/li&gt;
&lt;li&gt;在你的仓库 &lt;code&gt;Settings -&amp;gt; Secrets and variables -&amp;gt; Actions&lt;/code&gt; 中，添加两个 &lt;code&gt;Repository secrets&lt;/code&gt;：

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;LLM_API_URL&lt;/code&gt;: 兼容 OpenAI API 格式的大模型接口地址，例如 &lt;code&gt;https://api.siliconflow.cn/v1/chat/completions&lt;/code&gt;。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;OPENAI_API_KEY&lt;/code&gt;: 调用该 API 所需的 Key。&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;当然，这个方案也并非完美。比如对于有严格反爬策略的网站（点名微信公众号），&lt;code&gt;jina reader&lt;/code&gt; 也无能为力，无法直接获取到文章内容。&lt;/p&gt;

&lt;h3 id=&#34;总结&#34;&gt;总结&lt;/h3&gt;

&lt;p&gt;在后 Pocket 时代，借助 LLM 的强大能力，我的个人书签系统完成了一次有趣的进化。它不再是一个依赖于第三方在线服务的传统书签，而是变成了一个由我自己掌控、活在 GitHub 上的智能知识库。所有数据都以 Markdown 格式清晰地存储，检索也变得前所未有的简单——打开 &lt;code&gt;category.md&lt;/code&gt;，按下 &lt;code&gt;CTRL + F&lt;/code&gt; 即可。&lt;/p&gt;

&lt;p&gt;这个小项目让我再次感受到，将 AI 作为一种工具融入到个人工作流中，能够迸发出巨大的能量。它不仅解决了我的实际问题，也让整个过程充满了探索和创造的乐趣。&lt;/p&gt;</description>
    </item>
    
    <item>
      <title>我理解的AI Agent与MCP</title>
      <link>https://zhu327.github.io/2025/04/02/%E6%88%91%E7%90%86%E8%A7%A3%E7%9A%84ai-agent%E4%B8%8Emcp/</link>
      <pubDate>Wed, 02 Apr 2025 10:55:52 &#43;0800</pubDate>
      
      <guid>https://zhu327.github.io/2025/04/02/%E6%88%91%E7%90%86%E8%A7%A3%E7%9A%84ai-agent%E4%B8%8Emcp/</guid>
      <description>&lt;h3 id=&#34;前言&#34;&gt;前言&lt;/h3&gt;

&lt;p&gt;最近AI圈子里Manus这个项目可以说是相当火了，连带着MCP（Model Context Protocol）这个概念也开始频繁出现在各种技术讨论区。作为一个程序员，自然也对这些新东西充满了好奇，于是花时间捣鼓了一下AI Agent和MCP相关的知识。这篇文章就是我学习和思考后，对这两个概念的一些个人理解和梳理。&lt;/p&gt;

&lt;h3 id=&#34;1-从workflow到ai-agent-大脑的进化&#34;&gt;1. 从Workflow到AI Agent：大脑的进化&lt;/h3&gt;

&lt;p&gt;回顾我们以前做自动化任务，比如搞个自动抢票、自动下单之类的，思路基本都是围绕着一个固定的&lt;strong&gt;workflow&lt;/strong&gt;。我们会预先设定好一套流程逻辑：收到指令 -&amp;gt; 判断条件 -&amp;gt; 走对应分支 -&amp;gt; 调用特定工具（API、脚本等）。整个过程就像一个流程图，每个节点和路径都是我们程序员预先设计好的。在这个模式下，&lt;strong&gt;我们程序员就是这个workflow的“大脑”&lt;/strong&gt;，我们把执行计划通过代码逻辑，“硬编码”到系统里。比如预定机票这个场景，我们会写代码一步步调用查询接口、选择航班接口、填写乘机人信息接口、支付接口等等。&lt;/p&gt;

&lt;p&gt;&lt;/p&gt;

&lt;h3 id=&#34;2-llm登场-有了-大脑-但还缺-手脚&#34;&gt;2. LLM登场：有了“大脑”，但还缺“手脚”&lt;/h3&gt;

&lt;p&gt;随着大语言模型（LLM）技术的突飞猛进，特别是像DeepSeek R1这样强大的推理模型出现，它们的推理和规划能力越来越接近人类大脑。这就让我们自然而然地想到：能不能让LLM来充当这个自动化流程的“大脑”，代替我们来制定执行计划呢？&lt;/p&gt;

&lt;p&gt;想法很美好，但LLM本质上还是一个&lt;strong&gt;文本补全&lt;/strong&gt;的模型。它能“思考”并告诉你计划是什么，但它自己并不能直接撸起袖子去调用那些具体的工具（API、函数等）来完成任务。为了解决这个问题，OpenAI在其API中引入了&lt;code&gt;tools&lt;/code&gt;（或称为 Function Calling）的概念。&lt;/p&gt;

&lt;p&gt;这个流程大致是这样的：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;我们的应用程序（可以称为Agent）调用LLM API时，在请求的上下文中详细描述可用的工具：每个工具是干嘛的、输入需要什么参数、输出是什么格式。&lt;/li&gt;
&lt;li&gt;Agent把用户的自然语言指令（Prompt）发给LLM。&lt;/li&gt;
&lt;li&gt;LLM根据用户的需求，结合它所知道的工具信息，判断是否需要以及需要调用哪个（或哪些）工具。&lt;/li&gt;
&lt;li&gt;如果需要调用工具，LLM不会直接执行，而是&lt;strong&gt;返回一个包含调用指令的响应&lt;/strong&gt;，里面说明了要调用哪个工具以及需要传递的参数（通常是JSON格式）。&lt;/li&gt;
&lt;li&gt;Agent收到这个响应后，解析出调用指令，&lt;strong&gt;在Agent自己的环境里执行&lt;/strong&gt;相应的工具（比如调用一个本地函数或一个外部API）。&lt;/li&gt;
&lt;li&gt;Agent拿到工具的执行结果后，把这个结果再次作为上下文信息，传回给LLM。&lt;/li&gt;
&lt;li&gt;LLM根据工具的执行结果，决定下一步是继续调用其他工具，还是生成最终的回复给用户。&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;这个基于&lt;code&gt;tools&lt;/code&gt;的交互模式，让LLM有了指挥“手脚”（工具）的能力。但这里也暴露了一个比较明显的&lt;strong&gt;弊端&lt;/strong&gt;：完成一个任务可能需要&lt;strong&gt;多次与LLM进行交互&lt;/strong&gt;（LLM决策 -&amp;gt; Agent执行 -&amp;gt; Agent反馈结果 -&amp;gt; LLM再决策&amp;hellip;），并且为了让LLM理解上下文，每次交互都需要传递越来越长的历史信息，这既&lt;strong&gt;增加了延迟&lt;/strong&gt;，也&lt;strong&gt;增加了API调用成本和Token消耗&lt;/strong&gt;。&lt;/p&gt;

&lt;h3 id=&#34;3-codeact-让llm直接写代码执行&#34;&gt;3. CodeAct：让LLM直接写代码执行&lt;/h3&gt;

&lt;p&gt;我们知道，当前LLM最强的能力之一就是&lt;strong&gt;代码生成&lt;/strong&gt;。于是，就有人想出了另一种更直接的思路：既然LLM擅长写代码，而我们提供的工具本身很多就是函数或者可以通过代码调用的API，那何不让LLM直接生成一小段可执行的代码（比如Python），然后在我们的Agent里内置一个安全的&lt;strong&gt;代码执行沙箱&lt;/strong&gt;来运行这段代码呢？&lt;/p&gt;

&lt;p&gt;在这段生成的代码里，LLM可以直接包含对我们提供的工具（函数）的调用，甚至可以编写一些简单的流程控制逻辑（if/else、循环等）。这样一来，多个步骤和工具调用可能通过一次LLM生成、一次代码执行就完成了，大大&lt;strong&gt;减少了与LLM的交互次数&lt;/strong&gt;。这种方法就被称为&lt;strong&gt;CodeAct&lt;/strong&gt;（代码作为行动）。&lt;/p&gt;

&lt;h3 id=&#34;4-到底什么是ai-agent&#34;&gt;4. 到底什么是AI Agent？&lt;/h3&gt;

&lt;p&gt;聊了这么多，我们再来尝试给AI Agent下一个定义。我认为，&lt;strong&gt;AI Agent = LLM（大脑） + Tools（手脚） + Agent Runtime（执行器） + 决策循环&lt;/strong&gt;。&lt;/p&gt;

&lt;p&gt;具体来说，AI Agent通过调用LLM API，并结合一系列可用的工具（Tools），来理解并执行用户的自然语言任务。它通常采用一种&lt;strong&gt;决策-执行-观察&lt;/strong&gt;的循环模式（ReAct）：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;决策（Reason）&lt;/strong&gt;：由LLM根据当前任务目标和上下文信息，决定下一步是调用工具还是直接回复。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;执行（Act）&lt;/strong&gt;：由Agent Runtime根据LLM的决策，执行相应的工具调用或代码片段。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;观察（Observe）&lt;/strong&gt;：Agent Runtime将执行结果反馈给LLM，作为新的上下文信息，供LLM进行下一轮决策。&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;这个循环一直持续，直到任务完成。&lt;/p&gt;

&lt;p&gt;但这里有个关键问题：LLM本身具有一定的&lt;strong&gt;不确定性&lt;/strong&gt;。对于相同的输入（Prompt），它每次返回的结果可能都不完全一样。这就给AI Agent的执行带来了挑战，有时候可能会偏离预期或者卡在某个环节。因此，在开发AI Agent时，接入&lt;strong&gt;Tracing（追踪）&lt;/strong&gt;系统变得非常重要。我们需要能够实时跟踪Agent与LLM的每一次交互、上下文内容、工具调用情况以及执行结果，这样才能在出现问题时快速定位和调试，进而优化我们的Prompt或者Agent逻辑。&lt;/p&gt;

&lt;h3 id=&#34;5-多agent协作-专业的事交给专业的agent&#34;&gt;5. 多Agent协作：专业的事交给专业的Agent&lt;/h3&gt;

&lt;p&gt;随着Manus的流行，&lt;strong&gt;多Agent编排（Multi-Agent Orchestration）&lt;/strong&gt;的理念也开始受到关注。核心思路是&lt;strong&gt;化整为零，分工协作&lt;/strong&gt;。&lt;/p&gt;

&lt;p&gt;我们不再试图构建一个“万能”的超级Agent，而是将复杂的任务拆解，构建多个&lt;strong&gt;功能单一、职责明确&lt;/strong&gt;的&lt;strong&gt;专家Agent&lt;/strong&gt;。比如，我们可以把&lt;code&gt;web_search&lt;/code&gt;和&lt;code&gt;web_fetch&lt;/code&gt;这两个工具组合起来，封装成一个专门负责网页抓取的&lt;code&gt;web_scraper_agent&lt;/code&gt;。这种单一功能的Agent，它的大脑（LLM）可能不需要最顶级的推理能力，我们可以选用一个&lt;strong&gt;性能足够且成本更低&lt;/strong&gt;的模型（比如一些中小型模型或者特定领域的微调模型）。&lt;/p&gt;

&lt;p&gt;当我们有了多个这样的专家Agent后，再引入一个&lt;strong&gt;Planner Agent（规划器Agent）&lt;/strong&gt;。这个Planner Agent通常需要一个&lt;strong&gt;推理能力较强&lt;/strong&gt;的LLM作为大脑，它的职责是：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;接收用户的原始任务。&lt;/li&gt;
&lt;li&gt;将任务拆解成若干子步骤。&lt;/li&gt;
&lt;li&gt;根据每个子步骤的需求，选择并调用合适的专家Agent。&lt;/li&gt;
&lt;li&gt;收集专家Agent的执行结果。&lt;/li&gt;
&lt;li&gt;根据执行结果，动态调整后续的计划（可能需要重新规划或调用其他Agent）。&lt;/li&gt;
&lt;li&gt;循环这个过程，直到最终任务完成，然后将结果汇总返回给用户。&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;这种多Agent架构带来的好处显而易见：&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;成本效益&lt;/strong&gt;：在大量执行具体任务的专家Agent上可以使用更便宜的LLM。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;维护性&lt;/strong&gt;：每个Agent功能单一，更容易开发、测试和维护。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;扩展性&lt;/strong&gt;：可以方便地增加新的专家Agent来扩展整个系统的能力。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;可能更优化的上下文管理&lt;/strong&gt;：Planner Agent可能只需要关注子任务的目标和专家Agent返回的关键结果，而不需要承载所有底层工具调用的详细上下文。&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;6-prompt工程-agent的灵魂&#34;&gt;6. Prompt工程：Agent的灵魂&lt;/h3&gt;

&lt;p&gt;无论是使用ReAct还是CodeAct，无论是单Agent架构还是多Agent编排，有一个环节始终是绕不开的，那就是&lt;strong&gt;Prompt Engineering（提示工程）&lt;/strong&gt;。&lt;/p&gt;

&lt;p&gt;我们需要为每一个与LLM交互的环节（无论是Planner Agent制定计划，还是专家Agent执行任务，或是Function Calling/CodeAct的触发）&lt;strong&gt;精心设计Prompt&lt;/strong&gt;。好的Prompt需要能够引导LLM按照我们的预期来思考和输出：&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;让Planner Agent生成&lt;strong&gt;结构化、可分步执行&lt;/strong&gt;的计划。&lt;/li&gt;
&lt;li&gt;让LLM在需要时&lt;strong&gt;准确地选择并调用&lt;/strong&gt;我们提供的工具。&lt;/li&gt;
&lt;li&gt;让LLM返回&lt;strong&gt;格式规范、易于解析&lt;/strong&gt;的文本（比如JSON），方便Agent Runtime处理。&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;可以说，Prompt就是我们给AI Agent注入灵魂的方式。&lt;/p&gt;

&lt;h3 id=&#34;7-mcp-agent间沟通的标准语&#34;&gt;7. MCP：Agent间沟通的标准语&lt;/h3&gt;

&lt;p&gt;随着多Agent架构的兴起，Agent之间如何发现彼此、如何调用彼此的能力就成了一个问题。这时，&lt;strong&gt;MCP（Model Context Protocol）&lt;/strong&gt;这个概念应运而生。&lt;/p&gt;

&lt;p&gt;你可以把MCP理解为一套&lt;strong&gt;为Agent（或者说LLM的工具）设计的标准化接口规范&lt;/strong&gt;。&lt;/p&gt;

&lt;p&gt;在没有MCP之前，我们实现的工具可能五花八门：一段本地Python代码、一个内部HTTP API调用、一个第三方云服务接口等等。每次要给Agent添加新工具，都需要手动编写关于这个工具的描述（功能、参数、格式），然后注入到Agent的上下文中。&lt;/p&gt;

&lt;p&gt;有了MCP之后，情况就可能变得更规范：&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;工具提供方可以将其能力封装成一个遵循MCP协议的&lt;strong&gt;MCP Server&lt;/strong&gt;。&lt;/li&gt;
&lt;li&gt;Agent可以通过标准的MCP方法（比如&lt;code&gt;list_tools&lt;/code&gt;）来&lt;strong&gt;动态发现&lt;/strong&gt;某个MCP Server提供了哪些工具及其描述。&lt;/li&gt;
&lt;li&gt;Agent可以通过标准的MCP &lt;strong&gt;RPC Call&lt;/strong&gt;来执行这些工具。&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;MCP不仅仅规范了工具的调用，它通常也试图规范&lt;strong&gt;Prompt模板、资源管理&lt;/strong&gt;等Agent开发中常见的元素。如果MCP能够被广泛采用，理论上可以：&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;降低Agent的开发门槛&lt;/strong&gt;：开发者可以直接复用社区提供的、遵循MCP标准的工具服务，而不需要自己重复实现和描述工具。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;提高Agent的互操作性&lt;/strong&gt;：不同开发者、不同团队开发的Agent或许能更容易地进行协作。&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;当然，MCP目前似乎还在发展初期，但它指明了一个让Agent生态更加规范化、标准化的方向。&lt;/p&gt;

&lt;h3 id=&#34;8-总结-门槛不高-精通不易&#34;&gt;8. 总结：门槛不高，精通不易&lt;/h3&gt;

&lt;p&gt;以上就是我这段时间学习下来，对AI Agent和MCP的一些粗浅理解。在阅读了几个开源的Manus实现（或者类似的多Agent框架）之后，我的一个直观感受是：&lt;/p&gt;

&lt;p&gt;对于掌握Python的程序员来说，上手开发一个基础的AI Agent，或者编写一个简单的Tool/MCP Server，&lt;strong&gt;技术门槛似乎并不算特别高&lt;/strong&gt;。很多框架（如LangChain、LlamaIndex等）已经帮我们处理了与LLM交互、管理上下文、执行工具等繁琐的底层工作。&lt;/p&gt;

&lt;p&gt;然而，&lt;strong&gt;真正的挑战在于&lt;/strong&gt;：如何在一个&lt;strong&gt;特定的业务场景&lt;/strong&gt;下，设计和实现一个&lt;strong&gt;稳定、可靠、高效&lt;/strong&gt;的AI Agent。这需要：&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;深刻理解业务需求&lt;/strong&gt;，并将其转化为适合Agent执行的任务流程。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;精心的Prompt设计与调优&lt;/strong&gt;，不断尝试，引导LLM给出期望的输出。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;有效的Tracing和Debugging&lt;/strong&gt;，快速定位Agent执行过程中的问题并进行修复。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;合理的架构选择&lt;/strong&gt;（单Agent vs 多Agent，ReAct vs CodeAct）和&lt;strong&gt;成本控制&lt;/strong&gt;。&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;就像当年我们从写简单脚本到构建复杂系统一样，AI Agent的世界也是易学难精。工具和框架降低了入门门槛，但要做出真正好用的Agent，还需要大量的实践、思考和打磨。&lt;/p&gt;

&lt;h3 id=&#34;9-参考&#34;&gt;9. 参考&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://arthurchiao.art/blog/ai-agent-white-paper-zh/&#34;&gt;Google AI Agent（智能体）技术白皮书&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://arthurchiao.art/blog/build-effective-ai-agent-zh/&#34;&gt;Anthropic AI Workflow &amp;amp; AI Agent：架构、模式与工程建议&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://huggingface.co/learn/agents-course/zh-CN/unit0/introduction&#34;&gt;Hugging Face AI Agents 课程&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/liaokongVFX/MCP-Chinese-Getting-Started-Guide&#34;&gt;Model Context Protocol(MCP) 编程极速入门&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/liaokongVFX/LangChain-Chinese-Getting-Started-Guide&#34;&gt;LangChain 中文入门教程&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/mannaandpoem/OpenManus&#34;&gt;OpenManus&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/Darwin-lfl/langmanus&#34;&gt;LangManus&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</description>
    </item>
    
    <item>
      <title>云原生开发入门</title>
      <link>https://zhu327.github.io/2025/03/28/%E4%BA%91%E5%8E%9F%E7%94%9F%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8/</link>
      <pubDate>Fri, 28 Mar 2025 10:55:52 &#43;0800</pubDate>
      
      <guid>https://zhu327.github.io/2025/03/28/%E4%BA%91%E5%8E%9F%E7%94%9F%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8/</guid>
      <description>&lt;p&gt;作为一名在云原生领域摸爬滚打了一段时间的开发者，我时常会遇到一些刚接触这个领域的朋友，他们面对 Kubernetes (K8s)、容器这些概念时，常常感到有些迷茫，不知道从何学起。这篇文章，我想结合自己的一些学习体会，为想要入门云原生开发的同学提供一个相对清晰的指引。&lt;/p&gt;

&lt;p&gt;我自己并非科班出身，从最初接触软件测试写 Lua 脚本，到后来学习 Python 做后端，再到进入腾讯接触 Golang 和 K8s 相关开发，一路走来也踩了不少坑。云原生技术栈确实庞大，但核心的理念是利用容器、微服务、声明式 API 等方式，去构建更可靠、更具弹性的分布式系统。而 K8s 作为这个生态的核心编排引擎，可以说是我们必须掌握的关键技能。&lt;/p&gt;

&lt;p&gt;这篇文章，我会从基础概念聊起，分享几本我学习过程中觉得非常有帮助的书籍，一个不错的社区文章集合，以及两个可以动手实践的代码项目。最后，还会结合实际工作经验，聊聊 K8s 运维实践中一些重要的事情。希望这些能帮助大家在学习云原生的路上少走一些弯路。&lt;/p&gt;

&lt;hr /&gt;

&lt;h2 id=&#34;一-云原生与-kubernetes-从基础概念开始&#34;&gt;一、云原生与 Kubernetes：从基础概念开始&lt;/h2&gt;

&lt;h3 id=&#34;云原生到底是什么&#34;&gt;云原生到底是什么？&lt;/h3&gt;

&lt;p&gt;我理解的云原生（Cloud Native），它不是指某一个具体的技术，更像是一种面向云环境的应用设计、开发和部署的最佳实践集合。它鼓励我们使用像容器、微服务、不可变基础设施、声明式 API 这些技术和方法，目标是让我们的应用能更好地利用云计算的弹性、分布式、自动化等优势。根据 CNCF（云原生计算基金会）的定义，这些是关键要素。简单说，就是让应用为云而生，能在云上运行得更好。&lt;/p&gt;

&lt;h3 id=&#34;为什么-kubernetes-这么重要&#34;&gt;为什么 Kubernetes 这么重要？&lt;/h3&gt;

&lt;p&gt;容器技术（比如 Docker）解决了环境一致性的问题，但当你有成百上千个容器需要管理时，手动操作就变得不现实了。Kubernetes 就是来解决这个问题的。它是一个开源的容器编排平台，最初由 Google 开发，现在由 CNCF 维护。它可以自动化地完成应用的部署、扩缩容、服务发现、负载均衡、故障恢复等一系列复杂工作。在我看来，掌握 K8s 是进入现代后端开发、特别是平台工程领域的一张重要门票。&lt;/p&gt;

&lt;h3 id=&#34;我的学习路径建议&#34;&gt;我的学习路径建议：&lt;/h3&gt;

&lt;p&gt;回顾我自己的学习过程，我建议可以按以下步骤来：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;先搞懂容器&lt;/strong&gt;：理解 Docker 的基本概念，比如镜像（Image）、容器（Container）、Dockerfile，能自己动手构建、运行一个简单的容器化应用。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;再深入 K8s 核心&lt;/strong&gt;：学习 K8s 的核心组件（比如 Pod、Service、Deployment、StatefulSet、Namespace 等）都是做什么的，它们之间是如何协作的。了解控制平面（Master）和数据平面（Node）的基本工作原理。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;动手实践是关键&lt;/strong&gt;：理论学习后，一定要动手实践。尝试编写 YAML 文件部署应用，使用 &lt;code&gt;kubectl&lt;/code&gt; 与集群交互。然后可以去探索存储（Volumes, PV, PVC）、网络（Ingress, CNI）、配置（ConfigMap, Secret）等更深入的主题。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;理解运维视角&lt;/strong&gt;：开发的应用最终要跑在生产环境。了解 K8s 集群的监控、日志、告警、排错等运维实践，对于写出更健壮、更易于维护的应用非常有帮助。&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;接下来，分享一些我在学习过程中用过且觉得不错的资源。&lt;/p&gt;

&lt;p&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;h2 id=&#34;二-推荐书籍-理论与实践结合&#34;&gt;二、推荐书籍：理论与实践结合&lt;/h2&gt;

&lt;p&gt;市面上关于 K8s 的书不少，但下面这两本是我个人觉得非常经典，值得花时间去读的。&lt;/p&gt;

&lt;h3 id=&#34;1-kubernetes-in-action&#34;&gt;1. 《Kubernetes in Action》&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;豆瓣评分参考&lt;/strong&gt;：8.8 分&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;我的推荐理由&lt;/strong&gt;：
这本书非常侧重实践。作者 Marko Lukša 通过大量可操作的例子，一步步带你上手 K8s。从最基础的 Pod、Service 到 Deployment 实现滚动更新，都讲得很清楚。对于刚入门 K8s，希望快速看到效果、建立信心的同学来说，这本书是极好的选择。我当初就是跟着这本书敲代码，对 K8s 的基本操作有了直观的认识。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;可以重点关注的章节&lt;/strong&gt;：

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;第 2 章&lt;/strong&gt;：用一个 Node.js 例子带你跑通第一个 K8s 应用。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;第 5 章&lt;/strong&gt;：讲解 Service，理解应用如何被访问。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;第 9 章&lt;/strong&gt;：讲解 Deployment，掌握应用发布的核心方式。&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;适合谁&lt;/strong&gt;：K8s 新手，特别是喜欢通过动手实践来学习的开发者。&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;2-深入剖析-kubernetes&#34;&gt;2. 《深入剖析 Kubernetes》&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;豆瓣评分参考&lt;/strong&gt;：9.3 分&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;我的推荐理由&lt;/strong&gt;：
张磊大佬写的这本书，更侧重于 K8s 的设计理念和底层实现原理。如果你不满足于仅仅会用 K8s，还想知道它内部是怎么工作的（比如调度器如何决策？网络 CNI 如何实现？），那这本书绝对值得一读。对我自己而言，阅读这本书加深了我对 K8s 架构的理解，对于后来做一些 K8s 相关的开发工作非常有帮助。它不仅仅是讲技术，还融入了作者在一线的实践思考。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;可以重点关注的章节&lt;/strong&gt;：

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;第 3 章&lt;/strong&gt;：K8s 整体架构和设计哲学。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;第 5 章&lt;/strong&gt;：控制器（Controller）和编排原理，这是 K8s 自动化的核心。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;第 7 章&lt;/strong&gt;：网络原理，CNI、Service 等机制讲得很透彻。&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;适合谁&lt;/strong&gt;：对 K8s 有一定基础，想深入理解其工作原理和设计思想的开发者。&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;怎么选？&lt;/strong&gt; 我的建议是，如果你是新手，可以先看《Kubernetes in Action》动手实践，建立基本概念；然后再读《深入剖析 Kubernetes》加深理解。如果你已经有基础，可以直接看《深入剖析 Kubernetes》。&lt;/p&gt;

&lt;hr /&gt;

&lt;h2 id=&#34;三-社区文章合集-k8s-club&#34;&gt;三、社区文章合集：K8s Club&lt;/h2&gt;

&lt;p&gt;除了书籍，社区里也有很多高质量的文章。我个人比较关注 &lt;a href=&#34;https://github.com/k8s-club/k8s-club&#34;&gt;K8s Club&lt;/a&gt; 这个 GitHub 仓库。&lt;/p&gt;

&lt;p&gt;它汇集了不少国内云原生开发者撰写的技术文章，内容覆盖从基础到进阶，也有源码分析和实践经验分享，质量普遍不错。&lt;/p&gt;

&lt;h3 id=&#34;值得关注的内容&#34;&gt;值得关注的内容：&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;概念梳理与入门&lt;/strong&gt;：比如用问答形式总结 K8s 核心概念的文章。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;知识图谱&lt;/strong&gt;：帮助你了解 K8s 的整体知识体系。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;核心组件原理分析&lt;/strong&gt;：比如 Informer 机制、调度器原理等，对深入理解 K8s 或做二次开发很有帮助。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;实践操作指南&lt;/strong&gt;：比如手动搭建集群、Pod 生命周期管理等。&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;如何利用？&lt;/strong&gt; 遇到具体问题时可以去搜索相关的文章；也可以系统性地阅读某个系列；最重要的是，看完之后尽量动手在自己的环境（比如 Minikube）中验证一下。&lt;/p&gt;

&lt;hr /&gt;

&lt;h2 id=&#34;四-代码示例项目-动手实践出真知&#34;&gt;四、代码示例项目：动手实践出真知&lt;/h2&gt;

&lt;p&gt;理论学习最终还是要落到实践上。就像我学习 Rust 会自己动手写项目一样，学习 K8s 也需要通过代码来加深理解。下面是我找到的两个 GitHub 上的项目集合，提供了不错的练手机会：&lt;/p&gt;

&lt;h3 id=&#34;1-kubernetes-learning-playground&#34;&gt;1. Kubernetes Learning Playground&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;地址&lt;/strong&gt;：&lt;a href=&#34;https://github.com/Kubernetes-Learning-Playground&#34;&gt;https://github.com/Kubernetes-Learning-Playground&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;简介&lt;/strong&gt;：这个组织下有不少关于 K8s 扩展开发的项目示例，比如如何与 K8s API 交互（client-go）、简单的 CSI/CNI 插件实现、自定义调度器等。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;可以看看的项目&lt;/strong&gt;：

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;multi-cluster-informer&lt;/code&gt;：学习如何监控多个 K8s 集群。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;csi-interface-study&lt;/code&gt;：一个简单的 CSI 存储插件示例。&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;适合&lt;/strong&gt;：对 K8s 内部机制、API 编程、插件开发感兴趣的同学。&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;2-operator-learning-playground&#34;&gt;2. Operator Learning Playground&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;地址&lt;/strong&gt;：&lt;a href=&#34;https://github.com/Operator-Learning-Playground&#34;&gt;https://github.com/Operator-Learning-Playground&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;简介&lt;/strong&gt;：专注于 K8s Operator 开发模式的练习项目。Operator 是用来管理有状态应用或自动化复杂运维任务的重要模式。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;可以看看的项目&lt;/strong&gt;：

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;proxy-operator&lt;/code&gt;：一个简单的 Operator 例子，感受下基本结构。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;podReStarter-operator&lt;/code&gt;：实现特定条件下自动重启 Pod 的控制器。&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;适合&lt;/strong&gt;：想学习如何使用 CRD (自定义资源) 和 Controller 来扩展 K8s 功能的同学。&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;实践建议&lt;/strong&gt;：
*   在本地用 Minikube 或 Kind 搭个 K8s 环境，方便实验。
*   从简单的项目开始，先跑起来，再尝试理解代码，然后可以试着修改或扩展它。&lt;/p&gt;

&lt;hr /&gt;

&lt;h2 id=&#34;五-学习路线与个人心得&#34;&gt;五、学习路线与个人心得&lt;/h2&gt;

&lt;p&gt;结合上面的资源，我梳理了一个学习 K8s 的大致路线：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;基础入门&lt;/strong&gt;：通过《Kubernetes in Action》和动手实验，掌握 Docker 和 K8s 的基本概念与操作。能部署简单应用，会用 &lt;code&gt;kubectl&lt;/code&gt;。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;深入原理&lt;/strong&gt;：阅读《深入剖析 Kubernetes》，理解 K8s 的核心架构和工作机制。结合 K8s Club 的文章，针对性学习。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;实践进阶&lt;/strong&gt;：研究上面提到的代码示例项目，尝试理解并动手修改。开始关注 K8s 生态中的其他工具，如 Helm、Prometheus 等。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;持续学习&lt;/strong&gt;：云原生技术发展很快，保持学习状态很重要。多看官方文档，关注社区动态。&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;&lt;strong&gt;我自己的一些体会：&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;动手非常重要&lt;/strong&gt;：看再多文档不如自己动手敲一遍。遇到问题、解决问题的过程是最好的学习。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;非科班不用怕&lt;/strong&gt;：像我一样非科班出身的同学，可能基础会薄弱一些，那就多花点时间去补基础（比如《深入理解计算机系统》这样的书）。关键是持续学习和实践。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;利用好 GitHub&lt;/strong&gt;：无论是学习别人的项目，还是像我一样把自己写的东西放上去，GitHub 都是一个很好的平台。它不仅能记录你的成长，有时还能带来意想不到的机会。&lt;/li&gt;
&lt;/ul&gt;

&lt;hr /&gt;

&lt;h2 id=&#34;六-k8s-运维实践-开发者也需关注&#34;&gt;六、K8s 运维实践：开发者也需关注&lt;/h2&gt;

&lt;p&gt;开发完应用部署到 K8s 只是第一步，如何保障它在生产环境稳定运行，是同样重要的事情。虽然可能有专门的运维团队，但作为开发者，了解一些基本的运维实践，能帮助我们写出更符合生产要求的应用，也能在排查问题时更有思路。&lt;/p&gt;

&lt;p&gt;这部分我参考了腾讯云 K8s 运维开发工程师整理的《&lt;a href=&#34;https://imroc.cc/kubernetes/best-practices&#34;&gt;Kubernetes 实践指南&lt;/a&gt;》（这份指南写得挺实用的），结合自己的一些经验，提炼几点：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;熟练使用 &lt;code&gt;kubectl&lt;/code&gt;&lt;/strong&gt;：这是与 K8s 交互的基础。&lt;code&gt;get&lt;/code&gt;, &lt;code&gt;describe&lt;/code&gt;, &lt;code&gt;logs&lt;/code&gt;, &lt;code&gt;exec&lt;/code&gt; 等命令要常用常练。学会看 &lt;code&gt;describe&lt;/code&gt; 里的 Events 信息，对排错很有帮助。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;镜像管理&lt;/strong&gt;：注意使用小的基础镜像、多阶段构建来优化镜像体积。生产环境用私有镜像仓库，配置好拉取密钥。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;监控告警是标配&lt;/strong&gt;：Prometheus + Grafana 是社区主流方案，需要了解如何暴露应用的 metrics，如何配置基本的告警规则。日志收集（如 EFK/ELK）也要考虑。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;资源管理（Requests &amp;amp; Limits）&lt;/strong&gt;：一定要给 Pod 设置合理的 CPU 和内存 &lt;code&gt;requests&lt;/code&gt;（用于调度）和 &lt;code&gt;limits&lt;/code&gt;（用于限制），避免资源抢占导致应用不稳定或影响其他应用。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;健康检查（Probes）&lt;/strong&gt;：配置好 Liveness Probe（存活探针，判断容器是否需要重启）和 Readiness Probe（就绪探针，判断容器是否准备好接收流量），让 K8s 能准确管理应用状态。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;理解 Namespace 和 RBAC&lt;/strong&gt;：Namespace 用于资源隔离，RBAC 用于权限控制，都是保障集群安全和管理有序性的重要机制。&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;&lt;strong&gt;运维学习建议&lt;/strong&gt;：同样需要动手，可以在本地环境模拟一些场景，比如手动删除 Pod 看 K8s 如何恢复，调整资源限制看效果等。&lt;/p&gt;

&lt;hr /&gt;

&lt;h2 id=&#34;七-结语&#34;&gt;七、结语&lt;/h2&gt;

&lt;p&gt;回头看，云原生开发这条路确实内容不少，但走下来收获也很大。从 K8s 的基础操作到深入理解其原理，再到关注运维实践，是一个逐步深入的过程。&lt;/p&gt;

&lt;p&gt;希望我分享的这些学习资源和路径建议，能对正在入门或打算入门云原生开发的你有所帮助。我自己也是在不断学习中，云原生技术日新月异，保持好奇心和动手实践的热情非常重要。&lt;/p&gt;

&lt;p&gt;如果你在学习过程中有任何问题或心得，也欢迎一起交流。&lt;/p&gt;</description>
    </item>
    
    <item>
      <title>从《软件设计的哲学》谈代码的复杂性与应对</title>
      <link>https://zhu327.github.io/2025/01/10/%E4%BB%8E%E8%BD%AF%E4%BB%B6%E8%AE%BE%E8%AE%A1%E7%9A%84%E5%93%B2%E5%AD%A6%E8%B0%88%E4%BB%A3%E7%A0%81%E7%9A%84%E5%A4%8D%E6%9D%82%E6%80%A7%E4%B8%8E%E5%BA%94%E5%AF%B9/</link>
      <pubDate>Fri, 10 Jan 2025 10:55:52 &#43;0800</pubDate>
      
      <guid>https://zhu327.github.io/2025/01/10/%E4%BB%8E%E8%BD%AF%E4%BB%B6%E8%AE%BE%E8%AE%A1%E7%9A%84%E5%93%B2%E5%AD%A6%E8%B0%88%E4%BB%A3%E7%A0%81%E7%9A%84%E5%A4%8D%E6%9D%82%E6%80%A7%E4%B8%8E%E5%BA%94%E5%AF%B9/</guid>
      <description>&lt;p&gt;几个月前读完了《软件设计的哲学》这本书，在结合自己多年的工作体会，对于代码的可读性，可维护性有了系统性的体会，然后基于我记录的读书笔记然后经过AI的润色，形成了这篇笔记。希望对你也有所帮助。&lt;/p&gt;

&lt;p&gt;读完《软件设计的哲学》，感觉像经历了一次代码的“深度体检”。这本书没有讲解具体的编码技巧，而是从更高的维度帮助我们重新审视代码复杂性的问题，并提出了许多实用的建议。今天，我想结合自己的理解，分享这本书带来的启发。&lt;/p&gt;

&lt;h3 id=&#34;什么是代码的复杂性&#34;&gt;什么是代码的复杂性？&lt;/h3&gt;

&lt;p&gt;简单来说，复杂性就是那些让系统难以理解和修改的因素。它不仅仅指代码的行数或逻辑深度，还包括：&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;难以理解&lt;/strong&gt;：即便是自己写的代码，过一段时间可能也看不懂，更别提其他人。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;修改成本高&lt;/strong&gt;：一个小改动需要改动多个地方，甚至引发新的问题。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;模糊的改动范围&lt;/strong&gt;：不知道该修改哪些模块才能实现目标，或者不确定修改后是否会引发其他问题。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;难以修复的错误&lt;/strong&gt;：修复一个 bug 可能需要大量时间，还可能引入新的问题。&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;/p&gt;

&lt;h3 id=&#34;复杂性的表现形式&#34;&gt;复杂性的表现形式&lt;/h3&gt;

&lt;p&gt;复杂性并非抽象概念，它常以以下形式体现：&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;变更放大&lt;/strong&gt;：一个简单需求改动需要修改多个模块甚至代码库。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;认知负荷&lt;/strong&gt;：完成一个任务需要了解大量背景知识或复杂细节。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;未知的未知&lt;/strong&gt;：修改代码时，不确定是否会引入新的问题。&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;复杂性的来源&#34;&gt;复杂性的来源&lt;/h3&gt;

&lt;p&gt;复杂性通常来源于以下几点：&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;模块之间的依赖&lt;/strong&gt;：一个模块的改动可能需要同步修改依赖它的其他模块。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;晦涩难懂的代码&lt;/strong&gt;：不清晰的变量名、函数名以及缺乏注释的逻辑。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;文档不足&lt;/strong&gt;：缺乏解释代码意图和约束的文档。&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;面对复杂性的两大策略&#34;&gt;面对复杂性的两大策略&lt;/h3&gt;

&lt;p&gt;书中提到了解决代码复杂性的两种核心策略：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;让代码更简单、更直观&lt;/strong&gt;

&lt;ul&gt;
&lt;li&gt;通过清晰的命名、简洁的逻辑、规范的实现，让代码易于理解。&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;封装复杂性&lt;/strong&gt;

&lt;ul&gt;
&lt;li&gt;将复杂逻辑封装起来，通过简洁的接口暴露给外部，用户无需关心内部细节。&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;h3 id=&#34;如何应对复杂性&#34;&gt;如何应对复杂性？&lt;/h3&gt;

&lt;p&gt;以下是书中提到的一些有效方法：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;模块化设计&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;将系统分解为独立模块，减少模块间的依赖。每个模块应只负责一个明确任务，提供清晰接口。&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;抽象&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;忽略不重要的细节，只暴露必要的信息。好的抽象能降低认知负荷并提高代码复用性。&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;信息隐藏&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;隐藏模块的内部实现细节，只暴露接口。这样能减少模块之间的耦合，降低修改风险。&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;设计通用接口&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;通用接口能隐藏细节并提高代码复用性。&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;专注于任务的知识&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;设计模块时，应关注任务所需的知识，而非任务发生的顺序。&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;注释代码&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;注释应解释代码的“为什么”，而非“是什么”。例如，描述变量单位、边界条件等。&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;清晰命名&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;使用准确且一致的命名，避免歧义。&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;先写注释，再写代码&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;先用注释明确表达代码意图，然后再实现。&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;设计两次&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;初步完成代码后，重新审视设计，思考是否有更好的接口和实现方式。&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;统一规范&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;制定团队代码规范，保持一致性，提高可读性。&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;显式代码优于隐式代码&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;代码应尽可能清晰易懂，避免晦涩技巧。&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;h3 id=&#34;危险信号-什么时候该警惕复杂性&#34;&gt;危险信号：什么时候该警惕复杂性？&lt;/h3&gt;

&lt;p&gt;以下是书中提到的一些“危险信号”，遇到这些情况时，需要考虑重构：&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;浅模块&lt;/strong&gt;：接口与实现的复杂性相差无几。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;信息泄漏&lt;/strong&gt;：设计决策导致多个模块之间耦合。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;时间分解&lt;/strong&gt;：代码结构依赖操作执行顺序，而非基于信息隐藏。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;过度暴露&lt;/strong&gt;：API 暴露了不常用的功能。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;重复代码&lt;/strong&gt;：相同代码反复出现。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;联合方法&lt;/strong&gt;：两个方法间依赖性强，难以单独理解。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;注释重复代码&lt;/strong&gt;：注释仅重复代码内容。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;含糊不清的名称&lt;/strong&gt;：变量或方法名称传递不了有用信息。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;难以描述&lt;/strong&gt;：需要冗长文档解释变量或方法意图。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;非显而易见的代码&lt;/strong&gt;：代码行为或意图不直观。&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;软件设计的核心原则&#34;&gt;软件设计的核心原则&lt;/h3&gt;

&lt;p&gt;书中总结了以下关键原则：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;复杂性是逐步增加的&lt;/strong&gt;：从小事做起，持续改进。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;代码跑起来并不够&lt;/strong&gt;：还需关注可读性和可维护性。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;持续投入改善系统设计&lt;/strong&gt;：不要忽视代码的长期维护成本。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;模块应该足够深&lt;/strong&gt;：接口要比实现简单得多。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;简化接口&lt;/strong&gt;：接口设计应尽可能简化最常见用法。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;通用与专用分离&lt;/strong&gt;：通用代码与专用代码应明确区分。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;层次分明&lt;/strong&gt;：不同层次应有不同抽象。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;降低复杂性&lt;/strong&gt;：始终关注减少认知负荷和模块耦合。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;先设计，再实现&lt;/strong&gt;：避免仓促决策，多次设计迭代。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;注释不明显内容&lt;/strong&gt;：好的注释可显著降低认知负荷。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;代码是写给人看的&lt;/strong&gt;：清晰性优先于实现技巧。&lt;/li&gt;
&lt;/ol&gt;

&lt;h3 id=&#34;结语&#34;&gt;结语&lt;/h3&gt;

&lt;p&gt;《软件设计的哲学》让我意识到，软件开发不仅是实现功能，更是一门需要深思熟虑的艺术。它提醒我们，代码的核心目标是&lt;strong&gt;易于理解和维护&lt;/strong&gt;。毕竟，&lt;strong&gt;代码是写给人看的，其次才是给机器看的&lt;/strong&gt;。希望这些心得对你有所启发，让我们一起写出更清晰、更优雅的代码！&lt;/p&gt;</description>
    </item>
    
    <item>
      <title>如何快速上手项目</title>
      <link>https://zhu327.github.io/2025/01/08/%E5%A6%82%E4%BD%95%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B%E9%A1%B9%E7%9B%AE/</link>
      <pubDate>Wed, 08 Jan 2025 10:55:52 &#43;0800</pubDate>
      
      <guid>https://zhu327.github.io/2025/01/08/%E5%A6%82%E4%BD%95%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B%E9%A1%B9%E7%9B%AE/</guid>
      <description>&lt;p&gt;职业生涯中接手过很多项目了，各种项目都接触过，一个对新人友好的项目一般具备如下特征：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;完备的安装/功能文档&lt;/li&gt;
&lt;li&gt;完备的技术方案，架构设计文档&lt;/li&gt;
&lt;li&gt;合理的分层，清晰的代码目录结构&lt;/li&gt;
&lt;li&gt;可读，可维护性高的代码&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;但是往往我们会忽略一个一个简单的指引性的文档：&lt;strong&gt;Quick Start&lt;/strong&gt;，这个文档不需要很详细，只需要说明，如何快速上手的过程，具体的步骤链接到对应的文档即可。一般我们会在Quick Start上写明：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;最简安装的步骤&lt;/li&gt;
&lt;li&gt;主流程功能的使用&lt;/li&gt;
&lt;li&gt;开发环境的搭建&lt;/li&gt;
&lt;li&gt;开发注意事项

&lt;ol&gt;
&lt;li&gt;包含组件的架构图&lt;/li&gt;
&lt;li&gt;包含代码的分层目录说明&lt;/li&gt;
&lt;/ol&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;这个文档需要由项目的负责人编写，在后续由项目的新人实践的过程中逐步完善。&lt;/p&gt;

&lt;p&gt;当然这都是比较理想的情况，实际情况中，我们可能遇到的项目可能根本就没有文档，然后只有一个代码仓库的情况，那怎么才能快速上手呢？其实还是按照Quick Start的思路，只不过需要自己来摸索来了。&lt;/p&gt;

&lt;p&gt;&lt;/p&gt;

&lt;h3 id=&#34;1-安装&#34;&gt;1. 安装&lt;/h3&gt;

&lt;p&gt;我相信不管什么项目，或多或少都有一些如何安装的文档，如果连一点这样的文档都没有，那就需要问其它同事了，如果连问都问不出来，那恭喜你赶快跑路吧，😂&lt;/p&gt;

&lt;p&gt;因为我们是初次接触项目，不必搞懂安装的每个步骤，每个配置的含义，目标仅仅是把项目跑起来，能用起来，所以这里的目标就是安装最简化的方式把项目跑起来。当前的后端项目一般采用容器交付的形式，一般就交付镜像与helm chart，这种方式的安装理论来说是非常简单的，一条helm install 的命令就可以搞定。所以我们在交付的的时一定要在默认的配置中写好最简化的配置，这样新人就可以直接用默认的配置来安装。&lt;/p&gt;

&lt;h3 id=&#34;2-功能体验&#34;&gt;2. 功能体验&lt;/h3&gt;

&lt;p&gt;安装好之后，我们就可以从产品的角度开始体验项目的相关功能，这里我们要聚焦到项目的核心功能上，跑完整个主要流程，不要在意细节，也不要急于把体验的功能与代码实现结合起来，我们只要梳理功能流程，数据的流转，数据的建模。然后有经验的程序员往往会在这个过程中思考，这个功能如果是我来做，我会怎么做。在这个过程中一定要有自己的输出，比如：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;功能清单&lt;/li&gt;
&lt;li&gt;功能流程图&lt;/li&gt;
&lt;li&gt;数据模型&lt;/li&gt;
&lt;li&gt;数据流转图&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;如果有思考如何实现，还可以记录这些：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;技术选型&lt;/li&gt;
&lt;li&gt;技术方案&lt;/li&gt;
&lt;li&gt;架构设计&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;在体验过程中如果发现了问题，也需要记录下来，还有自己对项目的疑问，为什么要这么设计，这个功能解决的什么实际问题等等。&lt;/p&gt;

&lt;p&gt;但是我们需要注意的是避免陷入细节，有些东西没搞懂就没搞懂，没有关系，我们是一个新人，搞不懂也正常，把没搞懂的问题记录下来，后续再逐步熟悉。&lt;/p&gt;

&lt;h3 id=&#34;3-组件拆解与用途分析&#34;&gt;3. 组件拆解与用途分析&lt;/h3&gt;

&lt;p&gt;在功能体验完成后，我们就有了自己的对与项目的思考，也有了一些疑问，然后我们就可以从项目的依赖的各个组件来逐步搞清楚这些问题。比如项目中用了什么数据库，用了什么缓存等等。然后我们可以对照我们自己的分析来看看项目是不是真的就是想我们想想的来实现的，数据库的表设计是不是也跟我们的数据建模一致。经验丰富的程序员往往很快就能猜出项目的主要组件依赖，快速画出一个简单的架构图。&lt;/p&gt;

&lt;h3 id=&#34;4-项目代码分析&#34;&gt;4. 项目代码分析&lt;/h3&gt;

&lt;p&gt;搞明白各个组件的用途后，我们需要的是单刀直入，从主要功能流程出发，找到对应代码的入口，然后按照我们整理的功能流程，梳理出代码流转的过程，在这个过程中我们就可以大体分析出项目代码中目录的分层，各个模块的功能了。我们还可以借助工具来绘制代码的依赖图，这样可以帮助我们快速的理解代码。&lt;/p&gt;

&lt;p&gt;在阅读的过程中代码本身可能也会有我们看不惯的地方，这个时候我们需要把代码切出一个分支来，专门用来记录自己阅读时写的注释以及一些觉得要重构的点，但是千万不要直接开始动手，一定只是记录，打上标记，比如：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;// TODO: 这里有待重构
// ? 为什么这里用的是这种方式
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;等等，也是把自己的疑问记录下来，后续有需要可以带着疑问去问同事。&lt;/p&gt;

&lt;p&gt;在代码阅读的过程中，切记不要陷入细节，不要陷入细节，不要陷入细节。我们只需要搞清楚代码流转的过程即可，至于代码的实现细节，我们后续在解BUG的过程中再去逐步熟悉。&lt;/p&gt;

&lt;h3 id=&#34;5-从小问题入手-逐步上手&#34;&gt;5. 从小问题入手，逐步上手&lt;/h3&gt;

&lt;p&gt;入手项目的初期不要好高骛远，我们从解小的BUG开始熟悉怎么正确的提交第一个PR，在这个过程中我们可以学习项目的规范，正确的写单元测试，然后解BUG的过程中我们不要看哪里的代码就只是哪里的代码，我们还需要关注模块的边界，了解整个模块都有一些什么功能。很多的BUG往往不是主要功能流程中的问题，在处理这些小的BUG的时候正是我们去了解其它非主要流程功能的好机会。&lt;/p&gt;

&lt;h3 id=&#34;6-新功能与重构&#34;&gt;6. 新功能与重构&lt;/h3&gt;

&lt;p&gt;当我们对项目有一定的了解后，就可以做一些新功能了，然后在规划新功能时，往往我们需要对涉及到已有的代码做一些重构，我们需要把握代码重构的一个度，一定是有限处理对我们写新功能有阻碍的代码，然后需要考虑功能的后续迭代与未来的演进来重构。渐进式的重构，不要上来就搞大的，我相信很多程序员都希望能把代码写的跟符合自己的审美，但是初期还是要以功能为主，再实现功能的同时小步渐进式的重构。重构有很多技巧，我们可以把我们改不动的代码做隔离，先保证能跑起来，然后再完善。&lt;/p&gt;

&lt;h3 id=&#34;总结&#34;&gt;总结&lt;/h3&gt;

&lt;p&gt;初入一个项目，我们可能会遇到很多很多问题，但是没有关系的，我们需要做的是把这些疑问都记录下来，然后带着疑问慢慢去熟悉，熟悉一个项目也需要一个过程，不要着急，1个星期不行，就1个月，遇到困难就及时寻求帮助。前人种树，后人乘凉。如果前人没能帮你种好树，那我们就把我们熟悉项目的过程整理成文档，留给后人，这样后人就可以少走很多弯路。&lt;/p&gt;</description>
    </item>
    
    <item>
      <title>我的2024</title>
      <link>https://zhu327.github.io/2024/12/31/%E6%88%91%E7%9A%842024/</link>
      <pubDate>Tue, 31 Dec 2024 10:55:52 &#43;0800</pubDate>
      
      <guid>https://zhu327.github.io/2024/12/31/%E6%88%91%E7%9A%842024/</guid>
      <description>&lt;p&gt;今天是2024年的最后一天，我有这一下午的空闲时间，所以就让我来絮絮叨叨的写写我这神奇的2024年吧。&lt;/p&gt;

&lt;p&gt;我是龙年出生的，所以2024年是我的本命年，年初的时候，老婆还有姐姐就给我准备了红内裤，红袜子。由于红袜子太过显眼了，所以这一年我的内裤都是红色的，哈哈。本命年，犯太岁，这一年工作上，心态上，都有一些变化，就让我在本命年的最后一天瞎写写吧。&lt;/p&gt;

&lt;h3 id=&#34;我自己&#34;&gt;我自己&lt;/h3&gt;

&lt;p&gt;我是80年代末生人，出生在一个小镇，是标准的小镇做题家。从高中开始基本就不怎么回家了，然后上大学，跑去了云南，双非一本，学的是热能与动力工程。我的同学大都找到了水电厂，火电厂的工作。工作好的去了三峡，一般就去了云南一些比较偏僻的电厂。而我呢毕业就失业了，后来找到一个海南的小电厂。工作2年后，我就来到了深圳，在躺了好几个月后，经一个亲戚的介绍到一个华为的软件外包公司学习做软件测试。&lt;/p&gt;

&lt;p&gt;&lt;/p&gt;

&lt;p&gt;软件测试本身是没什么门槛的，然后我自认为还有点小聪明，也由于亲戚的安排，我所在的项目并不是纯粹的手工测试。而是偏向自动化的TCP/IP协议栈的测试，这个测试需要我写一些Lua脚本来模拟发送一些数据包来做测试。虽然这不是一个开发的工作，但是在这个过程中我还是学到不少东西，基本的协议栈，socket，还有一些基础的编程语言方面的知识。&lt;/p&gt;

&lt;p&gt;后来又换了别的项目，做GUI跟网页的功能测试，我接手这个项目的测试的时候，里面还维护了一堆Java写的基于一个IBM的测试框架的自动化测试用例。这可难倒我了，以至于大半年的时间我都没跑过这个自动化的测试，一直都是手动测试。想想不是办法，还是搞搞自动化的测试吧，Java是一时半会学不会的，不如自己学一学Python自动化吧，就这样我接触到Python编程。我依然记得在某一天我用Python写了一个自动匹配关键字的工具用来做安全检查后，获得了华为的持续集成奖。&lt;/p&gt;

&lt;p&gt;就这样我在这个软件外包公司做测试做了4年，然后我决定还是找一份Python开发的工作吧，于是在学习了Django开发后，我就裸辞了。&lt;/p&gt;

&lt;p&gt;在2015年的那个激荡的万众创业，万众创新的2015年，只要你会写点代码，就能找到工作。于是我入职了一家很小的公司做Python后端开发，然后半年之后，我就被优化了。这个时候我确实怀疑过自己，我是不是真的适合做开发呢，我能拿出手的项目只有我在github上写的一个Django的论坛。&lt;/p&gt;

&lt;p&gt;然后就又开始找工作了，不是很顺利，直到2015年下半年的某一天，我收到了一封邮件，嗯，一家我没有投递的公司邀请我去面试。后来才从这家公司的CTO口中得知，他是在看到我的github才邀请我去面试的，然后我就入职了这家公司，继续做Python的后端开发。在这家公司我又找到了自信。然后在这里我发现我做测试的经历还是有用的，毕竟我的自测做的比较细致，以至于我的效率以及质量都远超其他同事。然后由于效率的提升，很快我就开始负责更基础的框架开发，引入了DRF框架，还尝试做了RPC框架，然后又引入了API网关，认识了Openresty，你看，Openresty又回到了我最初做测试的老本行Lua上面。&lt;/p&gt;

&lt;p&gt;由于在github上面尝到了甜头，后续我又在github上写了一些Openresty的小项目，也有Python RPC相关的项目，然后也写了一些我觉得还行的博客文章。我感觉我的能力还是又比较大的提升的，我想我是不是再出去找找机会呢？所以我又开始面试了，不出意外的还是被打击到了，无非是因为非科班出生，然后基础很差。有一个比较nice的面试官推荐我去读一读深入理解计算机系统，然后我就买了这本书。年轻的时候还是比较要强的，不喜欢认输，所以花了好几个月死啃这本书，然后再回顾自己的在工作中点点滴滴，确实对编程这个工作有了更多的理解。再然后我就买了更多的书，在douban上找评分高的书，补齐了很多基础知识。&lt;/p&gt;

&lt;p&gt;时间来到了2018年，很幸运的是我通过了腾讯的面试，这里面有我读书的能力提升，也有不停在github上写项目的努力，还有我那几年积累下来的工作经验。&lt;/p&gt;

&lt;h3 id=&#34;腾讯&#34;&gt;腾讯&lt;/h3&gt;

&lt;p&gt;初入腾讯，我是在一个运维组里的唯一的开发，我接的需求都是我的运维同事通过开发工具来改善他们的运维工作。这期间有一个直播推流相关的需求对我来说算是一个契机，促成了我从Python程序转向Golang程序员。在这个组里做了一年后，我觉得我做的的事情都不具备持久性，没有一个清晰的未来，所以我决定换一个组，于是我来到了蓝鲸的开发组。&lt;/p&gt;

&lt;p&gt;在腾讯作为一个非科班出身的新人，我并没有觉得自己能做很久，我脑子里一直有一个念想就是做个几年，有了大厂光环，然后再出去作为一个架构师找一份新的工作。但是我在蓝鲸确实认识了一群nice的同事，然后这一做就是5年。这期间我一直专注在一个项目上，可以说成为了领域内的专家。持续的一直做一件事情有好处，也有坏处，好处是你可以在这个领域内做到极致，坏处是你很难跳出这个领域。&lt;/p&gt;

&lt;p&gt;在大厂，每半年一次的考核，催促着我成长，沟通能力，项目管理能力，架构能力，规划能力等等，我都有实实在在的成长。然而在本命年的这一年，我还是觉得我可以离开了，毕竟互联网35岁的危机，年纪越大感受越深。&lt;/p&gt;

&lt;h3 id=&#34;新工作&#34;&gt;新工作&lt;/h3&gt;

&lt;p&gt;虽然顶着大厂光环，但是在2024年36岁的年纪，找工作还是很困难，面试了很多，只要涉及写算法什么的基本都挂了，然后我就降薪入职了现在的公司。我有了更多的时间，然后写了更多的文章，也学习了Rust编程，新的Rust的项目也都放到了github上。我不知道自己的职业生涯还能走多远，但是我觉得我依然热爱编程。&lt;/p&gt;

&lt;p&gt;随着AI编程应用越来越多，我觉得对于头部的程序员来说，他们的优势会越来越大，因为AI会极大的提升他们的效率，这对中下部的程序员可能是一个灾难。可能会因为这个整个市场的行情会越来越差，所以我个人觉得持续学习，终身学习在这个时代是必须的。&lt;/p&gt;

&lt;h3 id=&#34;生活&#34;&gt;生活&lt;/h3&gt;

&lt;p&gt;3月的时候跟老婆来了一次广西自驾游，从深圳出发，开着我的电车第一次长途自驾，感谢老婆的辛苦做了攻略，在广西边境看了大瀑布，也第一次体验了溶洞速降，还看到了美丽梦幻的三门海。也去了一些小众的景点。在广西的山间小路悬崖边小心的开着车，在溶洞里面听着水流的声音，看着头顶的灯光，那种感觉真的很棒。&lt;/p&gt;

&lt;p&gt;7月的时候，正式从腾讯离职了，然后也没找到工作，就在家里躺平静静的思考了，关于工作不焦虑是假的，但是生活也是要继续的。新的工作开始后，我有了更多的时间陪小孩，看着小孩的成长，确实又感觉生活不一样了，小孩的需求没那么多，更多是我都是作为一个捧哏的角色，看着她玩耍，配合她的各种需求。&lt;/p&gt;

&lt;p&gt;关于未来，世界变化很快，我也不知道未来会怎么样，在深圳还没有买房，没啥压力，在广西游的过程中有个小小的种子种在了心里，什么时候能在广西找个山好水好的地方过上慢生活呢。&lt;/p&gt;

&lt;h3 id=&#34;结尾&#34;&gt;结尾&lt;/h3&gt;

&lt;p&gt;回头看2024年，这一年过得挺特别的，有变化也有成长。无论是工作上的转折，还是生活中的点滴，我都在慢慢适应、慢慢调整。虽然未来会怎样还不好说，但我想继续保持学习的习惯，保持对生活的热情，也尽量多陪陪家人。生活总是这样，充满未知，但也正因为如此，每一天都值得认真过好。&lt;/p&gt;</description>
    </item>
    
    <item>
      <title>从Pingora到API网关：总结</title>
      <link>https://zhu327.github.io/2024/12/19/%E4%BB%8Epingora%E5%88%B0api%E7%BD%91%E5%85%B3%E6%80%BB%E7%BB%93/</link>
      <pubDate>Thu, 19 Dec 2024 10:55:52 &#43;0800</pubDate>
      
      <guid>https://zhu327.github.io/2024/12/19/%E4%BB%8Epingora%E5%88%B0api%E7%BD%91%E5%85%B3%E6%80%BB%E7%BB%93/</guid>
      <description>&lt;h3 id=&#34;前言&#34;&gt;前言&lt;/h3&gt;

&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/zhu327/pingisx&#34;&gt;https://github.com/zhu327/pingisx&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;经过一个多月的开发，终于完成了使用Rust实现一个API网关的目标，通过这个项目，我基本上把Pingora的核心功能都摸透了，然后也再次加深了对APISIX的理解。总的来说PingSIX基于Pingora实现了APISIX的核心功能，是APISIX功能的一个子集。&lt;/p&gt;

&lt;p&gt;开发这个项目本身也是为了学习Rust的使用，在开发的过程中确实也遇到了很多的问题，在ChatGPT的帮助下，这些问题得到了解决，也让我对Rust有了更深刻的理解。下面我通过4个方面来总结一下在这个项目中我的收获。&lt;/p&gt;

&lt;p&gt;&lt;/p&gt;

&lt;h3 id=&#34;1-生命周期&#34;&gt;1. 生命周期&lt;/h3&gt;

&lt;p&gt;在Rust中，任何变量，对象都有它的生命周期与作用域，刚开始看Rust的书时，会想是不是只有&lt;strong&gt;指针&lt;/strong&gt;需要标注，它才有生命周期，其实不是的，任何变量都有生命周期，在作用域闭合时，生命周期也就结束了，而内存也会被释放。这就是Rust通过生命周期来管理内存的机制。&lt;/p&gt;

&lt;p&gt;变量的作用域可以从前一个转移到后一个，也就是&lt;code&gt;move&lt;/code&gt;, 转移后前一个作用域就不再持有这个变量，这就是所谓的所有权，这个变量是属于这个作用域，在作用域内就可以使用，而在&lt;code&gt;move&lt;/code&gt;出作用域后就无法使用了。比如一个函数的调用，对象在传入后，对象的作用域就转移到新的函数作用域中。那我们如果希望在原来的作用域中继续使用这个变量，就涉及到&lt;code&gt;Copy&lt;/code&gt; trait与&lt;code&gt;Clone&lt;/code&gt; trait了，如果对象实现了&lt;code&gt;Copy&lt;/code&gt; trait，那么这个变量就可以在原来的作用域中继续使用。如果对象实现了&lt;code&gt;Clone&lt;/code&gt; trait，那么这个变量可以在新的作用域中通过clone方法来获取。无论是&lt;code&gt;Copy&lt;/code&gt; trait还是&lt;code&gt;Clone&lt;/code&gt; trait，相当于把对象复制了一份，在新的作用域中可以使用。&lt;/p&gt;

&lt;p&gt;有时候我们并不希望每次函数调用都把对象复制一份，并且在函数中也不需要持有对象的所有权，这个时候就可以通过&lt;code&gt;&amp;amp;&lt;/code&gt;来&lt;strong&gt;借用&lt;/strong&gt;对象，通过&lt;code&gt;&amp;amp;mut&lt;/code&gt;来&lt;strong&gt;可变借用&lt;/strong&gt;对象。初看Rust的书，我会觉得这不就是指针吗，哪个语言没有这个概念呀，但是真正理解了生命周期与所有权后，就会发现这确实就是&lt;strong&gt;借用&lt;/strong&gt;，我不给你所有权，你必须在我的作用域内使用，这就是借用。&lt;/p&gt;

&lt;p&gt;然后再来理解下一个对象不能同时存在&lt;strong&gt;可变借用&lt;/strong&gt;与&lt;strong&gt;不可变借用&lt;/strong&gt;，也就比较好理解了，如果可变借用被修改了，那同时存在的不可以变借用到底是变了还是没变呢，如果都存在就是矛盾的。&lt;/p&gt;

&lt;p&gt;说完了借用，再来看看智能指针，我希望在多个作用域中使用对象，并且都有所有权，那就可以使用&lt;code&gt;Rc&amp;lt;T&amp;gt;&lt;/code&gt;，它实现了引用计数，当对象被Rc所持有时，引用计数加1，当离开作用域后，引用计数减1，当引用计数为0时内存被释放。&lt;code&gt;Rc&amp;lt;T&amp;gt;&lt;/code&gt;是不是线程安全的，所以我们往往使用&lt;code&gt;Arc&amp;lt;T&amp;gt;&lt;/code&gt;，它实现了原子的引用计数，所以是线程安全的。这2个智能指针是通过 &lt;code&gt;Drop&lt;/code&gt; trait来实现引用计数的变更。&lt;/p&gt;

&lt;p&gt;&lt;code&gt;Rc&amp;lt;T&amp;gt;&lt;/code&gt;与&lt;code&gt;Arc&amp;lt;T&amp;gt;&lt;/code&gt;如果直接包裹对象，那对象就是不可变的，为了实现可变借用，需要使用&lt;code&gt;RefCell&amp;lt;T&amp;gt;&lt;/code&gt;包裹对象，通过&lt;code&gt;borrow_mut()&lt;/code&gt;来获取可变借用。然而&lt;code&gt;RefCell&amp;lt;T&amp;gt;&lt;/code&gt;也不是线程安全的，所以需要使用&lt;code&gt;Mutex&amp;lt;T&amp;gt;&lt;/code&gt;或者&lt;code&gt;RWLock&amp;lt;T&amp;gt;&lt;/code&gt;来包裹对象，通过&lt;code&gt;lock()&lt;/code&gt;获取可变借用。&lt;/p&gt;

&lt;p&gt;说完了生命周期，所有权，借用，智能指针，举几个我在PingSIX中的实际代码，来帮助理解一下：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-rust&#34; data-lang=&#34;rust&#34;&gt;&lt;span class=&#34;sd&#34;&gt;/// Proxy load balancer.
&lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;///
&lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;/// Manages the load balancing of requests to upstream servers.
&lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;pub&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;ProxyUpstream&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;pub&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;inner&lt;/span&gt;: &lt;span class=&#34;nc&#34;&gt;config&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;Upstream&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;lb&lt;/span&gt;: &lt;span class=&#34;nc&#34;&gt;SelectionLB&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;runtime&lt;/span&gt;: &lt;span class=&#34;nb&#34;&gt;Option&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Runtime&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;watch&lt;/span&gt;: &lt;span class=&#34;nb&#34;&gt;Option&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;watch&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;Sender&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;bool&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;impl&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ProxyUpstream&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;pub&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;new_with_health_check&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;upstream&lt;/span&gt;: &lt;span class=&#34;nc&#34;&gt;config&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;Upstream&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;work_stealing&lt;/span&gt;: &lt;span class=&#34;kt&#34;&gt;bool&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;-&amp;gt; &lt;span class=&#34;nb&#34;&gt;Result&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Self&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;mut&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;proxy_upstream&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Self&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;try_from&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;upstream&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;?&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;proxy_upstream&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;start_health_check&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;work_stealing&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Ok&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;proxy_upstream&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;/// Starts the health check service, runs only once.
&lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;pub&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;start_health_check&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;mut&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;work_stealing&lt;/span&gt;: &lt;span class=&#34;kt&#34;&gt;bool&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Some&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;mut&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;service&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;take_background_service&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Create a channel for watching the health check status
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;watch_tx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;watch_rx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;watch&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;channel&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kc&#34;&gt;false&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;watch&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Some&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;watch_tx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Determine the number of threads for the service
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;threads&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;service&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;threads&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;().&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unwrap_or&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Create a runtime based on the work_stealing flag
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;runtime&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;create_runtime&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;work_stealing&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;threads&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;service&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;());&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Spawn the service on the runtime
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;runtime&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get_handle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;().&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;spawn&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;async&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;move&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;service&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;start_service&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;None&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;watch_rx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;).&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;await&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;info&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;Service exited.&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;});&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Set the runtime lifecycle with ProxyUpstream
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;runtime&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Some&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;runtime&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;create_runtime&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;work_stealing&lt;/span&gt;: &lt;span class=&#34;kt&#34;&gt;bool&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;threads&lt;/span&gt;: &lt;span class=&#34;kt&#34;&gt;usize&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;service_name&lt;/span&gt;: &lt;span class=&#34;kp&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;str&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;-&amp;gt; &lt;span class=&#34;nc&#34;&gt;Runtime&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;work_stealing&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Runtime&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;new_steal&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;threads&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;service_name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;else&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Runtime&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;new_no_steal&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;threads&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;service_name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;stop_health_check&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;mut&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Some&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;watch&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;take&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;send&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kc&#34;&gt;true&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;...&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code&gt;ProxyUpstream&lt;/code&gt;是反向代理的上游对象，在new这个对象的同时会创建一个后台任务来执行健康检查，可以看到健康检查在这里是通过&lt;code&gt;tokio&lt;/code&gt;的&lt;code&gt;Runtime&lt;/code&gt;来执行的。在Golang中我可能会通过&lt;code&gt;go&lt;/code&gt;关键字来创建一个goroutine来执行后台任务就不管了，然而在Rust这里我必须在&lt;code&gt;spawn&lt;/code&gt;后台任务后让&lt;code&gt;ProxyUpstream&lt;/code&gt;持有&lt;code&gt;Runtime&lt;/code&gt;的生命周期，否则后台任务会因为作用域结束而提前退出。在&lt;code&gt;ProxyUpstream&lt;/code&gt;持有&lt;code&gt;Runtime&lt;/code&gt;后，只有当&lt;code&gt;ProxyUpstream&lt;/code&gt;对象被drop后，后台任务才会结束。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-rust&#34; data-lang=&#34;rust&#34;&gt;&lt;span class=&#34;k&#34;&gt;impl&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Drop&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ProxyUpstream&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;/// Stops the health check service if it exists.
&lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;drop&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;mut&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;stop_health_check&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 确保其他资源如 runtime 被释放
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Some&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;runtime&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;runtime&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;take&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 获取 runtime 的 handle
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;handler&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;runtime&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get_handle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;().&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;clone&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 使用 handler 执行关闭逻辑
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;handler&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;spawn_blocking&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;move&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;||&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;runtime&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shutdown_timeout&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Duration&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;from_secs&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;});&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;info&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;Runtime shutdown successfully.&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;再来看看&lt;code&gt;Drop&lt;/code&gt; trait的实现，在&lt;code&gt;ProxyUpstream&lt;/code&gt;对象被释放的同时我们希望停止健康检查，这个时候还需要主动关闭&lt;code&gt;Runtime&lt;/code&gt;，否则运行中的&lt;code&gt;Runtime&lt;/code&gt;会因为作用域结束而panic。&lt;/p&gt;

&lt;p&gt;再来看一个可变借用与不可变借用冲突的例子：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-rust&#34; data-lang=&#34;rust&#34;&gt;&lt;span class=&#34;cp&#34;&gt;#[async_trait]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;impl&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ServeHttp&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;AdminHttpApp&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;async&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;response&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;http_session&lt;/span&gt;: &lt;span class=&#34;kp&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;mut&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ServerSession&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;-&amp;gt; &lt;span class=&#34;nc&#34;&gt;Response&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Vec&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;u8&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;http_session&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;set_keepalive&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;None&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;validate_api_key&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;http_session&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;config&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;api_key&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;).&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;is_err&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Response&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;builder&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;status&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;StatusCode&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;FORBIDDEN&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;body&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Vec&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;())&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unwrap&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;req_header&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;http_session&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;req_header&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;path&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;req_header&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;uri&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;path&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;().&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;to_string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;method&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;req_header&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;method&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;clone&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;//   let (path, method) = {
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;//       let req_header = http_session.req_header();
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;//       (req_header.uri.path().to_string(), req_header.method.clone())
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;//   };
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;match&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;router&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;at&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;path&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Ok&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Match&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;value&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;params&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;})&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;match&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;value&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;method&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Some&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;handler&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                    &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;params&lt;/span&gt;: &lt;span class=&#34;nc&#34;&gt;BTreeMap&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;String&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;String&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;params&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;iter&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;map&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;k&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;v&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;k&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;to_string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;v&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;to_string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()))&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;collect&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;match&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;handler&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;handle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;etcd&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;http_session&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;params&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;).&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;await&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                        &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Ok&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;resp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;resp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                        &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Err&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Response&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;builder&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                            &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;status&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;StatusCode&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;BAD_REQUEST&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                            &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;body&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;to_string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;().&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;into_bytes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;())&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                            &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unwrap&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;None&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Response&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;builder&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;status&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;StatusCode&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;METHOD_NOT_ALLOWED&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;body&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Vec&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;())&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unwrap&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;},&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Err&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Response&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;builder&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;status&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;StatusCode&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;NOT_FOUND&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;body&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;b&amp;#34;Not Found&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;to_vec&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;())&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unwrap&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code&gt;http_session&lt;/code&gt;是一个可变借用，然后在获取&lt;code&gt;path&lt;/code&gt;与&lt;code&gt;method&lt;/code&gt;时，&lt;code&gt;http_session&lt;/code&gt;会变成不可变借用来调用&lt;code&gt;req_header()&lt;/code&gt;，然而在获取&lt;code&gt;path&lt;/code&gt;与&lt;code&gt;method&lt;/code&gt;后，&lt;code&gt;http_session&lt;/code&gt;又需要被修改，所以这里同时存在了可变借用与不可变借用，Rust编译器会提示错误。那怎么修改呢？&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-rust&#34; data-lang=&#34;rust&#34;&gt;&lt;span class=&#34;cp&#34;&gt;#[async_trait]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;impl&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ServeHttp&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;AdminHttpApp&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;async&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;response&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;http_session&lt;/span&gt;: &lt;span class=&#34;kp&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;mut&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ServerSession&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;-&amp;gt; &lt;span class=&#34;nc&#34;&gt;Response&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Vec&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;u8&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;...&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;path&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;method&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// 创建一个单独的作用域
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;req_header&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;http_session&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;req_header&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;req_header&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;uri&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;path&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;().&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;to_string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;req_header&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;method&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;clone&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;())&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;...&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;我们给&lt;code&gt;req_header&lt;/code&gt;创建一个单独的作用域，这样&lt;code&gt;http_session&lt;/code&gt;就变成不可变借用，在作用域结束时，&lt;code&gt;req_header&lt;/code&gt;也跟着释放了。这用就不会同时存在可变借用与不可变借用冲突了。&lt;/p&gt;

&lt;h3 id=&#34;2-函数式编程&#34;&gt;2. 函数式编程&lt;/h3&gt;

&lt;p&gt;以往在写Python或Golang的过程中基本上没怎么用到函数式编程，Python中虽然有map、filter等函数，但是也只是在简单的场景下使用。而Rust中函数式编程是必不可少的，它让代码更简洁、更优雅。在写PingSIX的过程中，刚开始我也没怎么用到函数式编程，一直就式老老实实的if else，match等等。这样代码其实也没问题，但是会让代码看起来很长，所以我就把我的代码帖到ChatGPT问问它如何能让代码更加简洁，就有了下面的这些代码：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-rust&#34; data-lang=&#34;rust&#34;&gt;&lt;span class=&#34;k&#34;&gt;impl&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Upstream&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;validate_upstream_host&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;-&amp;gt; &lt;span class=&#34;nb&#34;&gt;Result&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ValidationError&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pass_host&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;==&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;UpstreamPassHost&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;REWRITE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;upstream_host&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;as_ref&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;().&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;map_or_else&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;||&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Err&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ValidationError&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;upstream_host_required_for_rewrite&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Ok&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(()),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;else&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Ok&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(())&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这是一个简单是否为&lt;code&gt;Option&lt;/code&gt;的判断，如果为&lt;code&gt;None&lt;/code&gt;则返回错误，否则返回&lt;code&gt;Ok(())&lt;/code&gt;。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-rust&#34; data-lang=&#34;rust&#34;&gt;&lt;span class=&#34;cp&#34;&gt;#[async_trait]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;impl&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ServiceDiscovery&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;DnsDiscovery&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;/// Discovers backends by resolving DNS names to IP addresses.
&lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;async&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;discover&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;-&amp;gt; &lt;span class=&#34;nb&#34;&gt;Result&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;BTreeSet&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Backend&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;HashMap&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;u64&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;bool&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;as_str&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;log&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;debug&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;Resolving DNS for domain: {}&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;backends&lt;/span&gt;: &lt;span class=&#34;nc&#34;&gt;BTreeSet&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Backend&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;resolver&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;lookup_ip&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;await&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;or_err_with&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;InternalError&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;||&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;format&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;DNS discovery failed for domain: {}&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;})&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;?&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;iter&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;map&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ip&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;addr&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;SocketAddr&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ip&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;port&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;as&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;u16&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;).&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;to_string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Creating backend
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;mut&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;backend&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Backend&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;new_with_weight&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;addr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;weight&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;as&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;usize&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;).&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unwrap&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Determine if TLS is needed
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tls&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;matches&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;scheme&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;UpstreamScheme&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;HTTPS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;UpstreamScheme&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;GRPCS&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Create HttpPeer
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;mut&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;peer&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;HttpPeer&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;addr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tls&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;clone&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;());&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;matches&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;scheme&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;UpstreamScheme&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;GRPC&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;UpstreamScheme&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;GRPCS&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;peer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;options&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;alpn&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ALPN&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;H2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Insert HttpPeer into the backend
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;assert&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;backend&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ext&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;insert&lt;/span&gt;::&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;HttpPeer&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;peer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;).&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;is_none&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;());&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;backend&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;})&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;collect&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Return backends and an empty HashMap for now
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Ok&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;backends&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;HashMap&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()))&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这是一串DNS解析与转换的代码，说实话我的脑子里还没形成这种函数式编程的定式思维，虽然我看的懂，但是真正写的时候我还是不会直接想到这么写，幸好有ChatGPT帮我解决了这个问题。我想写的越多也就越熟悉了吧。&lt;/p&gt;

&lt;h3 id=&#34;3-多态&#34;&gt;3. 多态&lt;/h3&gt;

&lt;p&gt;在Rust里面写多态有2中选择，一种使用trait，一种是用enum，我们分别来看下。&lt;/p&gt;

&lt;h4 id=&#34;enum&#34;&gt;enum&lt;/h4&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-rust&#34; data-lang=&#34;rust&#34;&gt;&lt;span class=&#34;k&#34;&gt;enum&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;SelectionLB&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;RoundRobin&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;LB&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;RoundRobin&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Random&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;LB&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Random&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Fnv&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;LB&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;FVNHash&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Ketama&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;LB&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;KetamaHashing&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;impl&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TryFrom&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;config&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;Upstream&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;SelectionLB&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;type&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;Error&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Box&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Error&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;try_from&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;value&lt;/span&gt;: &lt;span class=&#34;nc&#34;&gt;config&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;Upstream&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;-&amp;gt; &lt;span class=&#34;nb&#34;&gt;Result&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Self&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;match&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;value&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;#&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;type&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;config&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;SelectionType&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;RoundRobin&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Ok&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;SelectionLB&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;RoundRobin&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;LB&lt;/span&gt;::&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;RoundRobin&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;try_from&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;value&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;?&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;config&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;SelectionType&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;Random&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Ok&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;SelectionLB&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;Random&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;LB&lt;/span&gt;::&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Random&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;try_from&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;value&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;?&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;config&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;SelectionType&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;Fnv&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Ok&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;SelectionLB&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;Fnv&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;LB&lt;/span&gt;::&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;FVNHash&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;try_from&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;value&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;?&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;config&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;SelectionType&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;Ketama&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Ok&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;SelectionLB&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;Ketama&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;LB&lt;/span&gt;::&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;KetamaHashing&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;try_from&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;value&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;?&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这是一个包装了多种负载均衡算法的枚举，在&lt;code&gt;try_from()&lt;/code&gt;方法中根据不同的类型创建对应的负载均衡算法。在使用时，我需要根据不同enum的variant进行match，然后调用对应的负载均衡算法。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-rust&#34; data-lang=&#34;rust&#34;&gt;&lt;span class=&#34;k&#34;&gt;impl&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ProxyUpstream&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;/// Selects a backend server for a given session.
&lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;pub&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;select_backend&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;na&#34;&gt;&amp;#39;a&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;na&#34;&gt;&amp;#39;a&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;session&lt;/span&gt;: &lt;span class=&#34;kp&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;na&#34;&gt;&amp;#39;a&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;mut&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Session&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;-&amp;gt; &lt;span class=&#34;nb&#34;&gt;Option&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Backend&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;key&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;request_selector_key&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;session&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;inner&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hash_on&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;inner&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;key&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;as_str&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;());&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;log&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;debug&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;proxy lb key: {}&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;key&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;mut&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;backend&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;match&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;lb&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;SelectionLB&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;RoundRobin&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;lb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;lb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;upstreams&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;select&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;key&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;as_bytes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;256&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;SelectionLB&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;Random&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;lb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;lb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;upstreams&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;select&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;key&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;as_bytes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;256&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;SelectionLB&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;Fnv&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;lb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;lb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;upstreams&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;select&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;key&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;as_bytes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;256&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;SelectionLB&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;Ketama&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;lb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;lb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;upstreams&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;select&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;key&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;as_bytes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;256&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;};&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Some&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;backend&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;backend&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;as_mut&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Some&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;peer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;backend&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ext&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get_mut&lt;/span&gt;::&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;HttpPeer&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;set_timeout&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;peer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;backend&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这样我们就可以隐藏不同负载均衡算法的细节，对外提供统一的调用入口来实现多态。&lt;/p&gt;

&lt;p&gt;在Pingora中处理http1与http2的差异时也使用enum来实现多态。&lt;/p&gt;

&lt;h4 id=&#34;trait&#34;&gt;trait&lt;/h4&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-rust&#34; data-lang=&#34;rust&#34;&gt;&lt;span class=&#34;sd&#34;&gt;/// Hybrid service discovery.
&lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;///
&lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;/// Combines static and DNS-based service discovery.
&lt;/span&gt;&lt;span class=&#34;sd&#34;&gt;&lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;#[derive(Default)]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;pub&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;HybridDiscovery&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;discoveries&lt;/span&gt;: &lt;span class=&#34;nb&#34;&gt;Vec&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Box&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;dyn&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ServiceDiscovery&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Send&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Sync&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;为了包装DNS的服务发现与静态服务发现，我定义了&lt;code&gt;HybridDiscovery&lt;/code&gt;同时处理这两种服务发现，它持有一个&lt;code&gt;Vec&amp;lt;Box&amp;lt;dyn ServiceDiscovery + Send + Sync&amp;gt;&amp;gt;&lt;/code&gt;的成员变量。这里通过Box包裹的trait object来实现多态。当然为了支持async trait，还要加上&lt;code&gt;Send + Sync&lt;/code&gt;。&lt;/p&gt;

&lt;h3 id=&#34;4-局部可变性&#34;&gt;4. 局部可变性&lt;/h3&gt;

&lt;p&gt;在我使用etcd来实现PingSix的资源实时加载时，遇到了这样的问题，对etcd client的使用必须是mut的，但是持有etcd client的对象又是不可变的，所以这里就必须包装出局部可变的etcd client，代码如下：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-rust&#34; data-lang=&#34;rust&#34;&gt;&lt;span class=&#34;k&#34;&gt;pub&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;EtcdClientWrapper&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;config&lt;/span&gt;: &lt;span class=&#34;nc&#34;&gt;Etcd&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;client&lt;/span&gt;: &lt;span class=&#34;nc&#34;&gt;Arc&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Mutex&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Option&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Client&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;impl&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;EtcdClientWrapper&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;pub&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cfg&lt;/span&gt;: &lt;span class=&#34;nc&#34;&gt;Etcd&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;-&amp;gt; &lt;span class=&#34;nc&#34;&gt;Self&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Self&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;config&lt;/span&gt;: &lt;span class=&#34;nc&#34;&gt;cfg&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;client&lt;/span&gt;: &lt;span class=&#34;nc&#34;&gt;Arc&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Mutex&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;None&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;async&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;ensure_connected&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;-&amp;gt; &lt;span class=&#34;nb&#34;&gt;Result&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Arc&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Mutex&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Option&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Client&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Box&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;dyn&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Error&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Send&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Sync&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;mut&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;client_guard&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;client&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;lock&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;().&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;await&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;client_guard&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;is_none&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;log&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;info&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;Creating new etcd client...&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;client_guard&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Some&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;create_client&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;config&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;).&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;await&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;?&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Ok&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;client&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;clone&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;())&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;pub&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;async&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;get&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;key&lt;/span&gt;: &lt;span class=&#34;kp&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;str&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;-&amp;gt; &lt;span class=&#34;nb&#34;&gt;Result&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Option&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Vec&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;u8&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Box&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;dyn&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Error&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Send&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Sync&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;client_arc&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ensure_connected&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;().&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;await&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;?&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;mut&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;client_guard&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;client_arc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;lock&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;().&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;await&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;client&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;client_guard&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;as_mut&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ok_or&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;Etcd client is not initialized&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;?&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;resp&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;client&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;with_prefix&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;key&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;None&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;).&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;await&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;?&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Ok&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;resp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;kvs&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;().&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;first&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;().&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;map&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;kv&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;kv&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;value&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;().&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;to_vec&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()))&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;pub&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;async&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;put&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;key&lt;/span&gt;: &lt;span class=&#34;kp&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;str&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;value&lt;/span&gt;: &lt;span class=&#34;nb&#34;&gt;Vec&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;u8&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;-&amp;gt; &lt;span class=&#34;nb&#34;&gt;Result&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Box&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;dyn&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Error&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Send&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Sync&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;client_arc&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ensure_connected&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;().&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;await&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;?&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;mut&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;client_guard&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;client_arc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;lock&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;().&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;await&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;client&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;client_guard&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;as_mut&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ok_or&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;Etcd client is not initialized&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;?&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;client&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;put&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;with_prefix&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;key&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;value&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;None&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;).&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;await&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;?&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Ok&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(())&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;pub&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;async&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;delete&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;key&lt;/span&gt;: &lt;span class=&#34;kp&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;str&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;-&amp;gt; &lt;span class=&#34;nb&#34;&gt;Result&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Box&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;dyn&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Error&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Send&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Sync&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;client_arc&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ensure_connected&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;().&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;await&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;?&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;mut&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;client_guard&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;client_arc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;lock&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;().&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;await&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;client&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;client_guard&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;as_mut&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ok_or&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;Etcd client is not initialized&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;?&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;client&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;delete&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;with_prefix&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;key&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;None&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;).&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;await&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;?&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Ok&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(())&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;with_prefix&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;key&lt;/span&gt;: &lt;span class=&#34;kp&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;str&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;-&amp;gt; &lt;span class=&#34;nb&#34;&gt;String&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;format&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;{}/{}&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;config&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;prefix&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;key&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;就如我在第一节的生命周期中所说的，为了局部可变，我们必须使用Arc&lt;Mutex&gt;包裹，这样在任何地方都可以通过lock()来获取可变引用。&lt;/p&gt;

&lt;h3 id=&#34;总结&#34;&gt;总结&lt;/h3&gt;

&lt;p&gt;在写PingSIX之前，我写过一些Rust的小项目，比如一些http接口的调用，比如一些TCP协议的解析。但是都没有系统性的来使用Rust，所以一直有计划用Rust来写一个API网关，然后这一个多月下来，我对Rust可以说有了一定的理解吧，虽然像&lt;code&gt;Send + Sync&lt;/code&gt;这种东西还是不太理解，但是至少知道怎么用了。在比如像&lt;code&gt;FnOnce&lt;/code&gt;，还有&lt;code&gt;Pin&lt;/code&gt;这些也都还不太了解，但是可以说现在用Rust写点项目还是可以的。&lt;/p&gt;

&lt;p&gt;PingSIX虽然只实现了APISIX的一个子集，有很多功能的缺失，比如被动的健康检查，动态的TLS支持，还有很多插件等，但是大的框架其实已经搭好了，剩下的其实都是体力活了。所以暂时先告一段落吧。&lt;/p&gt;

&lt;p&gt;通过这个项目我对Pingora的各个crate都有了深度使用，当然还有一些功能也是没有覆盖到，比如下面的这些：&lt;/p&gt;

&lt;p&gt;dynamic ssl：&lt;a href=&#34;https://github.com/cloudflare/pingora/blob/main/pingora/examples/server.rs#L77&#34;&gt;https://github.com/cloudflare/pingora/blob/main/pingora/examples/server.rs#L77&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;cache：&lt;a href=&#34;https://github.com/cloudflare/pingora/blob/main/pingora-proxy/tests/utils/server_utils.rs#L393&#34;&gt;https://github.com/cloudflare/pingora/blob/main/pingora-proxy/tests/utils/server_utils.rs#L393&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;这些都还没有文档，所以暂时先不提了。&lt;/p&gt;

&lt;p&gt;在开发这个项目的过程中，我频繁使用ChatGPT，深刻的感受到ChatGPT对于程序员的效率的提升，项目中的所有代码都经过了ChatGPT的Review，AI不会淘汰程序员，只会淘汰不会使用AI的程序员。&lt;/p&gt;</description>
    </item>
    
    <item>
      <title>从Pingora到API网关：Rust实战</title>
      <link>https://zhu327.github.io/2024/11/15/%E4%BB%8Epingora%E5%88%B0api%E7%BD%91%E5%85%B3rust%E5%AE%9E%E6%88%98/</link>
      <pubDate>Fri, 15 Nov 2024 10:55:52 &#43;0800</pubDate>
      
      <guid>https://zhu327.github.io/2024/11/15/%E4%BB%8Epingora%E5%88%B0api%E7%BD%91%E5%85%B3rust%E5%AE%9E%E6%88%98/</guid>
      <description>&lt;h3 id=&#34;前言&#34;&gt;前言&lt;/h3&gt;

&lt;p&gt;在学习Rust的过程中，我主要进行了一些小工具的练习，对Rust的内存安全性和性能优势有了初步的体会，但始终没有实现过一个完整的大型项目。最近随着Rust在高性能计算领域的应用不断拓展，尤其是Pingora等项目的发布，让我看到了Rust在网络通信领域中的潜力，也激发了我用Rust来实现一个API网关的兴趣。&lt;/p&gt;

&lt;p&gt;在加入腾讯之前，我曾使用OpenResty和Kong进行API网关的开发工作，后来在腾讯进一步深入参与了APISix的云原生网关项目，逐步积累了关于API网关设计、实现以及性能调优方面的经验。API网关是一个兼具架构复杂度与性能要求的系统，涉及请求路由、流量控制、身份验证等多个关键模块，恰好可以充分发挥Rust的优势。因此，我决定以Rust为基础开发一个API网关，这不仅是为了提升自己的Rust技术，更希望通过此项目进一步巩固和提升在API网关方面的知识。&lt;/p&gt;

&lt;p&gt;在具体实现中，我计划基于Pingora的设计思路，打造一个APISix网关的子集功能。我已在GitHub上发布了该项目的初始版本 &lt;a href=&#34;https://github.com/zhu327/pingsix&#34;&gt;https://github.com/zhu327/pingsix&lt;/a&gt;，目前实现了基础的standalone模式，包括基本的路由与反向代理功能。接下来，我将扩展插件定义，逐步实现一些典型的功能插件，最终目标是支持基于etcd的动态配置加载，以便适应多场景的API网关需求。&lt;/p&gt;

&lt;p&gt;&lt;/p&gt;

&lt;h3 id=&#34;实现-配置&#34;&gt;实现：配置&lt;/h3&gt;

&lt;p&gt;在设计 pingsix 的配置文件时，我参考了 APISix 和 Pingora 的配置文件结构，结合自身项目目标和功能，简化了部分复杂内容，同时保持了核心功能的灵活性。配置文件包含以下三个关键部分：&lt;strong&gt;基础配置&lt;/strong&gt;、&lt;strong&gt;Listener 配置&lt;/strong&gt; 和 &lt;strong&gt;资源配置&lt;/strong&gt;，以下是详细说明与完整 YAML 示例。&lt;/p&gt;

&lt;h4 id=&#34;1-基础配置&#34;&gt;1. 基础配置&lt;/h4&gt;

&lt;p&gt;基础配置部分直接沿用了 Pingora 的设计，用于定义网关的全局行为和运行参数。以下是完整配置示例：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span class=&#34;c&#34;&gt;# pingora config example from https://github.com/cloudflare/pingora/blob/main/docs/user_guide/conf.md&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;pingora&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;version&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;              &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# 配置文件版本&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;threads&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;              &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# 工作线程数量&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;pid_file&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;/run/pingora.pid&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# 保存进程ID的文件路径&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;upgrade_sock&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;/tmp/pingora_upgrade.sock&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# 热升级用的Unix socket文件&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;user&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;nobody&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# 运行网关的用户&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;group&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;webusers&lt;span class=&#34;w&#34;&gt;         &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# 运行网关的用户组&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;设计思路&lt;/strong&gt;：这一部分配置是网关运行时的基础，保持简洁的同时，与 Pingora 配置完全兼容，降低了配置的学习成本。&lt;/p&gt;

&lt;hr /&gt;

&lt;h4 id=&#34;2-listener-配置&#34;&gt;2. Listener 配置&lt;/h4&gt;

&lt;p&gt;Listener 是 API 网关的入口，用于定义网关监听的地址、端口以及协议类型（HTTP/HTTPS）。以下是完整配置示例：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;listeners&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;-&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;address&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;0.0&lt;/span&gt;.&lt;span class=&#34;m&#34;&gt;0.0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;8080&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# HTTP监听地址和端口&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# - address: &amp;#34;[::1]:443&amp;#34;  # 示例：IPv6地址监听&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;#   tls:                  # 配置HTTPS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;#     cert_path: /etc/ssl/server.crt # SSL证书路径&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;#     key_path: /etc/ssl/server.key  # SSL私钥路径&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;#   offer_h2: true         # 是否支持HTTP/2&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;设计思路&lt;/strong&gt;：
- 当前支持 HTTP 和 HTTPS 协议，通过配置 &lt;code&gt;tls&lt;/code&gt; 参数来开启 HTTPS。 未来可能加入类似 APISix 的 &lt;code&gt;Stream Proxy&lt;/code&gt; 功能，用于支持 TCP/UDP 流量代理。&lt;/p&gt;

&lt;hr /&gt;

&lt;h4 id=&#34;3-资源配置&#34;&gt;3. 资源配置&lt;/h4&gt;

&lt;p&gt;资源配置是网关的核心部分，主要定义路由规则（Router）和后端服务（Upstream）的负载均衡策略。目前 pingsix 支持的功能子集以实现反向代理为主，以下是完整示例：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span class=&#34;c&#34;&gt;# 参考APISix的Standalone模式配置示例：https://apisix.apache.org/zh/docs/apisix/3.1/stand-alone/&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# 完整的Router，Upstream配置参考APISix的API文档：https://apisix.apache.org/zh/docs/apisix/admin-api/#route&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;routers&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;-&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;id&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                     &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# 路由唯一标识&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;uri&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;/&lt;span class=&#34;w&#34;&gt;                    &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# 路由匹配的URI&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;host&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;www.baidu.com&lt;span class=&#34;w&#34;&gt;       &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# 匹配的主机&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# 可选项：&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# uris: [&amp;#34;/&amp;#34;,&amp;#34;/test&amp;#34;]     # 支持多个URI匹配&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# hosts: [&amp;#34;www.baidu.com&amp;#34;,&amp;#34;www.taobao.com&amp;#34;] # 支持多个Host匹配&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# methods: [&amp;#34;GET&amp;#34;, &amp;#34;POST&amp;#34;] # 限制请求方法&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# timeout:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;#   connect: 2           # 连接超时时间（秒）&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;#   send: 3              # 发送超时时间（秒）&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;#   read: 5              # 读取超时时间（秒）&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# priority: 10           # 路由优先级（数字越大，优先级越高）&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;upstream&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# 定义后端服务&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;nodes&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;www.baidu.com&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;   &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# 后端服务地址及权重&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;type&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;roundrobin&lt;span class=&#34;w&#34;&gt;       &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# 负载均衡类型（支持roundrobin、random等）&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;checks&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# 健康检查配置&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;active&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;              &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# 主动健康检查&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;type&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;https&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# 检查类型（http/https）&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;timeout&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;         &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# 健康检查超时时间（秒）&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;host&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;www.baidu.com&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# 检查目标主机&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;http_path&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;/&lt;span class=&#34;w&#34;&gt;       &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# 健康检查路径&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;https_verify_certificate&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;kc&#34;&gt;true&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# 是否验证HTTPS证书&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;req_headers&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;User-Agent: curl/7.29.0&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# 请求头&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;healthy&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;           &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# 健康服务的标准&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;interval&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;5&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# 健康检查间隔时间（秒）&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;http_statuses&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;200&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;201&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# 判断健康的HTTP状态码&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;successes&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;     &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# 连续成功次数&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;unhealthy&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;         &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# 不健康服务的标准&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;http_failures&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;5&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# 连续失败的HTTP请求次数&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;tcp_failures&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;m&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# 连续失败的TCP请求次数&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;pass_host&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;rewrite&lt;span class=&#34;w&#34;&gt;     &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# 是否透传主机信息&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;upstream_host&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;www.baidu.com&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# 传递给后端的Host&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;scheme&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;https&lt;span class=&#34;w&#34;&gt;          &lt;/span&gt;&lt;span class=&#34;c&#34;&gt;# 使用的协议（http/https）&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;说明&lt;/strong&gt;：
- &lt;strong&gt;Router&lt;/strong&gt; 定义了请求的路由规则，目前支持 &lt;code&gt;uri&lt;/code&gt; 和 &lt;code&gt;host&lt;/code&gt; 的匹配，还可以扩展支持 &lt;code&gt;methods&lt;/code&gt;、&lt;code&gt;priority&lt;/code&gt; 等参数。
- &lt;strong&gt;Upstream&lt;/strong&gt; 配置支持负载均衡和健康检查，支持配置各种复杂均衡算法，还支持主动健康检查。&lt;/p&gt;

&lt;p&gt;可以在 &lt;a href=&#34;https://github.com/zhu327/pingsix/blob/main/config.yaml&#34;&gt;GitHub&lt;/a&gt; 查看完整的配置文件。&lt;/p&gt;

&lt;hr /&gt;

&lt;h4 id=&#34;4-配置加载&#34;&gt;4. 配置加载&lt;/h4&gt;

&lt;p&gt;在 pingsix 中，配置加载的实现方式与 Pingora 完全兼容，主要通过复用 Pingora 的命令行解析和配置加载代码来完成。这些代码大部分是直接借鉴了 Pingora 的实现，并根据 pingsix 的需求做了一些简单的调整和优化。&lt;/p&gt;

&lt;h5 id=&#34;主要改进&#34;&gt;主要改进：&lt;/h5&gt;

&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;使用 &lt;code&gt;serde&lt;/code&gt; 进行配置解析&lt;/strong&gt;：配置文件仍然采用 YAML 格式，使用 &lt;code&gt;serde_yaml&lt;/code&gt; 库进行解析。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;配置校验&lt;/strong&gt;：为了确保配置的正确性，我们引入了 &lt;code&gt;validator&lt;/code&gt; crate，对配置项进行简单的校验，确保它们符合预期。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;默认值和拷贝&lt;/strong&gt;：通过 &lt;code&gt;serde&lt;/code&gt; 的 &lt;code&gt;default&lt;/code&gt; 特性简化了默认值的处理，使用 &lt;code&gt;Clone&lt;/code&gt; derive 特性实现了配置的拷贝。&lt;/li&gt;
&lt;/ol&gt;

&lt;h5 id=&#34;配置加载实现&#34;&gt;配置加载实现&lt;/h5&gt;

&lt;p&gt;配置的加载流程和 Pingora 基本一致，代码结构也与 Pingora 相似。我们首先读取 YAML 配置文件，然后通过 &lt;code&gt;serde_yaml&lt;/code&gt; 进行解析，最后使用 &lt;code&gt;validator&lt;/code&gt; 校验配置项的合法性。&lt;/p&gt;

&lt;p&gt;具体的实现可以参考 &lt;a href=&#34;https://github.com/zhu327/pingsix/blob/main/src/config/mod.rs&#34;&gt;pingsix 的配置加载代码&lt;/a&gt;，该文件展示了配置解析、校验和默认值处理的实现方式。&lt;/p&gt;

&lt;h3 id=&#34;实现-上游&#34;&gt;实现：上游&lt;/h3&gt;

&lt;p&gt;从 APISix 的上游配置功能可以看出，网关的上游模块需要具备以下核心功能：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;DNS 解析&lt;/strong&gt;：支持上游服务的域名解析。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;负载均衡算法&lt;/strong&gt;：支持多种负载均衡算法和自定义 hash key。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;健康检查&lt;/strong&gt;：实现主动健康检查，确保上游服务的可用性。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;超时与重试配置&lt;/strong&gt;：为连接、发送和读取设置超时时间，并在请求失败时进行重试。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;协议支持&lt;/strong&gt;：支持 HTTP 和 HTTPS 上游协议。&lt;/li&gt;
&lt;/ol&gt;

&lt;h4 id=&#34;上游模块实现结构&#34;&gt;上游模块实现结构&lt;/h4&gt;

&lt;p&gt;根据 Pingora 的抽象设计，我们将上游处理拆分为两个主要模块，分别负责服务发现和负载均衡：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;服务发现模块&lt;/strong&gt;&lt;br /&gt;
服务发现模块位于 &lt;code&gt;discovery.rs&lt;/code&gt;，支持静态 IP 配置、域名 DNS 解析，并允许 HTTP/HTTPS 混合配置。详情见 &lt;a href=&#34;https://github.com/zhu327/pingsix/blob/main/src/proxy/discovery.rs&#34;&gt;discovery.rs 源码&lt;/a&gt;。&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;负载均衡模块&lt;/strong&gt;&lt;br /&gt;
负载均衡模块位于 &lt;code&gt;lb.rs&lt;/code&gt;，支持 roundrobin、random、fnvhash 和 ketama 等算法，并按照 APISix 实现了部分基于 &lt;code&gt;vars&lt;/code&gt;、&lt;code&gt;header&lt;/code&gt; 和 &lt;code&gt;cookie&lt;/code&gt; 的 hash 计算。负载均衡模块可扩展不同的 hash key 类型。更多实现细节见 &lt;a href=&#34;https://github.com/zhu327/pingsix/blob/main/src/proxy/lb.rs&#34;&gt;lb.rs 源码&lt;/a&gt;。&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;h4 id=&#34;实现心得&#34;&gt;实现心得&lt;/h4&gt;

&lt;ol&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;多态设计&lt;/strong&gt;：通过 &lt;code&gt;enum&lt;/code&gt; 实现负载均衡算法的多态性，将不同算法的差异封装在模块内，便于调用和扩展。&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;配置转换简化&lt;/strong&gt;：使用 &lt;code&gt;From&lt;/code&gt; trait 将配置结构转换为业务对象，简化代码，提高可读性。&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;健康检查集成&lt;/strong&gt;：Pingora 的健康检查逻辑与上游绑定在一起，而健康检查后台服务需要在 server 启动时注入。因此，我们在上层结构中将上游和健康检查逻辑绑定，通过 &lt;code&gt;Option&lt;/code&gt; 灵活控制其生命周期。&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;以上实现方法确保了代码结构的简洁性和模块的可复用性，建议阅读相关源码进一步了解实现细节。&lt;/p&gt;

&lt;h3 id=&#34;实现-路由&#34;&gt;实现：路由&lt;/h3&gt;

&lt;p&gt;路由模块参考了 &lt;a href=&#34;https://github.com/apache/apisix/tree/master/apisix/http/router&#34;&gt;APISix 的 radixtree_host_uri 路由方式&lt;/a&gt;，通过 &lt;code&gt;host&lt;/code&gt; 和 &lt;code&gt;uri&lt;/code&gt; 的组合实现高效的路由匹配。&lt;/p&gt;

&lt;p&gt;在 pingsix 中，我们使用了 Rust 的 &lt;code&gt;matchit&lt;/code&gt; crate，这是一个高性能的 Radix Tree 路由库，用来实现与 APISix 相同的功能。&lt;code&gt;matchit&lt;/code&gt; 提供了灵活的路由匹配能力，支持精确匹配和通配符规则。&lt;/p&gt;

&lt;p&gt;此外，路由逻辑还结合了负载均衡（lb）模块的方法，实现请求的精准路由，并支持通过路由的 &lt;code&gt;timeout&lt;/code&gt; 配置覆盖默认的上游超时设置。&lt;/p&gt;

&lt;p&gt;完整实现可以参考 &lt;a href=&#34;https://github.com/zhu327/pingsix/blob/main/src/proxy/router.rs&#34;&gt;router.rs 源码&lt;/a&gt;。&lt;/p&gt;

&lt;h3 id=&#34;实现-pingora-service-与-server&#34;&gt;实现：Pingora Service 与 Server&lt;/h3&gt;

&lt;h4 id=&#34;service-实现&#34;&gt;Service 实现&lt;/h4&gt;

&lt;p&gt;Pingora 的 &lt;code&gt;Service&lt;/code&gt; 概念用于定义 HTTP 请求处理的各个阶段，其处理流程与 Nginx 的处理阶段类似（参考 &lt;a href=&#34;https://github.com/cloudflare/pingora/blob/main/docs/user_guide/phase.md&#34;&gt;Pingora 的阶段设计&lt;/a&gt;）。在 pingsix 中，通过实现 &lt;code&gt;ProxyService&lt;/code&gt; trait，可以构建一个完整的反向代理服务，并在以下阶段插入自定义逻辑：&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;request&lt;/strong&gt;: 请求接收后可进行修改或校验。&lt;br /&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;upstream_request&lt;/strong&gt;: 转发到上游前处理请求。&lt;br /&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;upstream_response&lt;/strong&gt;: 接收上游响应后进行处理。&lt;br /&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;response&lt;/strong&gt;: 返回客户端前对响应进行最终修改。&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;这种设计让我们可以通过插件灵活扩展功能，例如添加认证、流量控制等。核心代码实现可参考 &lt;a href=&#34;https://github.com/cloudflare/pingora/blob/main/src/mod.rs&#34;&gt;pingsix proxy 模块&lt;/a&gt;。&lt;/p&gt;

&lt;h4 id=&#34;server-实现&#34;&gt;Server 实现&lt;/h4&gt;

&lt;p&gt;Server 层负责协调配置、路由和服务启动等核心功能：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;加载配置与路由&lt;/strong&gt;&lt;br /&gt;
从配置文件中加载路由规则和监听地址，并初始化所需的服务模块。&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;启动监听器&lt;/strong&gt;&lt;br /&gt;
支持多协议监听（如 HTTP/HTTPS），并动态绑定配置的监听端口。&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;Service 扩展&lt;/strong&gt;&lt;br /&gt;
在 Server 中可以注册多种 &lt;code&gt;Service&lt;/code&gt; 实现：&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;ProxyService&lt;/code&gt;: 用于处理反向代理逻辑。&lt;br /&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;BackgroundService&lt;/code&gt;: 如健康检查后台任务。&lt;br /&gt;&lt;/li&gt;
&lt;li&gt;自定义扩展 Service，例如自动申请证书等。&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;通过这种设计，Server 可以灵活地管理多个服务实例，扩展功能变得简单且直观。完整的实现代码可参考 &lt;a href=&#34;https://github.com/zhu327/pingsix/blob/main/src/main.rs&#34;&gt;pingsix 的 main.rs&lt;/a&gt;。&lt;/p&gt;

&lt;h3 id=&#34;规划&#34;&gt;规划&lt;/h3&gt;

&lt;p&gt;接下来，我们将基于当前的反向代理功能进一步完善 API 网关的核心扩展能力，规划包括：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;插件支持&lt;/strong&gt;&lt;br /&gt;
引入插件机制，支持动态加载和执行，逐步实现 API 网关的关键插件（如认证、限流、日志等），提升功能的灵活性与可扩展性。&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;动态配置管理&lt;/strong&gt;&lt;br /&gt;
集成 etcd，实现配置的动态加载和更新，以便在无需重启服务的情况下动态调整路由、上游配置等。&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;上游与服务的独立配置&lt;/strong&gt;&lt;br /&gt;
提供上游（upstream）和服务（service）的单独配置抽象，使得复杂业务需求下的配置更清晰、模块化。&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;hr /&gt;

&lt;p&gt;经过以上设计，我们已经构建了一个完整的基础反向代理功能，但要实现 API 网关的核心价值，接下来的重点将聚焦在插件系统的设计与实现，以便支持更丰富的功能扩展。&lt;/p&gt;

&lt;h3 id=&#34;参考&#34;&gt;参考&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/apache/apisix&#34;&gt;APISix&lt;/a&gt; - 开源、高性能的 API 网关，提供丰富的插件支持和灵活的配置管理。&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/cloudflare/pingora&#34;&gt;Pingora&lt;/a&gt; - Cloudflare 开发的高性能反向代理，采用 Rust 实现，设计灵感来源于 Nginx。&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;其他相关项目：&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/vicanso/pingap&#34;&gt;pingap&lt;/a&gt; - 一个使用 Rust 实现的轻量级 API 网关，适合参考其架构和插件设计。&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/memorysafety/river&#34;&gt;river&lt;/a&gt; - Rust 实现的分布式流量管理系统，支持动态路由和负载均衡功能。&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/caibirdme/penguin&#34;&gt;penguin&lt;/a&gt; - Rust 编写的反向代理服务器，用于学习和参考其路由与负载均衡实现。&lt;/li&gt;
&lt;/ul&gt;</description>
    </item>
    
    <item>
      <title>k8s云原生程序实现CRD的搜索查询分页</title>
      <link>https://zhu327.github.io/2024/10/22/k8s%E4%BA%91%E5%8E%9F%E7%94%9F%E7%A8%8B%E5%BA%8F%E5%AE%9E%E7%8E%B0crd%E7%9A%84%E6%90%9C%E7%B4%A2%E6%9F%A5%E8%AF%A2%E5%88%86%E9%A1%B5/</link>
      <pubDate>Tue, 22 Oct 2024 10:55:52 &#43;0800</pubDate>
      
      <guid>https://zhu327.github.io/2024/10/22/k8s%E4%BA%91%E5%8E%9F%E7%94%9F%E7%A8%8B%E5%BA%8F%E5%AE%9E%E7%8E%B0crd%E7%9A%84%E6%90%9C%E7%B4%A2%E6%9F%A5%E8%AF%A2%E5%88%86%E9%A1%B5/</guid>
      <description>&lt;h3 id=&#34;前言&#34;&gt;前言&lt;/h3&gt;

&lt;p&gt;来新公司还是在做云原生平台的开发，基本的业务逻辑就是通过一系列的CRD资源，走Operator的模式来实现平台的各种业务部署。但是CRD在apiserver中是以key-value的形式存储在etcd中，虽然labels可以实现简单的查询，但是并不能满足复杂的查询条件。在我来之前CRD资源的列表查询都是直接全量返回由前端自行筛选，随着业务量的增加，查询的效率越来越低。&lt;/p&gt;

&lt;p&gt;本来这个项目的前任开发者决策使用MySQL来双写CRD资源，来实现辅助查询，代码也写了很多了，双写带来了一些代码结构上的耦合，但是其实也不是个问题。更恶心的问题是有一个客户由于信创方面的政治问题，要求我们不能引入MySQL！虽然客户有建议用他们自己的数据库，但是从我们的角度来说，我们不希望自己的服务依赖外部客户组件，所以就必须考虑下其它的方案了，比如不用数据库服务。&lt;/p&gt;

&lt;p&gt;基于以往在SQLite上的学习经验，以当前CRD资源的体量完全可以使用SQLite来实现CRD资源的辅助查询，那么是不是要引入持久存储呢？其实还是不用，因为CRD本身已经存储在etcd中了，我们只需要在程序启动时通过k8s的List-Watch的方式将CRD资源同步到SQLite中，这样就可以实现CRD资源的辅助查询了。具体到实现上完全可以使用k8s client中的informer来实现CRD资源的同步，这样可以使用到informer的缓存机制减少apiserver的查询压力。&lt;/p&gt;

&lt;p&gt;&lt;/p&gt;

&lt;h3 id=&#34;实现&#34;&gt;实现&lt;/h3&gt;

&lt;h4 id=&#34;synchronizer的接口定义&#34;&gt;synchronizer的接口定义&lt;/h4&gt;

&lt;p&gt;首先我们定一个synchronizer接口，针对每种需要同步的CRD资源，需要实现synchronizer接口。这个接口会处理informer的add、update、delete事件，将CRD资源同步到SQLite中。每一个资源可以创建一张在SQLite中创建的表，将CRD资源同步到表中。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;kn&#34;&gt;import&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
	&lt;span class=&#34;s&#34;&gt;&amp;#34;k8s.io/apimachinery/pkg/runtime/schema&amp;#34;&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;

&lt;span class=&#34;kd&#34;&gt;type&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;synchronizer&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;interface&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;gvr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;schema&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;GroupVersionResource&lt;/span&gt;

	&lt;span class=&#34;nx&#34;&gt;add&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;obj&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;interface&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{})&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;update&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;oldObj&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;newObj&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;interface&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{})&lt;/span&gt;
	&lt;span class=&#34;nb&#34;&gt;delete&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;obj&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;interface&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{})&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;

&lt;span class=&#34;c1&#34;&gt;// 以下是一个实现接口的例子
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;type&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;templateSynchronizerImpl&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;struct&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;manager&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;dao&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;TemplateManager&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;// SQLite数据库操作
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;

&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;templateSynchronizerImpl&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;gvr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;schema&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;GroupVersionResource&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
	&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;schema&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;GroupVersionResource&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
		&lt;span class=&#34;nx&#34;&gt;Group&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;    &lt;span class=&#34;s&#34;&gt;&amp;#34;apps.titanide.cn&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
		&lt;span class=&#34;nx&#34;&gt;Version&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;  &lt;span class=&#34;s&#34;&gt;&amp;#34;v1alpha1&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
		&lt;span class=&#34;nx&#34;&gt;Resource&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;&amp;#34;templates&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
	&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;

&lt;span class=&#34;c1&#34;&gt;// 分别处理informer的add、update、delete事件，把数据同步到SQLite的表中
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;templateSynchronizerImpl&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;add&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;obj&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;interface&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{})&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;

&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;templateSynchronizerImpl&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;update&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;oldObj&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;newObj&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;interface&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{})&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;

&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;templateSynchronizerImpl&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;delete&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;obj&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;interface&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{})&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h4 id=&#34;同步逻辑实现&#34;&gt;同步逻辑实现&lt;/h4&gt;

&lt;p&gt;然后我们使用k8s的dynamicclient的informer来实现CRD资源的同步，因为这段代码在项目中的层级比较低，没能直接创建带scheme的client，所以只能使用dynamicclient。如果你的项目代码层级比较高，可以直接使用带scheme的client。initSynchronizer函数必须在服务启动时调用，等待同步完成后再启动服务。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;kn&#34;&gt;import&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
	&lt;span class=&#34;s&#34;&gt;&amp;#34;os&amp;#34;&lt;/span&gt;
	&lt;span class=&#34;s&#34;&gt;&amp;#34;os/signal&amp;#34;&lt;/span&gt;
	&lt;span class=&#34;s&#34;&gt;&amp;#34;syscall&amp;#34;&lt;/span&gt;
	&lt;span class=&#34;s&#34;&gt;&amp;#34;time&amp;#34;&lt;/span&gt;

	&lt;span class=&#34;s&#34;&gt;&amp;#34;github.com/pkg/errors&amp;#34;&lt;/span&gt;
	&lt;span class=&#34;s&#34;&gt;&amp;#34;k8s.io/apimachinery/pkg/apis/meta/v1/unstructured&amp;#34;&lt;/span&gt;
	&lt;span class=&#34;s&#34;&gt;&amp;#34;k8s.io/apimachinery/pkg/runtime&amp;#34;&lt;/span&gt;
	&lt;span class=&#34;s&#34;&gt;&amp;#34;k8s.io/apimachinery/pkg/runtime/schema&amp;#34;&lt;/span&gt;
	&lt;span class=&#34;s&#34;&gt;&amp;#34;k8s.io/client-go/dynamic&amp;#34;&lt;/span&gt;
	&lt;span class=&#34;s&#34;&gt;&amp;#34;k8s.io/client-go/dynamic/dynamicinformer&amp;#34;&lt;/span&gt;
	&lt;span class=&#34;s&#34;&gt;&amp;#34;k8s.io/client-go/rest&amp;#34;&lt;/span&gt;
	&lt;span class=&#34;s&#34;&gt;&amp;#34;k8s.io/client-go/tools/cache&amp;#34;&lt;/span&gt;

	&lt;span class=&#34;nx&#34;&gt;appsv1alpha1&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;&amp;#34;project/api/apis/apps/v1alpha1&amp;#34;&lt;/span&gt;
	&lt;span class=&#34;s&#34;&gt;&amp;#34;project/pkg/database&amp;#34;&lt;/span&gt;
	&lt;span class=&#34;s&#34;&gt;&amp;#34;project/pkg/database/dao&amp;#34;&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;

&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;initSynchronizer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;client&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;GetKubeDynamicClient&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
	&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;!=&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;nil&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
		&lt;span class=&#34;nb&#34;&gt;panic&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
	&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;

  &lt;span class=&#34;nx&#34;&gt;sigCh&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;make&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;chan&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;os&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Signal&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;signal&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Notify&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;sigCh&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;syscall&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;SIGINT&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;syscall&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;SIGTERM&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;

	&lt;span class=&#34;nx&#34;&gt;stopCh&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;make&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;chan&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{})&lt;/span&gt;
	&lt;span class=&#34;c1&#34;&gt;// 启动一个goroutine，等待接收信号
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;	&lt;span class=&#34;k&#34;&gt;go&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
		&lt;span class=&#34;o&#34;&gt;&amp;lt;-&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;sigCh&lt;/span&gt;
		&lt;span class=&#34;nb&#34;&gt;close&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;stopCh&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
	&lt;span class=&#34;p&#34;&gt;}()&lt;/span&gt;

	&lt;span class=&#34;c1&#34;&gt;// 启动同步逻辑
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;	&lt;span class=&#34;nx&#34;&gt;db&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;database&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;GetDB&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;

  &lt;span class=&#34;c1&#34;&gt;// 初始化具体的同步对象
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;	&lt;span class=&#34;nx&#34;&gt;templateSynchronizer&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;newTemplateSynchronizer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;dao&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;NewTemplateManager&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;db&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;projectSynchronizer&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;newProjectSynchronizer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;dao&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;NewProjectManager&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;db&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;pluginSynchronizer&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;newPluginSynchronizer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;dao&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;NewPluginManager&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;db&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;

	&lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;synchronize&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;client&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[]&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;synchronizer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;templateSynchronizer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;projectSynchronizer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;pluginSynchronizer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;},&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;stopCh&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
	&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;!=&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;nil&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
		&lt;span class=&#34;nb&#34;&gt;panic&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
	&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;

&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;synchronize&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;dynamicClient&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;dynamic&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Interface&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;syncs&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[]&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;synchronizer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;stopCh&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;chan&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{})&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;error&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
	&lt;span class=&#34;c1&#34;&gt;// 创建 Informer 工厂, 10分钟全量同步一次
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;	&lt;span class=&#34;nx&#34;&gt;factory&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;dynamicinformer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;NewDynamicSharedInformerFactory&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;dynamicClient&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;time&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Minute&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;10&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;

	&lt;span class=&#34;nx&#34;&gt;hasSyncedFuncs&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;make&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;([]&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;cache&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;InformerSynced&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;len&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;syncs&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;
	&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;sync&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;range&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;syncs&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
		&lt;span class=&#34;c1&#34;&gt;// 创建 informer
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;		&lt;span class=&#34;nx&#34;&gt;gvr&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;sync&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;gvr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;

		&lt;span class=&#34;nx&#34;&gt;informer&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;factory&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;ForResource&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;gvr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;).&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Informer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;

		&lt;span class=&#34;c1&#34;&gt;// 设置事件处理程序
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;		&lt;span class=&#34;nx&#34;&gt;informer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;AddEventHandler&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;cache&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;ResourceEventHandlerFuncs&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
			&lt;span class=&#34;nx&#34;&gt;AddFunc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;    &lt;span class=&#34;nx&#34;&gt;sync&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;add&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
			&lt;span class=&#34;nx&#34;&gt;UpdateFunc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;sync&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;update&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
			&lt;span class=&#34;nx&#34;&gt;DeleteFunc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;sync&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;delete&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
		&lt;span class=&#34;p&#34;&gt;})&lt;/span&gt;

		&lt;span class=&#34;c1&#34;&gt;// 启动 informer
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;		&lt;span class=&#34;k&#34;&gt;go&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;informer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Run&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;stopCh&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;

		&lt;span class=&#34;nx&#34;&gt;hasSyncedFuncs&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;append&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;hasSyncedFuncs&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;informer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;HasSynced&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
	&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;

	&lt;span class=&#34;c1&#34;&gt;// 等待缓存同步
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;	&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;cache&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;WaitForCacheSync&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;stopCh&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;hasSyncedFuncs&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;...&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
		&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;errors&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;New&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;failed to wait for cache sync&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
	&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;

	&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;nil&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;

&lt;span class=&#34;c1&#34;&gt;// GetKubeDynamicClient 函数用于获取 Kubernetes 客户端集，返回一个指向 *kubernetes.Clientset 的指针和 error 对象
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;GetKubeDynamicClient&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;dynamic&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Interface&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;error&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;cfg&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;rest&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;InClusterConfig&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
	&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;!=&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;nil&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
		&lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;errors&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Wrap&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;&amp;#34;failed to get cluster config&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
		&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;nil&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt;
	&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;

	&lt;span class=&#34;nx&#34;&gt;dynamicClient&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;dynamic&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;NewForConfig&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;cfg&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
	&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;!=&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;nil&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
		&lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;errors&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Wrap&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;&amp;#34;failed to create dynamicClient&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
		&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;nil&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt;
	&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;

	&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;dynamicClient&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;nil&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&#34;其它&#34;&gt;其它&lt;/h3&gt;

&lt;p&gt;通过以上机制，我们就可以实现CRD资源的辅助查询了。这种同步机制也摆脱了需要双写的复杂逻辑，在程序启动时List同步，启动后Watch动态更新，在查询时直接从SQLite中查询，写入时直接写CRD。从某种意义上来说，这种机制实现了读写分离，也解决了双写带来的耦合问题。&lt;/p&gt;

&lt;p&gt;在封装db的dao层时，基于以往项目的经验还是建议直接使用sqlx+squirrel来实现SQL的生成和执行，这样在代码结构上会更加清晰。没有引入ORM的原因是以前踩过坑。&lt;/p&gt;

&lt;p&gt;在使用SQLite时建议开启一些配置，来优化性能：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;nx&#34;&gt;db&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;MustExec&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;PRAGMA journal_mode = WAL;&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;nx&#34;&gt;db&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;MustExec&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;PRAGMA synchronous=NORMAL;&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;nx&#34;&gt;db&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;MustExec&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;PRAGMA mmap_size = 134217728;&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;nx&#34;&gt;db&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;MustExec&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;PRAGMA journal_size_limit = 27103364;&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;nx&#34;&gt;db&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;MustExec&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;PRAGMA cache_size=2000;&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&#34;总结&#34;&gt;总结&lt;/h3&gt;

&lt;p&gt;在实际项目中我们会碰到各种问题，解决问题的思路和方法多种多样。需要根据项目的实际情况与项目未来的发展方向来决策使用什么方法来解决问题。以我当前的项目为例，客户的政治原因导致不能引入MySQL，只能考虑其它的方式来解决问题。在引入SQLite的同时还解决了需要双写带来的耦合问题，这里的代码不多，但是提供一种解决CRD资源通用查询的思路，有需要可以参考。&lt;/p&gt;</description>
    </item>
    
  </channel>
</rss>
