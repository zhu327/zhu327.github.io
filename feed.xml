<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
      <title> on  </title>
      <generator uri="https://gohugo.io">Hugo</generator>
    <link>https://zhu327.github.io/</link>
    <language>zh-cn</language>
    
    
    <updated>Wed, 30 Mar 2022 17:38:04 &#43;0800</updated>
    
    <item>
      <title>About</title>
      <link>https://zhu327.github.io/about/</link>
      <pubDate>Mon, 01 Jan 0001 00:00:00 UTC</pubDate>
      
      <guid>https://zhu327.github.io/about/</guid>
      <description>&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-javascript&#34; data-lang=&#34;javascript&#34;&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;s2&#34;&gt;&amp;#34;name&amp;#34;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;朱小一&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
    &lt;span class=&#34;s2&#34;&gt;&amp;#34;job&amp;#34;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;Python backend engineer&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
    &lt;span class=&#34;s2&#34;&gt;&amp;#34;contact&amp;#34;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
        &lt;span class=&#34;s2&#34;&gt;&amp;#34;email&amp;#34;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;zhu327@gmail.com&amp;#34;&lt;/span&gt;
    &lt;span class=&#34;p&#34;&gt;},&lt;/span&gt;
    &lt;span class=&#34;s2&#34;&gt;&amp;#34;social network&amp;#34;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
        &lt;span class=&#34;s2&#34;&gt;&amp;#34;weibo&amp;#34;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;http://weibo.com/zhu327&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
        &lt;span class=&#34;s2&#34;&gt;&amp;#34;instagram&amp;#34;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;https://www.instagram.com/zhu327/&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
        &lt;span class=&#34;s2&#34;&gt;&amp;#34;github&amp;#34;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;https://github.com/zhu327&amp;#34;&lt;/span&gt;
    &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</description>
    </item>
    
    <item>
      <title>编程语言漫谈</title>
      <link>https://zhu327.github.io/2022/03/30/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E6%BC%AB%E8%B0%88/</link>
      <pubDate>Wed, 30 Mar 2022 17:38:04 &#43;0800</pubDate>
      
      <guid>https://zhu327.github.io/2022/03/30/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E6%BC%AB%E8%B0%88/</guid>
      <description>&lt;p&gt;半年前还是2021年春节的时候, 在家休假的我, 在B站上发现了一门叫&lt;a href=&#34;https://www.bilibili.com/video/BV1hp4y1k7SV&#34;&gt;RUST语言的课程&lt;/a&gt;, 学习的过程中, 发现RUST语言为了绝对的安全性, 在语法本身上做了很多的妥协, 所以想着等我学完这门课, 再基于自己以往编程语言的学习经历, 写一篇&amp;lt;如何学习一门新的编程语言&amp;gt;的文章. 但是时过境迁, 我并没有学完这门RUST课, 所以&amp;lt;如何学习一门新的编程语言&amp;gt;也就无疾而终了. 回过头来再思考下以往我学习的那些编程语言, 就有了这篇文章&amp;lt;编程语言漫谈&amp;gt;. 我希望以一种比较轻松的散文的形式来阐述我过完学习的一些经验与思考.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://user-images.githubusercontent.com/873883/160806614-07709f0a-add6-464b-a76a-bbaffdeab727.jpg&#34; alt=&#34;rust&#34; width=&#34;720px&#34;&gt;&lt;/p&gt;

&lt;p&gt;&lt;/p&gt;

&lt;h3 id=&#34;1-程序是如何运行的&#34;&gt;1. 程序是如何运行的&lt;/h3&gt;

&lt;p&gt;关于程序是如何运行的是一个很大的话题, 我个人认为最好的教材是这本&lt;a href=&#34;https://book.douban.com/subject/26912767/&#34;&gt;深入理解计算机系统&lt;/a&gt;, 值得每个程序员深入的阅读, 这里我就不再对这本书的内容做详细的总结, 只提2个点, CPU与内存.&lt;/p&gt;

&lt;h4 id=&#34;cpu&#34;&gt;CPU&lt;/h4&gt;

&lt;p&gt;&lt;img src=&#34;https://pic2.zhimg.com/v2-8b5b6ff186ebb7deef6905aa71c48261_r.jpg&#34; alt=&#34;preview&#34; /&gt;&lt;/p&gt;

&lt;p&gt;说到CPU就绕不过冯诺依曼结构, 在这个体系中, CPU就是一个非常傻的元器件, 它只做3件事:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;获取输入指令&lt;/li&gt;
&lt;li&gt;执行指令&lt;/li&gt;
&lt;li&gt;输出结果&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;然后循环做以上三件事, 只要不断电, 永不停歇.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://static001.geekbang.org/infoq/f5/f51fe88175b096a4cb3cbf6bd233fac3.png&#34; alt=&#34;img&#34; /&gt;&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;1．取指令阶段&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;取指令（Instruction Fetch，IF）阶段是将一条指令从主存中取到指令寄存器的过程。&lt;/p&gt;

&lt;p&gt;程序计数器PC中的数值，用来指示当前指令在主存中的位置。当一条指令被取出后，PC中的数值将根据指令字长度而自动递增。若为单字长指令，则(PC)+1PC，若为双字长指令，则(PC)+2PC，依此类推。&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;2．指令译码阶段&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;取出指令后，计算机立即进入指令译码（Instruction Decode，ID）阶段。&lt;/p&gt;

&lt;p&gt;在指令译码阶段，指令译码器按照预定的指令格式，对取回的指令进行拆分和解释，识别和区分出不同的指令类别及各种获取操作数的方法。&lt;/p&gt;

&lt;p&gt;在组合逻辑控制的计算机中，指令译码器对不同的指令操作码产生不同的控制电位，以形成不同的微操作序列；在微程序控制的计算机中，指令译码器用指令操作码找到执行该指令的微程序的入口，并从此入口开始执行。&lt;/p&gt;

&lt;p&gt;在传统的设计里，CPU中负责指令译码的部分是无法改变的硬件。不过，在众多运用微程序控制技术的新型CPU中，微程序有时是可重写的，可以通过修改成品CPU来改变CPU的译码方式。&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;3．执行指令阶段&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;在取指令和指令译码阶段之后，接着进入执行指令（Execute，EX）阶段。&lt;/p&gt;

&lt;p&gt;此阶段的任务是完成指令所规定的各种操作，具体实现指令的功能。为此，CPU的不同部分被连接起来，以执行所需的操作。&lt;/p&gt;

&lt;p&gt;例如，如果要求完成一个加法运算，算术逻辑单元（ALU）将被连接到一组输入和一组输出，输入端提供需要相加的数值，而输出端将含有最后的运算结果。&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;4．访存取数阶段&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;根据指令需要，有可能要访问主存，读取操作数，这样就进入了访存取数（Memory，MEM）阶段。&lt;/p&gt;

&lt;p&gt;此阶段的任务是：根据指令地址码，得到操作数在主存中的地址，并从主存中读取该操作数用于运算。&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;5．结果写回阶段&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;作为最后一个阶段，结果写回（Writeback，WB）阶段把执行指令阶段的运行结果数据“写回”到某种存储形式。结果数据经常被写到CPU的内部寄存器中，以便被后续的指令快速地存取。在有些情况下，结果数据也可被写入相对较慢、但较廉价且容量较大的主存。许多指令还会改变程序状态字寄存器中标志位的状态，这些标志位标识着不同的操作结果，可被用来影响程序的动作。&lt;/p&gt;

&lt;p&gt;在指令执行完毕、结果数据写回之后，若无意外事件（如结果溢出等）发生，计算机就接着从程序计数器PC中取得下一条指令地址，开始新一轮的循环，下一个指令周期将正常地顺序取出下一条指令。&lt;/p&gt;

&lt;p&gt;许多新型CPU可以同时取出、译码和执行多条指令，体现出并行处理的特性。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;以上内容引用至&lt;a href=&#34;[CPU的工作过程 (intel.com)](https://software.intel.com/content/www/cn/zh/develop/articles/book-processor-architecture_cpu_work_process.html)&#34;&gt;CPU的工作过程&lt;/a&gt;, 虽然有5个阶段, 但是仔细看现代CPU还是脱离不了冯诺依曼体系结构, 仍然是在循环着取指令, 执行指令, 输出结果的过程.&lt;/p&gt;

&lt;h4 id=&#34;内存&#34;&gt;内存&lt;/h4&gt;

&lt;p&gt;从以上CPU结构, 我们可以看出无论是取指令还是输出结果, CPU都依赖于总线与外部存储, 也就是内存做交互. 那么程序是如何使用内存的呢, 这里以Linux的程序内存布局为例来说明.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://user-images.githubusercontent.com/873883/160808304-cffa5cad-f5d9-443d-9a52-eb565c25c3dd.png&#34; alt=&#34;memory&#34; width=&#34;720px&#34;&gt;&lt;/p&gt;

&lt;p&gt;在Linux系统中, 每个程序在运行时, 都会由操作系统将自己的可执行二进制文件载入到内存中, 通过虚拟内存地址空间, 每个程序看到的自己的内存高地址与低地址都是一样的, 其中用于运行函数本地变量的地址空间叫栈, 而需要程序自行管理内存的空间叫堆. 每个函数运行时都会在栈上创建一块栈帧, 函数返回时pop出栈帧, 空间被回收. 在堆上的内存分配则需要手动管理, 程序自行申请空间, 回收空间.&lt;/p&gt;

&lt;h4 id=&#34;汇编&#34;&gt;汇编&lt;/h4&gt;

&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;汇编语言&lt;/strong&gt;（英语：&lt;strong&gt;assembly language&lt;/strong&gt;）[&lt;a href=&#34;https://zh.wikipedia.org/wiki/汇编语言#cite_note-1&#34;&gt;注 1]&lt;/a&gt;[&lt;a href=&#34;https://zh.wikipedia.org/wiki/汇编语言#cite_note-2&#34;&gt;1]&lt;/a&gt;是任何一种用于&lt;a href=&#34;https://zh.wikipedia.org/wiki/电子计算机&#34;&gt;电子计算机&lt;/a&gt;、&lt;a href=&#34;https://zh.wikipedia.org/wiki/微处理器&#34;&gt;微处理器&lt;/a&gt;、&lt;a href=&#34;https://zh.wikipedia.org/wiki/微控制器&#34;&gt;微控制器&lt;/a&gt;，或其他可编程器件的&lt;a href=&#34;https://zh.wikipedia.org/wiki/低级语言&#34;&gt;低级语言&lt;/a&gt;。在不同的设备中，汇编语言对应着不同的&lt;a href=&#34;https://zh.wikipedia.org/wiki/机器语言&#34;&gt;机器语言&lt;/a&gt;&lt;a href=&#34;https://zh.wikipedia.org/wiki/指令集架構&#34;&gt;指令集&lt;/a&gt;。一种汇编语言专用于某种&lt;a href=&#34;https://zh.wikipedia.org/wiki/计算机系统结构&#34;&gt;计算机系统结构&lt;/a&gt;，而不像许多&lt;a href=&#34;https://zh.wikipedia.org/wiki/高级语言&#34;&gt;高级语言&lt;/a&gt;，可以在不同系统平台之间移植。&lt;/p&gt;

&lt;p&gt;使用汇编语言编写的源代码，然后通过相应的汇编程序将它们转换成可执行的机器代码。这一过程被称为&lt;strong&gt;汇编过程&lt;/strong&gt;。&lt;/p&gt;

&lt;p&gt;汇编语言使用助记符（Mnemonics）来代替和表示特定低级机器语言的操作。特定的汇编目标指令集可能会包括特定的操作数。许多汇编程序可以识别代表地址和常量的标签（Label）和符号（Symbols），这样就可以用字符来代表操作数而无需采取&lt;a href=&#34;https://zh.wikipedia.org/wiki/寫死&#34;&gt;写死&lt;/a&gt;的方式。普遍地说，每一种特定的汇编语言和其特定的机器语言指令集是一一对应的。&lt;/p&gt;

&lt;p&gt;许多汇编程序为程序开发、汇编控制、辅助&lt;a href=&#34;https://zh.wikipedia.org/wiki/调试工具&#34;&gt;调试&lt;/a&gt;提供了额外的支持机制。有的汇编语言编写工具经常会提供&lt;a href=&#34;https://zh.wikipedia.org/wiki/巨集&#34;&gt;宏&lt;/a&gt;，它们也被称为宏汇编器。&lt;/p&gt;

&lt;p&gt;现在汇编语言已不像其他大多数的程序设计语言一样被广泛用于&lt;a href=&#34;https://zh.wikipedia.org/wiki/程序設計&#34;&gt;程序设计&lt;/a&gt;，在今天的实际应用中，它通常被应用在底层硬件操作和高要求的程序优化的场合。&lt;a href=&#34;https://zh.wikipedia.org/wiki/驅動程序&#34;&gt;驱动程序&lt;/a&gt;、嵌入式&lt;a href=&#34;https://zh.wikipedia.org/wiki/操作系统&#34;&gt;操作系统&lt;/a&gt;和实时运行程序中都会需要汇编语言。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;以上是维基百科对于汇编的解释, 简单的理解汇编就是对于特定的硬件的指令的一种符号表示, 每个汇编指令与二进制的CPU指令机器码是一一对应的, 是为了避免让程序员直接写二进制程序被发明出来的一种便捷方式. 从汇编语言转换成可执行的二进制文件需要执行汇编过程.&lt;/p&gt;

&lt;p&gt;直接写汇编也不方便, 需要程序员了解整个CPU的结构, 了解所有CPU提供的指令, 了解每个寄存器的作用, 了解内存中每个地址该存什么, 而程序员通常并不想详细了解这些. 那怎么办呢:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;遇到问题不会解决的时候，多加一层就可以解决&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;这是计算机领域的一条金句, 为了解决汇编的上述问题, 通过抽象一门新的编程语言, 向程序员屏蔽掉以上细节, 可以大大的提高程序员的生产效率, 下面将介绍C语言来如何解决汇编带来的问题.&lt;/p&gt;

&lt;h3 id=&#34;2-c语言&#34;&gt;2. C语言&lt;/h3&gt;

&lt;p&gt;&lt;img src=&#34;https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy85c053c1hjTjY4cjlIUkc4RUR5cjRxaWJXdVB1ZVROYURJd0tmaWJVdFBKeVQxV1FQWnpyWXVXMjJERWlhdDZOdkFDdWxvN1VUM3MzOHM0b1pORVZ0MTBydy82NDA?x-oss-process=image/format,png&#34; alt=&#34;C语言编译&#34; /&gt;&lt;/p&gt;

&lt;p&gt;C语言是计算机世界的基石级语言, 它通过抽象的函数, 循环, 分支语句使得程序员不需要了解计算中的底层实现细节, 向程序员屏蔽了不同计算机指令架构的差异, 通过不同的编译器实现, 只需要写一份代码就可以在多个不同指令架构的机器上执行相同的逻辑.&lt;/p&gt;

&lt;p&gt;在Google有很多关于 Jeff Dean的笑话, 其中有一个关于编译器的:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Jeff Dean每次写完代码, 都会编译一遍, 不是为了检查自己写的程序是否正确, 而是检查编译器是否有BUG&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;C语言并不是一门完美的语言, 写C语言的程序员往往关注程序的性能, 这就需要程序员了解性能的瓶颈在哪里, 往往又需要了解到程序的每一条指令的执行细节, 这就造成了一个矛盾的点, C语言本身是想向程序员屏蔽计算机的实现细节, 但是想要用C语言写好程序又需要程序员充分了解C语言编译生成的每条汇编的细节.&lt;/p&gt;

&lt;p&gt;同时C语言使用手动管理内存的方式, 或多或少会制造出各种内存的安全性问题, 比如空指针, 野指针等等问题, 对于程序员来说, 应付这些问题并不轻松.&lt;/p&gt;

&lt;p&gt;随着计算机硬件性能的大幅提升, 使得程序员可以不再那么多的关注程序本身的运行性能, 更多的关注程序的逻辑实现, 互联网的兴起, 又导致IO密集的应用占比大幅提高, 为了解放生产力, 需要更高层次的语言, Python就是其中的一种.&lt;/p&gt;

&lt;h3 id=&#34;3-python语言&#34;&gt;3. Python语言&lt;/h3&gt;

&lt;p&gt;问: &lt;strong&gt;Python语言是解释型语言还是编译型语言?&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;Python语言既是解释型语言又是编译型语言, 下面通过解释Python的运行过程来进一步说明&lt;/p&gt;

&lt;h4 id=&#34;执行过程&#34;&gt;执行过程&lt;/h4&gt;

&lt;p&gt;&lt;img src=&#34;https://pic3.zhimg.com/v2-7624126b628c655fad226c1d2cc57a0e_r.jpg&#34; alt=&#34;Python执行过程&#34; /&gt;&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;启动编译&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Python在启动时首先加载所有的&lt;code&gt;.py&lt;/code&gt;文件并编译成字节码&lt;code&gt;.pyc&lt;/code&gt;文件, &lt;code&gt;pyc&lt;/code&gt;文件保存的Python代码编译出来的PyCode对象, 所谓的字节码到底是什么东西呢, 其实是一系列的指令, 这些指令不同于机器码的指令集, 它是Python自己定义指令集, 运行在Python VM上&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;虚拟机翻译&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Python虚拟机就是用来执行Python虚拟指令的虚拟机, VM与实体CPU类似, 通过一个大循环, 不停的执行PyCode中的指令, 与实体CPU不同的是, 它是一个中间层, 它会把Python的指令翻译成对应的C代码的调用, 最终通过CPython解释器来完成Python指令到CPU指令的翻译&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;机器码执行&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;我们所写的Python代码最终还是会被CPython解释成机器码到CPU上执行, 这里可以思考一下, 增加了CPython这一层后, 带来的好处, 以及坏处是什么?&lt;/p&gt;

&lt;p&gt;好处很明显, Python相对于C语言大大降低了编程的门槛, 实现同样的功能, Python代码量会比C代码少的多. 从上面的执行过程可以看出不同于C语言的可执行二进制直接加载到机器的虚拟内存空间中, Python代码需要启动时的编译过程, 执行时的VM翻译过程, 最终转换成机器码执行, 无论是VM的翻译过程, 还是最终执行机器码, 相对于C实现的机器指令的数量都会大大增加, 这个增加是千百倍的增加, 带来的差异就是同样的功能, Python的实现会比C实现慢得多.&lt;/p&gt;

&lt;h4 id=&#34;自动内存管理-gc&#34;&gt;自动内存管理(GC)&lt;/h4&gt;

&lt;p&gt;上面说完了Python的代码执行, 接下来进入内存管理, 首先问一个问题, &lt;strong&gt;Python对象是分配在堆还是栈上的?&lt;/strong&gt;&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;在 Python 中，内存管理涉及到一个包含所有 Python 对象和数据结构的私有堆（heap）。这个私有堆的管理由内部的 &lt;em&gt;Python 内存管理器（Python memory manager）&lt;/em&gt; 保证。Python 内存管理器有不同的组件来处理各种动态存储管理方面的问题，如共享、分割、预分配或缓存。&lt;/p&gt;

&lt;p&gt;在最底层，一个原始内存分配器通过与操作系统的内存管理器交互，确保私有堆中有足够的空间来存储所有与 Python 相关的数据。在原始内存分配器的基础上，几个对象特定的分配器在同一堆上运行，并根据每种对象类型的特点实现不同的内存管理策略。例如，整数对象在堆内的管理方式不同于字符串、元组或字典，因为整数需要不同的存储需求和速度与空间的权衡。因此，Python 内存管理器将一些工作分配给对象特定分配器，但确保后者在私有堆的范围内运行。&lt;/p&gt;

&lt;p&gt;Python 堆内存的管理是由解释器来执行，用户对它没有控制权，即使他们经常操作指向堆内内存块的对象指针，理解这一点十分重要。Python 对象和其他内部缓冲区的堆空间分配是由 Python 内存管理器按需通过本文档中列出的 Python/C API 函数进行的。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h5 id=&#34;垃圾回收&#34;&gt;垃圾回收&lt;/h5&gt;

&lt;ol&gt;
&lt;li&gt;引用计数&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;最基本的垃圾回收方式, PyObject对象每增加一个引用, 引用计数+1, 减少一个引用, 引用计数-1, 引用计数更新为0时, 等待被回收, 但是循环引用的对象, 计数永远不会清零, 这就需要标记清楚来辅助处理&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;标记清除&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;&lt;img src=&#34;https://user-images.githubusercontent.com/873883/160809972-6b6d53fc-a132-4cb3-8fc1-b68a1c0dc8d1.png&#34; alt=&#34;python&#34; width=&#34;720px&#34;&gt;&lt;/p&gt;

&lt;p&gt;Python解释器隔一段时间会进行一次全对象的扫描, 对于隔离于ROOT节点的孤立引用, 执行回收, 没有被ROOT节点引用的孤立节点, 即使引用计数大于0, 也会被回收.&lt;/p&gt;

&lt;p&gt;但是每次执行扫描, 都会产生STW, 影响程序的执行, 所以就有了内存分代&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;分代回收&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Python解释器将将对象分为三代:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;0代表幼年对象&lt;/li&gt;
&lt;li&gt;1代表青年对象&lt;/li&gt;
&lt;li&gt;2代表老年对象
&lt;br /&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;对象所在分代级别越低, GC回收的频率越低, 低级别的对象如果一直没有回收, 会被转移到高级别的代中, 这样就区分了不同活跃度的对象, 提高了GC回收的效率&lt;/p&gt;

&lt;h4 id=&#34;小结&#34;&gt;小结&lt;/h4&gt;

&lt;p&gt;从以上Python执行过程与内存管理中可以看出, Python并不适用于高性能需求的场景, 而GC带来延时也使Python不适用于实时性要求高的应用, 这些场景是C语言的主战场. 但是Python由于简单的语法, 高效的编码方式, 大大提高了程序员的生产效率, 在互联网时代, 要求快速实现, 快速实验的前提下, Python也越来越流行.&lt;/p&gt;

&lt;p&gt;那么有没有一种性能够用, 又兼具开发效率的语言呢, Golang就提供了这样一种折中的选择.&lt;/p&gt;

&lt;h3 id=&#34;4-golang&#34;&gt;4. Golang&lt;/h3&gt;

&lt;p&gt;Golang是一门编译型的语言, 同C语言一样它也是通过编译器把代码直接编译为二进制的机器码来保证执行性能, 与C语言不同的时, 它在编译时会在二进制中插入一个Golang的Runtime, Runtime帮助做用户态的Goroutine的调度, 做自动内存管理. 可以说Golang继承了C语言的精华, 并对C语言程序容易出错的点, 提出了自己的改进方案.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://img.draveness.me/2020-02-02-15805792666151-golang-gmp.png&#34; alt=&#34;golang&#34; width=&#34;720px&#34;&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://qiankunli.github.io/public/upload/go/go_memory_layout.jpeg&#34; alt=&#34;Golang内存分配&#34; /&gt;&lt;/p&gt;

&lt;p&gt;Golang语言也不是完美的, 它的性能还是比不上极致优化的C语言, GC带来的STW也导致不能应用于实时性领域. 但是在云原生时代, 它的原生支持并发, 优秀的自动内存管理, 在开发效率与性能之间的平衡性, 给程序员提供了一个新的选择.&lt;/p&gt;

&lt;h3 id=&#34;5-总结&#34;&gt;5. 总结&lt;/h3&gt;

&lt;p&gt;笔者主要使用的语言是Python与Golang, 对Python的运用更多一些, 原因是Python在Web后端开发的应用会更方便一些, 能够快速实现功能, 解决产品需求. Golang更多应用于一些对性能/并发要求比较高的场景, 当前我们会使用Golang构建的鉴权中间承载整个部门的健全需求.&lt;/p&gt;

&lt;p&gt;没有银弹!!! 没有完美的技术, 没有完美的方案, 只有在某个时间点, 某个环境下合适的技术或方案, 如何在这些技术与方案中做抉择, 平衡各方需求, 是对程序员最大的挑战.&lt;/p&gt;</description>
    </item>
    
    <item>
      <title>工作对话集</title>
      <link>https://zhu327.github.io/2022/03/28/%E5%B7%A5%E4%BD%9C%E5%AF%B9%E8%AF%9D%E9%9B%86/</link>
      <pubDate>Mon, 28 Mar 2022 17:38:04 &#43;0800</pubDate>
      
      <guid>https://zhu327.github.io/2022/03/28/%E5%B7%A5%E4%BD%9C%E5%AF%B9%E8%AF%9D%E9%9B%86/</guid>
      <description>&lt;p&gt;老婆是一名具有4年工作经验的产品经理, 上一份工作聚焦在人力资源SaaS上, 现在的工作刚刚开始不到半年, 行业转向了智能家居跨境电商的内部ERP系统, 面对新的行业, 新的公司的工作流程上的一些问题, 有了以下这些对话. 通过这些对话我也回顾了一些自己工作中感悟, 这里总结一下.&lt;/p&gt;

&lt;p&gt;&lt;/p&gt;

&lt;h4 id=&#34;1-关于责任&#34;&gt;1. 关于责任&lt;/h4&gt;

&lt;p&gt;老婆:&lt;/p&gt;

&lt;p&gt;新的工作中没有项目经理的角色, 导致项目进度把握不了, 开发同学相互甩锅, 本来定的开发说3天做完吗, 结果过了3天, 去问他又说又别的事情插进来, 让我去找开发组长&lt;/p&gt;

&lt;p&gt;我:&lt;/p&gt;

&lt;p&gt;没有项目经理所以项目的流程是怎样的? 谁来主导项目, 项目流程的推进的责任人是谁? 是不是谁负责谁推进?&lt;/p&gt;

&lt;p&gt;老婆:&lt;/p&gt;

&lt;p&gt;开始进公司的时候, 说是产品经理负责制, 产品经理立项推进, 直接向老板汇报, 但是我也不知道该怎么管项目&lt;/p&gt;

&lt;p&gt;我:&lt;/p&gt;

&lt;p&gt;既然是你自己负责项目的推进, 那你就必须把控整个项目的进度, 你本身工作的内容就要包括项目经理的职责, 不是每个项目中都有固定的角色的, 小项目中一人身兼数职太常见了&lt;/p&gt;

&lt;p&gt;老婆:&lt;/p&gt;

&lt;p&gt;我本身就只想做产品的事情, 为什么要管那么多, 推来推去好烦&lt;/p&gt;

&lt;p&gt;我:&lt;/p&gt;

&lt;p&gt;即使你不是项目经理, 但是处在项目中你都必须清楚的知道项目的运行过程, 了解了项目的运行的过程后, 还要去了解项目中干系人的工作习惯, 你才好跟他们一起合作, 有了这个前提以后, 你再来考虑怎么管理项目. 项目管理就是过程的管理, 干系人的管理, 风险的管理, 现在主要的问题是你把任务分配下去了, 但是没有关注任务本身的过程, 没有及时了解任务可能出现的风险, 导致项目进度出问题&lt;/p&gt;

&lt;p&gt;老婆:&lt;/p&gt;

&lt;p&gt;(生气脸) 所以变成我的问题了, 他们自己的事情没做好, 导致延期, 能怪我嘛&lt;/p&gt;

&lt;p&gt;我:&lt;/p&gt;

&lt;p&gt;项目本身是你自己负责, 不是说你把产品经理的工作做完了就不用管了, 是你要负责从这个项目开始到项目结束的整个生命周期, 这个生产的过程也是需要你负责的, 所以回到问题, 项目延期了, 你是负责人你该不该负责&lt;/p&gt;

&lt;p&gt;老婆:&lt;/p&gt;

&lt;p&gt;那我能怎么办?&lt;/p&gt;

&lt;p&gt;我:&lt;/p&gt;

&lt;p&gt;就我刚刚说的, 你还是要关注项目的过程, 可以向项目干系人收集项目相关的进度, 风险, 如果有风险, 及时向上说明问题, 就比如你刚刚说的这个问题, 你就应该拉项目相关的人每天开个10分钟的站会, 对一下进度, 开发就会告知你他有别的事情, 然后你就要及时的去找他的组长协调开发资源, 如果实在是解决不了, 也要他给排期把原因说明, 并作为会议纪要发送到相关责任方, 后需要项目总结有问题, 那也不是你自己的问题&lt;/p&gt;

&lt;p&gt;总结:&lt;/p&gt;

&lt;p&gt;一些刚刚工作的小伙伴在工作的过程中, 往往把自己的角色限制在固定的范围内, 以为做好自己的本职工作就行了, 不要管其他人的事情. 殊不知现代工作基本都是团队协作来完成的, 往往我们的工作的绩效并不是自己做了多少事情, 而是以结果为导向, 关键是做成了什么事情, 这就导致如果你身处项目之中, 项目本身的结果才是你做这个事情的结果, 并不是说开发写完代码就可以不用管理后续了, 项目中的每个都需要负责项目的推进, 把自己放到负责人的位子上, 每个都需要关注项目的过程, 及时识别风险, 项目才会向好方向前进.&lt;/p&gt;

&lt;h4 id=&#34;2-关于沟通-向上汇报&#34;&gt;2. 关于沟通/向上汇报&lt;/h4&gt;

&lt;p&gt;老婆:&lt;/p&gt;

&lt;p&gt;这次立项会议又被老板骂了, 连续3次了, 每次都被老板骂, 你说我是不是跟老板八字不合, 要不辞职吧&lt;/p&gt;

&lt;p&gt;我:&lt;/p&gt;

&lt;p&gt;具体说一说, 每次被骂都是一样的问题吗?&lt;/p&gt;

&lt;p&gt;老婆:&lt;/p&gt;

&lt;p&gt;这次倒是不是因为产品设计的原因, 我刚开始介绍我的产品设计, 老板马上就开始反驳我, 说我这里就没按照他的想法来操作, 然后我就给他解释了我没按照他想法的原因, 他也认可了我说的原因, 说我的方向没有错, 但是不应该在立项的时候才告诉他原因&lt;/p&gt;

&lt;p&gt;我:&lt;/p&gt;

&lt;p&gt;你知道项目管理中有个概念叫干系人吧, 所有与项目相关的人都叫干系人, 但是干系人也分优先级, 在你这里老板就是优先级最高的干系人. 因为他是掌握资源的人, 你想要推进你的项目前进, 你就需要服务好掌握资源的人.&lt;/p&gt;

&lt;p&gt;从老板的角度来看, 这个想法是我布置下去的, 在我的理解中如果过程中你没有来跟我说明我的想法有问题, 那么最终你做的东西就应该按我的想法来, 但是到了立项的时候, 你突然给我来了个惊喜, 说我的想法有问题, 你搞了一个另外一个方向, 我能不骂人嘛?&lt;/p&gt;

&lt;p&gt;所以你识别出老板的想法有问题, 然后也有新的产品方向, 你要及时跟老板沟通说明, 你要去向上沟通一下, 私下的沟通10分钟, 15分钟老板还是有时间的, 并且私下沟通, 老板也不会在立项会议上那样甩脸子吧.&lt;/p&gt;

&lt;p&gt;老婆:&lt;/p&gt;

&lt;p&gt;我才不像去找他, 看到就烦&lt;/p&gt;

&lt;p&gt;我:&lt;/p&gt;

&lt;p&gt;那你都已经被怼了3次了, 每次都这样你还做的下去嘛, 你都想辞职了, 这个心态怎么弄, 你就私下找他约一下, 直接问问他自己该怎么做才会不被骂&lt;/p&gt;

&lt;p&gt;老婆:&lt;/p&gt;

&lt;p&gt;再说吧&amp;hellip;&lt;/p&gt;

&lt;p&gt;总结:&lt;/p&gt;

&lt;p&gt;很多小伙伴在工作中都是埋头做自己的事情, 不及时跟相关人沟通自己的想法, 导致结果出现偏差, 做了无用功. 项目中的尽早的沟通能避免后续更改带来的巨大的成本, 很多时候并不是拿出完美的方案才需要沟通, 一点点的想法也可以说出来, 集思广益, 通过沟通来弥补我们想法的不足.&lt;/p&gt;

&lt;p&gt;如果你的工作经常出现问题, 你得考虑下是不是工作方式的问题, 可以找你的上级聊一聊, 自己该改进些什么才能使得自己的工作更顺利, 推动自己下属的能力提升也是上级工作的一部分, 相信坦诚的聊一聊上级会给到你一些建议.&lt;/p&gt;

&lt;h4 id=&#34;3-关于被甩锅&#34;&gt;3. 关于被甩锅&lt;/h4&gt;

&lt;p&gt;老婆:&lt;/p&gt;

&lt;p&gt;今天被人投诉了, 领导还找我谈话了, 本来一个说是要HR负责的事情, 我交出去了就不管了, 最后他们还是要说是我的问题&lt;/p&gt;

&lt;p&gt;我:&lt;/p&gt;

&lt;p&gt;确定是谁负责的了吗, 是怎么确定的呢?&lt;/p&gt;

&lt;p&gt;老婆:&lt;/p&gt;

&lt;p&gt;老板在立项会上说的, 我就负责把原型画出来, 后面就交给HR确认, 后面就是她来负责&lt;/p&gt;

&lt;p&gt;我:&lt;/p&gt;

&lt;p&gt;会议由纪要有吗, 这个事情HR自己清楚吗&lt;/p&gt;

&lt;p&gt;老婆:&lt;/p&gt;

&lt;p&gt;没有纪要&lt;/p&gt;

&lt;p&gt;我:&lt;/p&gt;

&lt;p&gt;那你是怎么交给她的呢?&lt;/p&gt;

&lt;p&gt;老婆:&lt;/p&gt;

&lt;p&gt;我把文件发给她了, 她要我发到群里给大家看看, 我就发了还@她了&lt;/p&gt;

&lt;p&gt;我:&lt;/p&gt;

&lt;p&gt;你发到群里的时候@她, 有没有说她要干什么, 后续的流程需要她负责了呢&lt;/p&gt;

&lt;p&gt;老婆:&lt;/p&gt;

&lt;p&gt;没有, 我觉的我给她就结束了, 然后后面估计是老板骂了她们, 她们就说是我的问题, 我没有推进&lt;/p&gt;

&lt;p&gt;我:&lt;/p&gt;

&lt;p&gt;你这里就犯了2错误, 会议中有关键的责任划分, 一定要记录下来, 在这个会议中你要写清楚老板的结论, 你来做原型, 剩下的HR来负责, 把会议纪要发到参会人, 这就是证据. 第二个问题是交接的时候你要说清楚, 按照之前的会议结论我把原型给你了, 接下来你应该干什么, 要交代清楚, 并且有记录, 然后即使是被甩锅, 你也可以把会议纪要, 交接的记录拿出来, 这个锅就不是你的&lt;/p&gt;

&lt;p&gt;总结:&lt;/p&gt;

&lt;p&gt;项目中的各种会议中的与自己相关的决议一定要及时确认清楚, 并告知到所有的相关人, 并且要有记录, 项目流程中的责任交接, 也要做好记录, 知会相关人她要干什么, 确定好责任是什么.&lt;/p&gt;

&lt;p&gt;小伙伴们在工作中如果真的是自己的锅, 就得认, 回顾自己问题, 下次不要再犯, 但是如果被甩锅了, 一定要理性的对待, 找出证据, 说明不是自己的问题. 项目管理往往是对过程的管理, 所以我们的每个结论, 每个交接内容修需要有记录, 从而在划分责任时才能有理有据.&lt;/p&gt;

&lt;p&gt;另外在如何定义事情是否做完上这个问题上, 每个人对事情做完的理解可能都不一样, 所以在项目相关的会议上我们要清楚的确认自己的责任, 自己需要做的事情, 产出物是什么, 做到&lt;strong&gt;事事有回应 件件有着落 凡事有交代&lt;/strong&gt;&lt;/p&gt;</description>
    </item>
    
    <item>
      <title>领域驱动设计与微服务</title>
      <link>https://zhu327.github.io/2020/10/22/%E9%A2%86%E5%9F%9F%E9%A9%B1%E5%8A%A8%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%BE%AE%E6%9C%8D%E5%8A%A1/</link>
      <pubDate>Thu, 22 Oct 2020 17:38:04 &#43;0800</pubDate>
      
      <guid>https://zhu327.github.io/2020/10/22/%E9%A2%86%E5%9F%9F%E9%A9%B1%E5%8A%A8%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%BE%AE%E6%9C%8D%E5%8A%A1/</guid>
      <description>&lt;h3 id=&#34;drf的起手式&#34;&gt;DRF的起手式&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;CURD Boy的通常的工作模式&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&#34;https://blog-1251544432.cos.ap-guangzhou.myqcloud.com/blog/image-20201010162649717.png&#34; alt=&#34;image-20201010162649717&#34;  /&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;先设计Serializer还是先设计Model?&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;/p&gt;

&lt;h3 id=&#34;问题是什么&#34;&gt;问题是什么&lt;/h3&gt;

&lt;p&gt;&lt;img src=&#34;https://blog-1251544432.cos.ap-guangzhou.myqcloud.com/blog/image-20201010162706372.png&#34; alt=&#34;image-20201010162706372&#34;  /&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;框架捆绑

&lt;ul&gt;
&lt;li&gt;写框架无关的代码&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;复杂的逻辑会陷入职责不清晰, 交叉依赖

&lt;ul&gt;
&lt;li&gt;抽象一层&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;面向对象&#34;&gt;面向对象&lt;/h3&gt;

&lt;p&gt;SOLID原则&lt;/p&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;-&lt;/th&gt;
&lt;th&gt;-&lt;/th&gt;
&lt;th&gt;-&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;

&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;SRP&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;The Single Responsibility Principle&lt;/td&gt;
&lt;td&gt;单一责任原则&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;OCP&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;The Open Closed Principle&lt;/td&gt;
&lt;td&gt;开放封闭原则&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;LSP&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;The Liskov Substitution Principle&lt;/td&gt;
&lt;td&gt;里氏替换原则&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;DIP&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;The Dependency Inversion Principle&lt;/td&gt;
&lt;td&gt;依赖倒置原则&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;ISP&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;The Interface Segregation Principle&lt;/td&gt;
&lt;td&gt;接口分离原则&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;h3 id=&#34;clean-architecture&#34;&gt;clean Architecture&lt;/h3&gt;

&lt;p&gt;&lt;img src=&#34;https://blog-1251544432.cos.ap-guangzhou.myqcloud.com/blog/201507-CleanArchitecture.jpg&#34; alt=&#34; &#34; style=&#34;zoom:80%;&#34; /&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;实体: 模型, 比如权限中心的一条策略就是一个实体, 它具有唯一的ID

&lt;ul&gt;
&lt;li&gt;模型不是分散的, 与存储无关, 避免交叉依赖&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;用例: 业务的使用规则, 实例在某种场景下的使用方式, 一段实体的使用逻辑

&lt;ul&gt;
&lt;li&gt;与api无关, 只与业务逻辑相关&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;对外暴露接口与适配器

&lt;ul&gt;
&lt;li&gt;隐藏用例与实体, 只对外暴露接口&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;框架, 驱动

&lt;ul&gt;
&lt;li&gt;对接接口, 实现适配器接口&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;hr /&gt;

&lt;ul&gt;
&lt;li&gt;从业务出发, 以业务逻辑为核心构建系统&lt;/li&gt;
&lt;li&gt;灵活的使用外部依赖, 扩展方便&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;六边形架构&#34;&gt;六边形架构&lt;/h3&gt;

&lt;p&gt;&lt;img src=&#34;https://blog-1251544432.cos.ap-guangzhou.myqcloud.com/blog/3-application.jpg&#34; alt=&#34;img&#34; style=&#34;zoom: 80%;&#34; /&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;以业务为核心, 外部依赖全部做成适配器, 方便替换&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;领域驱动设计&#34;&gt;领域驱动设计&lt;/h3&gt;

&lt;p&gt;为解决复杂的现实问题的一种设计模式, 将数据和行为封装在一起，并与现实世界中的业务对象相映射。各类具备明确的职责划分，将领域逻辑分散到领域对象中。&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;业务架构——根据业务需求设计业务模块及其关系&lt;/li&gt;
&lt;li&gt;系统架构——设计系统和子系统的模块&lt;/li&gt;
&lt;li&gt;技术架构——决定采用的技术及框架&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;DDD的核心诉求就是将业务架构映射到系统架构上，在响应业务变化调整业务架构时，也随之变化系统架构。&lt;/p&gt;

&lt;h3 id=&#34;什么是领域&#34;&gt;什么是领域&lt;/h3&gt;

&lt;p&gt;在互联网兴起之前, 传统的软件行业, 做的软件都是在解决现实中已经存在的问题, 软件的意义在于提示现实问题处理的效率, 比如电子商务, 现实中的商务模式只怎样运转的, 电子商务就是怎样运转的, 软件系统的意义在于大大提升了商务模式的运转的效率, 所以要设计一个好的软件系统, 先要有足够的领域知识, 以现实中出现的问题为基础, 构建领域的模型&lt;/p&gt;

&lt;p&gt;已订单模型为例, 同样是订单, 对于购买客户展示的订单与对商户展示的订单信息就不一样, 操作也不一样, 这就需要对模型进行域的划分, 分别分为客户域与商户域&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://blog-1251544432.cos.ap-guangzhou.myqcloud.com/blog/image-20201010170636576.png&#34; alt=&#34;image-20201010170636576&#34;  /&gt;&lt;/p&gt;

&lt;h3 id=&#34;领域语言&#34;&gt;领域语言&lt;/h3&gt;

&lt;p&gt;定义术语, 识别出领域内的用例主谓宾, 主语: 实体, 谓语: 用例, 宾语: 值对象, 比如在权限中心, 管理员对用户授权了xx权限&lt;/p&gt;

&lt;h3 id=&#34;领域模型-entry与valueobject&#34;&gt;领域模型 &amp;ndash; Entry与ValueObject&lt;/h3&gt;

&lt;p&gt;&lt;img src=&#34;http://www.cosmicpython.com/book/images/apwp_0104.png&#34; alt=&#34;apwp 0104&#34; style=&#34;zoom: 50%;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;实体&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;当一个对象由其标识（而不是属性）区分时，这种对象称为实体（Entity）。&lt;/p&gt;

&lt;p&gt;在权限中心, 用户, 管理员, 策略, 都有唯一的标志, 可以分门别类划分到各自域的实体&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;值对象&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;当一个对象用于对事务进行描述而没有唯一标识时，它被称作值对象（Value Object）。&lt;/p&gt;

&lt;p&gt;权限中心中, 策略中的拓扑, 属性, 这些没有唯一标志的值, 就是值对象&lt;/p&gt;

&lt;h3 id=&#34;repository&#34;&gt;Repository&lt;/h3&gt;

&lt;p&gt;数据存储的adapter, 以Entry为参数, 保存实体信息到存储引擎, 从数据库中加载数据为实体对象&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://www.cosmicpython.com/book/images/apwp_0201.png&#34; alt=&#34;apwp 0201&#34; style=&#34;zoom:50%;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;好处:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;简单的接口, 解耦了对存储的依赖&lt;/li&gt;
&lt;li&gt;方便进行单元测试, 通过Facke Repository&lt;/li&gt;
&lt;li&gt;开考虑如何存储数据前, 专注于解决业务问题, 使得模型更加贴合实际问题&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;坏处:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;增加了额外的代码逻辑, 提高的维护的成本&lt;/li&gt;
&lt;li&gt;有一些逻辑可能ORM框架就已经支持了&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;service&#34;&gt;Service&lt;/h3&gt;

&lt;p&gt;服务层, 领域模型的使用用例, 一些重要的领域行为或操作，可以归类为领域服务。它既不是实体，也不是值对象的范畴。&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://www.cosmicpython.com/book/images/apwp_0402.png&#34; alt=&#34;apwp 0402&#34; style=&#34;zoom: 50%;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;好处:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;提供一个单一的地方放所以的用例&lt;/li&gt;
&lt;li&gt;通过服务层来把领域模型隐藏在api后面, 方便对领域层做重构&lt;/li&gt;
&lt;li&gt;把定制http相关的协议改变成了定制服务的协议, 接口只是服务层的派生&lt;/li&gt;
&lt;li&gt;有了存储层后, 可以方便的使用Fake存储来做测试&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;坏处:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;如果你的app是一个纯粹的web服务, MVC就可很好的处理用例了, 不需要增加多余复杂度&lt;/li&gt;
&lt;li&gt;服务层是另外的一个抽象&lt;/li&gt;
&lt;li&gt;服务层承载了太多的逻辑, 会导致领域层成为贫血模式&lt;/li&gt;
&lt;li&gt;在采用服务层前, 需要理清控制面上的逻辑编排&lt;/li&gt;
&lt;li&gt;把控制面的逻辑下沉到领域模型上, 可以得到胖模型, 瘦控制&lt;/li&gt;
&lt;/ol&gt;

&lt;h3 id=&#34;unit-of-work&#34;&gt;Unit of Work&lt;/h3&gt;

&lt;p&gt;service层中直接对接了Repository, 处理了太多事务相关的逻辑, 通过UOW来封装事务的处理&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://www.cosmicpython.com/book/images/apwp_0602.png&#34; alt=&#34;apwp 0602&#34; style=&#34;zoom: 50%;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;好处:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;对于原子操作有一个更好的抽象, 通过上下文管理器直观的看到哪些逻辑组合在一起&lt;/li&gt;
&lt;li&gt;对事务的开始与结束有了明确的定义&lt;/li&gt;
&lt;li&gt;提供了实例化存储类的地方&lt;/li&gt;
&lt;li&gt;帮助处理事件与消息总线&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;坏处:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;可能ORM已经有类似的封装&lt;/li&gt;
&lt;li&gt;看起来简单, 但是还要处理回滚, 多线程, 嵌条事务等情况&lt;/li&gt;
&lt;/ol&gt;

&lt;h3 id=&#34;aggregate&#34;&gt;Aggregate&lt;/h3&gt;

&lt;p&gt;Aggregate(聚合）是一组相关对象的集合，作为一个整体被外界访问，聚合根（Aggregate Root）是这个聚合的根节点。&lt;/p&gt;

&lt;p&gt;有了Service与UOA后, 往往会导致Service的逻辑复杂, 而领域模型上的逻辑非常简单, 甚至于没有相关的方法, 这就是所谓的贫血模式/失血模式, 这时候就需要一种新的抽象来承载领域模型上的相关逻辑, Aggregate&lt;/p&gt;

&lt;p&gt;以权限中心为例, 每次操作的Policy并不是一个, 而是一批, 这时候就可以定义PolicyAggregate, 来把批量的Policy操作的方法封装在聚合之中&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://www.cosmicpython.com/book/images/apwp_0701.png&#34; alt=&#34;apwp 0701&#34; style=&#34;zoom:50%;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;好处:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;聚会可以定义出哪些模型是可以暴露, 那些不暴露&lt;/li&gt;
&lt;li&gt;显示的定义界限上下文, 有助于提高ORM性能&lt;/li&gt;
&lt;li&gt;由聚合来负责状态的变更, 更容易控制内部数据, 提供统一的出入口&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;坏处:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;对于新开发者不友好, 需要多理解一个概念&lt;/li&gt;
&lt;li&gt;严格定义聚合的单一职责, 对于思维的考研很大&lt;/li&gt;
&lt;li&gt;不同聚合之间数据的最终一致可能很麻烦&lt;/li&gt;
&lt;/ol&gt;

&lt;h3 id=&#34;event-drive&#34;&gt;Event Drive&lt;/h3&gt;

&lt;p&gt;领域事件是对领域内发生的活动进行的建模。&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://www.cosmicpython.com/book/images/apwp_0801.png&#34; alt=&#34;apwp 0801&#34; style=&#34;zoom:50%;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;好处:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;消息总线解耦了不同逻辑之间的耦合, 通过响应消息实现多种逻辑的处理&lt;/li&gt;
&lt;li&gt;时间响应的处理与核心的领域逻辑得到隔离&lt;/li&gt;
&lt;li&gt;领域时间实际上是现实问题的一种抽象, 可以跟领域语言有机的结合到一起&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;坏处:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;消息总线隔离各种逻辑, 不方便梳理整体逻辑&lt;/li&gt;
&lt;li&gt;要小心消息的循环依赖&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;完全的事件驱动&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://www.cosmicpython.com/book/images/apwp_0902.png&#34; alt=&#34;apwp 0902&#34; style=&#34;zoom:50%;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;好处:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;handler与service变成了一个, 架构简化&lt;/li&gt;
&lt;li&gt;事件对于api与handle的参数传递提供统一的结构&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;坏处:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;对于web服务来说, 消息总线不是一个可以感知的过程, 异步逻辑不知道什么时候完成&lt;/li&gt;
&lt;li&gt;事件对象与模型对象存在大量相同的字段, 修改时也要同时修改&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;引入命令模式:&lt;/p&gt;

&lt;p&gt;好处:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;区分出命令与事件, 可以清晰的定义出哪些是必须完成的, 哪些是额外的逻辑&lt;/li&gt;
&lt;li&gt;命令名称相对于事件更明确&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;坏处:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;命令与事件语义上的差异可能很小, 要小心区分&lt;/li&gt;
&lt;li&gt;明确的处理失败与异常, 使得影响变小, 逻辑更加难理解, 需要增加更多监控&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;事件驱动的微服务:&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://www.cosmicpython.com/book/images/apwp_1101.png&#34; alt=&#34;apwp 1101&#34; style=&#34;zoom:50%;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;好处:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;避免依赖大泥球&lt;/li&gt;
&lt;li&gt;分离服务: 更新与新增单个服务更简单&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;坏处:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;整理流程的信息很难直观看出来&lt;/li&gt;
&lt;li&gt;需要理解最终一致性&lt;/li&gt;
&lt;li&gt;消息的可靠性需要权衡: 至少一次还是最多一次&lt;/li&gt;
&lt;/ol&gt;

&lt;h3 id=&#34;cqrs&#34;&gt;CQRS&lt;/h3&gt;

&lt;p&gt;&lt;img src=&#34;http://www.cosmicpython.com/book/images/apwp_1201.png&#34; alt=&#34;apwp 1201&#34; style=&#34;zoom:50%;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;命令于查询分离&lt;/p&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;&lt;/th&gt;
&lt;th&gt;查询&lt;/th&gt;
&lt;th&gt;命令&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;

&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;行为&lt;/td&gt;
&lt;td&gt;简单&lt;/td&gt;
&lt;td&gt;负责业务逻辑&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;缓存&lt;/td&gt;
&lt;td&gt;可缓存&lt;/td&gt;
&lt;td&gt;不可缓存&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;一致性&lt;/td&gt;
&lt;td&gt;可能延迟&lt;/td&gt;
&lt;td&gt;事务一致&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;h3 id=&#34;微服务&#34;&gt;微服务&lt;/h3&gt;

&lt;h3 id=&#34;宏服务的问题&#34;&gt;宏服务的问题&lt;/h3&gt;

&lt;ol&gt;
&lt;li&gt;&lt;p&gt;代码量变大: 模块之间没有严格的界限, 想要理解系统整体困难, 随着代码的增加复杂度增加, 变更的成本变高, 降低迭代速度&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;资源利用低效: 整体服务占用大量的内存, 不管其中模块是否被大量的使用, 占用所有的数据库连接, 不管有没有使用&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;带来可扩展的问题: 即使能实现横向的扩展, 但是开发的过程中由于团队的人员变多, 也会带来版本迭代上的冲突, 除非有很好的职责划分, 不同团队之间的沟通, 会带来效率的降低&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;部署困难: 每次部署都需要保证所有模块的正确性, 其中某个模块出问题, 会导致整个系统的崩溃&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;技术的限制: 在选定一种技术后, 整个系统的技术就被限制了, 比如Python, 想要更改会非常困难&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;bug影响: 一个模块的bug可能会影响到整个系统, 一个模块的资源占用过多, 也会影响到整个系统&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;h3 id=&#34;微服务-1&#34;&gt;微服务&lt;/h3&gt;

&lt;ol&gt;
&lt;li&gt;&lt;p&gt;模块之间松耦合&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;独立部署&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;每个微服务互相通信&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;为了提供整体的服务, 需要把微服务暴露成一个整体, 微服务隐藏在整体后面&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;优点:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;p&gt;微服务之间使用统一的通信协议通信, http-json, 更加通用一些, rpc更加高效&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;更好的资源利用率, 每个服务都是可控的, 按需分配资源&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;每个微服务都很小, 代码量少更简单, 重构更方便, 可以选择不同的技术栈&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;某些服务可以隐藏在微服务后面, 不对外提供, 更加安全&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;由于系统的独立, 一个服务的崩溃不会导致整体的崩溃&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;每个服务都是独立维护, 提高团队的开发效率&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;缺点:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;p&gt;迁移到微服务很困难, 需要付出大量的开发成本, 初期会带来很多混乱&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;微服务的会带来组织架构上的调整, 而一般公司的组织架构是很难改变的, 就会导致职责的分不清&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;学习曲线陡峭, 开发人员需要学习相关的开发模式, 需要开发运维相关的培训&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;调试更加困难&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;划分微服务本身很困难, 需要警惕多个独立服务合并到一个服务中, 这样就偏离的迁移微服务的初衷&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;违法对于团队配合会带来困难, 不同的团队会站在自己的角度思考, 沟通协调需要付出更多的成本&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;在整体功能与每个微服务的功能之间需要做平衡, 没有很好的配合, 团队之间会出现信息孤岛, 重复造轮子. 应该共享知识, 共享经验&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;敏捷开发的同时, 需要各个团队落地的文档就有要求了, 可以减少沟通, 但是增加额外的工作量&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;如果有对其它服务的依赖, 会增加请求的响应时间&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;h3 id=&#34;总结&#34;&gt;总结&lt;/h3&gt;

&lt;p&gt;没有银弹, 没有完美的技术, 只有合适的技术.&lt;/p&gt;</description>
    </item>
    
    <item>
      <title>读书方法论</title>
      <link>https://zhu327.github.io/2020/05/07/%E8%AF%BB%E4%B9%A6%E6%96%B9%E6%B3%95%E8%AE%BA/</link>
      <pubDate>Thu, 07 May 2020 18:45:08 &#43;0800</pubDate>
      
      <guid>https://zhu327.github.io/2020/05/07/%E8%AF%BB%E4%B9%A6%E6%96%B9%E6%B3%95%E8%AE%BA/</guid>
      <description>&lt;p&gt;从2017年决定补计算机基础开始, 至今已经读了50来本计算机书籍. 读书的时间总是很宝贵, 如何正确的读书呢? 下面是我的一些经验与总结.&lt;/p&gt;

&lt;h3 id=&#34;读书的目的&#34;&gt;读书的目的&lt;/h3&gt;

&lt;p&gt;我们读书的目的是什么? 概况起来可以分为以下2种:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;学习知识&lt;/li&gt;
&lt;li&gt;提升自己的能力&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;我们在上学时专注与学习知识, 所以书本上的每一部分我们都需要了解, 所以我们需要一遍一遍的读, 抓住书本种每一个知识点.&lt;/p&gt;

&lt;p&gt;但是在工作后, 我们读书是为了解决问题, 提升自己的能力, 知识 != 能力, 工作后我们读书的主语不再是知识, 而是自己, 面向自己读书需要一些方法.&lt;/p&gt;

&lt;p&gt;&lt;/p&gt;

&lt;h3 id=&#34;sq3r&#34;&gt;SQ3R&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;综览(Survey): 开始读书前, 先浏览书本的目录, 粗读文章的标题, 调查出书本的大致内容&lt;/li&gt;
&lt;li&gt;提问(Question): 结合书本内容与自己的实际, 尝试向自己发问, 总结出自己可能在书本种收获的内容&lt;/li&gt;
&lt;li&gt;阅读(Read): 带着问题认真在书本种找出答案&lt;/li&gt;
&lt;li&gt;复述(Recite): 使用自己语言描述出问题的答案&lt;/li&gt;
&lt;li&gt;回顾(Review): 回忆解决问题的方法, 并在实践中使用, 使用知识提升自己的能力&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;拆书法&#34;&gt;拆书法&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;I 使用自己的语言重述信息&lt;/li&gt;
&lt;li&gt;A1 描述自己的相关经验 &amp;ndash; 总结自己在面对问题时是怎么做的&lt;/li&gt;
&lt;li&gt;A2 我的应用(目标与行动) &amp;ndash; 根据掌握的信息结合自己的实际指定改进方案并实践, 能力得到提升&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&#34;常见问题&#34;&gt;常见问题&lt;/h4&gt;

&lt;ul&gt;
&lt;li&gt;I 附会旧知&lt;/li&gt;
&lt;li&gt;A1 泛泛而谈&lt;/li&gt;
&lt;li&gt;A2 决心泛滥, 感慨万千&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;思维方式&#34;&gt;思维方式&lt;/h3&gt;

&lt;h4 id=&#34;前车可鉴&#34;&gt;前车可鉴&lt;/h4&gt;

&lt;ul&gt;
&lt;li&gt;作者是怎么引出这个信息的?&lt;/li&gt;
&lt;li&gt;为什么这件事对我重要?&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&#34;相因相生&#34;&gt;相因相生&lt;/h4&gt;

&lt;ul&gt;
&lt;li&gt;作者提出了哪些关于原因的假设?&lt;/li&gt;
&lt;li&gt;是怎么验证或排除这些假设的?&lt;/li&gt;
&lt;li&gt;还有其它可能吗?&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&#34;以观后效&#34;&gt;以观后效&lt;/h4&gt;

&lt;ul&gt;
&lt;li&gt;若依从信息去做后会怎么样?&lt;/li&gt;
&lt;li&gt;对我的好处是什么?&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&#34;自食其果&#34;&gt;自食其果&lt;/h4&gt;

&lt;ul&gt;
&lt;li&gt;不这么做的后果是什么?&lt;/li&gt;
&lt;li&gt;不改变的问题有多严重?&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&#34;适得其反&#34;&gt;适得其反&lt;/h4&gt;

&lt;ul&gt;
&lt;li&gt;有没有相反的观点?&lt;/li&gt;
&lt;li&gt;有没有不支持这个的实例?&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&#34;使用条件&#34;&gt;使用条件&lt;/h4&gt;

&lt;ul&gt;
&lt;li&gt;要这样做, 具体的条件(成本, 收益, 态度, 能力)?&lt;/li&gt;
&lt;li&gt;什么情况下是不管用的?&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&#34;旁敲边鼓&#34;&gt;旁敲边鼓&lt;/h4&gt;

&lt;ul&gt;
&lt;li&gt;从前有没有类似的信息?&lt;/li&gt;
&lt;li&gt;其它领域/行业/作者是如何看代类似的问题?&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&#34;楚河汉界&#34;&gt;楚河汉界&lt;/h4&gt;

&lt;ul&gt;
&lt;li&gt;无论是相反的还是类似的信息, 和这个信息真正的区别是什么? 交界在哪里?&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;知识体系&#34;&gt;知识体系&lt;/h3&gt;

&lt;ol&gt;
&lt;li&gt;思维带来表达的提升(成长思维, 批判型思维, 系统思维)&lt;/li&gt;
&lt;li&gt;从零到一成为专家&lt;/li&gt;
&lt;li&gt;智慧影响待人接物&lt;/li&gt;
&lt;/ol&gt;

&lt;h3 id=&#34;知识管理&#34;&gt;知识管理&lt;/h3&gt;

&lt;p&gt;碎片化时代的知识管理, 重点不是对承载知识的文档和文章进行管理, 而是对加工知识的大脑进行管理.&lt;/p&gt;</description>
    </item>
    
    <item>
      <title>从Python到Golang</title>
      <link>https://zhu327.github.io/2019/12/22/%E4%BB%8Epython%E5%88%B0golang/</link>
      <pubDate>Sun, 22 Dec 2019 18:45:08 &#43;0800</pubDate>
      
      <guid>https://zhu327.github.io/2019/12/22/%E4%BB%8Epython%E5%88%B0golang/</guid>
      <description>&lt;p&gt;是的, 从去年底开始, 我差不多写Golang一年了, 从最开始的视频流处理, 到Websocket远程控制, 再到现在写的高性能鉴权中间件. 为什么不用Python? 因为Python满足不了长连接或者高性能的需求. 为什么不用其它语言? 大概是因为Golang足够&lt;code&gt;简单&lt;/code&gt;吧. 这里分享下这一年多写Golang相对于Python的一些感想.&lt;/p&gt;

&lt;h3 id=&#34;强类型&#34;&gt;强类型&lt;/h3&gt;

&lt;h4 id=&#34;代码检查&#34;&gt;代码检查&lt;/h4&gt;

&lt;p&gt;Golang是强类型语言, 配合IDE, Lint, 编译工具, 一些常见的, 马马虎虎的写代码的低级错误在代码提交之前就能被检测出来. 虽然Python也有flak8, 但是相对于Golang犯低级错误的可能性更大些, 特别是对于没有单元测试的代码(是的, 单元测试不是每个团队都会做的).&lt;/p&gt;

&lt;p&gt;&lt;/p&gt;

&lt;h4 id=&#34;代码提示&#34;&gt;代码提示&lt;/h4&gt;

&lt;p&gt;写过Pyhon的人都知道, 无论是Pycharm也好还是VS Code也好, 代码提示对于多重继承的类总是不那么友好, 当然Pyhon3的type hint会稍好一些. 而Golang就没有这方面的困扰, 类型一目了然, 代码补全, 提示更高效一些.&lt;/p&gt;

&lt;h4 id=&#34;像计算机科学家一样思考&#34;&gt;像计算机科学家一样思考&lt;/h4&gt;

&lt;p&gt;有一本书叫《像计算机科学家一样思考Python》, 那么如何做到像计算科学家一样思考呢, 需要理解程序在计算机上是怎么运行的, 然后就会知道为什么有类型系统. Python在很大程度上隐藏了这些细节, 但是只是隐藏并不是没有, 要想写好Python依然需要学习计算机相关的基础知识. Golang与C一脉相承, 如果不了解程序运行的这些细节, 写出烂代码的可能性会更高.&lt;/p&gt;

&lt;h3 id=&#34;程序设计&#34;&gt;程序设计&lt;/h3&gt;

&lt;p&gt;写Python的时候会有种感觉, 由于框架比较完善, 在写业务的时候都是一把梭, 先把代码堆出来再说. 但是写Golang就是另一种感觉了, 你要设计一个好的结构才能方便的进行扩展, 设计出好的接口来减少耦合. 在写实现前就需要对于程序有一个详细的设计, 不能想到哪写到哪, 不然项目的后期改动就是灾难(是的, 我已经经历过2次这样的灾难了).&lt;/p&gt;

&lt;h3 id=&#34;编写可测试的代码&#34;&gt;编写可测试的代码&lt;/h3&gt;

&lt;p&gt;虽然不是每个团队都写单元测试, 但是想成为一名优秀的程序员, 单元测试必不可少. 特别是对于Python语言, 由于lint工具的薄弱, 保证代码质量不犯低级错误的方式就只能是测试了. Python写单元测试也是很简单了, Mock工具也很方便.&lt;/p&gt;

&lt;p&gt;Golang就不一样, 接手过一个没有单元测试项目, 为了提高项目质量, 我从单元测试开始入手, 面临的是完全没法测试的代码, 各种依赖纠缠, 想Mock都没法动手, 这就是不可测试的代码. 为了测试, 我完全重构了整个模块, 抽象接口, 提取函数, 花了很大的精力才搞定单元测试. 所以在写Golang代码时还要考虑代码是不是能方便的测试, 最好能边写实现边写单元测试. 当然能做到测试驱动开发就更好了.&lt;/p&gt;

&lt;h3 id=&#34;性能分析&#34;&gt;性能分析&lt;/h3&gt;

&lt;p&gt;写Golang后接触到了性能分析, profile 火焰图都使用过, 也从算法上优化过程序性能. 那为啥之前写了好几年Python都没做过性能分析呢, 可能是因为对Python的性能预期更低吧. 本来就没想过Python性能好到哪里去, 所以就不考虑分析了, 做业务的过程中更多的是优化SQL查询性能.&lt;/p&gt;

&lt;h3 id=&#34;问题的分析与解决&#34;&gt;问题的分析与解决&lt;/h3&gt;

&lt;p&gt;这是与Golang无关的一个话题, 也是过去一年中我认识到的我的短板. 以往工作都是为了快速解决问题, 而忽略了很多需要思考的地方, 导致后续的一些事故, 以及难以扩展的问题. 在经历了一次失败的答辩, 以及上了《问题的分析与解决》这门课程, 然后在参与大佬同事的一些方案设计评审后才理清楚这些.&lt;/p&gt;

&lt;h4 id=&#34;提问题&#34;&gt;提问题&lt;/h4&gt;

&lt;p&gt;什么是问题, 问题的本质是什么? who what when where, 这就是问题, 先理清楚这个问题的本质, 什么人做了什么在哪里什么时间产生了什么. 然后是How/How Many, 是怎么发生的, 发生了多少次, 影响了什么.&lt;/p&gt;

&lt;h4 id=&#34;分析问题&#34;&gt;分析问题&lt;/h4&gt;

&lt;p&gt;分析产生问题的所有原因, 理清了原因才能针对性的输出解决方案.&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;p&gt;对比法&lt;/p&gt;

&lt;p&gt;对比问题产生的前后, 做了什么变化, 产生了什么效果, 找出问题的原因&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;鱼骨图&lt;/p&gt;

&lt;p&gt;列出问题相关的所有因子, 从各个大的因子方面分析导致问题出现的原因&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;why why why&lt;/p&gt;

&lt;p&gt;不停的问原因, 直到找到问题的根因&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;通过以上方式, 找出问题所有的原因, 一定要改掉以偏概全的毛病, 理性分析问题, 不要找到了一个原因就马上开始想解决办法, 只有找到所有的原因, 才能针对的提出解决方案.&lt;/p&gt;

&lt;h4 id=&#34;解决方案&#34;&gt;解决方案&lt;/h4&gt;

&lt;p&gt;由于问题可能是多个原因导致的, 所以解决方法可能不会完美的覆盖所有的原因, 这时候就需要对比多个解决方案. 根据经验从多个维度对比打分各个解决方案找出最优解.&lt;/p&gt;

&lt;h4 id=&#34;风险管理&#34;&gt;风险管理&lt;/h4&gt;

&lt;p&gt;选择的解决方案会不会带来什么风险, 有什么预防措施, 如果真的发生了这样的风险有什么应对措施.&lt;/p&gt;

&lt;p&gt;通过以上一套问题的分析与解决方法论, 基本上在做架构设计, 出各种方案时都能做到有理有据, 引用小龙今年年会的主题: 思辨大于执行.&lt;/p&gt;

&lt;h3 id=&#34;最后&#34;&gt;最后&lt;/h3&gt;

&lt;p&gt;从去年进入腾讯到现在已经1年半的时间, 从运维组调动到了开发组, 经历一次失败的答辩, 回过头来看, 不曾后悔自己做的所有决定. 看过很多书, 各方面对比去年确实提高了很多, 但是也清楚的认识到自己的短板, 再接再厉, 继续加油, 展望未来.&lt;/p&gt;</description>
    </item>
    
    <item>
      <title>Gunicorn与uWSGI之我见</title>
      <link>https://zhu327.github.io/2018/08/29/gunicorn%E4%B8%8Euwsgi%E4%B9%8B%E6%88%91%E8%A7%81/</link>
      <pubDate>Wed, 29 Aug 2018 23:23:20 &#43;0800</pubDate>
      
      <guid>https://zhu327.github.io/2018/08/29/gunicorn%E4%B8%8Euwsgi%E4%B9%8B%E6%88%91%E8%A7%81/</guid>
      <description>&lt;p&gt;昨天前同事问我&lt;a href=&#34;https://github.com/zhu327/doge&#34;&gt;doge&lt;/a&gt;的服务端怎么是单进程跑的, 其实在生产环境下我们参考&lt;a href=&#34;https://github.com/eleme/gunicorn_thrift&#34;&gt;gunicorn_thrift&lt;/a&gt;实现了一个定制的master/worker模型的Gunicorn服务器. 昨天也写了一个&lt;a href=&#34;https://github.com/zhu327/doge/tree/master/doge/gunicorn&#34;&gt;简化版本&lt;/a&gt;集成到doge, 实际代码不超过20行就能利用到Gunicorn的进程管理功能. 有感于Gunicorn简洁优雅的模型, 这里聊聊我理解的Gunicorn与uWSGI.&lt;/p&gt;

&lt;h2 id=&#34;perfork&#34;&gt;perfork&lt;/h2&gt;

&lt;p&gt;perfork是一种服务端编程模型, Nginx, Gunicorn, uWSGI都是这种模型的实现, 简单的说perfok就是master进程启动注册一堆信号处理函数, 创建listen socket fd, fork出多个worker子进程, 子进程执行accept循环处理请求(这里简化模型, 当然也可以用select, epoll多路复用), master进程只负责监控worker进程状态, 通过pipeline通信来控制worker进程.&lt;/p&gt;

&lt;p&gt;&lt;/p&gt;

&lt;p&gt;perfork模型使用master进程来监控worker进程状态, 避免了我们使用supervisor来监控进程, 还支持多种信号来控制worker的数量, 使得CPU能充分得到利用, 多个worker进程监听同一端口, 可以配置reuse_port参数在worker进程间负载均衡.&lt;/p&gt;

&lt;p&gt;Gunicorn与uWSGI都是基于perfork模型的WSGI服务器, 下面我们就来聊聊他们的区别.&lt;/p&gt;

&lt;h2 id=&#34;gunicorn&#34;&gt;Gunicorn&lt;/h2&gt;

&lt;p&gt;Gunicorn是使用Python实现的WSGI服务器, 直接提供了http服务, 并且在woker上提供了多种选择, gevent, eventlet这些都支持, 在多worker最大化里用CPU的同时, 还可以使用协程来提供并发支撑, 对于网络IO密集的服务比较有利.&lt;/p&gt;

&lt;p&gt;同时Gunicorn也很容易就改造成一个TCP的服务, 比如&lt;a href=&#34;https://github.com/zhu327/doge/tree/master/doge/gunicorn&#34;&gt;doge&lt;/a&gt;重写worker类, 在针对长连接的服务时, 最好开启reuse_port, 避免worker进程负载不均.&lt;/p&gt;

&lt;h2 id=&#34;uwsgi&#34;&gt;uWSGI&lt;/h2&gt;

&lt;p&gt;不同于Gunicorn, uWSGI是使用C写的, 它的socket fd创建, worker进程的启动都是使用C语言系统接口来实现的, 在worker进程处理循环中, 解析了http请求后, 使用python的C接口生成environ对象, 再把这个对象作为参数塞到暴露出来的WSGI application函数中调用. 而这一切都是在C程序中进行, 只是在处理请求的时候交给python虚拟机调用application. 完全使用C语言实现的好处是性能会好一些.&lt;/p&gt;

&lt;p&gt;除了支持http协议, uWSGI还实现了uwsgi协议, 一般我们会在uWSGI服务器前面使用Nginx作为负载均衡, 如果使用http协议, 请求在转发到uWSGI前已经在Nginx这里解析了一遍, 转发到uWSGI又会重新解析一遍. uWSGI为了追求性能, 设计了uwsgi协议, 在Nginx解析完以后直接把解析好的结果通过uwsgi协议转发到uWSGI服务器, uWSGI拿到请求按格式生成environ对象, 不需要重复解析请求. 如果用Nginx配合uWSGI, 最好使用uwsgi协议来转发请求.&lt;/p&gt;

&lt;p&gt;除了是一个WSGI服务器, uWSGI还是一个开发框架, 它提供了缓存, 队列, rpc等等功能, 在github找找就会发现有人用它的缓存写了一个Django cache backend, 用它的队列实现异步任务这些东西, 但是用了这些东西技术栈也就跟uWSGI绑定在一起, 所以一般也只是把uWSGI当作WSGI服务器来用.&lt;/p&gt;

&lt;h2 id=&#34;nginx&#34;&gt;Nginx&lt;/h2&gt;

&lt;p&gt;使用多个进程监听同一端口就绕不开惊群这个话题, fork子进程, 子进程共享listen socket fd, 多个子进程同时accept阻塞, 在请求到达时内核会唤醒所有accept的进程, 然而只有一个进程能accept成功, 其它进程accept失败再次阻塞, 影响系统性能, 这就是惊群. Linux 2.6内核更新以后多个进程accept只有一个进程会被唤醒, 但是如果使用epoll还是会产生惊群现象.&lt;/p&gt;

&lt;p&gt;Nginx为了解决epoll惊群问题, 使用进程间互斥锁, 只有拿到锁的进程才能把listen fd加入到epoll中, 在accept完成后再释放锁.&lt;/p&gt;

&lt;p&gt;但是在高并发情况下, 获取锁的开销也会影响性能, 一般会建议把锁配置关掉. 直到Nginx 1.9.1更新支持了socket的&lt;code&gt;SO_REUSEPORT&lt;/code&gt;选项, 惊群问题才算解决, listen socket fd不再是在master进程中创建, 而是每个worker进程创建一个通过&lt;code&gt;SO_REUSEPORT&lt;/code&gt; 选项来复用端口, 内核会自行选择一个fd来唤醒, 并且有负载均衡算法.&lt;/p&gt;

&lt;p&gt;Gunicorn与uWSGI都支持reuse_port选项, 在使用时可以通过压测来评估一下reuse_port是否能提升性能.&lt;/p&gt;

&lt;p&gt;一般我们会在Gunicorn/uWSGI前面再加一层Nginx, 这样做的原因有一下几点:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;做负载均衡&lt;/li&gt;
&lt;li&gt;静态文件服务器&lt;/li&gt;
&lt;li&gt;更安全&lt;/li&gt;
&lt;li&gt;扛并发&lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&#34;参考&#34;&gt;参考&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;https://github.com/Junnplus/blog/issues/9&#34;&gt;https://github.com/Junnplus/blog/issues/9&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://gunicorn.readthedocs.io/en/latest/index.html&#34;&gt;https://gunicorn.readthedocs.io/en/latest/index.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://www.nginx.com/blog/socket-sharding-nginx-release-1-9-1/&#34;&gt;https://www.nginx.com/blog/socket-sharding-nginx-release-1-9-1/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://www.zhihu.com/question/38528616&#34;&gt;https://www.zhihu.com/question/38528616&lt;/a&gt;&lt;/p&gt;</description>
    </item>
    
    <item>
      <title>Python后端架构演进</title>
      <link>https://zhu327.github.io/2018/07/19/python%E5%90%8E%E7%AB%AF%E6%9E%B6%E6%9E%84%E6%BC%94%E8%BF%9B/</link>
      <pubDate>Thu, 19 Jul 2018 00:15:07 &#43;0800</pubDate>
      
      <guid>https://zhu327.github.io/2018/07/19/python%E5%90%8E%E7%AB%AF%E6%9E%B6%E6%9E%84%E6%BC%94%E8%BF%9B/</guid>
      <description>&lt;p&gt;来腾讯之前在前公司做了3年的后端开发, 经历一款SaaS产品从0到10(还没有到100, 哈哈哈)的过程, 3年间后端的架构逐步演变, 在微服务的实践过程中遇到的问题也越来越多, 在这里总结下.&lt;/p&gt;

&lt;p&gt;产品是一款服务于人力资源的SaaS在线服务, 面向HR有Web Android/iOS 小程序多个客户端, 后端采用RESTful风格API来提供服务. 主要使用Python语言, 方便快速迭代.&lt;/p&gt;

&lt;p&gt;架构的演进经历了4个大的阶段: 1. MVC 2. 服务拆分 3. 微服务架构 4. 领域驱动设计.&lt;/p&gt;

&lt;p&gt;&lt;/p&gt;

&lt;h3 id=&#34;1-mvc&#34;&gt;1. MVC&lt;/h3&gt;

&lt;p&gt;项目刚开始的时候, 后端同事不超过5个, 这个阶段主要的工作是实现产品的原型, 没有太多的考虑架构, 使用Django来快速实现功能, DB的表结构设计好之后, 抽象出功能View, 由于产品设计也很不完善, 后端需要很多的预留设计, 避免产品逻辑的变更带来整个表结构的变动, 在这个阶段代码上最重要的是确定适合团队的代码规范, 代码检查规则.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://blog-1251544432.cos.ap-guangzhou.myqcloud.com/blog/v2-8fec1c067dae33c7fcaeb95f5e3a3792_r.jpg&#34; width=&#34;720&#34;&gt;&lt;/p&gt;

&lt;p&gt;整体上架构如上图, Nginx负责负载均衡, 分发流量到多个Django服务, Django处理逻辑, 需要异步任务就交给Celery, 然后数据量比较大的地方使用Redis做缓存. 同时还有实时消息通知的需要使用了Nginx Push Module.&lt;/p&gt;

&lt;p&gt;问题与优化方式:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;Django并发性能差 使用uWSGI Master+Worker 配合 gevent 携程支持高并发&lt;/li&gt;
&lt;li&gt;Redis连接数过多 使用redis-py自带的连接池来实现连接复用&lt;/li&gt;
&lt;li&gt;MySQL连接数过多 使用&lt;a href=&#34;https://github.com/djangonauts/djorm-ext-pool&#34;&gt;djorm-ext-pool&lt;/a&gt;连接池复用连接&lt;/li&gt;
&lt;li&gt;Celery配置gevent支持并发任务&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;随着开发的功能越来越多, Django下的app也越来越多, 这就带了发布上的不方便, 每次发布版本都需要重启所有的Django服务, 如果发布遇到问题, 只能加班解决了. 而且单个Django工程下的代码量也越来越多, 不好维护.&lt;/p&gt;

&lt;h3 id=&#34;2-服务拆分&#34;&gt;2. 服务拆分&lt;/h3&gt;

&lt;p&gt;随着后端团队的壮大, 分给每个同事的需求也越来越细, 如果继续在一个工程里面开发所有的代码, 维护起来的代价太高, 而我们的上一个架构中在Django里面已经按模块划分了一个个app, app内高类聚, app之间低耦合, 这就为服务的拆分带来了便利. 拆分的过程没有遇到太大的问题, 初期的拆分只是代码的分离, 把公用的代码抽离出来实现一个公用的Python库, 数据库, Redis还是共用, 随着负载的增加, 数据库也做了多实例.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://blog-1251544432.cos.ap-guangzhou.myqcloud.com/blog/v2-501318fe25b9852cf72270a20c783db0_r.jpg&#34; width=&#34;720&#34;&gt;&lt;/p&gt;

&lt;p&gt;如上图, 服务之间尽量避免相互调用, 需要交互的地方采用http请求的方式, 内网的调用使用hosts指向内网地址.&lt;/p&gt;

&lt;p&gt;问题与优化方式:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Nginx Push Module由于长时间没有维护, 长连接最大数量不够, 使用Tornado + ZeroMQ实现了&lt;a href=&#34;https://github.com/zhu327/tormq&#34;&gt;tormq&lt;/a&gt;服务来支撑消息通知&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;服务之间的调用采用http的方式, 并且要求有依赖的服务主机配置hosts指向被调用的地址, 这样带来的维护上的不方便. 以及在调用链的过程中没有重试, 错误处理, 限流等等的策略, 导致服务可用性差. 随着业务拆分, 继续使用Nginx维护配置非常麻烦, 经常因为修改Nginx的配置引发调用错误. 每一个服务都有一个完整的认证过程, 认证又依赖于用户中心的数据库, 修改认证时需要重新发布多个服务.&lt;/p&gt;

&lt;h3 id=&#34;3-微服务架构&#34;&gt;3. 微服务架构&lt;/h3&gt;

&lt;p&gt;&lt;img src=&#34;https://blog-1251544432.cos.ap-guangzhou.myqcloud.com/blog/v2-f6b57db532f92e1664b13702cd99ddda_r.jpg&#34; width=&#34;720&#34;&gt;&lt;/p&gt;

&lt;p&gt;首先是在接入层引入了基于OpenResty的Kong API Gateway, 定制实现了认证, 限流等插件. 在接入层承接并剥离了应用层公共的认证, 限流等功能. 在发布新的服务时, 发布脚本中调用Kong admin api注册服务地址到Kong, 并加载api需要使用插件.&lt;/p&gt;

&lt;p&gt;为了解决相互调用的问题, 维护了一个基于gevent+msgpack的RPC服务框架&lt;a href=&#34;https://github.com/zhu327/doge&#34;&gt;doge&lt;/a&gt;, 借助于etcd做服务治理, 并在rpc客户端实现了限流, 高可用, 负载均衡这些功能.&lt;/p&gt;

&lt;p&gt;在这个阶段最难的技术选型, 开源的API网关大多用Golang与OpenResty(lua)实现, 为了应对我们业务的需要还要做定制. 前期花了1个月时间学习OpenResty与Golang, 并使用OpenResty实现了一个短网址服务&lt;a href=&#34;https://github.com/zhu327/shorturl&#34;&gt;shorturl&lt;/a&gt;用在业务中. 最终选择Kong是基于Lua发布的便利性, Kong的开箱即用以及插件开发比较容易. 性能的考量倒不是最重要的, 为了支撑更多的并发, 还使用了云平台提供的LB服务分发流量到2台Kong服务器组成的集群. 集群之间自动同步配置.&lt;/p&gt;

&lt;p&gt;饿了么维护一个纯Python实现的thrift协议框架&lt;a href=&#34;https://github.com/eleme/thriftpy&#34;&gt;thriftpy&lt;/a&gt;, 并提供很多配套的工具, 如果团队足够大, 这一套RPC方案其实是合适的, 但是我们的团队人手不足, 水平参差不齐, 很难推广这一整套学习成本高昂的方案. 最终我们开发了类Duboo的RPC框架&lt;a href=&#34;https://github.com/zhu327/doge&#34;&gt;doge&lt;/a&gt;, 代码主要参考了weibo开源的motan.&lt;/p&gt;

&lt;h3 id=&#34;4-领域驱动设计&#34;&gt;4. 领域驱动设计&lt;/h3&gt;

&lt;p&gt;&lt;img src=&#34;https://blog-1251544432.cos.ap-guangzhou.myqcloud.com/blog/v2-d2218f7f78615b7149a2fbdce7f11ab1_r.jpg&#34; width=&#34;720&#34;&gt;&lt;/p&gt;

&lt;p&gt;在这一架构中我们尝试从应用服务中抽离出数据服务层, 每一个数据服务包含一个或多个界限上下文, 界限上下文类只有一个聚合根来暴露出RPC调用的方法. 数据服务不依赖于应用服务, 应用服务可以依赖多个数据服务. 有了数据服务层, 应用就解耦了相互之间的依赖, 高层服务只依赖于底层服务.&lt;/p&gt;

&lt;p&gt;在我离职时领域驱动设计还在学习设计阶段, 还没有落地, 但是我相信前公司的后端架构一定会往这个方向继续演进.&lt;/p&gt;

&lt;h3 id=&#34;总结&#34;&gt;总结&lt;/h3&gt;

&lt;p&gt;架构的设计, 技术的选型, 不能完全按照流行的技术走, 最终还是服务于产品, 服务于客户的需求. 设计过程中由于团队, 人员的结构问题, 有很多的妥协之处, 如何在妥协中找到最优解才是最大的挑战.&lt;/p&gt;

&lt;p&gt;Service Mesh这种新一代的微服务架构正在成为主流, 虽然现在的工作与微服务无关了, 但是也还会继续关注学习.&lt;/p&gt;</description>
    </item>
    
    <item>
      <title>微信公众号迁移Serverless详解</title>
      <link>https://zhu327.github.io/2018/07/17/%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7%E8%BF%81%E7%A7%BBserverless%E8%AF%A6%E8%A7%A3/</link>
      <pubDate>Tue, 17 Jul 2018 00:12:12 &#43;0800</pubDate>
      
      <guid>https://zhu327.github.io/2018/07/17/%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7%E8%BF%81%E7%A7%BBserverless%E8%AF%A6%E8%A7%A3/</guid>
      <description>&lt;p&gt;3月腾讯云函数计算开放测试, 看到的第一反应是这种Serverless太适合做微信公众号的后端来实现自动应答了, 尝试把我服务了3年的一个公众号迁移到腾讯云函数计算, 结果因为API gateway的一个功能缺失搁置了, 这周腾讯云API gateway终于补上了集成响应的能力, 能正常服务我的公众号, 这里记录下实现过程.&lt;/p&gt;

&lt;p&gt;&lt;/p&gt;

&lt;h3 id=&#34;改造werobot&#34;&gt;改造werobot&lt;/h3&gt;

&lt;p&gt;&lt;a href=&#34;https://github.com/zhu327/ifwechat&#34;&gt;https://github.com/zhu327/ifwechat&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;ifwechat这个公众号是基于&lt;a href=&#34;https://github.com/offu/WeRoBot&#34;&gt;werobot&lt;/a&gt;实现的, 之前以WSGI的方式部署在&lt;a href=&#34;https://sae.sina.com.cn/&#34;&gt;SAE&lt;/a&gt;上, 而不同于WSGI, 函数计算从API gateway触发的事件是一个Python的字典, 需要从这个事件字典里面获取http request的信息来调用werobot的方法. API gateway的触发事件参考: &lt;a href=&#34;https://cloud.tencent.com/document/product/583/13197&#34;&gt;https://cloud.tencent.com/document/product/583/13197&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;需要实现一个从http request事件到werobot的message的wrapper handler:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# coding: utf-8&lt;/span&gt;

&lt;span class=&#34;kn&#34;&gt;from&lt;/span&gt; &lt;span class=&#34;nn&#34;&gt;handlers&lt;/span&gt; &lt;span class=&#34;kn&#34;&gt;import&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;robot&lt;/span&gt;

&lt;span class=&#34;n&#34;&gt;robot&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;config&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;from_pyfile&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;configs.py&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;


&lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;werobot_handler&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;event&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;):&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;timestamp&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;event&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;queryString&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;timestamp&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;nonce&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;event&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;queryString&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;nonce&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;signature&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;event&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;queryString&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;signature&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;

    &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;ow&#34;&gt;not&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;robot&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;check_signature&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;timestamp&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;timestamp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
                                 &lt;span class=&#34;n&#34;&gt;nonce&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nonce&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
                                 &lt;span class=&#34;n&#34;&gt;signature&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;signature&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;):&lt;/span&gt;
        &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;error: wrong wechat signature&amp;#34;&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;event&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;requestContext&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;][&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;httpMethod&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;GET&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
        &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;event&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;queryString&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;echostr&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;elif&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;event&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;requestContext&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;][&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;httpMethod&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;POST&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
        &lt;span class=&#34;n&#34;&gt;body&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;event&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;body&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;event&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;body&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;replace&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;\\&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;u003c&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;lt;&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;replace&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;\\&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;u003e&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;gt;&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;decode&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;utf8&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
        &lt;span class=&#34;n&#34;&gt;message&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;robot&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;parse_message&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
            &lt;span class=&#34;n&#34;&gt;body&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
            &lt;span class=&#34;n&#34;&gt;timestamp&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;timestamp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
            &lt;span class=&#34;n&#34;&gt;nonce&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nonce&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
            &lt;span class=&#34;n&#34;&gt;msg_signature&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;event&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;queryString&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;msg_signature&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;
        &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;robot&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get_encrypted_reply&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;message&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;在API gateway上创建API时需要勾选集成响应功能, 并且在函数入口返回的格式如下:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# coding: utf-8&lt;/span&gt;

&lt;span class=&#34;kn&#34;&gt;from&lt;/span&gt; &lt;span class=&#34;nn&#34;&gt;scf_werobot&lt;/span&gt; &lt;span class=&#34;kn&#34;&gt;import&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;werobot_handler&lt;/span&gt;


&lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;main_handler&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;event&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;context&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;):&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;requestContext&amp;#34;&lt;/span&gt; &lt;span class=&#34;ow&#34;&gt;not&lt;/span&gt; &lt;span class=&#34;ow&#34;&gt;in&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;event&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;keys&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;():&lt;/span&gt;
        &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;error: event is not come from api gateway&amp;#34;&lt;/span&gt;

    &lt;span class=&#34;n&#34;&gt;content&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;werobot_handler&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;event&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;

    &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
        &lt;span class=&#34;s2&#34;&gt;&amp;#34;statusCode&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;200&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
        &lt;span class=&#34;s2&#34;&gt;&amp;#34;headers&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;Content-Type&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;application/xml&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;},&lt;/span&gt;
        &lt;span class=&#34;s2&#34;&gt;&amp;#34;body&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;content&lt;/span&gt;
    &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&#34;通过cos实现werobot的session&#34;&gt;通过cos实现werobot的session&lt;/h3&gt;

&lt;p&gt;除了计算外, ifwechat还用到了werobot的session来存微信用户与ifttt用户之间的对应关系, 在SAE上部署session数据是存在SAE的kvdb里的, 但是在腾讯云这里就没有免费的Redis或者MySQL来用了. 在研究zappa这个serverless框架的时候, 发现他们用AWS S3实现了一个NoDB的库可用用来做kvdb, 而腾讯云对标S3存储的就是cos, 把NoDB fork修改S3代码改成cos sdk调用, 就有了这个&lt;a href=&#34;https://github.com/zhu327/NoDB&#34;&gt;NoDB for Tencent Cloud COS&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;继承werobot的SessionStorage实现用NoDB来做session backend:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# coding: utf-8&lt;/span&gt;

&lt;span class=&#34;kn&#34;&gt;from&lt;/span&gt; &lt;span class=&#34;nn&#34;&gt;werobot.session&lt;/span&gt; &lt;span class=&#34;kn&#34;&gt;import&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;SessionStorage&lt;/span&gt;
&lt;span class=&#34;kn&#34;&gt;from&lt;/span&gt; &lt;span class=&#34;nn&#34;&gt;nodb&lt;/span&gt; &lt;span class=&#34;kn&#34;&gt;import&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;NoDB&lt;/span&gt;


&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;NoDBStorage&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;SessionStorage&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;):&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;fm&#34;&gt;__init__&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;secret_id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;secret_key&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;region&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;bucket&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;):&lt;/span&gt;
        &lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nodb&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;NoDB&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;secret_id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;secret_key&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;region&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
        &lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nodb&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bucket&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;bucket&lt;/span&gt;

    &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;get&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;):&lt;/span&gt;
        &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nodb&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;load&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;ow&#34;&gt;or&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{}&lt;/span&gt;

    &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;set&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;value&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;):&lt;/span&gt;
        &lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nodb&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;save&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;value&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;

    &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;delete&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;):&lt;/span&gt;
        &lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;nodb&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;delete&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;

    &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;fm&#34;&gt;__getitem__&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;):&lt;/span&gt;
        &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;

    &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;fm&#34;&gt;__setitem__&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;session&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;):&lt;/span&gt;
        &lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;set&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;session&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;

    &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;fm&#34;&gt;__delitem__&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;):&lt;/span&gt;
        &lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;delete&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;打包所有代码为zip文件, 并发布到scf就完成了这个迁移过程.&lt;/p&gt;

&lt;h3 id=&#34;关于zappa&#34;&gt;关于zappa&lt;/h3&gt;

&lt;p&gt;从迁移过程的体验来看, 功能的开发还是很简单的, 只是部署的过程不是很友好, 如果能有一个类似于zappa这样的自动化部署框架来对接到腾讯云函数计算, 相信对开发者来说会更友好.&lt;/p&gt;</description>
    </item>
    
    <item>
      <title>像OpenResty一样使用Golang开发Web App</title>
      <link>https://zhu327.github.io/2018/06/26/%E5%83%8Fopenresty%E4%B8%80%E6%A0%B7%E4%BD%BF%E7%94%A8golang%E5%BC%80%E5%8F%91web-app/</link>
      <pubDate>Tue, 26 Jun 2018 21:35:01 &#43;0800</pubDate>
      
      <guid>https://zhu327.github.io/2018/06/26/%E5%83%8Fopenresty%E4%B8%80%E6%A0%B7%E4%BD%BF%E7%94%A8golang%E5%BC%80%E5%8F%91web-app/</guid>
      <description>&lt;p&gt;&lt;a href=&#34;https://github.com/zhu327/glualor&#34;&gt;https://github.com/zhu327/glualor&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;最近在公司内网读过一篇Gopher Lua的文章, 感觉在Golang中使用Lua VM的模式跟OpenResty是一样一样的. 在Github上找了一圈net/http的到Gopher Lua的绑定, 然而并没有. 造轮子的机会来了 ^_^&lt;/p&gt;

&lt;h3 id=&#34;gluaweb&#34;&gt;gluaweb&lt;/h3&gt;

&lt;p&gt;虽然看过几本Golang的书, 也读过几个开源项目的代码, 来腾讯后还上过两门Golang的课, 但是却没有写过一个Golang的项目, 从新读过net/http标准库的文档, 再看看Gopher Lua的例子就写了&lt;a href=&#34;https://github.com/zhu327/gluaweb&#34;&gt;gluaweb&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;kn&#34;&gt;package&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;main&lt;/span&gt;

&lt;span class=&#34;kn&#34;&gt;import&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
	&lt;span class=&#34;s&#34;&gt;&amp;#34;github.com/yuin/gopher-lua&amp;#34;&lt;/span&gt;
	&lt;span class=&#34;s&#34;&gt;&amp;#34;github.com/zhu327/gluaweb&amp;#34;&lt;/span&gt;
	&lt;span class=&#34;s&#34;&gt;&amp;#34;net/http&amp;#34;&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;

&lt;span class=&#34;kd&#34;&gt;type&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;helloHandler&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{}&lt;/span&gt;

&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;h&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;helloHandler&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;ServeHTTP&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;w&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;http&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;ResponseWriter&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;http&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Request&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;L&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;lua&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;NewState&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
	&lt;span class=&#34;k&#34;&gt;defer&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;L&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Close&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;ctx&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;gluaweb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;NewWebContext&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;w&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;).&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;WebContext&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;L&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;L&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;SetGlobal&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;gluaweb&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;ctx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
	&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;L&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;DoString&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;`
&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;        gluaweb.Write(&amp;#34;hello world!&amp;#34;)
&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;    `&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;!=&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;nil&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
		&lt;span class=&#34;nb&#34;&gt;panic&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
	&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;

&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;main&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;http&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Handle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;/&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;helloHandler&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{})&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;http&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;ListenAndServe&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;:8080&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;nil&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;使用很简单, 每个请求进来启动一个Lua VM, 然后注入gluaweb上下文, 在lua里面调用gluaweb绑定的Request或者ResponseWriter的方法即可.&lt;/p&gt;

&lt;p&gt;到这一步基本上跟OpenResty其实就差不多了, OpenResty里Request与Response相关的方法都在ngx下, 而在gluaweb里gluaweb就相当于OpenResty的ngx.&lt;/p&gt;

&lt;h3 id=&#34;glualor&#34;&gt;glualor&lt;/h3&gt;

&lt;p&gt;有了最基本的Request/Response的方法还不够, 还需要Web FrameWork, 就如同Gin之于net/http. 在OpenResty那边有一个&lt;a href=&#34;https://github.com/sumory/lor&#34;&gt;lor&lt;/a&gt;框架, 代码很简洁, 使用方式类似于Python的Flask. 同样是Lua写的, 只需要阅读代码, 把其中使用ngx相关的部分改写成gluaweb对应的方法即可. 包括request.lua respnse.lua cookie.lua.&lt;/p&gt;

&lt;p&gt;lor还支持json编解码, 在OpenResty里使用的cjson, 在Github找到了&lt;a href=&#34;https://github.com/layeh/gopher-json&#34;&gt;gopher-json&lt;/a&gt;, 在main.go里面创建Lua VM时加载json module, 并且修改lor里面utils.lua json相关的代码从cjson改为gogher-json.&lt;/p&gt;

&lt;p&gt;除了json还有template, lor使用了lua-resty-template这个库, 在Gopher Lua这边可以直接使用Golang html/template, 同样去Github上面搜索找到一个text/template到Gopher Lua的绑定, 由于text/template提供的接口与html/template是一样的所以fork到&lt;a href=&#34;https://github.com/zhu327/gluatemplate&#34;&gt;gluatemplate&lt;/a&gt;, 改import把text改为html. 再修改lor里面view.lua把lua-resty-template替换为gluatemplate.&lt;/p&gt;

&lt;p&gt;main.go&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;kn&#34;&gt;package&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;main&lt;/span&gt;

&lt;span class=&#34;kn&#34;&gt;import&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
	&lt;span class=&#34;s&#34;&gt;&amp;#34;github.com/yuin/gopher-lua&amp;#34;&lt;/span&gt;
	&lt;span class=&#34;s&#34;&gt;&amp;#34;github.com/zhu327/gluatemplate&amp;#34;&lt;/span&gt;
	&lt;span class=&#34;s&#34;&gt;&amp;#34;github.com/zhu327/gluaweb&amp;#34;&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;luajson&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;&amp;#34;layeh.com/gopher-json&amp;#34;&lt;/span&gt;
	&lt;span class=&#34;s&#34;&gt;&amp;#34;net/http&amp;#34;&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;

&lt;span class=&#34;kd&#34;&gt;type&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;helloHandler&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{}&lt;/span&gt;

&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;h&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;helloHandler&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;ServeHTTP&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;w&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;http&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;ResponseWriter&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;http&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Request&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;L&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;lua&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;NewState&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;luajson&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Preload&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;L&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;L&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;PreloadModule&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;template&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;gluatemplate&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Loader&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
	&lt;span class=&#34;k&#34;&gt;defer&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;L&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Close&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;ctx&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;gluaweb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;NewWebContext&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;w&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;r&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;).&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;WebContext&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;L&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;L&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;SetGlobal&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;gluaweb&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;ctx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
	&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;L&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;DoFile&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;main.lua&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;!=&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;nil&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;// 加载 lua 代码
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;		&lt;span class=&#34;nb&#34;&gt;panic&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
	&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;

&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;main&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;http&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Handle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;/&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;helloHandler&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{})&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;http&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;ListenAndServe&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;:8080&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;nil&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;main.lua&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-lua&#34; data-lang=&#34;lua&#34;&gt;&lt;span class=&#34;kd&#34;&gt;local&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;lor&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;require&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;lor.index&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;

&lt;span class=&#34;kd&#34;&gt;local&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;app&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;lor&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;

&lt;span class=&#34;n&#34;&gt;app.get&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;/&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;kr&#34;&gt;function&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;err&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;req&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;res&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;next&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
	&lt;span class=&#34;n&#34;&gt;res&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;send&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;Hello world!&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;            
&lt;span class=&#34;p&#34;&gt;})&lt;/span&gt;

&lt;span class=&#34;n&#34;&gt;app.run&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;经过以上改造, 已经能在Gopher Lua上愉快的使用lor快速开发web app了, 然后ab测试一下性能, 简直不忍直视, 继续改造.&lt;/p&gt;

&lt;p&gt;每一个请求进来都新建一个Lua VM其实是没有必要的, 可以全局创建一个VM池, 每个请求进来从池里取出一个VM运行代码即可. Gopher Lua的README上也介绍了一个goroutine安全的pool实现直接拷贝过来用就好了. 除了VM复用还需要Lua代码的复用, 而不是每一次请求都Dofile加载一次所有的代码, 这样就需要把Lua中的某个函数暴露给Golang, 在Golang中调用已有的Lua函数来处理请求, 在lor里面就是app.run这个方法, 把app声明成全局变量就可以在Golang中调用app.run了.&lt;/p&gt;

&lt;p&gt;再ab测一下, 性能相对于原生Golang的Hello world有大概17%的损失, 相对于开发的便利性, 还是可以接受的.&lt;/p&gt;

&lt;p&gt;有了框架还要测试下到底能不能用, lor有一个官方的TODO示例, 直接用这个跑一下试试, 最终的完整实例就是&lt;a href=&#34;https://github.com/zhu327/glualor&#34;&gt;glualor&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&#34;扩展&#34;&gt;扩展&lt;/h3&gt;

&lt;p&gt;Web开发当然不只是Web Framework, OpenResty提供了全套开发库, MySQL Redis一应俱全, 但是Gopher Lua的生态还不完善, Github搜一圈并没有找到MySQL与Redis的绑定, 其实自己写也是很简单的, 有空再扩展一下^_^&lt;/p&gt;</description>
    </item>
    
    <item>
      <title>服务治理与RPC</title>
      <link>https://zhu327.github.io/2018/03/24/%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86%E4%B8%8Erpc/</link>
      <pubDate>Sat, 24 Mar 2018 15:38:54 &#43;0800</pubDate>
      
      <guid>https://zhu327.github.io/2018/03/24/%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86%E4%B8%8Erpc/</guid>
      <description>&lt;p&gt;以前写过Django中使用zerorpc的方法，但是由于我们的Django是运行在gevent下，而zeromq需要启动一个后台进程处理消息，与gevent使用的greenlet携程是冲突的。&lt;/p&gt;

&lt;p&gt;在Java的世界里，Spring Cloud全家桶覆盖了微服务的方方面面，专注于服务治理的框架也有阿里的Dubbo，微博的Motan。但是Python这边没有找到合适的轮子，甚至于好的RPC框架也没有，只有gRPC，Thrift这种跨语言的RPC框架。而这些跨语言的RPC框架基本上也是基于C/C++的Python port。&lt;/p&gt;

&lt;p&gt;在github上全局搜索Python rpc，找到一个原生支持gevent的&lt;a href=&#34;https://github.com/studio-ousia/mprpc&#34;&gt;MPRPC&lt;/a&gt;，而且也找到了微博Motan的Golang版本，所以考虑读Motan-go的源码学习一下什么是服务治理，再基于MPRPC实现自己的轮子。这就有了&lt;a href=&#34;https://github.com/zhu327/doge&#34;&gt;doge&lt;/a&gt;。&lt;/p&gt;

&lt;p&gt;&lt;/p&gt;

&lt;h4 id=&#34;服务注册&#34;&gt;服务注册&lt;/h4&gt;

&lt;p&gt;主流的注册中心服务包括etcd，Consul，zookeeper。这里只考虑了etcd与Consul，etcd相对来说简单些，是一个分布式的KV强一致数据库，数据以树状结构存储。Consul的功能更丰富些，有服务的定义，并且支持对服务的健康检查。etcd不支持健康检查，但是可以通过设置key的ttl，然后服务定时刷新ttl来主动上报。&lt;/p&gt;

&lt;h4 id=&#34;熔断&#34;&gt;熔断&lt;/h4&gt;

&lt;p&gt;MPRPC本身提供了一个简单socket pool池，但是在高并发测试下发现池会溢出，其实是一个并发安全的问题，打了一个补丁，解决了该问题。&lt;/p&gt;

&lt;p&gt;同时在连接池的基础上封装了EndPoint了，在调用失败多次后，判断EndPoint不可用，并且启动后台协程多次链接socket，一旦连接成功则重新设置为可用。&lt;/p&gt;

&lt;p&gt;同时客户端会监听服务的key变化，一旦服务没有刷新ttl，key被删除或过期，对应的EndPint也会被删除。&lt;/p&gt;

&lt;h4 id=&#34;负载均衡&#34;&gt;负载均衡&lt;/h4&gt;

&lt;p&gt;主流的负载均衡方式有：随机，平均，按负载，HASH。由于RPC主要是在内部网络使用，所以只实现了随机与平均的方式。&lt;/p&gt;

&lt;h4 id=&#34;高可用&#34;&gt;高可用&lt;/h4&gt;

&lt;p&gt;简单的方式failfast只调用一次，无论是否出错马上返回。failover会在重试次数以内遍历所有可以用的EndPoint，直到成功才返回。backrequest会在调用时保存所有成功的调用事件，算出一个合适的超市事件来遍历调用，直到成功并返回。&lt;/p&gt;

&lt;h4 id=&#34;服务降级&#34;&gt;服务降级&lt;/h4&gt;

&lt;p&gt;Java有hystrix这种专门用来做熔断，降级的库。Python由于比较简单，可用直接try/except来事件，在熔断以后，直接调用熔断处理函数。&lt;/p&gt;

&lt;h4 id=&#34;服务端限流&#34;&gt;服务端限流&lt;/h4&gt;

&lt;p&gt;限制连接数，可用通过信号量来实现。限制流速，漏桶算法或者令牌桶算法。事件段内的调用次数，使用计数器。&lt;/p&gt;

&lt;p&gt;在开发&lt;a href=&#34;https://github.com/zhu327/doge&#34;&gt;doge&lt;/a&gt;的过程中，学习通过pytest来写单元测试，感觉比unitest更方便一些。同时接入了travis ci在每次push代码的同时执行单元测试。发布到PyPI后补充了codecov代码测试覆盖率。对于开源项目的正确姿势有了更多的理解。&lt;/p&gt;</description>
    </item>
    
    <item>
      <title>OpenResty与API Gateway</title>
      <link>https://zhu327.github.io/2017/11/27/openresty%E4%B8%8Eapi-gateway/</link>
      <pubDate>Mon, 27 Nov 2017 18:20:31 &#43;0800</pubDate>
      
      <guid>https://zhu327.github.io/2017/11/27/openresty%E4%B8%8Eapi-gateway/</guid>
      <description>&lt;p&gt;公司业务向微服务方向迁移实践中, API Gateway成为接入层最重要的部分, 在完成开发的同时给同事做了一次OpenResty的分享, 以下是分享的内容整理.&lt;/p&gt;

&lt;hr /&gt;

&lt;h3 id=&#34;当我谈论高性能时我们谈论什么&#34;&gt;当我谈论高性能时我们谈论什么 ?&lt;/h3&gt;

&lt;p&gt;讨论时间, 大家自由发挥&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;机器&lt;/li&gt;
&lt;li&gt;语言&lt;/li&gt;
&lt;li&gt;架构

&lt;ul&gt;
&lt;li&gt;reactor&lt;/li&gt;
&lt;li&gt;coroutine&lt;/li&gt;
&lt;li&gt;cache&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;/p&gt;

&lt;h3 id=&#34;学习指南-1&#34;&gt;学习指南 #1&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;reactor

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;http://blog.csdn.net/u013074465/article/details/46276967&#34;&gt;http://blog.csdn.net/u013074465/article/details/46276967&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;coroutine

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;http://blog.csdn.net/wyx819/article/details/45420017&#34;&gt;http://blog.csdn.net/wyx819/article/details/45420017&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;Tornado代码阅读笔记 IOLoop

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;http://t.cn/R5XxpMM&#34;&gt;http://t.cn/R5XxpMM&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;hr /&gt;

&lt;h3 id=&#34;同步编程&#34;&gt;同步编程&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;多线程, 用户态/内核态相互切换&lt;/li&gt;
&lt;li&gt;阻塞, 带来线程切换&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;异步编程&#34;&gt;异步编程&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;事件驱动&lt;/li&gt;
&lt;li&gt;回调&lt;/li&gt;
&lt;li&gt;协程&lt;/li&gt;
&lt;/ul&gt;

&lt;hr /&gt;

&lt;h2 id=&#34;openresty&#34;&gt;OpenResty&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;Nginx&lt;/li&gt;
&lt;li&gt;&lt;code&gt;lua-nginx-module&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;lua resty libs

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/iresty/nginx-lua-module-zh-wiki#description&#34;&gt;https://github.com/iresty/nginx-lua-module-zh-wiki#description&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;em&gt;无聊的分割线&lt;/em&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;基于lua的Nginx开发&lt;/li&gt;
&lt;li&gt;Nginx的异步机制+lua coroutine&lt;/li&gt;
&lt;li&gt;够用的内置lua libs cosocket异步支持&lt;/li&gt;
&lt;li&gt;内置cache&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;em&gt;ngx_lua模块的原理&lt;/em&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;每个worker（工作进程）创建一个Lua VM，worker内所有协程共享VM；&lt;/li&gt;
&lt;li&gt;将Nginx I/O原语封装后注入 Lua VM，允许Lua代码直接访问；&lt;/li&gt;
&lt;li&gt;每个外部请求都由一个Lua协程处理，协程之间数据隔离；&lt;/li&gt;
&lt;li&gt;Lua代码调用I/O操作等异步接口时，会挂起当前协程（并保护上下文数据），而不阻塞worker；&lt;/li&gt;
&lt;li&gt;I/O等异步操作完成时还原相关协程上下文数据，并继续运行；&lt;/li&gt;
&lt;/ul&gt;

&lt;hr /&gt;

&lt;h3 id=&#34;学习指南-2&#34;&gt;学习指南 #2&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;OpenResty 系列课程

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;http://www.stuq.org/course/1015&#34;&gt;http://www.stuq.org/course/1015&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;agentzh 的 Nginx 教程

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://openresty.org/download/agentzh-nginx-tutorials-zhcn.html&#34;&gt;https://openresty.org/download/agentzh-nginx-tutorials-zhcn.html&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;OpenResty 最佳实践

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://moonbingbing.gitbooks.io/openresty-best-practices/content/&#34;&gt;https://moonbingbing.gitbooks.io/openresty-best-practices/content/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;nginx-lua-module-zh-wiki

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/iresty/nginx-lua-module-zh-wiki&#34;&gt;https://github.com/iresty/nginx-lua-module-zh-wiki&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;hr /&gt;

&lt;h3 id=&#34;api-gateway&#34;&gt;API Gateway&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;微服务&lt;/li&gt;
&lt;li&gt;入口&lt;/li&gt;
&lt;li&gt;授权、监控、负载均衡、缓存、请求分片和管理、静态响应处理&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;学习指南-3&#34;&gt;学习指南 #3&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;微服务

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;http://blog.csdn.net/wurenhai/article/details/37659335/&#34;&gt;http://blog.csdn.net/wurenhai/article/details/37659335/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;API Gateway

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;http://dockone.io/article/482&#34;&gt;http://dockone.io/article/482&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&#34;https://camo.githubusercontent.com/0e1bbef1559f33dd31b9f352c83d2caf2bc4e61b/687474703a2f2f636c2e6c792f696d6167652f3142334a33623368314831632f496d616765253230323031352d30372d30372532306174253230362e35372e3235253230504d2e706e67&#34; width=&#34;720&#34;&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;h3 id=&#34;kong&#34;&gt;Kong&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;基于Openresty&lt;/li&gt;
&lt;li&gt;自带武器库&lt;/li&gt;
&lt;li&gt;灵活的插件定制&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;学习指南-4&#34;&gt;学习指南 #4&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;Kong源码分析

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;http://cyukang.com/2017/07/02/kong-intro.html&#34;&gt;http://cyukang.com/2017/07/02/kong-intro.html&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;深入理解orange

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/linger1216/understanding-orange&#34;&gt;https://github.com/linger1216/understanding-orange&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;hr /&gt;

&lt;h3 id=&#34;定制需求&#34;&gt;定制需求&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;eebo auth

&lt;ul&gt;
&lt;li&gt;独立auth模块&lt;/li&gt;
&lt;li&gt;灵活配置api是否需要auth&lt;/li&gt;
&lt;li&gt;Python服务无需关注认证细节&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;eebo limiting

&lt;ul&gt;
&lt;li&gt;基于内置rate-limiting开发&lt;/li&gt;
&lt;li&gt;提供&lt;code&gt;company_id/user_id&lt;/code&gt;维度&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;eebo balancer

&lt;ul&gt;
&lt;li&gt;提供私有服务&lt;/li&gt;
&lt;li&gt;强大的分布式分发&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;自带的插件&#34;&gt;自带的插件&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;CORS

&lt;ul&gt;
&lt;li&gt;用于处理跨域请求&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;IP Restriction

&lt;ul&gt;
&lt;li&gt;IP 黑白名单&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;Correlation ID

&lt;ul&gt;
&lt;li&gt;为每个请求生成唯一请求id&lt;/li&gt;
&lt;li&gt;方便定位, 跟踪日志&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;Syslog

&lt;ul&gt;
&lt;li&gt;推送日志到Syslog-&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;</description>
    </item>
    
    <item>
      <title>记</title>
      <link>https://zhu327.github.io/2017/09/11/%E8%AE%B0/</link>
      <pubDate>Mon, 11 Sep 2017 13:43:35 &#43;0800</pubDate>
      
      <guid>https://zhu327.github.io/2017/09/11/%E8%AE%B0/</guid>
      <description>&lt;p&gt;好几个月都没写过Blog,写个小记&lt;/p&gt;

&lt;h3 id=&#34;openresty&#34;&gt;Openresty&lt;/h3&gt;

&lt;p&gt;公司业务向微服务迁移过程中接触到API Gateway这种中间件,评估了各种开源方案后,选择了在Openresty基础上实现的&lt;a href=&#34;https://github.com/Mashape/kong&#34;&gt;Kong&lt;/a&gt;.为了在Kong的基础上做二次开发,开始学习Openresty.&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://moonbingbing.gitbooks.io/openresty-best-practices/content/&#34;&gt;OpenResty 最佳实践&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://openresty.org/download/agentzh-nginx-tutorials-zhcn.html&#34;&gt;agentzh 的 Nginx 教程&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://jinnianshilongnian.iteye.com/blog/2190344&#34;&gt;跟开涛学OpenResty(Nginx+Lua)开发&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;还是在好几年做测试的时候用过lua语言写测试脚本,lua语言特性很简单,想捡起来也很快.更多的感触是由于学习过Torando的源码,理解了Reactor模型,协程这些概念.学起Openresty只需要把相关概念套上去就很好理解了.这就是知识体系建立的好处,虽然不同语言,不同框架,还是能快速上手.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/zhu327/shorturl&#34;&gt;https://github.com/zhu327/shorturl&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;正好公司有个生成短链接的小项目,不限语言,先拿Openresty练练手,写了个shorturl.&lt;/p&gt;

&lt;p&gt;&lt;/p&gt;

&lt;h3 id=&#34;kong&#34;&gt;Kong&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/linger1216/understanding-orange&#34;&gt;深入理解orange&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://cyukang.com/tags/#Lua&#34;&gt;Kong源码分析&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;理解API Gateway是什么是从&lt;a href=&#34;https://github.com/sumory/orange&#34;&gt;Orange&lt;/a&gt;这个Kong的国内轮子开始的,简单点描述Kong或者Orange就是在Openresty请求处理的过程中把各种过程抽象出来作为插件来组织功能代码.Kong还提供大量开箱即用的插件,并且定制开发插件也很简单.&lt;/p&gt;

&lt;h3 id=&#34;c&#34;&gt;C&lt;/h3&gt;

&lt;p&gt;看过了太多Python调用C代码的例子,而且Openresty的生态系统还不算完善,就有更多的用lua跟C语言打交道的地方了,重温了一下&lt;a href=&#34;https://book.douban.com/subject/1139336/&#34;&gt;C程序设计语言&lt;/a&gt;.读过&lt;a href=&#34;https://book.douban.com/subject/5333562/&#34;&gt;深入理解计算机系统&lt;/a&gt;再来看C语言很多以前的难点都迎刃而解了,还是要多读书.&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;http://luajit.org/ext_ffi.html&#34;&gt;luaJIT FFI Library&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://cffi.readthedocs.io/en/latest/&#34;&gt;python CFFI&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;python lua都有FFI api调用C语言,基本上都过了一遍,虽然还是不会写C,至少会用大量C库来扩展Python/lua了.&lt;/p&gt;

&lt;h3 id=&#34;机器学习&#34;&gt;机器学习&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://www.bilibili.com/video/av9912938/&#34;&gt;机器学习（Machine Learning）- 吴恩达（Andrew Ng）&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://mooc.study.163.com/smartSpec/detail/1001319001.htm&#34;&gt;深度学习工程师&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;年初就开始做机器学习的准备,在优达学城上了几门统计学/线性代数相关的课程,现在终于开始开始学Andrew Ng的机器学习相关课程.前路漫漫,还需坚持.&lt;/p&gt;

&lt;h3 id=&#34;读书&#34;&gt;读书&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;程序员修炼之道&amp;ndash;从小工到专家&lt;/li&gt;
&lt;li&gt;代码整洁之道&lt;/li&gt;
&lt;li&gt;重构:改善既有代码的设计&lt;/li&gt;
&lt;li&gt;Python数据挖掘入门与实践&lt;/li&gt;
&lt;li&gt;集体智慧编程&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;生活&#34;&gt;生活&lt;/h3&gt;

&lt;p&gt;嗯,在七夕之前脱单了,从此过上没羞没臊的生活(大雾).&lt;/p&gt;</description>
    </item>
    
    <item>
      <title>zerorpc api设计指南</title>
      <link>https://zhu327.github.io/2017/05/08/zerorpc-api%E8%AE%BE%E8%AE%A1%E6%8C%87%E5%8D%97/</link>
      <pubDate>Mon, 08 May 2017 15:19:58 &#43;0800</pubDate>
      
      <guid>https://zhu327.github.io/2017/05/08/zerorpc-api%E8%AE%BE%E8%AE%A1%E6%8C%87%E5%8D%97/</guid>
      <description>&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&#34;http://tailnode.tk/2017/03/google-api-design-guide/contents/&#34;&gt;Google API 设计指南&lt;/a&gt;&lt;br /&gt;
&lt;a href=&#34;https://zhu327.github.io/2017/03/31/%E5%9C%A8django%E4%B8%AD%E4%BD%BF%E7%94%A8zerorpc/&#34;&gt;在Django中使用zerorpc&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;之前实现了在Django环境下使用zerorpc的封装,api的组织单位是function.受到Google API 设计指南的启发,重新设计了一种基于Resources的api组织风格,并且约定Resource的方法名与Django Rest Framework的ViewSets中实现的action名称一致.&lt;/p&gt;

&lt;p&gt;zerorpc默认只能在同一个Server上面注册一个对象,而我们需要注册多个类(一个类表示一Resources),在阅读zerorpc Server的代码后,想到一个简单的方式来注册Resources.&lt;/p&gt;

&lt;p&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;&lt;span class=&#34;kn&#34;&gt;import&lt;/span&gt; &lt;span class=&#34;nn&#34;&gt;zerorpc&lt;/span&gt;

&lt;span class=&#34;n&#34;&gt;_methods&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{}&lt;/span&gt;


&lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;register&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;cls&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;):&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;obj&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;bp&#34;&gt;cls&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;prefix&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;bp&#34;&gt;cls&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;vm&#34;&gt;__name__&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;_methods&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;update&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;({&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;{}:{}&amp;#39;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;format&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;prefix&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;k&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;):&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;getattr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;obj&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;k&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
                     &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;k&lt;/span&gt; &lt;span class=&#34;ow&#34;&gt;in&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;dir&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;obj&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
                     &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;ow&#34;&gt;not&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;k&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;startswith&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;_&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;ow&#34;&gt;and&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;callable&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;getattr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;obj&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;k&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))})&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;bp&#34;&gt;cls&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;vm&#34;&gt;__name__&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&amp;#39;__main__&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
    &lt;span class=&#34;nd&#34;&gt;@register&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;Test&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;object&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;):&lt;/span&gt;
        &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;add&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;x&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;y&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;):&lt;/span&gt;
            &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;x&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;+&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;y&lt;/span&gt;

    &lt;span class=&#34;n&#34;&gt;server&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;zerorpc&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Server&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_methods&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;heartbeat&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;30&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;server&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bind&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;tcp://{0}:{1}&amp;#34;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;format&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;127.0.0.1&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;4242&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;server&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;run&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;通过在方法名前增加类名称前缀在Server的&lt;code&gt;_methods&lt;/code&gt;字典里面增加了&lt;code&gt;Class:method&lt;/code&gt;格式的调用方法.这样就实现了注册多个类到zerorpc Server.&lt;/p&gt;

&lt;h4 id=&#34;约定&#34;&gt;约定&lt;/h4&gt;

&lt;ul&gt;
&lt;li&gt;每个类代表一个Resources&lt;/li&gt;
&lt;li&gt;方法名称&lt;strong&gt;create,list,retrieve,update,destroy&lt;/strong&gt;分别对应于创建,列表,详情,更新,删除操作&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;约定尽量切合DRF已有的风格,不需要暴露的方法以&lt;code&gt;_&lt;/code&gt;开头.&lt;/p&gt;

&lt;h4 id=&#34;调用&#34;&gt;调用&lt;/h4&gt;

&lt;p&gt;还需要改造下Client端,因为默认的Client不能直接使用&lt;code&gt;class:method&lt;/code&gt;的方法名来调用rpc api&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;&lt;span class=&#34;kn&#34;&gt;import&lt;/span&gt; &lt;span class=&#34;nn&#34;&gt;zerorpc&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;Client&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;zerorpc&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Client&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;):&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;fm&#34;&gt;__init__&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;args&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;**&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;kwargs&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;):&lt;/span&gt;
        &lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_prefix&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;kwargs&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pop&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;prefix&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
        &lt;span class=&#34;nb&#34;&gt;super&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Client&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;fm&#34;&gt;__init__&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;args&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;**&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;kwargs&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;

    &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;set_prefix&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;prefix&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;):&lt;/span&gt;
        &lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_prefix&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;prefix&lt;/span&gt;

    &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;fm&#34;&gt;__getattr__&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;method&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;):&lt;/span&gt;
        &lt;span class=&#34;n&#34;&gt;method&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&amp;#39;:&amp;#39;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;join&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;([&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_prefix&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;method&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;])&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_prefix&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;else&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;method&lt;/span&gt;
        &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;lambda&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;args&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;**&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;kargs&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;method&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;args&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;**&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;kargs&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;重写下Client,实例化时添加可选的prefix参数来指定调用的Resources,通过&lt;code&gt;set_prefix&lt;/code&gt;方法来修改调用的Resources.&lt;/p&gt;</description>
    </item>
    
    <item>
      <title>Django 优化杂谈</title>
      <link>https://zhu327.github.io/2017/04/21/django-%E4%BC%98%E5%8C%96%E6%9D%82%E8%B0%88/</link>
      <pubDate>Fri, 21 Apr 2017 11:19:30 &#43;0800</pubDate>
      
      <guid>https://zhu327.github.io/2017/04/21/django-%E4%BC%98%E5%8C%96%E6%9D%82%E8%B0%88/</guid>
      <description>&lt;p&gt;总结下最近看过的一些文章,然后想到的一些优化点,整理一下.&lt;/p&gt;

&lt;h3 id=&#34;数据库连接池&#34;&gt;数据库连接池&lt;/h3&gt;

&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&#34;http://mt.dbanotes.net/arch/instagram.html&#34;&gt;http://mt.dbanotes.net/arch/instagram.html&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Django 默认DB配置提供了选项&lt;code&gt;CONN_MAX_AGE&lt;/code&gt;用于配置在同一个thread/greenlet里面DB connection的最大存活时间,便于连接的复用,在实践中发现如果使用gunicorn+gevent的方式来启动WSGI服务,由于gunicorn会创建一个很大的gevent pool,导致数据库连接数会暴涨.所以这个选项被放弃了,另外的方式是使用connection pool.&lt;/p&gt;

&lt;p&gt;instagram 使用 PostGreSQL 并且使用 Pgbouncer 这个中间件来管理连接池,MySQL也有Proxy这种中间件但是比较重,所以考虑在django mysql backend的基础上自己实现一个连接池.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&#34;https://gist.github.com/zhu327/94c22c7fa9c92cc38e998eab41e77c38&#34;&gt;https://gist.github.com/zhu327/94c22c7fa9c92cc38e998eab41e77c38&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;主要参考了Connector/Python的pool实现.&lt;/p&gt;

&lt;p&gt;数据库连接池也不是&amp;rdquo;银弹&amp;rdquo;,在应用层做数据库连接池也不值得推荐,随着业务的扩展,使用一主多备搭建集群,通过读写分类中间件来做连接池管理,推荐&lt;a href=&#34;https://github.com/sysown/proxysql&#34;&gt;ProxySQL&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;/p&gt;

&lt;h3 id=&#34;缓存一切&#34;&gt;缓存一切&lt;/h3&gt;

&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&#34;https://mozillazg.github.io/2015/09/high-performance-django-note-1.html&#34;&gt;https://mozillazg.github.io/2015/09/high-performance-django-note-1.html&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;从服务器的角度来看,我们可以用Nginx cache/Varnish来缓存响应.这里我们只讨论django cache framework.&lt;/p&gt;

&lt;p&gt;我们的系统中使用redis作为缓存服务器,使用redis-py与django-redis作为cache backend.&lt;/p&gt;

&lt;p&gt;redis-py是纯python实现的,查看了文档后发现它也支持使用一个C客户端的python绑定,只需要安装&lt;a href=&#34;https://github.com/redis/hiredis-py&#34;&gt;hiredis-py&lt;/a&gt;即可使用C解析器提升redis性能.&lt;/p&gt;

&lt;p&gt;redis-py是自带connection pool支持的,默认使用&lt;code&gt;redis.connection.ConnectionPool&lt;/code&gt;,连接数较多的情况下可能导致连接不够用抛出异常,可以考虑用&lt;code&gt;redis.connection.BlockingConnectionPool&lt;/code&gt;替换,无连接可用时阻塞.&lt;/p&gt;

&lt;h4 id=&#34;session&#34;&gt;Session&lt;/h4&gt;

&lt;p&gt;Django 默认的 Session Engine 用的是数据库,因为Session中间件的缘故,每个请求进来都会首先访问Session表.我们可以用缓存来替代这个数据库访问的过程,推荐配置&lt;code&gt;SESSION_ENGINE = &#39;django.contrib.sessions.backends.cached_db&#39;&lt;/code&gt;即用了缓存,又保存到db保证数据不丢失.&lt;/p&gt;

&lt;p&gt;Django 的 session 表在一段时间以后会数据会变得很大,需要定时执行&lt;code&gt;python manage.py clearsessions&lt;/code&gt;来清理过期session.&lt;/p&gt;

&lt;h4 id=&#34;缓存model&#34;&gt;缓存Model&lt;/h4&gt;

&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/rosarior/awesome-django&#34;&gt;https://github.com/rosarior/awesome-django&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;awesome-django有一些用户缓存的工具,翻过一些文档后决定引入&lt;a href=&#34;https://github.com/django-cache-machine/django-cache-machine&#34;&gt;django-cache-machine&lt;/a&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;访问频繁读多写少的Model要缓存&lt;/li&gt;
&lt;li&gt;写多读少的Model酌情缓存(写的时候更新缓存开销大)&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;日志&#34;&gt;日志&lt;/h3&gt;

&lt;p&gt;Python的日志是同步的,所以如果直接把日志写入文件,也会有文件系统I/O的开销,更快的方式是把日志记录到&lt;code&gt;sys.stderr&lt;/code&gt;或&lt;code&gt;sys.stdout&lt;/code&gt;,然后用gunicorn把标准输出的日志重定向到文件.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# 日志配置&lt;/span&gt;
&lt;span class=&#34;kn&#34;&gt;import&lt;/span&gt; &lt;span class=&#34;nn&#34;&gt;logging&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nn&#34;&gt;logging.config&lt;/span&gt;
&lt;span class=&#34;kn&#34;&gt;import&lt;/span&gt; &lt;span class=&#34;nn&#34;&gt;sys&lt;/span&gt;

&lt;span class=&#34;n&#34;&gt;LOGGING&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;s1&#34;&gt;&amp;#39;version&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
    &lt;span class=&#34;s1&#34;&gt;&amp;#39;handlers&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
        &lt;span class=&#34;s1&#34;&gt;&amp;#39;console&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
            &lt;span class=&#34;s1&#34;&gt;&amp;#39;class&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&amp;#39;logging.StreamHandler&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
            &lt;span class=&#34;s1&#34;&gt;&amp;#39;stream&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;sys&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;stdout&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
        &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
    &lt;span class=&#34;p&#34;&gt;},&lt;/span&gt;
    &lt;span class=&#34;s1&#34;&gt;&amp;#39;root&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
        &lt;span class=&#34;s1&#34;&gt;&amp;#39;handlers&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;console&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;],&lt;/span&gt;
        &lt;span class=&#34;s1&#34;&gt;&amp;#39;level&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&amp;#39;INFO&amp;#39;&lt;/span&gt;
    &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;gunicorn选项:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&#34;http://docs.gunicorn.org/en/stable/settings.html#capture-output&#34;&gt;http://docs.gunicorn.org/en/stable/settings.html#capture-output&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&#34;celery&#34;&gt;Celery&lt;/h3&gt;

&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&#34;http://docs.jinkan.org/docs/celery/userguide/optimizing.html&#34;&gt;http://docs.jinkan.org/docs/celery/userguide/optimizing.html&lt;/a&gt;
&lt;a href=&#34;https://blog.balthazar-rouberol.com/celery-best-practices&#34;&gt;https://blog.balthazar-rouberol.com/celery-best-practices&lt;/a&gt;
&lt;a href=&#34;http://orangleliu.info/2014/08/09/celery-best-practice/&#34;&gt;http://orangleliu.info/2014/08/09/celery-best-practice/&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;安装 librabbitmq 提升amqp访问速度,路由长任务与短任务到不同的Queue,并配置不同的预取策略.使用&lt;a href=&#34;https://github.com/msgpack/msgpack-python&#34;&gt;msgpack&lt;/a&gt;来序列化消息,性能优于json.&lt;/p&gt;

&lt;h3 id=&#34;gevent-与-mysqldb&#34;&gt;gevent 与 MySQLdb&lt;/h3&gt;

&lt;p&gt;因为redis最够快,所以在gunicorn+gevent的服务器下使用redis C客户端绑定也没什么问题,但是MySQL就不一样了,为了让MySQLdb也能在gevent/greenlet下切换引入Douban的greenify库.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/douban/greenify&#34;&gt;https://github.com/douban/greenify&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;</description>
    </item>
    
  </channel>
</rss>
