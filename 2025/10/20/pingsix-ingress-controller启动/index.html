<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      pingsix-ingress-controllerå¯åŠ¨ &middot; è·¬æ­¥
    
  </title>

  
  <link rel="stylesheet" href="https://zhu327.github.io/css/poole.css">
  <link rel="stylesheet" href="https://zhu327.github.io/css/syntax.css">
  <link rel="stylesheet" href="https://zhu327.github.io/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://zhu327.github.io/assets/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="https://zhu327.github.io/assets/favicon.ico">

  
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://zhu327.github.io/feed.xml">
</head>


  <body class="theme-base-0d">

    
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>My notes and thoughts.</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="https://zhu327.github.io/">Home</a>
    <a class="sidebar-nav-item " href="https://zhu327.github.io/post">Posts</a>
    <a class="sidebar-nav-item " href="https://zhu327.github.io/tags">Tags</a>

    
        <a class="sidebar-nav-item " href="https://zhu327.github.io/about/">About</a>

    <a class="sidebar-nav-item" href="https://github.com/zhu327" target="_blank">GitHub</a>
  </nav>

  <div class="sidebar-item">
    <p>&copy; 2025. All rights reserved.</p>
  </div>
</div>


    
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="https://zhu327.github.io/" title="Home">è·¬æ­¥</a>
            <small>On Coding</small>
          </h3>
        </div>
      </div>

      <div class="container content">


<div class="post">
  <h1 class="post-title">pingsix-ingress-controllerå¯åŠ¨</h1>
  <span class="post-date">Oct 20 2025</span>
  <blockquote>
<p><a href="https://github.com/zhu327/pingsix">https://github.com/zhu327/pingsix</a></p>
</blockquote>

<p>PingSIX è‡ªä»ä¸Šæ¬¡é‡æ„ä¹‹å, æˆ‘ä¸€ç›´åœ¨è€ƒè™‘å¦‚ä½•æ‰©å±•è¿™ä¸ªé¡¹ç›®çš„åŠŸèƒ½ä¸ä½¿ç”¨åœºæ™¯, æœ‰2ä¸ªæ–¹å‘å¯ä»¥è€ƒè™‘:</p>

<ol>
<li>æ”¯æŒproxy-wasmæ’ä»¶</li>
<li>å®ç°pingsix-ingress-controller</li>
</ol>

<p>åœ¨è°ƒç ”äº†proxy-wasmçš„ç›¸å…³åŠŸèƒ½å, ç»“è®ºæ˜¯ç”±äºpingoraé¢å‘çš„åœºæ™¯æ˜¯CDNçš„åå‘ä»£ç†, æ‰€ä»¥æ²¡æœ‰è€ƒè™‘è¿‡æ–¹ä¾¿çš„ä¿®æ”¹è¯·æ±‚ä½“ä¸å“åº”ä½“, è¿™å°±é€ æˆå¾ˆéš¾åŸºäºpingoraæ¥å®ç°proxy-wasmçš„ABI, å¦‚æœæˆ‘è¦è‡ªå·±å®šä¹‰ä¸€ä¸ªwasmçš„æ¥å£åè®®, æ²¡æ³•å¤ç”¨ç¤¾åŒºç°æœ‰çš„proxy-wasmæ’ä»¶, é‚£å°±æ²¡å¿…è¦äº†, ä¸å¦‚ç›´æ¥å†™Rustçš„æ’ä»¶. ç›¸å…³å‚è€ƒå†…å®¹:</p>

<ul>
<li><a href="https://github.com/cloudflare/pingora/issues/17">proxy-wasm support</a></li>
<li><a href="https://segmentfault.com/a/1190000045232953">pingora èƒ½åšä»€ä¹ˆå’Œä¸èƒ½åšä»€ä¹ˆ</a></li>
</ul>

<p>åœ¨æ”¾å¼ƒäº†proxy-wasmçš„æ”¯æŒå, æˆ‘å¼€å§‹è°ƒç ”å¦‚ä½•å®ç°pingsix-ingress-controller, ç”±äºpingsixçš„çš„èµ„æºå®šä¹‰æ˜¯å‚è€ƒapisixæ¥å®ç°çš„, æ‰€ä»¥å°±ç›´æ¥å‚è€ƒ<a href="https://github.com/apache/apisix-ingress-controller">apisix-ingress-controller</a>æ¥å®ç°æˆ‘ä»¬è‡ªå·±çš„<a href="https://github.com/zhu327/pingsix-ingress-controller">pingsix-ingress-controller</a>.</p>

<p></p>

<h3 id="1-apisix-ingress-controlleræ¶æ„">1. apisix-ingress-controlleræ¶æ„</h3>

<p><img src="https://github.com/user-attachments/assets/1ecf116a-378f-4357-a597-5bafb56991fd" alt="Image1" width="700px" /></p>

<h4 id="1-k8s-resources-watch-layer-èµ„æºç›‘å¬å±‚">1. K8s Resources Watch Layer (èµ„æºç›‘å¬å±‚)</h4>

<ul>
<li>å„ç§Controlleré€šè¿‡Kubernetesçš„Watchæœºåˆ¶ç›‘å¬å¯¹åº”çš„èµ„æºå˜åŒ–</li>
<li>æ”¯æŒçš„èµ„æºç±»å‹åŒ…æ‹¬ï¼š

<ul>
<li>Gateway API: HTTPRoute, Gateway, GRPCRoute, TCPRoute, UDPRoute, TLSRoute</li>
<li>KubernetesåŸç”Ÿ: Ingress, IngressClass</li>
<li>APISIX CRD: ApisixRoute, ApisixGlobalRule, ApisixTls, ApisixConsumer, ApisixUpstream</li>
<li>è‡ªå®šä¹‰: Consumer, GatewayProxy</li>
</ul></li>
</ul>

<h4 id="2-provider-layer-æä¾›è€…å±‚">2. Provider Layer (æä¾›è€…å±‚)</h4>

<ul>
<li>Provideræ¥æ”¶Controllerçš„Update/Deleteè¯·æ±‚</li>
<li>TranslateContextæ”¶é›†æ‰€æœ‰ä¾èµ–èµ„æºï¼ˆServices, Secrets, EndpointSlicesç­‰ï¼‰</li>
<li>ä¸ºTranslatoræä¾›å®Œæ•´çš„ä¸Šä¸‹æ–‡ä¿¡æ¯</li>
</ul>

<h4 id="3-translator-layer-ç¿»è¯‘å±‚">3. Translator Layer (ç¿»è¯‘å±‚)</h4>

<ul>
<li>å°†K8sèµ„æºç¿»è¯‘æˆADCèµ„æºæè¿°</li>
<li>æ¯ç§èµ„æºç±»å‹éƒ½æœ‰å¯¹åº”çš„Translatoræ–¹æ³•</li>
<li>è¾“å‡ºTranslateResultï¼ŒåŒ…å«ï¼š

<ul>
<li>Services (è·¯ç”±è§„åˆ™)</li>
<li>SSL/TLS (è¯ä¹¦)</li>
<li>Consumers (æ¶ˆè´¹è€…)</li>
<li>GlobalRules (å…¨å±€è§„åˆ™)</li>
<li>PluginMetadata (æ’ä»¶å…ƒæ•°æ®)</li>
</ul></li>
</ul>

<h4 id="4-adc-client-layer-adcå®¢æˆ·ç«¯å±‚">4. ADC Client Layer (ADCå®¢æˆ·ç«¯å±‚)</h4>

<ul>
<li><strong>ConfigManager</strong>: ç®¡ç†å¤šä¸ªGatewayProxyçš„é…ç½®</li>
<li><strong>Store/MemDB</strong>: å†…å­˜æ•°æ®åº“ï¼Œå­˜å‚¨ADCèµ„æºçŠ¶æ€</li>
<li><strong>StoreDelta</strong>: å¯¹æ¯”æ–°æ—§é…ç½®ï¼Œè®¡ç®—å·®å¼‚</li>
<li>å°†å˜æ›´ä»»åŠ¡ä¼ é€’ç»™Executoræ‰§è¡Œ</li>
</ul>

<h4 id="5-adc-executor-interface-æ‰§è¡Œå™¨æ¥å£">5. ADC Executor Interface (æ‰§è¡Œå™¨æ¥å£)</h4>

<p>ADC Executoræä¾›ç»Ÿä¸€çš„Executeæ¥å£ï¼Œæ”¯æŒä¸‰ç§å®ç°ï¼š</p>

<ul>
<li><strong>HTTPADCExecutor</strong>: é€šè¿‡HTTPè°ƒç”¨ADC Serverï¼ˆæ¨èæ–¹å¼ï¼‰</li>
<li><strong>DefaultADCExecutor</strong>: é€šè¿‡å‘½ä»¤è¡Œè°ƒç”¨adcå‘½ä»¤</li>
</ul>

<h4 id="6-adc-http-server-adc-httpæœåŠ¡å™¨">6. ADC HTTP Server (ADC HTTPæœåŠ¡å™¨)</h4>

<p>ADC HTTP Serverçš„æ ¸å¿ƒæµç¨‹ï¼š</p>

<ol>
<li>æ¥æ”¶<code>/sync</code>ç«¯ç‚¹çš„PUTè¯·æ±‚</li>
<li>è§£æADCServerRequestï¼ˆåŒ…å«optså’Œconfigï¼‰</li>
<li>æ ¹æ®label-selectorä»APISIXæ‹‰å–ç°æœ‰èµ„æº</li>
<li>å°†ADCèµ„æºæè¿°è½¬æ¢ä¸ºAPISIXèµ„æºæ ¼å¼</li>
<li>å¯¹æ¯”å·²æ‹‰å–çš„èµ„æºï¼Œè®¡ç®—å·®å¼‚ï¼ˆDiffï¼‰</li>
<li>è°ƒç”¨APISIX Admin APIæ‰§è¡Œåˆ›å»º/æ›´æ–°/åˆ é™¤æ“ä½œ</li>
<li>è¿”å›SyncResultï¼ˆåŒ…å«æˆåŠŸ/å¤±è´¥çŠ¶æ€ï¼‰</li>
</ol>

<h4 id="7-apisix-data-plane-apisixæ•°æ®å¹³é¢">7. APISIX Data Plane (APISIXæ•°æ®å¹³é¢)</h4>

<p>æœ€ç»ˆåœ¨APISIXä¸­åˆ›å»º/æ›´æ–°/åˆ é™¤çš„èµ„æºï¼š</p>

<ul>
<li>Routes (è·¯ç”±)</li>
<li>Services (æœåŠ¡)</li>
<li>Upstreams (ä¸Šæ¸¸)</li>
<li>SSL/TLS (è¯ä¹¦)</li>
<li>Consumers (æ¶ˆè´¹è€…)</li>
<li>Global Rules (å…¨å±€è§„åˆ™)</li>
<li>Plugin Metadata (æ’ä»¶å…ƒæ•°æ®)</li>
</ul>

<h4 id="8-æ ¸å¿ƒç‰¹æ€§">8. æ ¸å¿ƒç‰¹æ€§</h4>

<ol>
<li><strong>å¤šGatewayProxyæ”¯æŒ</strong>: é€šè¿‡ConfigManagerç®¡ç†å¤šä¸ªAPISIXå®ä¾‹çš„é…ç½®</li>
<li><strong>Label Selector</strong>: æ”¯æŒé€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨è¿‡æ»¤èµ„æº</li>
<li><strong>å¢é‡åŒæ­¥</strong>: é€šè¿‡MemDBå¯¹æ¯”å·®å¼‚ï¼ŒåªåŒæ­¥å˜æ›´çš„èµ„æº</li>
<li><strong>é”™è¯¯å¤„ç†</strong>: å®Œå–„çš„é”™è¯¯æ”¶é›†å’ŒçŠ¶æ€æ›´æ–°æœºåˆ¶</li>
<li><strong>çµæ´»çš„æ‰§è¡Œæ–¹å¼</strong>: æ”¯æŒHTTPã€å‘½ä»¤è¡Œå¤šç§æ‰§è¡Œæ¨¡å¼</li>
<li><strong>èµ„æºéš”ç¦»</strong>: é€šè¿‡labelå®ç°ä¸åŒèµ„æºçš„éš”ç¦»å’Œç®¡ç†</li>
</ol>

<h3 id="2-apisix-ingress-controllerçš„ç»éªŒ">2. apisix-ingress-controllerçš„ç»éªŒ</h3>

<p>è™½ç„¶ä»¥å‰ä¹Ÿå†™è¿‡ä¸€äº›operatorçš„ä»£ç , ä½†æ˜¯åœ¨å­¦ä¹ apisix-ingress-controllerä»£ç çš„è¿‡ç¨‹ä¸­, æˆ‘è¿˜æ˜¯å­¦åˆ°äº†ä¸€äº›æ–°çš„ä¸œè¥¿, åœ¨controller watchä¸€ç±»èµ„æºçš„æ—¶å€™, æˆ‘ä»¬å¯ä»¥watchæ‰€æœ‰å…³è”çš„èµ„æºç±»å‹, ä¸€æ—¦è¿™äº›å…³è”çš„èµ„æºç±»å‹æœ‰å˜æ›´, å°±å¯ä»¥è¿›å…¥ç»Ÿä¸€çš„å˜æ›´æµç¨‹, è¿™æ ·å°±å‡å°‘äº†æˆ‘ä»¬å†™controllerçš„é€»è¾‘å¤æ‚åº¦, æ‰€æœ‰çš„å…³è”èµ„æºçš„å˜æ›´éƒ½ä¼šè§¦å‘ä¸»èµ„æºçš„æ›´æ–°.</p>
<div class="highlight"><pre class="chroma"><code class="language-golang" data-lang="golang"><span class="c1">// SetupWithManager sets up the controller with the Manager.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">IngressReconciler</span><span class="p">)</span> <span class="nx">SetupWithManager</span><span class="p">(</span><span class="nx">mgr</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Manager</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">r</span><span class="p">.</span><span class="nx">genericEvent</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">event</span><span class="p">.</span><span class="nx">GenericEvent</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

	<span class="k">return</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">NewControllerManagedBy</span><span class="p">(</span><span class="nx">mgr</span><span class="p">).</span>
		<span class="nx">For</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">networkingv1</span><span class="p">.</span><span class="nx">Ingress</span><span class="p">{},</span>
			<span class="nx">builder</span><span class="p">.</span><span class="nx">WithPredicates</span><span class="p">(</span>
				<span class="nx">MatchesIngressClassPredicate</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">Client</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Log</span><span class="p">),</span>
			<span class="p">),</span>
		<span class="p">).</span>
		<span class="nx">WithEventFilter</span><span class="p">(</span>
			<span class="nx">predicate</span><span class="p">.</span><span class="nx">Or</span><span class="p">(</span>
				<span class="nx">predicate</span><span class="p">.</span><span class="nx">GenerationChangedPredicate</span><span class="p">{},</span>
				<span class="nx">predicate</span><span class="p">.</span><span class="nx">AnnotationChangedPredicate</span><span class="p">{},</span>
				<span class="nx">predicate</span><span class="p">.</span><span class="nx">NewPredicateFuncs</span><span class="p">(</span><span class="nx">TypePredicate</span><span class="p">[</span><span class="o">*</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">Secret</span><span class="p">]()),</span>
			<span class="p">),</span>
		<span class="p">).</span>
		<span class="nx">Watches</span><span class="p">(</span>
			<span class="o">&amp;</span><span class="nx">networkingv1</span><span class="p">.</span><span class="nx">IngressClass</span><span class="p">{},</span>
			<span class="nx">handler</span><span class="p">.</span><span class="nx">EnqueueRequestsFromMapFunc</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">listIngressForIngressClass</span><span class="p">),</span>
			<span class="nx">builder</span><span class="p">.</span><span class="nx">WithPredicates</span><span class="p">(</span>
				<span class="nx">predicate</span><span class="p">.</span><span class="nx">NewPredicateFuncs</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">matchesIngressController</span><span class="p">),</span>
			<span class="p">),</span>
		<span class="p">).</span>
		<span class="nx">Watches</span><span class="p">(</span>
			<span class="o">&amp;</span><span class="nx">discoveryv1</span><span class="p">.</span><span class="nx">EndpointSlice</span><span class="p">{},</span>
			<span class="nx">handler</span><span class="p">.</span><span class="nx">EnqueueRequestsFromMapFunc</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">listIngressesByService</span><span class="p">),</span>
		<span class="p">).</span>
		<span class="nx">Watches</span><span class="p">(</span>
			<span class="o">&amp;</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">Secret</span><span class="p">{},</span>
			<span class="nx">handler</span><span class="p">.</span><span class="nx">EnqueueRequestsFromMapFunc</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">listIngressesBySecret</span><span class="p">),</span>
		<span class="p">).</span>
		<span class="nx">Watches</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">v1alpha1</span><span class="p">.</span><span class="nx">BackendTrafficPolicy</span><span class="p">{},</span>
			<span class="nx">handler</span><span class="p">.</span><span class="nx">EnqueueRequestsFromMapFunc</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">listIngressForBackendTrafficPolicy</span><span class="p">),</span>
			<span class="nx">builder</span><span class="p">.</span><span class="nx">WithPredicates</span><span class="p">(</span>
				<span class="nx">BackendTrafficPolicyPredicateFunc</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">genericEvent</span><span class="p">),</span>
			<span class="p">),</span>
		<span class="p">).</span>
		<span class="nx">Watches</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">v1alpha1</span><span class="p">.</span><span class="nx">HTTPRoutePolicy</span><span class="p">{},</span>
			<span class="nx">handler</span><span class="p">.</span><span class="nx">EnqueueRequestsFromMapFunc</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">listIngressesByHTTPRoutePolicy</span><span class="p">),</span>
			<span class="nx">builder</span><span class="p">.</span><span class="nx">WithPredicates</span><span class="p">(</span><span class="nx">httpRoutePolicyPredicateFuncs</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">genericEvent</span><span class="p">)),</span>
		<span class="p">).</span>
		<span class="nx">Watches</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">v1alpha1</span><span class="p">.</span><span class="nx">GatewayProxy</span><span class="p">{},</span>
			<span class="nx">handler</span><span class="p">.</span><span class="nx">EnqueueRequestsFromMapFunc</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">listIngressesForGatewayProxy</span><span class="p">),</span>
		<span class="p">).</span>
		<span class="nx">WatchesRawSource</span><span class="p">(</span>
			<span class="nx">source</span><span class="p">.</span><span class="nx">Channel</span><span class="p">(</span>
				<span class="nx">r</span><span class="p">.</span><span class="nx">genericEvent</span><span class="p">,</span>
				<span class="nx">handler</span><span class="p">.</span><span class="nx">EnqueueRequestsFromMapFunc</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">listIngressForGenericEvent</span><span class="p">),</span>
			<span class="p">),</span>
		<span class="p">).</span>
		<span class="nx">Complete</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
<span class="p">}</span></code></pre></div>
<p>IngressReconciler Watch äº‹ä»¶è¯¦è§£</p>

<p>æ ¹æ®ä»£ç åˆ†æï¼Œ<code>IngressReconciler</code> åœ¨ <code>SetupWithManager</code> æ–¹æ³•ä¸­é…ç½®äº†å¤šä¸ª watch äº‹ä»¶ã€‚è®©æˆ‘ä¸ºæ‚¨è¯¦ç»†è§£é‡Šæ¯ä¸ªäº‹ä»¶çš„ä½œç”¨å’Œé€»è¾‘ï¼š</p>

<h4 id="1-ä¸»èµ„æº-watch-ingress-ç¬¬70-81è¡Œ">1. <strong>ä¸»èµ„æº Watch - Ingress</strong> (ç¬¬70-81è¡Œ)</h4>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">For</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">networkingv1</span><span class="p">.</span><span class="nx">Ingress</span><span class="p">{},</span> <span class="nx">builder</span><span class="p">.</span><span class="nx">WithPredicates</span><span class="p">(</span>
    <span class="nx">MatchesIngressClassPredicate</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">Client</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Log</span><span class="p">),</span>
<span class="p">))</span></code></pre></div>
<p><strong>ä½œç”¨</strong>ï¼šç›‘å¬ Ingress èµ„æºæœ¬èº«çš„å˜åŒ–</p>

<p><strong>Predicatesï¼ˆè¿‡æ»¤æ¡ä»¶ï¼‰</strong>ï¼š</p>

<ul>
<li><code>MatchesIngressClassPredicate</code>: åªå¤„ç†ç”±å½“å‰æ§åˆ¶å™¨ç®¡ç†çš„ IngressClass çš„ Ingress</li>
<li><code>GenerationChangedPredicate</code>: èµ„æºçš„ Generation å‘ç”Ÿå˜åŒ–ï¼ˆspec ä¿®æ”¹ï¼‰</li>
<li><code>AnnotationChangedPredicate</code>: æ³¨è§£å‘ç”Ÿå˜åŒ–</li>
<li><code>TypePredicate[*corev1.Secret]()</code>: ç”¨äº Secret ç±»å‹åˆ¤æ–­</li>
</ul>

<p><strong>é€»è¾‘</strong>ï¼šè¿™æ˜¯ä¸»è¦çš„ç›‘å¬å¯¹è±¡ï¼Œå½“ Ingress çš„è§„æ ¼æˆ–æ³¨è§£å˜åŒ–æ—¶è§¦å‘ Reconcile</p>

<h4 id="2-ingressclass-watch-ç¬¬82-88è¡Œ">2. <strong>IngressClass Watch</strong> (ç¬¬82-88è¡Œ)</h4>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">Watches</span><span class="p">(</span>
    <span class="o">&amp;</span><span class="nx">networkingv1</span><span class="p">.</span><span class="nx">IngressClass</span><span class="p">{},</span>
    <span class="nx">handler</span><span class="p">.</span><span class="nx">EnqueueRequestsFromMapFunc</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">listIngressForIngressClass</span><span class="p">),</span>
    <span class="nx">builder</span><span class="p">.</span><span class="nx">WithPredicates</span><span class="p">(</span>
        <span class="nx">predicate</span><span class="p">.</span><span class="nx">NewPredicateFuncs</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">matchesIngressController</span><span class="p">),</span>
    <span class="p">),</span>
<span class="p">)</span></code></pre></div>
<p><strong>ä½œç”¨</strong>ï¼šç›‘å¬ IngressClass èµ„æºçš„å˜åŒ–</p>

<p><strong>è§¦å‘æ¡ä»¶</strong>ï¼š</p>

<ul>
<li><code>matchesIngressController</code>: åªç›‘å¬ç”±å½“å‰æ§åˆ¶å™¨ç®¡ç†çš„ IngressClassï¼ˆé€šè¿‡ <code>spec.controller</code> å­—æ®µåŒ¹é…ï¼‰</li>
</ul>

<p><strong>é€»è¾‘</strong> (<code>listIngressForIngressClass</code>)ï¼š</p>

<ol>
<li>æ£€æŸ¥ IngressClass æ˜¯å¦æ˜¯é»˜è®¤ç±»ï¼ˆé€šè¿‡æ³¨è§£ <code>ingressclass.kubernetes.io/is-default-class</code>ï¼‰</li>
<li>å¦‚æœæ˜¯é»˜è®¤ç±»ï¼šåˆ—å‡ºæ‰€æœ‰æœªæŒ‡å®š IngressClassName æˆ–æŒ‡å®šä¸ºè¯¥ç±»çš„ Ingress</li>
<li>å¦‚æœä¸æ˜¯é»˜è®¤ç±»ï¼šé€šè¿‡ç´¢å¼•æŸ¥æ‰¾ä½¿ç”¨è¯¥ IngressClass çš„æ‰€æœ‰ Ingress</li>
<li>è¿”å›éœ€è¦ reconcile çš„ Ingress åˆ—è¡¨</li>
</ol>

<p><strong>ä½¿ç”¨åœºæ™¯</strong>ï¼šå½“ IngressClass çš„é…ç½®å˜åŒ–æ—¶ï¼Œéœ€è¦é‡æ–°å¤„ç†æ‰€æœ‰ä½¿ç”¨è¯¥ç±»çš„ Ingress</p>

<h4 id="3-endpointslice-watch-ç¬¬89-92è¡Œ">3. <strong>EndpointSlice Watch</strong> (ç¬¬89-92è¡Œ)</h4>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">Watches</span><span class="p">(</span>
    <span class="o">&amp;</span><span class="nx">discoveryv1</span><span class="p">.</span><span class="nx">EndpointSlice</span><span class="p">{},</span>
    <span class="nx">handler</span><span class="p">.</span><span class="nx">EnqueueRequestsFromMapFunc</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">listIngressesByService</span><span class="p">),</span>
<span class="p">)</span></code></pre></div>
<p><strong>ä½œç”¨</strong>ï¼šç›‘å¬åç«¯æœåŠ¡çš„ Endpoint å˜åŒ–</p>

<p><strong>é€»è¾‘</strong> (<code>listIngressesByService</code>)ï¼š</p>

<ol>
<li>ä» EndpointSlice çš„ label ä¸­æå– Service åç§°ï¼ˆ<code>discovery.k8s.io/service-name</code>ï¼‰</li>
<li>é€šè¿‡ç´¢å¼• <code>ServiceIndexRef</code> æŸ¥æ‰¾å¼•ç”¨è¯¥ Service çš„æ‰€æœ‰ Ingress</li>
<li>è¿‡æ»¤å‡ºç”±å½“å‰æ§åˆ¶å™¨ç®¡ç†çš„ Ingress</li>
<li>è¿”å›éœ€è¦ reconcile çš„ Ingress åˆ—è¡¨</li>
</ol>

<p><strong>ä½¿ç”¨åœºæ™¯</strong>ï¼šå½“åç«¯ Pod çš„ IP åœ°å€å˜åŒ–ï¼ˆæ‰©ç¼©å®¹ã€é‡å¯ç­‰ï¼‰æ—¶ï¼Œéœ€è¦æ›´æ–° APISIX çš„ upstream é…ç½®</p>

<h4 id="4-secret-watch-ç¬¬93-96è¡Œ">4. <strong>Secret Watch</strong> (ç¬¬93-96è¡Œ)</h4>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">Watches</span><span class="p">(</span>
    <span class="o">&amp;</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">Secret</span><span class="p">{},</span>
    <span class="nx">handler</span><span class="p">.</span><span class="nx">EnqueueRequestsFromMapFunc</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">listIngressesBySecret</span><span class="p">),</span>
<span class="p">)</span></code></pre></div>
<p><strong>ä½œç”¨</strong>ï¼šç›‘å¬ TLS è¯ä¹¦ Secret çš„å˜åŒ–</p>

<p><strong>é€»è¾‘</strong> (<code>listIngressesBySecret</code>)ï¼š</p>

<ol>
<li>é€šè¿‡ç´¢å¼• <code>SecretIndexRef</code> æŸ¥æ‰¾ç›´æ¥å¼•ç”¨è¯¥ Secret çš„ Ingressï¼ˆTLS é…ç½®ï¼‰</li>
<li>æŸ¥æ‰¾å¼•ç”¨è¯¥ Secret çš„ GatewayProxyï¼ˆç”¨äº provider è®¤è¯ï¼‰</li>
<li>å¦‚æœ GatewayProxy å¼•ç”¨äº†è¯¥ Secretï¼Œæ‰¾åˆ°ä½¿ç”¨è¯¥ GatewayProxy çš„ IngressClass</li>
<li>å†æ‰¾åˆ°ä½¿ç”¨è¿™äº› IngressClass çš„æ‰€æœ‰ Ingress</li>
<li>å»é‡åè¿”å›æ‰€æœ‰éœ€è¦ reconcile çš„ Ingress</li>
</ol>

<p><strong>ä½¿ç”¨åœºæ™¯</strong>ï¼š</p>

<ul>
<li>TLS è¯ä¹¦æ›´æ–°æˆ–è½®æ¢</li>
<li>GatewayProxy çš„ AdminKey Secret å˜åŒ–</li>
</ul>

<h4 id="5-backendtrafficpolicy-watch-ç¬¬97-102è¡Œ">5. <strong>BackendTrafficPolicy Watch</strong> (ç¬¬97-102è¡Œ)</h4>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">Watches</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">v1alpha1</span><span class="p">.</span><span class="nx">BackendTrafficPolicy</span><span class="p">{},</span>
    <span class="nx">handler</span><span class="p">.</span><span class="nx">EnqueueRequestsFromMapFunc</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">listIngressForBackendTrafficPolicy</span><span class="p">),</span>
    <span class="nx">builder</span><span class="p">.</span><span class="nx">WithPredicates</span><span class="p">(</span>
        <span class="nx">BackendTrafficPolicyPredicateFunc</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">genericEvent</span><span class="p">),</span>
    <span class="p">),</span>
<span class="p">)</span></code></pre></div>
<p><strong>ä½œç”¨</strong>ï¼šç›‘å¬åç«¯æµé‡ç­–ç•¥çš„å˜åŒ–</p>

<p><strong>Predicates é€»è¾‘</strong>ï¼š</p>

<ul>
<li><strong>Create</strong>: è¿”å› trueï¼Œæ–°å»ºæ—¶è§¦å‘</li>
<li><strong>Delete</strong>: è¿”å› trueï¼Œåˆ é™¤æ—¶è§¦å‘</li>
<li><strong>Update</strong>: æ£€æµ‹ <code>targetRefs</code> çš„å˜åŒ–

<ul>
<li>æ‰¾å‡ºè¢«ç§»é™¤çš„ targetRefs</li>
<li>å°†åŒ…å«è¢«ç§»é™¤ targetRefs çš„æ—§å¯¹è±¡å‘é€åˆ° genericEvent channel</li>
<li>è¿™æ ·å¯ä»¥æ¸…ç†ä¸å†è¢«å¼•ç”¨çš„èµ„æº</li>
</ul></li>
</ul>

<p><strong>é€»è¾‘</strong> (<code>listIngressForBackendTrafficPolicy</code>)ï¼š</p>

<ol>
<li>éå† Policy çš„æ‰€æœ‰ <code>targetRefs</code>ï¼ˆå¼•ç”¨çš„ Serviceï¼‰</li>
<li>é€šè¿‡ç´¢å¼•æŸ¥æ‰¾ä½¿ç”¨è¿™äº› Service çš„ Ingress</li>
<li>å»é‡åè¿”å›éœ€è¦ reconcile çš„ Ingress åˆ—è¡¨</li>
</ol>

<p><strong>ä½¿ç”¨åœºæ™¯</strong>ï¼šé…ç½®åç«¯æµé‡ç­–ç•¥ï¼ˆå¦‚è´Ÿè½½å‡è¡¡ç®—æ³•ã€å¥åº·æ£€æŸ¥ç­‰ï¼‰</p>

<h4 id="6-httproutepolicy-watch-ç¬¬103-106è¡Œ">6. <strong>HTTPRoutePolicy Watch</strong> (ç¬¬103-106è¡Œ)</h4>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">Watches</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">v1alpha1</span><span class="p">.</span><span class="nx">HTTPRoutePolicy</span><span class="p">{},</span>
    <span class="nx">handler</span><span class="p">.</span><span class="nx">EnqueueRequestsFromMapFunc</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">listIngressesByHTTPRoutePolicy</span><span class="p">),</span>
    <span class="nx">builder</span><span class="p">.</span><span class="nx">WithPredicates</span><span class="p">(</span><span class="nx">httpRoutePolicyPredicateFuncs</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">genericEvent</span><span class="p">)),</span>
<span class="p">)</span></code></pre></div>
<p><strong>ä½œç”¨</strong>ï¼šç›‘å¬ HTTP è·¯ç”±ç­–ç•¥çš„å˜åŒ–</p>

<p><strong>Predicates é€»è¾‘</strong>ï¼š</p>

<ul>
<li><strong>Create/Delete</strong>: è¿”å› true</li>
<li><strong>Update</strong>: æ£€æµ‹ <code>targetRefs</code> çš„å˜åŒ–

<ul>
<li>æ‰¾å‡ºè¢«ç§»é™¤çš„ targetRefs</li>
<li>å°†åŒ…å«è¢«ç§»é™¤ targetRefs çš„æ—§å¯¹è±¡å‘é€åˆ° genericEvent channel</li>
</ul></li>
</ul>

<p><strong>é€»è¾‘</strong> (<code>listIngressesByHTTPRoutePolicy</code>)ï¼š</p>

<ol>
<li>éå† Policy çš„æ‰€æœ‰ <code>targetRefs</code></li>
<li>è¿‡æ»¤å‡º Kind ä¸º <code>Ingress</code> çš„å¼•ç”¨</li>
<li>è·å–è¿™äº› Ingress å¯¹è±¡</li>
<li>è¿”å›éœ€è¦ reconcile çš„ Ingress åˆ—è¡¨</li>
</ol>

<p><strong>ä½¿ç”¨åœºæ™¯</strong>ï¼šé…ç½® HTTP è·¯ç”±çº§åˆ«çš„ç­–ç•¥ï¼ˆå¦‚é‡å†™ã€é‡å®šå‘ã€è¶…æ—¶ç­‰ï¼‰</p>

<h4 id="7-gatewayproxy-watch-ç¬¬107-109è¡Œ">7. <strong>GatewayProxy Watch</strong> (ç¬¬107-109è¡Œ)</h4>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">Watches</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">v1alpha1</span><span class="p">.</span><span class="nx">GatewayProxy</span><span class="p">{},</span>
    <span class="nx">handler</span><span class="p">.</span><span class="nx">EnqueueRequestsFromMapFunc</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">listIngressesForGatewayProxy</span><span class="p">),</span>
<span class="p">)</span></code></pre></div>
<p><strong>ä½œç”¨</strong>ï¼šç›‘å¬ GatewayProxy é…ç½®çš„å˜åŒ–</p>

<p><strong>é€»è¾‘</strong> (<code>listIngressesForGatewayProxy</code> -&gt; <code>listIngressClassRequestsForGatewayProxy</code>)ï¼š</p>

<ol>
<li>é€šè¿‡ç´¢å¼• <code>IngressClassParametersRef</code> æŸ¥æ‰¾å¼•ç”¨è¯¥ GatewayProxy çš„ IngressClass</li>
<li>å¯¹æ¯ä¸ª IngressClassï¼Œè°ƒç”¨ <code>listIngressForIngressClass</code> è·å–ç›¸å…³ Ingress</li>
<li>å»é‡åè¿”å›æ‰€æœ‰éœ€è¦ reconcile çš„ Ingress</li>
</ol>

<p><strong>ä½¿ç”¨åœºæ™¯</strong>ï¼š</p>

<ul>
<li>GatewayProxy çš„ APISIX åœ°å€å˜åŒ–</li>
<li>å‘å¸ƒæœåŠ¡é…ç½®å˜åŒ–</li>
<li>Provider é…ç½®å˜åŒ–</li>
</ul>

<h4 id="8-generic-event-channel-ç¬¬110-116è¡Œ">8. <strong>Generic Event Channel</strong> (ç¬¬110-116è¡Œ)</h4>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">WatchesRawSource</span><span class="p">(</span>
    <span class="nx">source</span><span class="p">.</span><span class="nx">Channel</span><span class="p">(</span>
        <span class="nx">r</span><span class="p">.</span><span class="nx">genericEvent</span><span class="p">,</span>
        <span class="nx">handler</span><span class="p">.</span><span class="nx">EnqueueRequestsFromMapFunc</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">listIngressForGenericEvent</span><span class="p">),</span>
    <span class="p">),</span>
<span class="p">)</span></code></pre></div>
<p><strong>ä½œç”¨</strong>ï¼šå¤„ç†é€šè¿‡ channel å‘é€çš„è‡ªå®šä¹‰äº‹ä»¶</p>

<p><strong>é€»è¾‘</strong> (<code>listIngressForGenericEvent</code>)ï¼š</p>

<ul>
<li>æ ¹æ®å¯¹è±¡ç±»å‹è·¯ç”±åˆ°ç›¸åº”çš„å¤„ç†å‡½æ•°ï¼š

<ul>
<li><code>BackendTrafficPolicy</code> -&gt; <code>listIngressForBackendTrafficPolicy</code></li>
<li><code>HTTPRoutePolicy</code> -&gt; <code>listIngressesByHTTPRoutePolicy</code></li>
</ul></li>
</ul>

<p><strong>ä½¿ç”¨åœºæ™¯</strong>ï¼š</p>

<ul>
<li>å¤„ç† Policy çš„ targetRefs è¢«ç§»é™¤æ—¶çš„æ¸…ç†å·¥ä½œ</li>
<li>ç¡®ä¿å½“èµ„æºä¸å†è¢«å¼•ç”¨æ—¶ï¼Œèƒ½æ­£ç¡®æ›´æ–°ç›¸å…³é…ç½®</li>
</ul>

<h4 id="æ•´ä½“å·¥ä½œæµç¨‹">æ•´ä½“å·¥ä½œæµç¨‹</h4>

<pre><code>1. äº‹ä»¶è§¦å‘ â†’ 2. Predicate è¿‡æ»¤ â†’ 3. MapFunc æ˜ å°„ â†’ 4. Reconcile é˜Ÿåˆ— â†’ 5. Reconcile æ‰§è¡Œ
</code></pre>

<h4 id="reconcile-ä¸»è¦æ­¥éª¤">Reconcile ä¸»è¦æ­¥éª¤ï¼š</h4>

<ol>
<li><strong>è·å– Ingress å¯¹è±¡</strong>ï¼šå¦‚æœä¸å­˜åœ¨åˆ™æ‰§è¡Œåˆ é™¤é€»è¾‘</li>
<li><strong>æŸ¥æ‰¾ IngressClass</strong>ï¼šç¡®å®šé…ç½®æ¥æº</li>
<li><strong>å¤„ç† IngressClass Parameters</strong>ï¼šåŠ è½½ GatewayProxy é…ç½®</li>
<li><strong>å¤„ç† TLS</strong>ï¼šåŠ è½½è¯ä¹¦ Secret</li>
<li><strong>å¤„ç† Backends</strong>ï¼šåŠ è½½ Service å’Œ EndpointSlice</li>
<li><strong>å¤„ç† HTTPRoutePolicy</strong>ï¼šåº”ç”¨è·¯ç”±ç­–ç•¥</li>
<li><strong>å¤„ç† BackendTrafficPolicy</strong>ï¼šåº”ç”¨åç«¯æµé‡ç­–ç•¥</li>
<li><strong>æ›´æ–° APISIX é…ç½®</strong>ï¼šé€šè¿‡ Provider åŒæ­¥åˆ° APISIX</li>
<li><strong>æ›´æ–°çŠ¶æ€</strong>ï¼šæ›´æ–° Ingress å’Œç›¸å…³èµ„æºçš„çŠ¶æ€</li>
</ol>

<h4 id="å…³é”®è®¾è®¡ç‰¹ç‚¹">å…³é”®è®¾è®¡ç‰¹ç‚¹</h4>

<ol>
<li><strong>ç´¢å¼•ä¼˜åŒ–</strong>ï¼šä½¿ç”¨ Field Indexer å¿«é€ŸæŸ¥æ‰¾èµ„æºå…³ç³»</li>
<li><strong>çº§è”æ›´æ–°</strong>ï¼šä¾èµ–èµ„æºå˜åŒ–æ—¶è‡ªåŠ¨è§¦å‘ä¸»èµ„æºæ›´æ–°</li>
<li><strong>å»é‡æœºåˆ¶</strong>ï¼šé¿å…é‡å¤å¤„ç†åŒä¸€ä¸ª Ingress</li>
<li><strong>äº‹ä»¶é€šé“</strong>ï¼šä½¿ç”¨ genericEvent channel å¤„ç†å¤æ‚çš„æ¸…ç†åœºæ™¯</li>
<li><strong>æ¡ä»¶è¿‡æ»¤</strong>ï¼šé€šè¿‡ Predicate å‡å°‘ä¸å¿…è¦çš„ Reconcile</li>
</ol>

<h4 id="indexeræ€§èƒ½ä¼˜åŒ–">indexeræ€§èƒ½ä¼˜åŒ–</h4>

<p>å¯ä»¥çœ‹åˆ°åœ¨ä¸Šé¢çš„watché€»è¾‘ä¸­æœ‰å¾ˆå¤šçš„listæ“ä½œ, æ¯”å¦‚listIngressForBackendTrafficPolicy, è¿™ä¸ªæ—¶å€™å°±éœ€è¦äº‹å…ˆåœ¨k8s clientçš„indexerä¸­å»ºç«‹ç´¢å¼•æ¥ä¼˜åŒ–æŸ¥è¯¢é€Ÿåº¦, é¿å…listå…¨æ‰«æ•°æ®:</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nx">setupIngressIndexer</span><span class="p">(</span><span class="nx">mgr</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Manager</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="c1">// create IngressClass index
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mgr</span><span class="p">.</span><span class="nx">GetFieldIndexer</span><span class="p">().</span><span class="nx">IndexField</span><span class="p">(</span>
		<span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">(),</span>
		<span class="o">&amp;</span><span class="nx">networkingv1</span><span class="p">.</span><span class="nx">Ingress</span><span class="p">{},</span>
		<span class="nx">IngressClassRef</span><span class="p">,</span>
		<span class="nx">IngressClassRefIndexFunc</span><span class="p">,</span>
	<span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>

	<span class="c1">// create Service index for quick lookup of Ingresses using specific services
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mgr</span><span class="p">.</span><span class="nx">GetFieldIndexer</span><span class="p">().</span><span class="nx">IndexField</span><span class="p">(</span>
		<span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">(),</span>
		<span class="o">&amp;</span><span class="nx">networkingv1</span><span class="p">.</span><span class="nx">Ingress</span><span class="p">{},</span>
		<span class="nx">ServiceIndexRef</span><span class="p">,</span>
		<span class="nx">IngressServiceIndexFunc</span><span class="p">,</span>
	<span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>

	<span class="c1">// create secret index for TLS
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mgr</span><span class="p">.</span><span class="nx">GetFieldIndexer</span><span class="p">().</span><span class="nx">IndexField</span><span class="p">(</span>
		<span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">(),</span>
		<span class="o">&amp;</span><span class="nx">networkingv1</span><span class="p">.</span><span class="nx">Ingress</span><span class="p">{},</span>
		<span class="nx">SecretIndexRef</span><span class="p">,</span>
		<span class="nx">IngressSecretIndexFunc</span><span class="p">,</span>
	<span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mgr</span><span class="p">.</span><span class="nx">GetFieldIndexer</span><span class="p">().</span><span class="nx">IndexField</span><span class="p">(</span>
		<span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">(),</span>
		<span class="o">&amp;</span><span class="nx">networkingv1</span><span class="p">.</span><span class="nx">Ingress</span><span class="p">{},</span>
		<span class="nx">TLSHostIndexRef</span><span class="p">,</span>
		<span class="nx">IngressTLSHostIndexFunc</span><span class="p">,</span>
	<span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span></code></pre></div>
<h5 id="ç´¢å¼•æ¦‚è§ˆè¡¨">ğŸ“Š <strong>ç´¢å¼•æ¦‚è§ˆè¡¨</strong></h5>

<table>
<thead>
<tr>
<th>ç´¢å¼•åç§°</th>
<th>ç´¢å¼•å­—æ®µ</th>
<th>ç´¢å¼•å‡½æ•°</th>
<th>ä¸»è¦ç”¨é€”</th>
</tr>
</thead>

<tbody>
<tr>
<td>IngressClassRef</td>
<td><code>ingressClassRef</code></td>
<td><code>IngressClassRefIndexFunc</code></td>
<td>æ ¹æ® IngressClass æŸ¥æ‰¾ Ingress</td>
</tr>

<tr>
<td>ServiceIndexRef</td>
<td><code>serviceRefs</code></td>
<td><code>IngressServiceIndexFunc</code></td>
<td>æ ¹æ®åç«¯ Service æŸ¥æ‰¾ Ingress</td>
</tr>

<tr>
<td>SecretIndexRef</td>
<td><code>secretRefs</code></td>
<td><code>IngressSecretIndexFunc</code></td>
<td>æ ¹æ® TLS Secret æŸ¥æ‰¾ Ingress</td>
</tr>

<tr>
<td>TLSHostIndexRef</td>
<td><code>tlsHostRefs</code></td>
<td><code>IngressTLSHostIndexFunc</code></td>
<td>æ ¹æ® TLS ä¸»æœºåæŸ¥æ‰¾ Ingress</td>
</tr>
</tbody>
</table>

<p>Ingress çš„ 4 ä¸ªç´¢å¼•å½¢æˆäº†ä¸€ä¸ªå®Œæ•´çš„æŸ¥è¯¢ä½“ç³»ï¼š</p>

<ol>
<li><strong>IngressClassRef</strong>ï¼šç®¡ç†å±‚é¢ - æŒ‰æ§åˆ¶å™¨åˆ†ç»„</li>
<li><strong>ServiceIndexRef</strong>ï¼šæ•°æ®å¹³é¢ - åç«¯æœåŠ¡å…³è”</li>
<li><strong>SecretIndexRef</strong>ï¼šå®‰å…¨å±‚é¢ - TLS è¯ä¹¦ç®¡ç†</li>
<li><strong>TLSHostIndexRef</strong>ï¼šåŸŸåå±‚é¢ - SSL é…ç½®ç®¡ç†</li>
</ol>

<p>è¿™äº›ç´¢å¼•ç¡®ä¿äº†å½“ä»»ä½•ä¾èµ–èµ„æºå˜åŒ–æ—¶ï¼Œæ§åˆ¶å™¨éƒ½èƒ½<strong>å¿«é€Ÿã€å‡†ç¡®</strong>åœ°æ‰¾åˆ°éœ€è¦æ›´æ–°çš„ Ingressï¼Œå®ç°<strong>é«˜æ•ˆçš„çº§è”æ›´æ–°</strong>å’Œ<strong>å®æ—¶é…ç½®åŒæ­¥</strong>ã€‚</p>

<h3 id="3-pingsix-ingress-controlleræ¶æ„å†³ç­–">3. pingsix-ingress-controlleræ¶æ„å†³ç­–</h3>

<p>ä»apisix-ingress-controllerçš„æ¶æ„ä¸­, æˆ‘ä»¬çŸ¥é“apisixæŠ½è±¡äº†ä¸€ç§ADC(API Declarative CLI)çš„èµ„æºç±»å‹ç”¨æ¥åœ¨ingressä¸apisixèµ„æºä¹‹é—´ä½œä¸ºä¸­é—´çš„æ¡¥æ¢, å¦‚æœç›´æ¥ä½¿ç”¨apisix-ingress-controlleræ¥å¯¹æ¥pingsixçš„è¯, å°±éœ€è¦pingsixå®Œæ•´çš„å®ç°apisixçš„admin api, å¹¶ä¸”è¿˜éœ€è¦åœ¨ä½¿ç”¨æ—¶å¯åŠ¨etcd.</p>

<p>åœ¨æˆ‘çš„å°è±¡ä¸­æ›¾ç»çœ‹åˆ°è¿‡apisix-ingress-controllerå®ç°è¿‡ä¸€ä¸ªä¸éœ€è¦etcdçš„æ–¹æ¡ˆ:</p>

<ul>
<li><a href="https://apisix.apache.org/blog/2023/10/18/ingress-apisix/">Embrace the Lightweight APISIX Ingress Controller Without etcd Dependency</a></li>
</ul>

<p>ç„¶åæˆ‘åœ¨apisix-ingress-controller 1.8.x ç‰ˆæœ¬çš„ä»£ç ä¸‹æ‰¾åˆ°äº†è¿™ä¸ªè¿™ä¸ªå®ç°æ–¹å¼, åªæ˜¯å½“å‰çš„ 2.0.x ç‰ˆæœ¬åœ¨å¼•å…¥äº†ADCç›¸å…³çš„åŠŸèƒ½åå»æ‰äº†<a href="https://github.com/api7/etcd-adapter">etcd-adapter</a>, é‚£æˆ‘åœ¨è€ƒè™‘å®ç°æˆ‘çš„pingsix-ingress-controlleræ—¶, ä¸ºäº†é¿å…ç›´æ¥æ”¹åŠ¨pingsixçš„ä»£ç , å¹¶ä¸”ä¹Ÿä¸å¸Œæœ›åœ¨ingresså¯åŠ¨æ—¶ä¾èµ–etcd, æ‰€ä»¥å†³å®šé‡æ–°å¼•å…¥etcd-adapter, ç„¶åä¸ºäº†åç»­pingsix-ingress-controllerèƒ½åŒæ­¥apisix-ingress-controllerçš„ä¸Šæ¸¸æ›´æ–°, æˆ‘å†³å®šåœ¨ç°æœ‰çš„ADC Executorçš„æ¥å£çš„åŸºç¡€ä¸Š, å®ç°pingsixçš„Executor, è¿™æ ·å°±å¯ä»¥åœ¨é¿å…ç›´æ¥ä¿®æ”¹apisixçš„é€»è¾‘ä»£ç , ä½¿ç”¨ä¸€ç§adapterçš„æ–¹å¼æ¥å®ç°æˆ‘ä»¬è‡ªå·±çš„pingsix-ingress-controller.</p>

<p><img src="https://github.com/user-attachments/assets/a10a7162-ea7d-4407-b7a6-b5481823592b" alt="Image2" width="700px" /></p>

<p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å®ç°çš„è¿™ä¸ªExecutor, å…¶å®å°±æ˜¯é‡å¤äº†ä¸€éADC http serveçš„é€»è¾‘, ä½†æ˜¯æœ€ç»ˆèµ„æºçš„æ•°æ®æ˜¯å†™å…¥åˆ°etcd-adapterä¸­çš„, æˆ‘ä»¬å®ç°äº†ä¸€ä¸ªapisix-ingress-controlleræœ€åº•å±‚çš„æŠ½è±¡, é€šè¿‡è¿™ç§ä½æˆæœ¬çš„æ”¹é€ æˆ‘ä»¬åç»­è¿˜å¯ä»¥ç»§ç»­åŒæ­¥apisix-ingress-controllerçš„å˜æ›´, å¹¶ä¸ä¼šé€ æˆä»£ç å†²çª.</p>

<h3 id="æ€»ç»“">æ€»ç»“</h3>

<p>åœ¨å®ç°<a href="https://github.com/zhu327/pingsix-ingress-controller">pingsix-ingress-controller</a>çš„è¿‡ç¨‹ä¸­, æˆ‘å®Œæ•´çš„é˜…è¯»äº†apisix-ingress-controllerçš„ä»£ç , æ”¶è·äº†ä¸€äº›å†™operatorçš„æŠ€å·§, ç„¶ååœ¨åˆ†æç°æœ‰apisix-ingress-controllerçš„ä»£ç æ¶æ„æ—¶, å†³å®šé€šè¿‡æ‰©å±•ADC Executorçš„å®ç°æ¥å®è·µäº†é¢å‘å¯¹è±¡çš„å¼€é—­åŸåˆ™, å¯¹äºåç»­çš„ä»£ç æ›´æ–°åˆå¹¶å¼€äº†ä¸€ä¸ªå¥½å¤´.</p>


</div>



<script src="https://utteranc.es/client.js"
  repo="zhu327/zhu327.github.io"
  issue-term="title"
  theme="github-light"
  crossorigin="anonymous"
  async>
</script>


      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
</html>

